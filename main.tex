
\documentclass{article}
\usepackage{fullpage}

\renewcommand{\familydefault}{\sfdefault}
\usepackage[scaled=1]{helvet}
\usepackage[helvet]{sfmath}
\everymath={\sf}
\usepackage{hyperref}
\usepackage{parskip}
\usepackage[colorinlistoftodos]{todonotes}
\usepackage{graphicx} 
\usepackage{amsmath}
\usepackage{amsthm}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{amsbsy}
\usepackage{graphicx}
\usepackage{bbm}
\usepackage{mathrsfs}
\usepackage[colorlinks=true, allcolors=blue]{hyperref}

\title{JJM user manual}

\date{\parbox{\linewidth}{\centering%
  \skip
  Criscely LUJAN \hspace*{3cm} Mirian GERONIMO\endgraf\medskip
  Instituto del Mar del Per√∫ IMARPE}
  }
\setcounter{tocdepth}{2}
\begin{document}
\maketitle

\tableofcontents
\newpage

\section*{Abstract} 
% Model description
This paper provides a detailed and comprehensive specification of the joint jack mackerel model (JJM), including the algebraic specifications of the assessment model, tables with the input data and key parameters for the assessment. In addition a case study has been used to illustrate the use of the JJM model. This paper aims to provide an illustrative description of the JJM which can serve as support and guidance to users.

\section{Introduction} 

% Model description
This paper gives a full algebraic description of the JJM model which is used for the Jack mackerel assessment in the South Pacific Regional Fisheries Management Organisation \href{https://www.sprfmo.int/}{SPRFMO}. For this work, we provide a set of data that is used as part of a case study (see \nameref{section:AppendixA}). This information is used as data input to simulate an assessment (see results in \nameref{section:AppendixB}). Part of the concepts of the JJM model presented here come from \href{https://www.sprfmo.int/assets/Meetings/SC/10th-SC-2022/Report-and-Annexes/Annex-8-JM-Technical-Advice-CV_2.pdf}{SPRFMO SC10 Report-Annex 10- Jack Mackerel Technical Annex}.

\section{JJM model}

\subsection{Model description}

% Aim of the model
The Joint Jack Mackerel Model (JJM) is a statistical catch-at-age and age-structured model used to evaluate the Jack mackerel (\textit{Trachurus murphyi}). This species is widespread throughout the South Pacific ocean, and there are at least five management units identified of Jack mackerel whose are associated to distinct fisheries: the Ecuadorian and Peruvian fishery, the northern and central-southern Chilean fisheries, and the purely high sea fishery. 

The JJM model was adopted as the assessment method in 2010 and continues to be used in the SPRFMO. In this context, each year an update of the model data is carried out, and using updated data inputs and indicators the model is run. Model results are used to provide an recommendation of the Jack mackerel population status for its exploitation. On the other hand, the JJM model was been adopted for some SPRFMO delegations (e.g. in Peru) for its internal fishery assessment.

% Programming languages
This JJM model, implemented in AD Molder Builder (\href{https://www.admb-project.org/}{ADMB}), uses a forward projection approach and maximum likelihood estimation to solve for model parameters. The operational population dynamics model of the JJM is defined by the standard catch equation with various modifications such as those described by Fournier \& Archibald (1982), Hilborn \& Walters (1992) and Schnute \& Richards (1995).\\

\textbf{Algorithm sections}\\

There are three obligatory and important sections in the JJM code:

\begin{itemize}
    \item Data section: data reading from a document with init prefix
    \item Parameter section: model parameterisation
    \item Procedure section: current model calculations
\end{itemize}

\subsection{Model history}
% A little of history about the model
Since the creation of the JJM model, this tool is in continuous development and has been improved by participant scientists mainly involved in the SPRFMO. As part of the most important changes since its creation, was to include length composition data (and specifying or estimating growth) and the capacity to estimate the natural mortality by age and time. Nowadays, the model allow the use of catch information either at age or size for any fleet, this is an important change that provides flexibility in terms of data usage. Besides, other important change is the explicit incorporation of regime shifts in population productivity by fleet.

% Which information need the model
The model consists of four main components: i) the dynamics of the stock, ii) the fishery dynamics, iii) the observation models for the data, and iv) the procedure used for parameter estimation (including uncertainties).

\subsection{Main assumptions}

A statistical catch-at-age model analyses data on the age of fish caught in scientific surveys and by fisheries to provide a management advice. Catch-at-age models typically require information on stock age, fishing effort and total catches for each fishery targeting a stock.

To apply a statistical catch-at-age models, specific data are needed for each age class, where an age class is a set of all fish born in a given year. Then, catch-at-age results provide the full suite of management advice estimating a stock's current size and its management reference points associated with the maximum sustainable yield (MSY). The main assumptions of such models and implemented in the JJM model are detailed in the following sections.

\subsubsection{Stock dynamics}

\begin{itemize}

\item The JJM model is not spatially-explicit, although the fisheries operate in geographically distinct areas.

\item The model needs initial conditions which should preferably be set at equilibrium conditions.

\item The population's age composition considers individuals of diverse years (from 1 to more). But in all cases a stochastic Beverton-Holt relationship between stock and recruitment is included.

\item The recruitment and the spawning season should be assumed to occur in specific month or period of time.

%For the study of the Jack Mackerel in the South Pacific ocean, the recruitment is assumed to occur in January while the spawning season is assumed to be an instantaneous process occurring in mid-November.

\item Each cohort survives an age-specific mortality composed of fishing mortalities at age by fleet and natural mortality.

\item Natural mortality is assumed to be constant over time and age.

\end{itemize}

\subsubsection{Fishery dynamics}

\begin{itemize}

\item The JJM model assumes that the interaction of the population with the fisheries occurs through the fishing mortality. 
    
\item The fishing mortality is assumed to be a composite of several processes: selectivity (by fleet), catchability and effort deviations.

\item The selectivity report the age-specific pattern of fishing mortality and its pattern is non-parametric assuming to be fishery-specific and time-variant.

\item The catchability describes the scales of fishing effort to fishing mortality and it is specific to each of abundance indices.
    
\item The effort deviations describes a random effect in the fishing effort.

\item The JJM model includes temporal variation in both fishery and index selectivity patterns at the annual and regime scales, depending on the index and the stock structure hypothesis.
\end{itemize}

\subsubsection{Observation models for data}

\begin{itemize}

\item There are four data components that contribute to the log-likelihood
function: the total catch data, the age-frequency data, the length-frequency data and the abundance indices.

\item Probability distributions for the age and length-frequency proportions are assumed to be approximated by multinomial distributions.

\item Sample size is specified to be gear-specific but mostly constant over years.

\item For the total catch by fishery and the abundance indices, a log-normal assumption has been assumed with constant coefficient of variation (CV).

\end{itemize}

%To be included in model input parameters
%The CV for the fisheries being 0.05 whereas the CV for the abundance indices depends on the index. Besides, the Francis T1.8 weighting method is used to assign weighted sample sizes for age-frequency data. The data weights have been updated during the JM benchmark.

\subsubsection{Parameter estimation}

% Methods for estimated parameters

\begin{itemize}

\item The most numerous parameters estimated involve estimates of annual and age-specific components of fishing mortality for each year and for each of the four fisheries identified in the model.

\item Model parameters are estimated by maximising the log-likelihoods of the data plus the log of the probability density functions of the priors and smoothing penalties specified in the model.

\item Parameter estimation is conducted in a series of phases, the first of which used arbitrary starting values for most parameters.

\end{itemize}

% Modeled process: a description of it

\subsection{Mathematical Model details}

This catch-at-age model is used as the underlying assessment model able to fit to CPUE indices as well as catch-at-age and length data. The assessment process involves developing a model of the resource dynamics and conditioning its output to the available data by minimizing a log-likelihood function.

\subsubsection{Population dynamics}

\textbf{a. Numbers at age}

The population dynamics are modelled by the following set of equations:

\begin{equation}
N^s_{y,a=1}=e^{\mu_R+\epsilon_{y}}  \ \ \ \ \ , y_{1}\leq y \leq y_{N}
\end{equation}

where:
\begin{itemize}
    \item $s$ is the fish stock, $a$ the age and $y$ the year;
    
    \item the simulation period ${y \in \{y_{0},y_{N}\}}$;

    \item $N^s_{y,a=1}$ is the numbers at age $a=1$ for the stock $s$ in year $y$;
    
    \item $\mu_R$ is the mean recruitment;
    %\item $\mu_R$: $mean\_log\_rec(cum\_regs(s)+yy\_sr(s,y))$;

    \item $\epsilon_{y}$ is the annual deviation of recruitment.
    
    %\item $\epsilon_{y}:rec\_dev(s,y)$;
\end{itemize}

The JJM uses the Pope approximation, a variant of the statistical catch-at-age. This fixes the predicted catches to the observed catches using Pope's approximation to calculate the annual exploitation rate in the midpoint of the year. In this case:

\begin{equation}
N^{s}_{y+1,a+1}=N^s_{y,a}e^{-M^s_y}-C^s_{y,a}e^{-M^s_y 0.5}, \ \ \ \ \ 1\leq a \leq m-2
\end{equation}
    
\begin{equation}
N^s_{y+1,m}=N^s_{y,m-1}e^{-M^s_y}-C^s_{y,m-1}e^{-M^s_y 0.5}+N^s_{y,m}e^{-M^s_y}-C^s_{y,m}e^{-M^s_y 0.5}
\end{equation}

where:
\begin{itemize}
    \item $m$ is the maximum age considered;
    
    \item $N^{s}_{y+1,a+1}$ is the number of fish at age $a+1$ for the stock $s$ in the year $y+1$;

    \item $N^{s}_{y+1,m}$ is the number of fish at age $m$ for the stock $s$ in the year $y+1$;

    \item $M^{s}_{y}$ denotes the natural mortality rate on fish of stock $s$ in the year $y$;

    \item $C^s_{y,a}$ and $C^s_{y,m}$ denotes the total catch of stock $s$ in the year $y$ at age $a$ and $m$ respectively.
    
\end{itemize}

\hfill

In addition, the fishing mortalities and survival rate are calculated:

\begin{equation}
F^s_{y,a}=log\left(\dfrac{N^s_{y,a}}{N^s_{y+1,a+1}}\right)-M^s_y, \ \ \ \ \ 1\leq a \leq m-1
\end{equation}

\begin{equation}
F^s_{y,m}=log\left(\dfrac{N^s_{y,m-1}+N^s_{y,m}}{N^s_{y+1,m}}\right)-M^s_y
\end{equation}

where:

\begin{itemize}
    \item $F^s_{y,a}$ is the fishing mortality for the stock $s$ at the age $a$ in the year $y$;

    \item $F^s_{y,m}$ is the fishing mortality for the stock $s$ at the maximum age $m$ considered in the year $y$.
\end{itemize}

\hfill

Also, the fishing mortality for each fishery and the survival rate are calculated as follows:

\begin{equation}
F^k_{y,a}=F^s_{y,a} \dfrac{\sum_{a = 1} ^{m} Cat^k_{y,a}}{\sum_{a=1} ^{m} C^s_{y,a}}, \ \ \ \ \ 1\leq a \leq m.
\end{equation}

\begin{equation}
S^s_{y,a}=e^{-(F^s_{y,a}+M^s_{y})}
\end{equation}

where:
\begin{itemize}
    \item $k$ is the fishery number and $s$ is the corresponding stock due to the fishery;
    
    \item $1\leq k \leq n_{fsh}$ where $n_{fsh}$ is the total number of fisheries;
   
    \item $F^k_{y,a}$ is the fishing mortality for fishery $k$ at age $a$ in the year $y$;

    \item $Cat^k_{y,a}$ is the catch at age $a$ for fishery $k$ in the year $y$ (see bellow);
    
    \item $S^s_{y,a}$ is survival rate for the stock $s$ at age $a$ in the year $y$.
\end{itemize}

When the Pope approximation is not used the number at age and survival rate are calculated as follows:

\begin{equation}
N^s_{y+1,a+1}=N^s_{y,a}S^s_{y,a}, \ \ \ \ \ 1\leq a \leq m-2
\end{equation}

\begin{equation}
N^s_{y+1,m}=N^s_{y,m-1}S^s_{y,m-1}+N^s_{y,m}S^s_{y,m}
\end{equation}

Defining the fishing mortality for the stock, survival rate, and fishing mortality for the fishery as:

\begin{equation}
F^s_{y,a} = \sum_{k_s}F^{k_s}_{y,a}, 
\end{equation}
where the sum is over all fisheries $k_s$ belonging to stock s.

\begin{equation}
S^s_{y,a}=e^{-(F^s_{y,a}+M^{s}_{y})},
\end{equation}

\begin{equation}
F^k_{y,a}=e^{Fmort^k_y}Se^k_{y,a}, \ \ \ y_0\leq y \leq y_N \ \ \ and  \ \ \  1\leq a \leq m
\end{equation}

where:
\begin{itemize}

    %\item $Z^{s}_{y,a}$ is the total mortality of stock $s$(to which fishery number k corresponds) in the year $y$ at the age $a$ ;
    %\item $sel\_map$ is a selectivity map,  se refiere al n√∫mero de stock al que pertenece la pesquer√≠a n√∫mero $k$, notemos que $1\leq k \leq nfsh$ donde $nfsh$ es la cantidad total de pesquer√≠as.
    
    \item $Fmort^k_y$ is the annual mortality for the fishery $k$ in the year $y$;
    \item $Se^k_{y,a}$ is the fishing selectivity of the fishery $k$ in the year $y$ at the age $a$.

\end{itemize}

\hfill

The numbers at age when $y_0$ for the stock $s$ at the age $a$ is calculated as following:

\begin{equation}
N^s_{y_0,a=1}=e^{\mu^s_{R,y_0} + \epsilon^s_{y_0}}
\end{equation}

If $r_0 = y_0-m+a_R$, where $r_0$ is the first year of recruitment and $a_R$ is the age at recruitment. For this case $a_R=1$:

\begin{equation}
N^s_{y_0,a}=e^{\mu_{R,y_0-a+1}^s + \epsilon^s_{y_0-a+1}}
            \prod_{j=1}^{a-1}e^{-M^s_{y_0,j}}, \ 1<a<m
\end{equation}
%M^s=_{y_0,j}=M^s_{y_0}, ya que la mortalidad natural es constante
If $r_0 = y_0-m+a_R$, where $a_R>1$:

\begin{equation}
N^s_{y_0,a}=e^{\mu_{R,y_0-a+1}^s + \epsilon^s_{y_0-a+1}}                          \prod_{j=1}^{a-1}e^{-M^s_{y_0,j}}, \ 1<a\leq m-a_R+1
\end{equation}

\begin{equation}
N^s_{y_0,a}=R_0^s\prod_{j=1}^{a-1}e^{-M^s_{y_0,j}}, \ m-a_R+1<a\leq m-1
\end{equation}

where $R_0^s$ is the recruitment to the first regime of stock $s$.

Finally, the number at age when the age es the maximum age considered in the population:

\begin{equation}
N^s_{y_0,m}=N^s_{y_0-1,m-1}e^{-M^s_{y_0,m-1}}+N^s_{y_0-1,m}e^{-M^s_{y_0,m}}
\end{equation}

%\begin{itemize}
%   \item $log\_Rzero_r$ estimated parameter for the regime $r$;
%   \item $Rzero(r)$=$e^{log\_Rzero_{r}}$, where $1\leq r \leq n_{regs}$ and $n_{regs}$ is the total number of regimes for all stocks;

%   \item cum\_regs(s) es la cantidad reg√≠menes acumulados hasta el stock n√∫mero s-1 (cada stock tiene una determinada cantidad de reg√≠menes).
%   \item $R^s_{0}$ es como el reclutamiento del primer r√©gimen del stock n√∫mero s
%   %\item Rzero(cum\_reg(s)+1)=R^s_{0} es como el reclutamiento del primer r√©gimen del stock n√∫mero s.
%\end{itemize}


\textbf{b. Spawning stock biomass}

The spawning stock biomass (SSB) is the total biomass of fish of reproductive age during the breeding season of a stock. SSB is calculated from the first year of spawning (styr\_sp) until $y_N+1$ as follows:

%\textbf{Biomasa desovante (sp\_biom)}\\
%Obtenci√≥n de la biomasa desovante desde el primer a√±o de desove $\left(styr\_sp\right)$ hasta el primer a√±o de observaci√≥n ($y_0$).
% \begin{equation}
%     Sp\_Biom(s)_p=wt\_mature(s)_1.e^{-M^s_{styr,1}.spmo\_frac}.Rzero(cum\_regs(s)+1),
%coment: Rzero(cum\_regs(s)+1)=R^s_0
% \end{equation}

% \begin{equation}
%     SB^s_p=wt\_mature(s)_1.e^{-M^s_{y_0,1}.spmo\_frac}.R^s_0
% \end{equation}
%styr_rec=r_0

\begin{equation}
    SSB^s_y=wt\_{mat}^s_1 e^{-(M^s_{y_0,1})(s_f)} R^s_0 +  
            \sum_{a=2}^{m-1}wt\_{mat}^s_a e^{-(M^s_{y_0,a}) (s_f)} R^s_0\prod_{l=1}^{a-1}e^{-M^s_{y_0,l}} + 
            {wt\_mat}^s_{m} e^{-(M^s_{y_0,m}) (s_f)} \dfrac{R^s_0}{1-e^{-(M^s_{y_0,m})}}\prod_{l=1}^{m-1}e^{-M^s_{y_0,l}}
\end{equation}
  
where:
%espa√±ol:
% \begin{itemize}
%    % \item $Sp\_Biom(s)_p$: Biomasa desovante desde el a√±o $p=styr\_sp$ hasta $p=styr\_rec$.
%    \item $SB^s_p$ es la Biomasa desovante para el stock n√∫mero s en el a√±o p, cuando  $styr\_sp\leq p \leq r_0$. 
%    %Biomasa desovante desde el a√±o $p=styr\_sp$ hasta $p=r_0$.
%    \item $wt\_mature^s_j$ es el peso(o proporci√≥n) de especies maduras para cada edad $j$ en cada stock $s$, se calcula como
%     \begin{equation}
%         wt\_mature^s_j=wt\_pop^s_j.maturity^s_j
%     \end{equation}
%     \item $wt\_pop^s_j$ es input, l√≠nea 140 del ctl. Peso a la edad $j$ de la poblaci√≥n para cada stock $s$.
%     \item $maturity^s_j$ es input, l√≠nea 143 del ctl. Madurez a la edad $j$ para cada stock $s$.
% \end{itemize}
%en ingles:

\begin{itemize}
  
   \item $SSB^s_y$ is the spawning stock biomass for stock s in year y, when  $styr\_sp\leq y \leq r_0$;
   
   \item $r_0$ is the first year of recruitment;
   
   \item $wt\_{mat}^s_a$ is the proportion of mature females (in weight) at each age $a$ in each stock $s$ that is calculated as a product of the population weight at age ($wt\_pop^s_a$) and the maturity ($maturity^s_a$) as follows:
    \begin{equation}
        wt\_{mat}^s_a=wt\_pop^s_a maturity^s_a, \ \ \ 1\leq a \leq m 
    \end{equation}
        
    \item $M^s_{y_0,m}$ is the natural mortality for stock s at age m in the year $y_0$;
    
    \item $R^s_{0}$ is the is the recruitment to the first regime of stock s;

    % \item spmo\_frac exponent of the survival rate ($S^s_{i,j}$), is computed as 
    % $spmo\_frac=\dfrac{spawnmo-1}{12}$.
    \item $s_f$ is computed as $s_f=\dfrac{spawnmo-1}{12}$.
    %\item spawnmo is input of file .dat, line 278.

\end{itemize}

\hfill

Also, the SSB is calculated for the years $r_0+1 \leq y \leq y_0 - 1$ and when $1\leq i \leq y_0-r_0$. First, the $natagetmp$ is calculated as follows:\\

\begin{equation}
natagetmp^s_{y=r_0+i,a}= e^{\epsilon^s_{r_0+i+1-a}+\mu^s_{R,r_0+i+1-a}}\prod_{t=1}^{a-1}e^{-M^s_{y_0,t}}, \ \ and \ \ 2\leq a \leq i+1
\end{equation}


\begin{equation}
natagetmp^s_{y=r_0+i,a}=R^s_0\prod_{t=1}^{a-1}e^{-M^s_{y_0,t}}, \ \ i+2\leq  a \leq m-1
\end{equation}


\begin{equation}
natagetmp^s_{y=r_0+i,m}=natagetmp^s_{r_0+i-1,m-1}
+natagetmp^s_{r_0+i-1,m}e^{-M^s_{m}}, \ \ a=m
\end{equation}


With these previous calculations, the SSB is obtained:

\begin{equation}
    SSB^s_y=\sum_{a=2}^{m}natagetmp^s_{y,a}e^{-M^s_{y_0}s_f}.wt\_{mat}^s_a,
\end{equation}


After having calculated the numbers at age for each year and the survival rate (both depending on the choice of popes, if true or false), the SSB is calculated for the stock s in the year y:

\begin{equation}
SSB^s_y=\sum_{a=1}^{m}N^s_{y,a}{(S^s_{y,a})}^{s_f}{wt\_{mat}}^s_a, \ \ y_0 \leq y \leq y_N
\end{equation}


% \begin{itemize}
%     \item $wt\_pop^s_j$: es input, l√≠nea 140 del ctl. Peso a la edad $j$ de la poblaci√≥n para cada stock $s$.
%     \item $maturity^s_j:$ es input, l√≠nea 143 del ctl. Madurez a la edad $j$ para cada stock $s$.
% \end{itemize}
%Calculo de la biomasa desovante para el a√±o j=endyr+1.\\
Now for the year $y=y_N+1$:

\begin{equation}
    SSB^s_{y_N+1}=e^{\mu^s_{R,y_N+1}}(S^{s}_{y_N,1})^{s_f}{wt\_{mat}}^s_1+\sum_{a=2}^{m-1}(N^{s}_{y_N,a-1}S^{s}_{y_N,a-1})(S^s_{y_N,a})^{s_f}wt\_{mat}^s_a
\end{equation}
\begin{equation*}
 +(N^{s}_{y_N,m-1}S^s_{y_N,m-1}+N^s_{y_N,m}S^s_{y_N,m})(S^s_{y_N,m})^{s_f}wt\_{mat}^s_{m}
\end{equation*}

The SSB ($SSB^s_{y_N+1}$) is also projected over the time when the number of projected years is $nproj\_yrs>0$ as function of futures numbers at age ($N^s_{fut}$) and survival rate ($S^s_{fut}$): 

\begin{equation}
    SSB^s_{y_N+1}= \sum_{a=1}^m wt\_{mat}^s_a{N_{fut}}^s_{y_N+1,a}({{S_{fut}}^s_{y_N+1,a}})^{s_f}
\end{equation}

where: 

\begin{itemize}

    \item ${S_{fut}}^s_{y_N+1,a} = e^{-M^s_{y_N}}$

    \item ${N_{fut}}^s_{y_N+1,a} = N^s_{y_N,a-1}S^s_{y_N,a-1}, \ \ 2\leq a \leq m-1$
    
    \item ${N_{fut}}^s_{y_N+1,m} = N^s_{y_N,m-1}S^s_{y_N,m-1}+N^s_{y_N,m}S^s_{y_N,m}$, \ \ a = m 
    
    \item ${N_{fut}}^s_{y_N,1} = SRecruit(SSB^s_{y_N-rec\_age},cum\_reg(s)+yy\_sr(s,y_N))e^{\epsilon^s_{y_N}}$, where $SRecruit$ is a function of  spawning biomass and the number of regimen (see section Recruitment).
    
\end{itemize}

%SRecruit is calculated in the recruitment section (from equation 50), it is a function with spawning biomass as the first argument and a regime number as the second argument.

\hfill

\textbf{c. Catches}\\

When the model is using the Popes's approximation, the total catch of stock ($C^s_{y,a}$) is calculated as a function of ${C_{tmp}}^{k_s}_{y,a}$ for each stock $s$ ($1\leq s \leq nstk$) at age $a$ in the year $y$ ($y_0 \leq y \leq y_N$): 

\begin{equation}
{C_{tmp}}^{k_s}_{y,a}=N^s_{y,a}e^{-0.5M^s_{y,a}} Se_{y,a}^{k_s} \dfrac{c_{tmp}}{v_{bio}}, \ \  1\leq a \leq m, \ \ where
\end{equation}

%\begin{equation}
%        Ctmp^{k_s}_a=N^s_{y,a}.e^{-\frac{M^s_{y,a}}{2}}sel\_fsh_a(k_s,y).\dfrac{catch\_tmp}{vbio},
%    \end{equation}

\begin{equation}
v_{bio}=\sum_{a=1}^mN^s_{y,a}e^{-0.5M^s_{y,a}} Se_{y,a}^{k_s} w_{y,a}^{k_s}, \ \ and 
\end{equation}
    %\item If $popes=TRUE$, then pentmp=0. Let  $k_s$ the fisheries that correspond to the stock $s$:
    
%    para $1\leq a \leq m$, where
%    \begin{equation}
%        vbio=\sum_{a=1}^mN^s_{y,a}.e^{-\frac{M^s_{y,a}}{2}}.sel\_fsh_a(k_s,y).wt\_fsh_a(k_s,y),
%    \end{equation}
%    and 

\begin{equation}
c_{tmp} = v_{bio}-posfun\left(\frac{v_{bio} - {C_{obs}}_{k_s,y}}{v_{bio}} , 0.1 , pen_{tmp}=0 \right).v_{bio}
\end{equation}

%        \begin{equation}
%        catch\_tmp=vbio-posfun\left(\frac{(vbio - catch\_bio(k_s)_y)}{vbio} , 0.1 , pentmp \right).vbio,
%    \end{equation}

Following this, the catch of the stock ($C$), catch-at-age ($Cat$) and the predicted catch ($C_{pred}$) are calculated as follows:

\begin{equation}
        %catage\_tot(s,i)+=Ctmp, consultar
C^s_{y,a}=\sum_{k_s}{C_{tmp}}^{k_s}_{y,a} 
%(sum on the fisheries belonging to the stock s)
\end{equation}

\begin{equation}
%catage(k,i)=Ctmp
Cat^{k_s}_{y,a}={C_{tmp}}^{k_s}_{y,a},  \  \  \ 1\leq a \leq m
\end{equation}

\begin{equation}
{C_{pred}}^{k_s}_y=\sum_{a=1}^{m}{C_{tmp}}^{k_s}_{y,a} w_{y,a}^{k_s}
\end{equation} 
%$\begin{equation}
%pred\_catch(k_s,y)=\sum_{a=1}^{m}Ctmp_a.wt\_fsh_a(k_s,y).
%\end{equation} 

where:        
\begin{itemize}
    %\item $C^s_{y,a}$ is the total catch of stock $s$ for year $y$ at age $a$. It is used in eq. 6.
    %\item $Cat(k,y)_a$ is the catch at age $a$ of fishery $k$ in year $y$. It is used in eq. 6.
    %\item pred\_catch(k,y) is the predicted catch for year $y$ of fishery number $k$.

    \item $Se_{y,a}^{k_s}$ is the fishing selectivity of the fishery $k$ at the age $a$ in the year $y$;
    
    \item $w_{y,a}^{k}$ is the weight at age $a$ for the fishery $k$ in the year $y$ of observation;
    %Is input, line 80 of .dat file.
    
    \item $C_{obs}$ is the observed catch.
    
    %\item catch\_bio is the observed catch biomass
    
    %    \begin{equation}
    %      catch\_bio(k)_y=catch\_bio\_in(k)_y,  
    %    \end{equation}
    %    where $1\leq k \leq nfsh$ y $y_0\leq y \leq y_N$.

    %\item $catch\_bio\_in(k)_y$ is the observed catch of fishery $k$ in year $y$. Is input, line 16 of .dat file. 
 
\end{itemize}

However, when the Pope's approximation is not used, the catch-at-age and predicted catch are estimated as follows:

\begin{equation}
Cat^{k_s}_{y,a}=\dfrac{F^{k_s}_{y,a}}{F^s_{y,a}+M^{s}_{y}}\left(1-S^s_{y,a}\right)N^s_{y,a}
\end{equation}

%\begin{equation}
%Cat(k_s,y)_a=\dfrac{F^{k_s}_{y,a}}{Z^s_{y,a}}\left(1-S^s_{y,a}\right)N^s_{y,a},
%\end{equation}

\begin{equation}
{C_{pred}}^{k_s}_y=\sum_{a=1}^{m}Cat^{k_s}_{y,a} w_{y,a}^{k_s}.
\end{equation}

%\begin{equation}
%pred\_catch(k,y)=\sum_{a=1}^{m}Cat(k,y)_a.wt\_fsh_a(k,y),
%\end{equation}

%where $Z^s_{y,a}=F^s_{y,a}+M^{s}_{y}$ 

\hfill

\textbf{d. Calculation of zero biomass}\\

The zero biomass (also called virgin biomass) is calculated for each regime $1\leq r \leq  nregs$. This estimation is needed to calculate recruitment and is calculated as follows:

% \begin{equation}
%     Bzero(cum\_regs(s)+1)=wt\_mature(s)_1.e^{-M^s_{styr,1}.spmo\_frac}.Rzero(cum\_regs(s)+1)
% \end{equation}
%cambiando Rzero(cum\_regs(s)+1) por R^s_0.
% \begin{equation}
%     Bzero(cum\_regs(s)+1)=wt\_mature^s_1.e^{-M^s_{styr,1}.spmo\_frac}.R^s_0
% \end{equation}

\begin{equation}
    B^{s,1}_0=wt\_{mat}^s_1.e^{-M^s_{y_0,1}.s_f}.R^s_0
  +\sum_{a=2}^{m-1}wt\_{mat}^s_a.e^{-M^s_{y_0,a} s_f}.R^s_0\prod_{l=1}^{a-1}e^{-M^s_{y_0,l}} 
+ wt\_{mat}^s_{m}.e^{-M^s_{y_0,m}.s_f}.\frac{R^s_0}{1-e^{-M^s_{y_0,m}}}.\prod_{l=1}^{m-1}e^{-M^s_{y_0,l}}.
\end{equation}

% \begin{equation}
%     B^{s,r}_0 = Sp\_Biom(s,reg\_shift(s,r-1)-rec\_age)
% \end{equation}
\begin{equation}
    B^{s,r}_0 = SSB^s_{reg\_shift(s,r-1)-a_R}, \ \ \ 2\leq r \leq nreg(s)
\end{equation}

where: 
\begin{itemize}
    \item $n_{reg}(s)$ is the number of regimes of stock number s
    \item %Bzero(cum\_regs(s)+1) es la biomasa virgen en el primer r√©gimen del stock s.
    $B^{s,1}_0$ is the virgin biomass in the first regime belonging to the stock s.
    \item  %Bzero(cum\_regs(s)+r) es la biomasa virgen en el r√©gimen r del stock s.
    $B^{s,r}_0$ is the virgin biomass in regime r belonging to stock s with $2\leq r \leq nreg(s)$.
    \item reg\_shift(s,r-1) is input, line 41 of .ctl file, for each stock s and regime number $r$.
    %\item $a_R$ rec\_age$ is the age at which recruitment is feasible.
\end{itemize}

\hfill

\textbf{e. Stock-Recruitment Parameters}\\

Let $r$ be a given regime number, that is, $1\leq r \leq nregs$.\\
The parameters of the recruitment curve (alpha, beta) are calculated according to the value assigned to SrType.\\

If SrType=1 (Ricker), then
\begin{equation}
alpha(r)=log\left(\dfrac{-4*steepness(irec)}{steepness(irec)-1}\right).
\end{equation}
If SrType=2 (Beverton-holt):
% \begin{equation}
%     alpha(r) = Bzero(r)*\dfrac{1}{Rzero(r)}\dfrac{(1-(steepness(irec)-0.2)}{0.8*steepness(irec)}
% \end{equation}
\begin{equation}
    alpha(r) = B^{s,r}_0*\dfrac{1}{R^{s,r}_0}\dfrac{(1-(steepness(irec)-0.2)}{0.8*steepness(irec)},
\end{equation}
\begin{equation}
    beta(r)=\dfrac{(5*steepness(irec)-1)}{4*steepness(irec)*R^{s,r}_0}.
\end{equation}
If $SrType=4$:
\begin{equation}
    beta(r)=log\left(\dfrac{5*steepness(irec)}{0.8*B^{s,r}_0}\right),
\end{equation}
\begin{equation}
    alpha(r)=log\left(\dfrac{R^{s,r}_0}{B^{s,r}_0}\right)+beta(r)*B^{s,r}_0.
\end{equation}
\begin{itemize}
    % \item Rzero(r) es el reclutamiento en el r√©gimen n√∫mero $r$, donde $1\leq r \leq nregs.$
    \item $R^{s,r}_0$ is the recruitment in regime number $r$ (belonging to stock s), where $1\leq r \leq nregs.$
    \item steepness is a parameter to be estimated.
    \item $irec=rec\_map(stk\_reg\_map(1,r),stk\_reg\_map(2,r))$, where $rec\_map$ is the recruitment matrix, it is input in the line 23 of .ctl file.
    \item $stk\_reg\_map$ is a matrix of dimensions 2xnregs, where $stk\_reg\_map(2,r)$ is the regime number $r_s$, with $1\leq r_s \leq nreg(s)$, corresponding to stock number $s=stk\_reg\_map(1,r)$.
\end{itemize}

\hfill

\textbf{f. Recruitment}\\

%(considerar escribir desde Von Bertalanfy hasta Age composition to length composition antes de numeros a la edad, as√≠ luego de reclutamiento ir√≠a selectividad).\\

Recruitment is calculated for each year $i$, where $y_0\leq i \leq y_N$:

\begin{equation}
    recruits(s,i)=N^s_{i,1}.
%es calculado en la funci√≥n calc_dependent_vars
\end{equation}

Now for the year $i=endyr+1$:
% \begin{equation}
%     recruits(s,endyr+1)=e^{\mu_{R,cum\_regs(s)+yy\_sr(s,endyr+1)}}.
% \end{equation}
\begin{equation}
    recruits(s,endyr+1)=e^{\mu^s_{R,y_N+1}}.
\end{equation}

For the stock-recruitment curve, it depends on the value of SrType. Let be
\begin{equation}
    stock^r_i=\dfrac{i.B^{s,r}_0}{250}, 1\leq i \leq 300.
\end{equation}
(Why is the stock $stock^r_i$ selected in this way?)\\
If SrType=1:
\begin{equation}
SRecruit(stock^r_i,r)=\dfrac{R^{s,r}_0.stock^r_i}{B^{s,r}_0}e^{alpha(r).\left(1-\dfrac{stock^r_i}{B^{s,r}_0}\right)}
\end{equation}
If SrType=2:

\begin{equation}
SRecruit(stock^r_i,r)=\dfrac{stock^r_i}{alpha(r)+beta(r).stock^r_i}
        \end{equation}
If SrType=3:
% \begin{equation}
% SRecruit(stock^r_i,r)=e^{mean\_log\_rec(r)}
% \end{equation}
\begin{equation}
SRecruit(stock^r_i,r)=e^{\mu_{R,r}}
\end{equation}
\begin{itemize}
    \item $\mu_{R,r}$ is the average recruitment in the regime $r$, $1\leq r \leq nregs$.
\end{itemize}
If SrType=4:
\begin{equation}
SRecruit(stock^r_i,r) =  stock^r_i.e^{alpha(r)-stock^r_i.beta(r)}.
\end{equation}
Finally, the points are plotted $(stock^r_i, SRecruit(stock^r_i,r))$ for each regime $1\leq r \leq nregs$.

%%%%%%%%%%%%%%%%%%%%%%%%
%\textbf{Recruitment}
%\textbf{Total catch and catches-at-age}
%\textbf{Exploitable and survey biomasses}
%\textbf{Initial conditions}

%\subsubsection{MSY and relative quantities}

%\subsubsection{The likelihood function}
%\textbf{CPUE relative biomass data}
%\textbf{Survey biomass data}
%\textbf{Catch at age/length}
%\textbf{Age-length keys}
%\textbf{Stock-recruitment function residuals}

%In other section:
%X. Model parameters
%X.1 Estimable parameters
%X.2 Input parameters and other choice for application?
%X.2.1 Age at maturity?
%X.2.2 Weight-at-length





\textbf{Von Bertalanfy}

\begin{equation}
    \mu_{age}(r,1)=L_0(r)
\end{equation}
\begin{equation}
    \mu_{age}(r,i)=Linf(r)(1-e^{-{k\_coeff(r)}})+\mu_{age}(r,i-1)(e^{-k\_{coeff(r)}}).
\end{equation}
 \begin{itemize}
    \item $\mu_{age}(r,i)$ is the mean lenght for each age $i$.
     \item $r$ is a entire number between $1\leq r \leq ngrowth$(maximum of the Growth map matrix values). 
     \item $Linf(r)$ is the maximum lenght.
     \item $k\_coeff(r)$ is the parameter curvature.
     \item $L_0(r)$ is the lenght initial.
     
 \end{itemize}
\textbf{Equation weight at lenght}\\
\begin{equation}
     wt\_age\_vb(r) = lw\_a * \left(\mu_{age}(r)\right)^{lw\_b}
 \end{equation}
 \begin{itemize}
     \item $wt\_age\_vb(r)$ is the weight vector at lenght vector $\mu_{age}(r)$.
     \item $lw\_a$, $lw\_b$ are growth parameters given by  $lw\_a=0.007778994e-3$ and $lw\_b=3.089248476$ in the model.
 \end{itemize}
 \textbf{Maturity equation}\\
 \begin{equation}
    maturity\_vb(r) = \dfrac{1}{1+e^{32.93-1.45*\mu_{age}(r)}}
\end{equation}
\begin{itemize}
    \item $maturity\_vb(r)$ is the proportion of mature species at lenght $\mu_{age}(r)$.
\end{itemize}
\textbf{Age composition to length composition}\\

It uses normal Distribution to model the probability of the random variable $X_a$, 
\begin{equation}
    P(l-0.5\leq X_a\leq l+0.5 ) = P\left(\dfrac{(l-0.5)-\mu_a}{\sigma_a}\leq Z\leq\dfrac{(l+0.5)-\mu_a}{\sigma_a}\right)
\end{equation}
$P(l-0.5\leq X_a\leq l+0.5 )$, is the probability that the number of fish at age $a$ varies in lenght between  $l-0.5$ and $l+0.5$. \\
The right expression is the normalization for $X_a$ because $X_a$ is a random variable with normal distribution, mean $\mu_a$ and  standard deviation $\sigma_a$ where it is calculated from $\sigma_{a}=sdage(r)*\mu_{age}(r)$).\\
Let $P\_age2len(r)$ the matrix such that $Cl(1,nyears,1,nlenght)=C(1,nyears,1,nages)*P\_age2lenght$ where $Cl$ is the matrix composition for lenghts that we want to obtein and $C$ is the matrix composition for ages.
\begin{equation}
    P\_age2len(a,j) = \dfrac{P(l_j-0.5\leq X_a\leq l_j+0.5 )}{\sum_{a}P(l_j-0.5\leq X_a\leq l_j+0.5 )}.
\end{equation}

\begin{itemize}
    \item $P\_age2len$ is a array with dimensions  $(1,ngrowth,1,nages,1,nlength)$.
\end{itemize}
\begin{itemize}
    \item $l_j$ is the lenght $jth$ considered from the vector $len\_bins$ ($lengthbin$ is in the .dat file in
    line 10).
\end{itemize}

\textbf{Survey Predictions}\\
Prediction from the index number k in year y, with y between $1\leq y \leq nyrs\_ind(k)$, where $nyrs\_ind(k)$ is the number of years of observation for survey number $k$ (is located on line 138 of the .dat file).\\
Let us first calculate $q\_ind(k,y)$ for each survey $1\leq k \leq nind$ and each year of observation $1\leq y \leq nyrs\_ind(k)$.
\begin{equation}
    q\_ind(k,y)=e^{log\_q\_ind(k,y)}
\end{equation}
for $1\leq y < yrs\_rw\_q(k,1)-yrs\_ind(k,1)+1$.\\

Let $2\leq i \leq 1+npars\_rw\_q(k)$ and $p_i=yrs\_rw\_q(k,i-1)-yrs\_ind(k,1)+1$:
\begin{equation}
     q\_ind(k,p_i)  = q\_ind(k,p_i-1)*e^{log\_rw\_q\_ind(k,1)},
\end{equation}
\begin{equation}
    q\_ind(k,iyr)  = q\_ind(k,p_i), 
\end{equation}
for $p_i+1\leq iyr \leq nyrs\_ind(k).$
\begin{itemize}
    \item log\_q\_ind is a parameter to be estimated. It is initialized.
    \item $yrs\_rw\_q(k,i-1)$ is input, line 95 of .ctl file.
    %  yrs_ind(k)  = yrs_ind_in(k)(1,nyrs_ind(k)), yrs_ind_in es input linea 141 del dat
    \item $yrs\_ind(k,1)$ is the first year of observation for the survey number $k$.
    \item yrs\_rw\_q is input, line 95 of .ctl file.
    \item yrs\_ind(k) is the set of years of observation of survey number k. 
    \item log\_rw\_q\_ind is a parameter to be estimated.
\end{itemize}

Now we calculate the prediction for the survey number k in the year $1\leq i \leq nyrs\_ind(k)$:
\begin{equation}
    pred\_ind(k,i)=q\_ind(k,i).
\end{equation}
% \begin{equation}
%     \left(\left(\sum_{age \ j}natage_j(istk,iyr).S(istk,iyr)_j^{ind\_month\_frac(k)}sel\_ind_j(k,iyr).wt\_ind_j(k,iyr)\right)\right)^{q\_power\_ind(k)}
% \end{equation}
\begin{equation}
    \left(\left(\sum_{j=1}^mN^{istk}_{iyr,j}.{S^{istk}_{iyr,j}}^{ind\_month\_frac(k)}sel\_ind_j(k,iyr).wt\_ind_j(k,iyr)\right)\right)^{q\_power\_ind(k)},
\end{equation}
with $iyr=yrs\_ind(k,i)$.
\begin{itemize}
\item nind is the number of surveys (or indexes).

    %\item $ind\_month\_frac$ es un vector de dimensiones (1,nind) y se calcula como $ind\_month\_frac(k)=\dfrac{mo\_ind(k)-1}{12}$, donde $mo\_ind(k)$, para cada pesquer√≠a n√∫mero $k$, est√° en la l√≠nea 144 del archivo dat.
    \item $ind\_month\_frac$ is calculated as $ind\_month\_frac(k)=\dfrac{mo\_ind(k)-1}{12}$, where $mo\_ind(k)$ (for each fishery number $k$) is on line 144 of the .dat file.
    \item $istk=sel\_map(1,k+nfsh)$ 
i.e., it is the stock number corresponding to the survey number $k$.
    %\item $iyr=yrs\_ind(k,i)$, √≠ndice n√∫mero $k$ y a√±o n√∫mero $i$.
    \item $sel\_ind_j(k,iyr)$ 
is the selectivity index of survey number k in year iyr at age j.
    \item $wt\_ind_j(k,iyr)$ 
weight composition at age j in year iyr of survey number $k$. It is input, line 171 of the .dat file.
    \end{itemize}
We calculate the expected age composition from the index (eac\_ind).\\
Let $i$ be the index of the year for which age data are available for survey $k$, that is, $1\leq i \leq nyrs\_ind\_age(k)$:
\begin{itemize}
        \item [i.] If $use\_age\_err$=TRUE then: 
    \begin{equation}
        eac\_ind(k,i)_j=age\_err*\dfrac{tmp\_n_j}{\sum_{j=1}^mtmp\_n_j}
    \end{equation}
        \item [ii.] If $use\_age\_err$=FALSE :
        \begin{equation}eac\_ind(k,i)_j=\dfrac{tmp\_n_j}{\sum_{j=1}^mtmp\_n_j}
    \end{equation}
%     donde \begin{equation}
%     tmp\_n_j= S_j(istk,iyr)^{ind\_month\_frac(k)}sel\_ind(k,iyr)_j.natage(istk,iyr)_j
% \end{equation}.
where \begin{equation}
    tmp\_n_j= {S^{istk}_{iyr,j}}^{ind\_month\_frac(k)}sel\_ind(k,iyr)_j.N^{istk}_{iyr,j},
% \end{equation}.
\end{equation}
 $iyr=yrs\_ind\_age(k,i)$ y $1\leq j\leq m$.
    \end{itemize}

Now, the expected size composition (elc\_ind) is calculated from the index. Let $i$ be the index of the year for which size data are available for survey $k$, i.e.   $1\leq i \leq nyrs\_ind\_length(k)$:
\begin{equation}
    elc\_ind(k,i)_l=\sum_{j=1}^m\dfrac{tmp\_n_j}{\sum_{j=1}^mtmp\_n_j}*P\_age2len(igrowth,j,l).
\end{equation}
donde
% \begin{equation}
%     tmp\_n_j= S_j(istk,iyr)^{ind\_month\_frac(k)}sel\_ind(k,iyr)_j.natage(istk,iyr)_j
% \end{equation}
\begin{equation}
    tmp\_n_j= {S^{istk}_{iyr,j}}^{ind\_month\_frac(k)}sel\_ind(k,iyr)_j.N^{istk}_{iyr,j},
\end{equation}
y
\begin{equation}
    igrowth=growth\_map(istk,yy\_sr(istk,iyr)).    
\end{equation}

\begin{itemize}
    %\item tmp\_n es un vector de dimensiones (1,nages).
    \item growth\_map growth matrix, is input. Line 43 of file .ctl.
    \item P\_age2len(igrowth,j,l)is the element of the respective matrix at age $j$ and size $l$.
    \item iyr=$yrs\_ind\_lenght(k,i)$, year of index i for which survey $k$ length data are available.
    
    %a√±o de √≠ndice i para el cu√°l se tienen datos de longitud del survey $k$.
    \end{itemize}
    
%     Then the expected lenght composition from index elc\_ind is calculate from:
%     \begin{equation}
%     elc\_ind(k,i)=tmp\_n*P\_age2len(igrowth).
% \end{equation}

Index predicted for the next year of the survey $k$ is calculated from:
\begin{equation}
    pred\_ind\_nextyr(k)=q\_ind(k,nyrs\_ind(k)) * 
\end{equation}
\begin{equation*}
    \left( SRecruit. {S^{istk}_{y_N,i}}^{ind\_month\_frac(k)} sel\_ind_i(k,y_N)  wt\_ind_i(k,y_N).\right.
\end{equation*}
% \begin{equation}
% \left(\sum_inatagetmp_iS(istk,endyr)_i^{ind\_month\_frac(k)} sel\_ind_i(k,endyr)  wt\_ind_i(k,endyr)\right)^{q\_power\_ind(k)}.
% \end{equation}

\begin{equation}
+\sum_{i=2}^{m-1}S^{istk}_{y_N,i-1}N^{istk}_{y_N,i-1}{S^{istk}_{y_N,i}}^{ind\_month\_frac(k)} sel\_ind_i(k,y_N)  wt\_ind_i(k,y_N)+
\end{equation}
\begin{equation*}
  \left. (S^{istk}_{y_N,m-1}.N^{istk}_{y_N,m-1}+N^{istk}_{y_N,m}S^{istk}_{y_N,m}){S^{istk}_{y_N,i}}^{ind\_month\_frac(k)} sel\_ind_i(k,y_N)  wt\_ind_i(k,y_N) \right)^{q\_power\_ind(k)}.
\end{equation*}


\textbf{Fishery Predictions}\\
Calculate the expected age composition (eac\_fsh) from fisheries. Let $y$ a positive integer with $1\leq y \leq nyrs\_fsh\_length(k)$:
%catage_a(k,i):Cat_a(k,y)
\begin{itemize}
%     \item [i.] If $use\_age\_err=TRUE$:
%     \begin{equation}
%     eac\_fsh(k,i)=age\_err.\dfrac{catage(k,yrs\_fsh\_age(k,i))}{sum(catage(k,yrs\_fsh\_age(k,i)))}
% \end{equation}
\item [i.] If $use\_age\_err=TRUE$:
    \begin{equation}
    eac\_fsh_a(k,y)=age\_err.\dfrac{Cat_a(k,yrs\_fsh\_age(k,y))}{\displaystyle\sum_{a=1}^mCat_a(k,yrs\_fsh\_age(k,y))}
\end{equation}
% \item [ii.] If $use\_age\_err=FALSE$:
% \begin{equation}
%     eac\_fsh(k,i)=\dfrac{catage(k,yrs\_fsh\_age(k,i))}{sum(catage(k,yrs\_fsh\_age(k,i)))}.
% \end{equation}
\item [ii.] If $use\_age\_err=FALSE$:
\begin{equation}
    eac\_fsh_a(k,y)=\dfrac{Cat_a(k,yrs\_fsh\_age(k,y))}{\displaystyle\sum_{a=1}^mCat_a(k,yrs\_fsh\_age(k,y)))},
\end{equation}
\end{itemize}
for $1\leq a \leq m$.
After calculate eac\_fsh:
\begin{equation}
    eac\_fsh_a(k,y)=\dfrac{eac\_fsh_a(k,y)}{\displaystyle\sum_{a=1}^meac\_fsh_a(k,y)}, \ 1\leq a \leq m.
\end{equation}
Now for the lenghts. Calculate the expected length composition (elc\_fsh) for fisheries from: 
% \begin{equation}
% elc\_fsh(k,i)=catage(k,yrs\_fsh\_length(k,i))*P\_age2len(igrowth^{istk}_{iyr}),
% \end{equation}
\begin{equation}
elc\_fsh_a(k,y)=Cat_a(k,yrs\_fsh\_length(k,y)).P\_age2len(igrowth^{istk}_{iyr}),
\end{equation}
finally
\begin{equation}
elc\_fsh_a(k,y)=\dfrac{elc\_fsh_a(k,y)}{\displaystyle\sum_{l=1}^melc\_fsh_l(k,y)},
\end{equation}
for $1\leq y \leq nyrs\_fsh\_length(k)$.\\
\begin{itemize}
    \item $igrowth^{istk}_{iyr}=growth\_map(istk,yy\_sr(istk,iyr))$, where $istk$ is the stock number corresponding to fishery number $k$, $iyr$ is the index year i for which fishery k has data available and $growth\_map$ is input on line 43 of .ctl file.
\end{itemize}

\textbf{Selectivity}\\
- The treatment of selectivity patterns and how they are shared among fisheries and indices need to be specified. Also the selectivity for each fleet, and depending on the model configuration, some growth functions were employed inside the model to convert model-predicted age compositions to length compositions, in order to fit the model to the length composition data.\\

Let $k$ the number of fishery and $y$ is the year between $y_0$ and $y_N$.
Depending on which values $fsh\_sel\_opt$ takes in order to calculate the logarithm of fishery selectivity $log\_sel\_fsh$:
\begin{itemize}
\item $fsh\_sel\_opt=1:$\\
% \begin{equation}
%        log\_sel\_fsh(k,i)(1,nselages\_fsh(k))=sel\_coffs\_tmp
%    \end{equation}
%    \begin{equation}
%        log\_sel\_fsh(k,i)(nselages\_fsh(k),nages)=log\_sel\_fsh(k,i,nselages\_fsh(k))
%    \end{equation}
%    \begin{equation}
%        log\_sel\_fsh(k,i)-=log(mean(e^{log\_sel\_fsh(k,i)}))
%    \end{equation}
Se asume $y_0$ como el primer a√±o de cambio de selectividad, es decir $yrs\_sel\_ch\_fsh(k,1)=y_0$, luego se toman en cuenta el resto de a√±os de cambio de selectividad $yrs\_sel\_ch\_fsh(k,y)$, para $2\leq y \leq n\_sel\_ch\_fsh(k)$, introducidos en el archivo .ctl en la l√≠nea 116.
\begin{itemize}
    \item $yrs\_sel\_ch\_fsh(k)$ contiene los a√±os de cambio de selectividad para cada pesquer√≠a n√∫mero k.
    \item $n\_sel\_ch\_fsh(k)$ es el n√∫mero de cambios de selectividad para la pesquer√≠a $k$.
    
\end{itemize}

%Tambi√©n sel\_change\_in\_fsh(k,styr)=1. 
% Se calcula los valores para $log\_selcoffs\_fsh\_in$( logaritmo de los coeficientes de selectividad (?) ) desde el primer cambio de selectividad hasta el cambio n√∫mero $n\_sel\_ch\_fsh(k)$ para la respectiva pesquer√≠a n√∫mero $k$:
% \begin{equation}
%     log\_selcoffs\_fsh\_in(k,jj)_l=\log\left(\dfrac{sel\_fsh\_tmp_l+1e-7}{\dfrac{1}{nselages\_in\_fsh(k)}\displaystyle\sum_{p=1}^{nselages\_in\_fsh(k)}(sel\_fsh\_tmp_p+1e-7)}\right),
% \end{equation}
% for $1\leq l \leq nselages\_fsh(k)$ y $1\leq jj \leq n\_sel\_ch\_fsh(k)$.
% %Ahora calculamos $log\_selcoffs\_fsh\_in(k,jj)$, que es el logaritmo de los coeficientes de selectividad para la pesquer√≠a n√∫mero $k$ y el cambio de selectividad n√∫mero $jj$, donde $2\leq jj \leq nsel\_ch\_fsh(k)$(se utilizar√≠a esto si cambiara sel\_fsh\_tmp_j para 1\leq j \ƒºeq nselages\_in\_fsh(k) pero no cambia solo cambia para nselages\_in\_fsh +1 \leq j \leq nages) :

% %\begin{equation}
% %    log\_selcoffs\_fsh\_in(k,jj)_l = 
% %\end{equation}

% \begin{itemize}
%     \item $sel\_fsh\_tmp_j$ es el coeficiente de cambio de selelctividad para cada edad $j$, con $1\leq j \leq nages$. Es input, l√≠nea 119 del archivo .ctl.
%     \item Adem√°s para esta opci√≥n (fsh\_sel\_opt(1)), se asigna a la fase de coeficientes de selectividad para la pesquer√≠a $k$ ($phase\_selcoff\_fsh(k)$):
%     \begin{equation}
%         phase\_selcoff\_fsh(k)=phase\_sel\_fsh(k),
%     \end{equation}
%     \end{itemize}

%     donde $phase\_sel\_fsh(k)$ es la fase de minimizaci√≥n(del par√°metro log\_selcoffs\_fsh?), input dada en la l√≠nea 111 del ctl, as√≠mismo si este es negativo entonces se calculan los valores de inicializaci√≥n para $log\_selcoffs\_fsh$ de la siguiente manera:
%     \begin{equation}
%         log\_selcoffs\_fsh(k,jj)\_l = log\_selcoffs\_fsh\_in_l
%     \end{equation}
% for $1\leq l \leq nselages\_in\_fsh(k)$ and $1\leq jj \leq n\_sel\_ch\_fsh(k)$.\\

Calculamos la selectividad de la pesquer√≠a $k$ en el a√±o $y$. Sea $A$ el conjunto de a√±os de cambio de selectividad ( i.e $A= yrs\_sel\_ch\_fsh(k)$, adem√°s se incluye $y_0$) y $p_k\in A$ ($p_{k+1}$ vendr√≠a ser el siguiente a√±o de cambio de selectividad), alg√∫n elemento de $A$:
 \begin{equation}
        log\_sel\_fsh(k,y)_a=log\_selcoffs\_fsh(k,jj_{p_k})_a-log\left(\dfrac{1}{m}.\left(\sum_{i=1}^{nselages\_fsh(k)}e^{log\_selcoffs\_fsh(k,jj_{p_k})_i}+\right.\right.
    \end{equation}
    \begin{equation*}
       \left. \left.\sum_{i=nselages\_fsh(k)+1}^{m}e^{log\_selcoffs\_fsh(k,jj_{p_k})_{nselages\_fsh(k)}}\right)\right), 
    \end{equation*}
   for $\ 1\leq a \leq nselages\_fsh(k)$.\\
   
  Now for the remaining ages:
    \begin{equation}
         log\_sel\_fsh(k,y)_a=log\_selcoffs\_fsh(k,jj_{p_k})_{nselages\_fsh(k)}-log\left(\dfrac{1}{nages}.\left(\sum_{i=1}^{nselages\_fsh(k)}e^{log\_selcoffs\_fsh(k,jj_{p_k})_i}+\right.\right.
    \end{equation}
 \begin{equation*}
       \left. \left.\sum_{i=nselages\_fsh(k)+1}^{m}e^{log\_selcoffs\_fsh(k,jj_{p_k})_{nselages\_fsh(k)}}\right)\right), 
    \end{equation*}
    for $nselages\_fsh(k)\leq a \leq m$ where $p_k\leq y < p_{k+1}$.
    \begin{itemize}
        \item $jj_{p_k}$ es el n√∫mero de cambio que le corresponde al a√±o de cambio $p_k\in A$.
        \item $log\_selcoffs\_fsh$ es par√°metro a estimar.
    \end{itemize}














    
   
   % \begin{equation}
   %     log\_sel\_fsh(k,styr)_j=sel\_coffs\_tmp_j-log\left(\dfrac{1}{nages}*%%\left(\sum_{l=1}^{nselages\_fsh(k)}e^{sel\_coffs\_tmp_l}+\right.\right.
  %  \end{equation}
   % \begin{equation*}
    %   \left. \left.\sum_{l=nselages\_fsh(k)+1}^{nages}e^{sel\_coffs\_tmp_{nselages\_fsh(k)}}\right)\right), \ 1\leq j \leq nselages\_fsh(k).
    %\end{equation*}
    %\begin{equation}
    %    sel\_coffs\_tmp_j=\log\left(\dfrac{sel\_fsh\_tmp_j+1e-7}{mean(sel\_fsh\_tmp(1,nselages\_in\_fsh(k))+1e-7)}\right)
    %\end{equation}
   % \begin{itemize}
   %     \item $sel\_fsh\_tmp$ is input line 119 of ctl (?).
   % \end{itemize}
   % Now for $nselages\_fsh(k)\leq j \leq nages$:
   % \begin{equation}
   %     log\_sel\_fsh(k,styr)=log\_sel\_fsh(k,styr)_{nselgaes\_fsh(k)}.
   % \end{equation}
   % Now calculate $log\_sel\_fsh$ para el resto de a√±os de cambio de selectividad. La selectividad es lo mismo para los a√±os que siguen a menos que haya un cambio (a√±o de cambio de selectividad, estos a√±os est√°n ubicados en la l√≠nea 116 del ctl).
    %\begin{equation}
    %    sel\_fsh\_tmp_j=sel\_fsh\_tmp(nselages\_in\_fsh(k)), \ nselages\_in\_fsh(k)+1\leq j \leq nages.
    %    \end{equation}
    
\item $fsh\_sel\_opt=2:$ 
Sea $p_k$ como antes, 
\begin{equation}
            log\_sel\_fsh(k,y)_a=-log( 1.0 + e^{(-1.sel\_slope\_fsh(k,jj_{p_k}) . ( age\_vector_a - sel50\_fsh(k,jj_{p_k})) )})
        \end{equation}
        for $1\leq a \leq nselages\_fsh(k)$.
        \begin{equation}
            log\_sel\_fsh(k,y)_a=log\_sel\_fsh(k,y)_{nselages\_fsh(k))},
        \end{equation}
        for $nselages\_fsh(k) \leq a \leq m$ where $p_k\leq y < p_{k+1}$.
        \begin{itemize}
            \item $sel\_slope\_fsh(k,jj_{p_k}) = e^{logsel\_slope\_fsh(k,jj_{p_k})}$.
            \item logsel\_slope\_fsh and sel50\_fsh are parameters to be estimated.
        \end{itemize}
\item $fsh\_sel\_opt=3:$ Sea $p_k$ como antes,
 \begin{equation}
        log\_sel\_fsh(k,y)_a     = \left( -log(1.0 + e^{(\frac{-2.9444389792}{du}.( age\_vector_a - bu) )}) \right.
    \end{equation}
    \begin{equation*}
         \left.+log\left(1 - \dfrac{1}{1 + e^{(\frac{-2.9444389792}{dd} ( age\_vector_a - bd))}} \right) \right)+0.102586589 
    \end{equation*}
      for $1\leq a \leq nselages\_fsh(k)$.\\
      Now for the remaining ages:
    \begin{equation}
        log\_sel\_fsh(k,y)_a = log\_sel\_fsh(k,y)_{nselages\_fsh(k)},
    \end{equation}
    for $nselages\_fsh(k)\leq a \leq m$.
    \begin{itemize}
        \item %$bu = sel\_p1\_fsh(k,jj_{p_k})$
        $bu = e^{logsel\_p1\_fsh(k,jj_{p_k})}$
        \item 
        $du = e^{logsel\_p2\_fsh(k,jj_{p_k})}$
        %$du = sel\_p2\_fsh(k,jj_{p_k})$
        \item
        $dd = e^{logsel\_p3\_fsh(k,jj_{p_k})}$
        %$dd = sel\_p3\_fsh(k,jj_{p_k})$
        \item $bd = bu + du + dd$.
        \item $logsel\_p1\_fsh$, $logsel\_p2\_fsh$ and $logsel\_p3\_fsh$ are parameters to be estimated.
    \end{itemize}
    
    \end{itemize}

For the surveys:\\
\begin{itemize}

\item $ind\_sel\_opt=1:$
Calculamos la selectividad del crucero $k$ en el a√±o $y$. Sea $B$ el conjunto de a√±os de cambio de selectividad ( i.e $B= yrs\_sel\_ch\_ind(k)$, adem√°s se incluye $y_0$) y $p_k\in A$, alg√∫n elemento de $B$:
\begin{equation}
    sel\_tmp_{y,a} = log\_selcoffs\_ind(k,jj_{p_k})_a
\end{equation}
for $1\leq a \leq nselages\_ind(k)$.
Now for remaining ages
\begin{equation}
    sel\_tmp_{y,a}= log\_selcoffs\_ind(k,jj_{p_k})_{nselages\_ind(k)},
\end{equation}
for $nselages\_ind(k)\leq a \leq m$. \\

Now we calculate $log\_sel\_ind$
     \begin{equation}
        log\_sel\_ind(k,y)_a=sel\_tmp_{y,a}-log\left(\dfrac{1}{q\_age\_max(k)-q\_age\_min(k)+1}\sum_{i=q\_age\_min(k)}^{q\_age\_max(k)}sel\_tmp_{y,i}\right)
    \end{equation}
    for $1\leq a \leq m$ and $p_k\leq y < p_{k+1}$.\\ 
\begin{itemize}    
    \item $jj_{p_k}$ es el n√∫mero de cambio que le corresponde al a√±o de cambio $p_k\in B$.
    \item $log\_selcoffs\_ind$ es par√°metro a estimar.
\end{itemize}

    
    \item $ind\_sel\_opt=2:$
    Sea $p_k$ como antes, 
\begin{equation}
            log\_sel\_ind(k,y)_a = - log( 1.0 + e^{(-sel\_slope\_ind(k,jj_{p_k}) . ( age\_vector_a - sel50\_ind(k,jj_{p_k})) )}).
        \end{equation}
        for $1\leq a \leq m
$ where $p_k\leq y < p_{k+1}$.
        \begin{itemize}
            \item $sel\_slope\_ind(k,jj_{p_k}) = e^{logsel\_slope\_ind(k,jj_{p_k})}$.
            \item logsel\_slope\_ind and sel50\_ind are parameters to be estimated.
        \end{itemize}

    \item $ind\_sel\_opt=3:$
     \begin{equation}
        log\_sel\_ind(k,y)_a     = ( -log(1.0 + e^{(\frac{-2.9444389792}{p1} . ( age\_vector_a - i1) )}) 
\end{equation}
    \begin{equation}
          +log\left(1 - \frac{1}{(1 + e^{(\frac{-2.9444389792}{p3} . ( age\_vector_a - i2))})} ) \right)+0.102586589 
    \end{equation}
for $1\leq a \leq nselages\_ind(k).$ \\

    Now for remaining ages
    \begin{equation}
         log\_sel\_ind(k,y)_a = log\_sel\_ind(k,y)_{nselages\_ind(k)},
    \end{equation}
    for $nselages\_ind(k)\leq a \leq m$ where $p_k\leq y < p_{k+1}$.
\begin{itemize}
    \item $p1 = e^{logsel\_p1\_ind(k,jj_{p_k})}$
    \item $p2 = sel\_p2\_ind(k,jj_{p_k})$
    \item $p3 = e^{logsel\_p3\_ind(k,jj_{p_k})}$
    \item $i1 = p1 + p2$
    \item $i2 = p1 + i1 + p3$
    \item logsel\_p1\_ind, sel\_p2\_ind y logsel\_p3\_ind are parameters to be estimated.
\end{itemize}

    
\end{itemize}
Finally we get the selectivites from:
\begin{equation}
    sel\_fsh=e^{log\_sel\_fsh}
\end{equation}
\begin{equation}
    sel\_ind=e^{log\_sel\_ind}.
\end{equation}

- The equilibrium-based reference points are calculated within the JJM model. The model estimates values of Maximum Sustainable Yield (MSY) and the Fishing mortality expected to produce maximum sustainable yield (\(F_{MSY}\)) using a Newton-Raphson minimization routine that finds the value of fishing mortality, given the terminal year relative catches (and selectivities-at-age) by fleet,  and the terminal year weights-at-ages for each fleet, that maximizes catch. Since weights-at-age and effective selectivity change each year, these values can vary. MSY is thus defined as the maximum amount of catch that allows the remaining stock to generate sufficient recruitment to maintain the population at the same level. Besides (\(B_{MSY}\)) is taken as the long-term average of biomass fished under MSY.

%To be included in model input parameters
Between 2013 and 2021, a provisional \(B_{MSY}\) level of 5.5 millions tons was applied. 
An interim management reference point for \(B_{MSY}\) was revised to a ten-year average of the model-estimated (\(B_{MSY}\)). 
A limit reference point \(B_{LIM}\) (where B refers to spawning biomass) was defined as the spawning biomass level below which recruitment would likely be impaired. As such, there should be no fishing when the current spawning biomass is estimated to be below \(B_{LIM}\).
For the jack mackerel, \(B_{LIM}\) was computed from the lowest ratio of historical spawning biomass relative to the most recently estimated unfished spawning biomass (e.g. as the 8\% of the unfished spawning biomass).\\

%\textbf{Mortality}\\
%If popes=false:
%Let the number of fishery $k$ and $i$ the year of observation between $styr$ and $endyr$.
%\begin{equation}
%    F(k,i)=e^{fmort(k,i)}*sel\_fsh(k,i)
%\end{equation}
%\begin{equation}
%    Z(sel\_map(1,k),i)=M(sel\_map(1,k),i)+F(k,i)
%\end{equation}
%\begin{equation}
%    S=e^{-Z}
%\end{equation}
%\begin{itemize}
    %\item Fmort:matrix Fmort(1,nstk,styr,endyr). Annual total Fmort.
%    \item init\_bounded\_matrix fmort(1,nfsh,styr,endyr,-15,15.,phase\_fmort)
%    \item sel\_map:mapa de selectividad
%    \item sel\_fsh: selectividad de la pesquer√≠a.
%\end{itemize}








In the last phase, the model calculate the Replacement Yield.\\

\textbf{Replacement Yield}\\
It is the volume by weight that can be removed from a fish stock without increasing or decreasing the biomass of the stock.
For calculate the Replacement Yield for each stock  number $s$ use Newton method for 4 iterations to find the root of 
\begin{equation}
    dssb   = \dfrac{ssb2 - ssb3}{df}, \ \text{with} \  df=1.e-3.
\end{equation}

The iteration is on
% \begin{equation}
%     F_{i+1}=F_{i}-\dfrac{dssb}{dssbp}, \ 0\leq  i \leq 3,
% \end{equation}
\begin{equation}
    F_{1}^s\leftarrow F_{1}^s-\dfrac{dssb}{dssbp}, \ \text{with initial $F_{1}^s=0.1$}.
\end{equation}
Other variables are
\begin{equation}
    F_2^s \leftarrow F_1^s+df*0.5,
\end{equation}
\begin{equation}
    F_3^s \leftarrow F_2^s -df.
\end{equation}

Here $dssp$ is the second derivative of $dssb$:
\begin{equation}
    dssbp  = \dfrac{(ssb2 + ssb3 - 2.*ssb1)}{(.25*df*df)},
\end{equation}
where
\begin{equation}
    ssb1=-1000.\left(log\left(\dfrac{repl\_ssb(F_1^s,s)}{SB^s_{y_N}}\right)\right)^2,
\end{equation}
\begin{equation}
    ssb2=-1000.\left(log\left(\dfrac{repl\_ssb(F_2^s,s)}{SB^s_{y_N}}\right)\right)^2,
\end{equation}
and
\begin{equation}
    ssb3=-1000.\left(log\left(\dfrac{repl\_ssb(F_3^s,s)}{SB^s_{y_N}}\right)\right)^2,
\end{equation}
The numerical solution ($F_1^s$) is the  FMSY for each stock s.\\
Finally:
\begin{equation}
    repl\_F(s) = F1^s,
\end{equation}
\begin{equation}
    repl\_SSB(s) = repl\_ssb(F1^s,s).
\end{equation}
\begin{itemize}
    \item $repl\_ssb(F,s)$ is a function calculated for each F and each stock s. (See the next section).
    \item $repl\_F(s)$ is the FMSY for each stock s.
    \item $repl\_SSB(s)$ is the yield for each stock s.
\end{itemize}

In addition, this section also calculates:
\begin{equation}
    sumF(s)=\sum_{k_s}\sum_{l=1}^m F^{k_s}_{y_N,l}, \  \text{with} \ 1\leq s \leq nstk,
\end{equation}
where the $k_s$ are the numbers of fisheries belonging to stock number s, and
\begin{equation}
    Fratio(k)=\dfrac{\sum_{l=1}^mF^k_{y_N,l}}{sumF(s_k)}, \  \text{with} \ 1\leq k  \leq nfsh,
\end{equation}
where $s_k$ is the stock number where fishery number k belongs to.

\textbf{Function repl\_ssb(F, s):}\\
It is calculated from:

\begin{equation}
    repl\_ssb(F,s)=\sum_{a=1}^m ntmp_a. Stmp^{spmo\_frac}_a.wt\_mature^s_a,
\end{equation}
where (ver)
\begin{equation}
    Ztmp_a=M^s_{y_N}+\sum_{k_s}F.Fratio(k_s), \ \text{Fratio as defined in eq. 108},
\end{equation}
\begin{equation}
    Stmp_a=e^{-Ztmp_a}, \ \text{with} \ 1\leq a \leq m,
\end{equation}
and
\begin{equation}
    ntmp_1 = \dfrac{\displaystyle\sum_{i=styr\_rec}^{y_N} {mod\_rec}(s,i)}{{y_N}-r_0+1},
\end{equation}
\begin{equation}
    ntmp_a=Stmp_{a-1}.N^s_{y_N+1,{a-1}}, \ 2\leq a\leq m-1,
\end{equation}
\begin{equation}
    ntmp_{m}=Stmp_{m-1}.N^s_{y_N+1,m-1}+N^s_{y_N+1,m}.Stmp_{m}.
\end{equation}
\begin{itemize}
    \item $mod\_rec(s,i)$ is the recruitment as estimated by model. It is calculated, from year $styr\_rec$ to year $y_N$, for each stock $s$ as
     \begin{equation}
        mod\_rec(s,i)=e^{\epsilon^s_i+\mu^s_{R,i}}, \ r_0\leq i \leq y_0-1,
    \end{equation}
    \begin{equation}
        mod\_rec(s,y_0)=N^s_{y_0,1},
    \end{equation}
    \begin{equation}
        mod\_rec(s,i+1)=N^s_{i+1,1}, \ y_0\leq i \leq y_N-1.
    \end{equation}
   
    % where
    % \begin{equation}
    %     natagetmp^s_{i,1}=e^{\epsilon^s_i+\mu^s_{R,i}}, \ r_0\leq i \leq y_0.
    % \end{equation}
    %mfexp(rec_dev(s,i) + mean_log_rec(cum_regs(s)+yy_sr(s,i)))=e^{\epsilon^s_i+\mu^s_{R,i}}.
\end{itemize}
In this section is also calculated
\begin{equation}
    repl\_yld(s)=\sum_{a=1}^m Ctmp,
\end{equation}
where
\begin{equation}
    Ctmp_a=\sum_{k_s} wt\_fsh^{k_s}_{y_N,a}\dfrac{F.Fratio(k_s)}{Ztmp_a}(1-Stmp_a).ntmp_a, \ 1\leq a \leq m.
\end{equation}

\textbf{Function yld (Fratio, Ftmp, s)}\\

This function returns msy\_stuff(i) for $i$ positive integer with $1\leq i \leq 5$. \\
The msy\_stuff(5) ( BmsyTot) is calculated from
\begin{equation}
    msy\_stuff(5)=\left(\sum_{a=1}^m Ntmp_a.wt\_pop^s_a\right).msy\_stuff(3),
\end{equation}
where
\begin{equation}
    Ztmp_a=M^s_{y_0}+\sum_{k_s}Fratio(k)*Ftmp*sel\_fsh_a(k_s,y_N), \ 1\leq a \leq m, 
\end{equation}
where $k_s$ are the indexes of the fisheries belonging to the stock s, then let
\begin{equation}
    survtmp_a=e^{-Ztmp_a}, \ 1\leq a \leq m,
\end{equation}
finally we obtain
\begin{equation}
    Ntmp_1=1,
\end{equation}
\begin{equation}
    Ntmp_{j+1}=Ntmp_j.survtmp_j, \ 1\leq j \leq m-2,
\end{equation}
\begin{equation}
    Ntmp_m=\dfrac{Ntmp_{m-1}.survtmp_{m-1}}{1-survtmp_m}.
\end{equation}
The msy\_stuff(4) (SPR) is calculated from
\begin{equation}
    msy\_stuff(4)=\dfrac{phi}{phizero^s_{y_N}}
\end{equation}
where 
\begin{equation}
    phi= \sum_{a=1}^m Ntmp_a(survtmp_a)^{spmo\_frac}.wt\_mature^s_a,
\end{equation}
and 
\begin{equation}
    phizero(r)=\dfrac{Bzero(r)}{Rzero(r)}, \ 1\leq r \leq nregs.
\end{equation}
The msy\_stuff(3) (Eq Recruitment) is calculated from
\begin{equation}
    msy\_stuff(3)  = Requil(phi,y_N,s),
\end{equation}
where $Requil(phi,y_N,s)$ is a function that depends on the choice of SrType, that is, let $ireg=cum\_regs(s)+yy\_sr(s,y_N)$:\\
If $SrType=1$
\begin{equation}
    Requil(phi,y_N,s)=Bzero(ireg) * \dfrac{(alpha(ireg) + log(phi) - log(phizero(ireg)) )}  {(alpha(ireg)*phi)}.
\end{equation}
If $SrType=2$
\begin{equation}
Requil(phi,y_N,s)=\dfrac{(phi-alpha(ireg))}{(beta(ireg)*phi)}.
\end{equation}
If $SrType=3$
\begin{equation}
    Requil(phi,y_N,s)=e^{\mu^s_{R,y_N}}.
\end{equation}
If $SrType=4$
\begin{equation}
    Requil(phi,y_N,s)=\dfrac{(log(phi)+alpha(ireg))}{(beta(ireg)*phi)}.
\end{equation}
\\
The msy\_stuff(2) (MSY) is calculated from
\begin{equation}
    msy\_stuff(2)=\left(\sum_{k_s}\sum_{a=1}^m wt\_fsh^{k_s}_{y_N,a}Ntmp_a.Fratio(k_s).Ftmp.sel\_fsh_a(k_s,y_N)\dfrac{1-survtmp_a}{Ztmp_a}\right).msy\_stuff(3).
\end{equation}
Note that the first sum of equation 130 is about the indexes of fisheries belonging to stock s.\\
Finally, the msy\_stuff(1) (Bmsy) is calculated from
\begin{equation}
    msy\_stuff(1)=phi.(msy\_stuff(3)).
\end{equation}
\\
%calc_dependent_vars
\textbf{Get MSY}\\

Calculate MSY, FMSY, MSY, Bmsy for the last year of observation ($y_N$). 
Use Newton Raphson method with 4 iterations to find the root of
\begin{equation}
        dyld=\dfrac{yld2-yld3}{df}
    \end{equation}
    for each stock.
    Let 
    \begin{equation}
        F_2^s \leftarrow F_1^s + df*0.5, \ \text{with}  \ df=1.e-05,
    \end{equation}
    \begin{equation}
        F_3^s\leftarrow F_2^s-df.
    \end{equation}
Iteration on
\begin{equation}
    F_1^s\leftarrow F_1^s-\dfrac{dyld}{dyldp}, \ \text{with initial } \ F_1^s=0.8*natmortprior(mort\_map(s,1))
\end{equation}
    here $dyldp$ is the derivative expression of $dyld$, that is
\begin{equation}
    dyldp=\dfrac{yld2+yld3 - 2.yld1}{0.25*df*df}
\end{equation}
where
\begin{equation}
    yld1=yield(Fratio,F_1^s,s),
\end{equation}
\begin{equation}
    yld2=yield(Fratio,F2^s,s),
\end{equation}
\begin{equation}
    yld3=yield(Fratio.F3^s,s).
\end{equation}
The function $yield(Fratio,F^s,s)$ is calculated in the next section.\\

After obtaining the numerical solution $F1^s$ (FMSY) for each stock $s$, this uses the function $yld(Fratio, F1,s)$ (from previous section) in the last year ($y_N$):
\begin{equation}
    Fmsy(s)=F_1,
\end{equation}
\begin{equation}
    Rtmp(s)=msy\_stuff(3),
\end{equation}
\begin{equation}
    MSY(s)=msy\_stuff(2),
\end{equation}
\begin{equation}
    Bmsy(s)=msy\_stuff(1),
\end{equation}
\begin{equation}
    MSYL(s)=\dfrac{msy\_stuff(1)}{Bzero^s_{y_N}},
\end{equation}
%Bzero^s_{y_N}=Bzero(cum_regs(s)+yy_sr(s,endyr)).
exploitation fraction relative to total biomass:
\begin{equation}
    lnFmsy(s)   = log\left(\dfrac{MSY(s)}{msy\_stuff(5)}\right),
\end{equation}
and
\begin{equation}
    Bcur\_Bmsy(s)= \dfrac{SB^s_{y_N}}{Bmsy(s)}.
\end{equation}
It is also calculated
\begin{equation}
    FFtmp_s=\sum_{k_s}\left(\dfrac{1}{m}\sum_{a=1}^mF^{k_s}_{y_N,a}\right),
\end{equation}
\begin{equation}
    Fcur\_Fmsy(s)= \dfrac{FFtmp}{Fmsy(s)},
\end{equation}
and finally
\begin{equation}
    Rmsy(s)     = Rtmp(s).
\end{equation}
\textbf{Function yield(Fratio, $F^s$,s)} \\

Let
\begin{equation}
    Ztmp_a=M^s_{y_0}+\sum_{k_s}Fratio(k)*Ftmp*sel\_fsh_a(k_s,y_N), \ 1\leq a \leq m, 
\end{equation}
where $k_s$ are the indexes of the fisheries belonging to the stock s, then let
\begin{equation}
    survtmp_a=e^{-Ztmp_a}, \ 1\leq a \leq m,
\end{equation}
and
\begin{equation}
    Ntmp_1=1,
\end{equation}
\begin{equation}
    Ntmp_{j+1}=Ntmp_j.survtmp_j, \ 1\leq j \leq m-2,
\end{equation}
\begin{equation}
    Ntmp_m=\dfrac{Ntmp_{m-1}.survtmp_{m-1}}{1-survtmp_m}.
\end{equation}
We also need
\begin{equation}
    phi=\sum_{a=1}^m Ntmp_a(sruvtmp_a)^{spmo\_frac}.wt\_mature^s_a
\end{equation}
and
\begin{equation}
    Req=Requil(phi,y_N,s) \  \text{(as eq.130 to eq. 133)}\,
\end{equation}
and finally we obtein
\begin{equation}
    yield(Fratio, F^s,s)=\left(\sum_{k_s}\sum_{a=1}^m wt\_fsh^{k_s}_{y_N,a}Ntmp_a.Fratio(k_s).Ftmp.sel\_fsh_a(k_s,y_N)\dfrac{1-survtmp_a}{Ztmp_a}\right).Req.
\end{equation}


\textbf{N\_NoFsh}\\
%Let the array $N\_NoFsh$ with dimensions $(1,nstk,styr,endyr\_fut,1,nages)$.\\
Let $s$ the number stock,  that is $1\leq s \leq nstk$.
\begin{equation}
N\_NoFsh_j(s,styr)=N^s_{y_0,j}, \ 1\leq j \leq m,
\end{equation}
and for $styr\_sp \leq i \leq styr$ 
\begin{equation}
    Sp\_Biom\_NoFish_j(s,i)=SB^s_{i,j}, \ 1\leq j \leq m.
\end{equation}
\begin{itemize}
    \item $N\_NoFsh$
    \item $Sp\_Biom\_NoFish$
    
\end{itemize}
Now for $styr\leq i \leq endyr$, the number of recruits from stock $s$ in year $i$ is equal to the number of individuals of stock $s$ in year $i$ at age 1 i.e $recruits(s,i)=N^s_{i,1}$ .\\ Let $y_0\leq i \leq y_N$.
Si $i>y_0$:
\begin{equation}
    N\_NoFsh(s,i,1)=recruits(s,i)*\dfrac{SRecruit(Sp\_Biom\_NoFish(s,i-rec\_age),cum\_regs(s)+yy\_sr(s,i))}{SRecruit(SB^s_{i-a_R},cum\_regs(s)+yy\_sr(s,i))}
\end{equation}
\begin{itemize}
    \item recruits:
    \item $SRecruit$:
    \item $rec\_age$
    \item $cum\_regs$
    \item $yy\_sr$
\end{itemize}
\begin{equation}
    N\_NoFsh(s,i)_j=N\_NoFsh(s,i-1)_{j-1}.e^{-M(s,i-1)_{j-1}}
\end{equation}
for $2\leq j \leq m.$ Updating for $m$:
\begin{equation}
    N\_NoFsh(s,i,m)=N\_NoFsh(s,i-1)_{m-1}.e^{-M^s_{i-1,m-1}}+N\_NoFsh(s,i-1,m).e^{-M^s_{i-1,m}}
\end{equation}
Now for $ y_0\leq i \leq y_N$:
\begin{equation}
    totbiom\_NoFish(s,i)=\sum_{j=1}^mN\_NoFsh(s,i)_j.wt\_pop^s_j.
\end{equation}
\begin{equation}
    totbiom(s,i)=\sum_{j=1}^mN^s_{i,j}.wt\_pop^s_j.
\end{equation}
\begin{equation}
Sp\_Biom\_NoFish(s,i)=\sum_{j=1}^m N\_NoFsh(s,i)_j.e^{-M^s_{i,j}.spmo\_frac}wt\_mature^s_j
\end{equation}
\begin{equation}
    Sp\_Biom\_NoFishRatio(s,i)=\dfrac{SB^s_i}{Sp\_Biom\_NoFish(s,i)}
\end{equation}
\begin{equation}
    depletion(s)=\dfrac{totbiom(s,y_N)}{totbiom(s,y_0)}
\end{equation}
\begin{equation}
    depletion\_dyn(s)=\dfrac{totbiom(s,y_N)}{totbiom\_NoFish(s,y_N)}
\end{equation}
\begin{itemize}
    \item totbim\_NoFish
    \item totbiom
    \item Sp\_Biom\_NoFish
    \item Sp\_Biom\_NoFishRatio
    \item depletion\_dyn
\end{itemize}
\begin{equation}
%calculado en Spawning stock biomass
Nnext(s)_j=N^s_{y_N,j-1}.S^s_{y_N,j-1}, \ for \ 2\leq j\leq m-1,
\end{equation}
\begin{equation}
Nnext(s)_m=N^s_{y_N,m-1}.S^s_{y_N,m-1}+N^s_{y_N,m}.S^s_{y_N,m},
\end{equation}
% Calcula la SSB(biomasa desovante) para el siguiente a√±o usando el reclutamiento medio  para la edad 1 y el mismo survival (S) como en $y_N$:
% \begin{equation}
%     Nnext(s,1)=e^{mean\_log\_rec(cum\_regs(s)+yy\_sr(s,endyr+1))}
% \end{equation}
\begin{equation}
    Nnext(s,1)=e^{\mu^s_{R,y_N+1}},
\end{equation}
% \begin{equation}
%     Sp\_Biom(s,endyr+1)=\sum_{age \ j}Nnext(s)_jS(s,endyr)^{spmo\_frac}.wt\_mature(s)_j
% \end{equation}
and then
\begin{equation}
recruits(s,endyr+1)=Nnext(s,1),
\end{equation}
\begin{equation}
totbiom(s,endyr+1)=\sum_{j=1}^mNnext(s)_j.wt\_pop(s)_j.
\end{equation}
\begin{itemize}
    \item Nnext

\end{itemize}
Now OFL for the next year:
\begin{equation}
    OFL(s) =\sum_{k_s} \sum_{j=1}^mwt\_fsh^{k_s}_{y_N,j} . Nnext(s)_j * Fatmp(k_s,j) * \dfrac{(1 - e^{-Ztmp^s_j})}{Ztmp^s_j}, \ 1\leq s \leq nstk,
\end{equation}
where
\begin{equation}
    seltmp_j(k)=sel\_fsh_j(k,endyr),
\end{equation}
for $1\leq k \leq nfsh$ and
\begin{equation}
    Fatmp_j(k)=Fratio(k).Fmsy(s_k).seltmp_j(k), \  1\leq j \leq m,
\end{equation}
\begin{equation}
    Ztmp_j(s)=M^s_{y_0,j}+ \sum_{k_s}Fatmp(k_s).
\end{equation}

\textbf{Get Future Fs:}\\
Let stock s, a positive integer i and some iscenario.\\
Depending the value of iscenario:
\begin{itemize}
    \item Caso iscenario=1. \begin{equation}
        F\_fut\_tmp_a(k)=F^k_{y_N,a},
    \end{equation}
    \item Caso iscenario=2.  \begin{equation}
        F\_fut\_tmp_a(k) = F^k_{y_N,a}*0.75,
    \end{equation}
    \item Caso iscenario=3.  \begin{equation}
        F\_fut\_tmp_a(k) = F^{k}_{y_N,a}*1.25,
    \end{equation}
    \item Caso iscenario=4.
    \begin{equation}
        F\_fut\_tmp_a(k)=seltmp_a(k)*Fratio(k)*Fmsy(s),
    \end{equation}
    where $seltmp_a(k)=sel\_fsh_a(k,y_N)$,
    \item Caso iscenario=5.
    \begin{equation}
        F\_fut\_tmp = 0.0
    \end{equation}
\end{itemize}
for $1\leq a \leq m$ and  $1\leq k \leq nfsh$.\\
It also calculates
\begin{equation}
    {F_{fut}}^k_{i,a}   = F\_fut\_tmp_a(k)
\end{equation}
\begin{equation}
    {Z_{fut}}^s_{i,a}=M^s_{y_N,a}+\sum_{k_s}F\_fut\_tmp_a(k_s)
\end{equation}
and 
\begin{equation}
    {S_{fut}}^s_{i,a}=e^{-{Z_{fut}}^s_{i,a}}.
\end{equation}


\textbf{Future Projections}\\
Here we calculate the future biomass $Sp\_Biom\_future^s_{y}$ for each stock s with $1 \leq s \leq nstk$ and $styr\_fut-a_R\leq y \leq endyr\_fut$, and different scenarios iscen with $1\leq iscen \leq 5$, where $styr\_fut=y_N+1$ if $nproj\_yrs>0$ and else $styr\_fut=y_N$, and $endyr\_fut=y_N+nproj\_yrs$
\begin{equation}
    Sp\_Biom\_future^s_y=\sum_{a=1}^mwt\_{mat}^s_a N^s_{y,a}(S^s_{y,a})^{s_f}, 
\end{equation}
$\ styr\_fut-a_R\leq y \leq styr\_fut-1.$\\

Now for $y=styr\_fut$
\begin{equation}
    Sp\_Biom\_future^s_{styr\_fut}= \sum_{a=1}^mwt\_{mat}^s_a.{N_{fut}}^s_{y,a}.({{S_{fut}}^s_{y,a}})^{s\_f}
\end{equation}
where 
% \begin{equation}
%     {S_{fut}}^s_{y,a}=M^s_{y_N}, (cuando iscen = 5)
% \end{equation}
\begin{equation}
    {N_{fut}}^s_{y,a}=N^s_{y_N,a-1}.S^s_{y_N,a-1}, \ 2\leq a \leq m-1,
\end{equation}
\begin{equation}
    {N_{fut}}^s_{y,m}=N^s_{y_N,m-1}.S^s_{y_N,m-1}+N^s_{y_N,m}.S^s_{y_N,m},
\end{equation}
and 
\begin{equation}
    {N_{fut}}^s_{y_N,1}=SRecruit(SB^s_{y_N-rec\_age},cum\_reg(s)+yy\_sr(s,y_N)).e^{\epsilon^s_{y_N}}.
\end{equation}

Then for $styr\_fut+1 \leq y \leq endyr\_fut$
\begin{equation}
    Sp\_Biom\_future^s_y = \sum_{a=1}^m wt\_mat^s_{a}.{N_{fut}}^s_{y,a}.({S_{fut}}^s_{y,a})^{s_f}
\end{equation}
where
\begin{equation}
   {N_{fut}}^s_{y,a}={N_{fut}}^s_{y-1,a-1}.{S_{fut}}^s_{y-1,a-1},  \ 2\leq a \leq m-1,
\end{equation}
\begin{equation}
    {N_{fut}}^s_{y,m}={N_{fut}}^s_{y-1,m-1}.{s_{fut}}^s_{y-1,a-1} + {N_{fut}}^s_{y,m}.{S_{fut}}^s_{y,m},
\end{equation}
and
\begin{equation}
    {N_{fut}}^s_{y,1}=SRecruit(SB^s_{y-rec\_age},cum\_reg(s)+yy\_sr(s,y_N)).e^{\epsilon^s_{y}}.
\end{equation}

%falta rec_dev_future

On the other hand if $iscen=1$, $N\_NoFsh^s_{y,a}$ and $Sp\_Biom\_NoFish^s_y$ are calculated for $y_N+1\leq y \leq endyr\_fut$, $1\leq a \leq m$ and each stock s, as follows

\begin{equation}
    N\_NoFsh^{s}_{y,1}={N_{fut}}^s_{y,1}.\dfrac{SRecruit(Sp\_Biom\_NoFish(s,y-a_R),cum\_regs(s)+yy\_sr(s,y_N))}{ SRecruit(Sp\_Biom\_future(s,y-a_R),cum\_regs(s)+yy\_sr(s,y_N))},
\end{equation}
\begin{equation}
    N\_NoFsh^{s}_{y,a}=N\_NoFsh^s_{y-1,a-1}.e^{-mean(natmort(s))}, \ 2\leq a\leq m-1,
\end{equation}
\begin{equation}
    N\_NoFsh^s_{y,m}=N\_NoFsh^s_{y-1,m-1}.e^{-mean(natmort(s))}+N\_NoFsh^s_{y-1,m}.e^{-mean(natmort(s))},
\end{equation}
and
\begin{equation}
    Sp\_Biom\_NoFish^s_y   = \sum_{a=1}^mN\_NoFsh^s_{y,a}.(e^{-mean(natmort(s))})^{s_f}  wt\_{mat}_a(s).
\end{equation}

Now get catch at future ages i.e when $styr\_fut \leq y \leq endyr\_fut$. If $iscen \neq 5$
\begin{equation}
    catage\_future^s_{y,a}=\sum_{k_s} {N_{fut}}^s_{y,a}.{F_{fut}}^{k_s}_{y,a}.\dfrac{1-{S_{fut}}^s_{y,a}}{{Z_{fut}}^s_{y,a}},
\end{equation}

\begin{equation}
    catch\_future(s,iscen,y)=\sum_{k_s} \sum_{a=1}^m{N_{fut}}^s_{y,a}.{F_{fut}}^{k_s}_{y,a}.\dfrac{1-{S_{fut}}^s_{y,a}}{{Z_{fut}}^s_{y,a}}.wt\_fsh^s_{y_N,a}
\end{equation}
where $\displaystyle\sum_{k_s}$ represents the sum is over all fisheries $k_s$ belonging to stock s.\\

\textbf{The objective function obj\_fun}\\

The parameters of the model are chosen so that this value obj\_comp is minimized. That is, it should be the negative of the log-likelihood.

\begin{equation}
    obj\_fun=obj\_fun+sum(catch\_like)+sum(age\_like\_fsh)+sum(lenght\_like\_fsh)+sum(sel\_like\_fsh)+
\end{equation}
\begin{equation*}
    sum(ind\_like)+sum(age\_like\_ind)+sum(lenght\_like\_ind)+
\end{equation*}
\begin{equation*}
    sum(sel\_like\_ind)+sum(rec\_like)+sum(fpen)+sum(post\_priors\_indp)+sum(post\_priors).
\end{equation*}

\subsection{Models for stock structure hypothesis}

The JJM model allows the exploration of two types of population structure. This allow the construction of models under the one-stock hypothesis "h1" and under the two-stock hypothesis "h2".

\subsection{Description of Model Explorations}

Model implementation could allow to analyse the effect of stock structure hypothesis, model updates and data revisions, changes in selectivity for a specific year, shift in the distribution of fishing effort, among others. 



\section{Data files}
% List of information as part of the data input files

\begin{tabular}{| c | c | c | c | c |}
\hline
Line in the .dat file & Name in .dat file  & Name in the User Guide & Tpl name & Definition\\ \hline
 3 &  years & $y_0$  & styr & year of start of observation\\ \hline
4 &  years & $y_N$  & endyr & end year of observation\\ \hline
6 & ages  & $a_R$  & $rec\_age$ & recruitment age\\ \hline
7 & ages  &   & $oldest\_age$ & oldest age\\ \hline
9 & nbins &   & $n\_lenght$ & number of sizes  considered\\ \hline
10 & lengthbin &   & $len\_bin$ & \\  \hline
12 & Fnum &   & $nfsh$ & \\ \hline
14 & Fnames &   & $fshnameread$ & \\ \hline
16 & Fcaton &   & $catch\_bio\_in$ & \\ \hline
19 & Fcatonerr &   & $catch\_bio\_sd\_in$ & \\ \hline
21 & FnumyearsA &   & $nyrs\_fsh\_age$ & \\ \hline
23 & FnumyearsL &   & $nyrs\_fsh\_lenght$ & \\ \hline
25 & Fageyears &   & $yrs\_fsh\_age\_in$ & \\ \hline
27 & Flenghtyears &   & $yrs\_fsh\_lenght\_in$ & \\ \hline
29 & Fagesample &   & $n\_sample\_fsh\_age\_in$ & \\ \hline
31 & Flenghtsample &   & $n\_sample\_fsh\_lenght\_in$ & \\ \hline
33 & Fagecomp &   & $oac\_fsh\_in$ & \\ \hline
36 & Flenghtcomp &   & $olc\_fsh\_in$ & \\ \hline
80 & Fwtatage &   & $wt\_fsh$ & \\ \hline
134 & Inum &   & $nind$ & \\ \hline
136 & Inames &   & $indnameread$ & \\ \hline
138 & Inumyears &   & $nyrs\_ind$ & \\ \hline
141 & Iyears &   & $yrs\_ind\_in$ & \\ \hline
144 & Imonths &   & $mo\_ind$ & \\ \hline
147 & Index &   & $obs\_ind\_in$ & \\ \hline
150 & Indexerr &   & $obs\_se\_ind\_in$ & \\ \hline
153 & Inumageyears &   & $nyrs\_ind\_age$ & \\
\hline
156 & Inumlenghtyears &   & $nyrs\_ind\_lenght$ & \\ \hline
159 & Iyearsage &   & $yrs\_ind\_age\_in$ & \\ \hline
161 & Iagesample &   & $s\_sample\_ind\_age\_in$ & \\ \hline
163 & Ipropage &   & $oac\_ind\_in$ & \\ \hline
165 & Iyearslenght &   & $syrs\_ind\_lenght\_in$ & \\ \hline
167 & Ilenghtsample &   & $n\_sample\_ind\_lenght\_in$ & \\ \hline
169 & Iproplenght &   & $olc\_ind\_in$ & \\ \hline
171 & Iwtatage &   & $wt\_ind$ & \\ \hline
278 & Pspwn &   & $spawnmo$ & \\ \hline
280 & Pageerr &   & $age\_err$ & \\ \hline
\end{tabular} 

\subsection{Fishery data}

- Catch data: This model uses the catch data for each of the fleet as part of the model representation.

- Length and age data: the age data is also an important input for the JJM model. But in the case any fleet is using length distribution data, this information in converted into age distributions by using age-length keys. The age-length keys is fleet dependent.

- CPUE (catch per unit effort) data series are used in the model, each fleet with a specific methodology for CPUE estimation. Besides, since 2022 the CPUE series include a factor that compensates for efficiency (also termed "effort creep") increases of fishing operations.

\subsection{Fishery independent data}

The model also allow the use of relative abundance indices such as for example acoustic biomass and numbers, spawning stock biomass, estimates of abundance and numbers-at-age, egg surveys results, among others. This information comes from hydro-acoustics, stock assessment and egg and larvae surveys. This information is also fleet-dependent.

\subsection{Biological parameters}

- The JJM model requires the maturity-at-age for the Jack mackerel. This parameter can be estimated by applying an ageing criteria to the otoliths and histological maturity data.

- On the other hand, for fleets that are using length data and age-length keys to convert length to age data, to fit the length composition data a growth curve is used to convert age composition predicted by the model to predicted lengths, with the conversion occurring withing the model.

- The model needs the growth parameters and in this case the JJM model uses the von Bertalanffy growth model. For the model under development is important to consistently use the same length metric for parameters and data, i.e. total length or fork length for model parameters and data.

- The mean weight-at-age will be calculated by year by taking the mean length-at-age in the catch and a length-weight relationship derived for the year. Mean weight-at-age is required for all fishing fleets and biomass indices in order to relate biomass quantities to the underlying model estimates of jack mackerel abundance (in numbers). In some cases, missing weight-at-age data could be replaced with data from the previous year. However, it is recommended that those missing data be replaced with appropriate mean values by fleet instead. 

- The natural mortality is also required for the JJM model. For this, the (\href{https://connect.fisheries.noaa.gov/natural-mortality-tool/}{Natural Mortality Tool}) could be used. 

\subsection{Data sets}
% Name, years, ages, nbins, lengthbin, Fnum, Fnames, Fcaton, Fcatonerr, FnumyearsA, FnumyearsL, Fageyears, Flengthyears, Fagesample, Flengthsample, Fagecomp, Flengthcomp, Fwtatage, Inum, Inames, Inumyears, Iyears, Imonths, Index, Indexerr, Inumageyears, Inumlengthyears, Iyearsage, Iagesample, Ipropage, Iyearslength, Ilengthsample, Iproplength, Iwtatage, Pspwn, Pageerr.

A full description of data sets used to the assessment of Jack mackerel is in the Annex X. Summaries of all data available for the assessment are provided in Table X and Figure Y.

\section{Getting started} 
% R, admb
% Installing jjmR: from CRAN, github
% Any other consideration

\section{File organization}
% List of files to run the model, and how those files are organized?

\section{Starting the JJM model}
% How run the model?

\section{Configuration files}
% List of information as part of the configuration files (ctl files)

\begin{tabular}{| c | c | c | c | c |}
\hline
Line in the .ctl file & Name in .ctl file  & Name in the User Guide & Tpl name & Definition\\ \hline
 5 &  Number of stocks & $nstk$  & nstk & number of stocks\\ \hline
6 &  Names of stocks &  & $stknameread$   & \\ \hline
8 &  Selectivity sharing vector &   & $sel\_map$ &\\ \hline
15 &  Number of regimes &   & $nreg$ &\\ \hline
17 &  Sr\_type &   & $SrType$ &\\ \hline
19 &  AgeError &   & $use\_age\_err$ &\\ \hline
21 &  Retro &   & $retro$ &\\ \hline
23 & Recruitment sharing matrix &   & $rec\_map$ &\\ \hline
26 &  Steepness &   & $steepnessprior$ &\\ \hline
27 &  Steepness &   & $cvsteepnessprior$ &\\ \hline
28 &  Steepness &   & $phase\_srec$ &\\ \hline
30 &  SigmaR &   & $sigmarprior$ &\\ \hline
31 &  SigmaR &   & $cvsigmarprior$ &\\ \hline
32 &  SigmaR &   & $phase\_sigmar$ &\\ \hline
33 &  phase\_Rzero &   & $phase\_Rzero$ &\\ \hline
35 &  Nyrs\_sr &   & $nrecs\_est\_shift$ &\\ \hline
38 &  yrs\_sr &   & $yr\_rec\_est$ &\\ \hline
41 &  reg\_shifts &   & $reg\_shift$ &\\ \hline
43 &  Growth parameters sharing matrix &   & $growth\_map$ &\\ \hline
46 &  Linf &   & $Linfprior$ &\\ \hline
47 &  Linf &   & $cvLinfprior$ &\\ \hline
48 &  Linf &   & $phase\_Linf$ &\\ \hline
50 &  K &   & $kprior$ &\\ \hline
51 & K &   & $cvkprior$ &\\ \hline
52 &  k &   & $phase\_k$ &\\ \hline
54 &  Lo\_Len &   & $Loprior$ &\\ \hline
55 &  Lo\_Len  &   & $cvLoprior$ &\\ \hline
56 &  Lo\_Len  &   & $phase\_Lo$ &\\ \hline
58 &  Sigma\_len  &   &  
 $sdageprior$ &\\ \hline
59 &  Sigma\_len  &   & $cvsdageprior$ &\\ \hline
60 &  Sigma\_len  &   & $phase\_sdage$  &\\ \hline
61 &  Mortality sharing matrix  &   & $mort\_map$  &\\ \hline
64 &  Natural\_Mortality  &   & $natmortprior$ &\\ \hline
65 &  Natural\_Mortality  &   & $cvnatmortprior$ &\\ \hline
66 &  Natural\_Mortality  &   & $phase\_M$  &\\ \hline
67 &  NEW npars\_mage  &   & $npars\_Mage$ &\\ \hline
69 &  NEW ages\_M\_changes  &   & $ages\_M\_changes$ &\\ \hline
71 &  NEW Mage\_in  &   & $Mage\_in$  &\\ \hline
73 &  phase\_Mage  &   &  $phase\_Mage$ &\\ \hline
75 &  Phase\_Random\_walk\_M	  &   & $phase\_rw\_M$ &\\ \hline
77 &  Nyrs\_Random\_walk\_M  &   & $npars\_rw\_M$ &\\ \hline
79 &  Random\_walk\_M\_yrs	  &   & $yrs\_rw\_M$ &\\ \hline
81 &  Random\_walk\_M\_sigmas  &   & $sigma\_rw\_M$  &\\ \hline

\end{tabular} 

\begin{tabular}{| c | c | c | c | c |}
\hline
Line in the .ctl file & Name in .ctl file  & Name in the User Guide & Tpl name & Definition\\ \hline

84 & catchability &   &  $qprior$&\\ \hline
85 & catchability &   &  $cvqprior$&\\ \hline
86 & catchability &   &  $phase\_q$&\\ \hline
88 & q\_power &   & $q\_power\_prior$ &\\ \hline
89 & q\_power &   & $cvq\_power\_prior$ &\\ \hline
90 & q\_power &   & $phase\_q\_power$  &\\ \hline
91 & Random\_walk\_q\_phases &   & $phase\_rw\_q$ &\\ \hline
93 & Nyrs\_Random\_walk\_q &   & $npars\_rw\_q$ &\\ \hline
95 & Random\_walk\_q\_yrs &   & $yrs\_rw\_q$ &\\ \hline
97 & Random\_walk\_q\_sigmas &   & $sigma\_rw\_q$ &\\ \hline
99 & q\_agemin &   & $q\_age\_min$ &\\ \hline
102 & q\_agemax &   & $q\_age\_max$  &\\ \hline
103 & use vb wt age &   & $use\_vb\_wt\_age$  &\\ \hline
105 & n\_proj\_yrs &   & $nproj\_yrs$ &\\ \hline
109 & Fishery \#  &   & $fsh\_sel\_opt$  &\\ \hline
110 & Fishery \# &   & $nselages\_in\_fsh$  &\\ \hline
112 & Fishery \# &   & $curv\_pen\_fsh$ &\\ \hline
113 & Fishery \# &   & $seldec\_pen\_fsh$ &\\ \hline
115 & Years of selectivity &   & $s\_sel\_ch\_fsh$ &\\ \hline
116 & Years of selectivity &   & $yrs\_sel\_ch\_fsh$ &\\ \hline
117 & Years of selectivity &   & $sel\_sigma\_fsh$ &\\ \hline
119 & Initial values for coeff. &   & $sel\_fsh\_tmp$ &\\ \hline
140 & Population weight at age 1000&   & $wt\_pop$ &\\ \hline
143 & Maturity at Age &   & $maturity$  &\\ \hline
146 & Test &   & $test$ &\\ \hline
\end{tabular} 



- Input Data File, model name, Number of stocks, Names of stocks, Selectivity sharing vector, (number\_fisheries + number\_surveys), Number of regimes (by stock), Sr\_type, AgeError, Retro, Recruitment sharing matrix (number\_stocks, number\_regimes), Steepness, SigmaR, phase\_Rzero, Nyrs\_sr, yrs\_sr, reg\_shifts blank if nreg==1, Growth parameters sharing matrix (number\_stocks, number\_regimes), Linf, K, Lo\_Len, Sigma\_len, Mortality sharing matrix number\_stocks, number\_regimes), Natural\_Mortality, npars\_mage, ages\_M\_changes, Mage\_in, phase\_Mage, Phase\_Random\_walk\_M, Nyrs\_Random\_walk\_M, Random\_walk\_M\_yrs blank if nyrs==0, Random\_walk\_M\_sigmas blank if nyrs==0, catchability, q\_power, Random\_walk\_q\_phases, Nyrs\_Random\_walk\_q, Random\_walk\_q\_yrs blank if nyrs==0, Random\_walk\_q\_sigmas blank if nyrs==0, q\_agemin, q\_agemax, use vb wt age, n\_proj\_yrs, Select type for fshry 1, n\_sel\_ages, phase sel, curvature penalty, Dome-shape penalty, Years of selectivity change Fishery 3 Peru, n\_sel\_ch\_fsh, yrs\_sel\_ch\_fsh, sel\_sigma\_fsh, Initial values for coefficitients at each change (one for every change plus 1), Initial values for parameters, Index number 5 Acoustic\_Peru, SelOption, n\_sel\_ages, phase sel, curvature penalty, Dome-shape penalty, n\_sel\_ch\_ind, yrs\_sel\_ch\_ind, sel\_sigma\_ind, Initial values for parameters, Population Weight at Age 1000, Maturity at Age, Test.



\section{Model outputs}

To analyse the stock status the JJM model provides a big set of model outputs such as: the biomass of the population, the spawning stock biomass (SSB) and the recruitment over the time. Also, the management reference points such as: \(B_{MSY}\) and \(F_{MSY}\) over the time (years).

% To be check!: 
The fishery mean weights-at-age?, estimates of numbers-at-age?, fits to the composition data, fits of age composition data from the surveys, fit of the indices, relative abundance, estimates of fishery mean age compositions, survey mean age compositions.

Time series stock status: spawning biomass, fishing mortality, recruitment, total biomass, for each hypothesis.

% Management advice and assessment issues is not included.

\section{Bibliography}

\section{Miscellaneous}
% Any other important points to be explained
\section{Parameter index}
% List of parameter names

\section{Appendix A: Case study description}
\label{section:AppendixA}

\section{Appendix B: Assessment results of case study}
\label{section:AppendixB}


\end{document}

\documentclass{article}
\usepackage{fullpage}

\renewcommand{\familydefault}{\sfdefault}
\usepackage[scaled=1]{helvet}
\usepackage[helvet]{sfmath}
\everymath={\sf}
\usepackage{hyperref}
\usepackage{parskip}
\usepackage[colorinlistoftodos]{todonotes}
\usepackage{graphicx} 
\usepackage{listings}
\usepackage{amsmath}
\usepackage{amsthm}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{amsbsy}
\usepackage{graphicx}
\usepackage{bbm}
\usepackage{mathrsfs}
%\usepackage[colorlinks=true, allcolors=blue]{hyperref}

\usepackage{algorithm,algcompatible,amsmath}
\usepackage[backend=biber]{biblatex}
\bibliography{referencias.bib}

\title{The JJM model: an user manual}

\date{\parbox{\linewidth}{\centering%
  \skip
  Mirian GERONIMO \hspace*{3cm} Criscely LUJAN \endgraf\medskip
  Instituto del Mar del Perú (IMARPE)}
  }
%\setcounter{tocdepth}{2}
\setcounter{tocdepth}{3}
\begin{document}
\maketitle
\tableofcontents
\newpage

\section*{Abstract} 

% Model description
%[work on it] \\
% This document provides a detailed and comprehensive specification of the Joint Jack Mackerel model (the JJM model). This model is widely used for the assessment of the Jack mackerel. This includes the algebraic specifications of the assessment model, tables with the input data and key parameters for the assessment. In addition a case study has been used to illustrate the use of the JJM model. This paper aims to provide an illustrative description of the JJM which can serve as support and guidance to users.

This paper provides a detailed specification of the Jack mackerel joint model (the JJM model). This model is recognized and used for jack mackerel assessment at the SPRFMO Convention. The document includes the algebraic specifications of the assessment model such as the mathematical equations that model the population dynamics of jack mackerel, functions defined in the model code for obtaining important quantities such as  the maximum sustainable yield (MSY),  biological reference points (BRPs) and catch projections(for this purpose we have analyzed the model code located at  \cite{codejjm}), input data (dat and cdt file) and key parameters for the assessment such as the parameters to be estimated. On the other hand, the steps to follow for the installation of the resources and to run the model are presented. Finally, a case study is used to illustrate the use of the JJM model. This document is intended to provide an illustrative description of the JJM that can serve as support and guidance to users.

\section{Introduction} 

% Model description
% [work on it] \\
% This paper gives a full algebraic description of the JJM model which is used for the Jack mackerel assessment in the South Pacific Regional Fisheries Management Organisation \href{https://www.sprfmo.int/}{SPRFMO}. For this work, we provide a set of data that is used as part of a case study (see \nameref{section:AppendixA}). This information is used as data input to simulate an assessment (see results in \nameref{section:AppendixB}).
This work provides a complete algebraic description of the JJM model used for horse mackerel assessment in the South Pacific Regional Fisheries Management Organization. This algebraic description consists of 4 sections, the first (2.4) where the mathematical equations to model the population dynamics of horse mackerel are presented, the second (section 2.5) where the functions with important biological results are described, the third (section 2.6 ) describes the objective function to be maximized and all the functions that make it up, and finally the fourth (section 2.7) which are resource functions that help to calculate others.


This user manual also describes the parameters to be estimated, how they are defined in the model (that is, whether it takes into account limited intervals, optimization phase or initiation values) that are already predetermined, the list of inputs and outputs, and a small instruction on how to carry out an evaluation.
Finally we provide a data set that is used as part of a case study (see \nameref{section:AppendixA}). This information is used as input to simulate an evaluation (see results in \nameref{section:AppendixB}).
Part of the concepts of the JJM model presented here come from \href{https://www.sprfmo.int/assets/Meetings/SC/10th-SC-2022/Report-and-Annexes/Annex-8-JM-Technical-Advice-CV_2.pdf}{SPRFMO SC10 Report-Annex 10- Jack Mackerel Technical Annex}.

\section{JJM model}

\subsection{Model description}

% Aim of the model
The Joint Jack Mackerel Model (JJM) is a statistical catch-at-age and age-structured model used to evaluate the Jack mackerel (\textit{Trachurus murphyi}). This species is widespread throughout the South Pacific ocean, and there are at least five management units identified of Jack mackerel whose are associated to distinct fisheries: the Ecuadorian and Peruvian fishery, the northern and central-southern Chilean fisheries, and the purely high sea fishery. 

The JJM model was adopted as the assessment model in 2010 and continues to be used in the SPRFMO. In this context, each year an update of the model data is carried out, and using updated data inputs and indicators the model is run. Model results are used to provide an recommendation of the Jack mackerel population status for its exploitation. On the other hand, the JJM model was been adopted for some SPRFMO delegations (e.g. in Peru) for its internal fishery assessment.

% Programming languages
The JJM model, implemented in AD Molder Builder (\href{https://www.admb-project.org/}{ADMB}), uses a forward projection approach and maximum likelihood estimation to solve for model parameters. The operational population dynamics model of the JJM is defined by the standard catch equation with various modifications such as those described by Fournier \& Archibald (1982), Hilborn \& Walters (1992) and Schnute \& Richards (1995)\cite{sc10report}.\\


There are three important sections in the JJM model template\cite{admbmanual}:

\begin{itemize}
    \item The data section describes the structure of the data in the model. Some of the data is read from a file, this data are declared in the data section  with the  \textbf{init} prefix,
    \item The parameter section describes the model parameterization,
    \item The procedure section describes the current model calculations.
\end{itemize}





\subsection{Model history}
% A little of history about the model
Since the creation of the JJM model, this tool is in continuous development and has been improved by participant scientists mainly involved in the SPRFMO. As part of the most important changes since its creation, was to include length composition data (and specifying or estimating growth) and the capacity to estimate the natural mortality by age and time. Nowadays, the model allow the use of catch information either at age or size for any fleet, this is an important change that provides flexibility in terms of data usage. Besides, other important change is the explicit incorporation of regime shifts in population productivity by fleet.

% Which information need the model
The model consists of four main components: i) the dynamics of the stock, ii) the fishery dynamics, iii) the observation models for data, and iv) the procedure used for parameter estimation (including uncertainties).

\subsection{Main assumptions}

A statistical catch-at-age model analyses data on the age of fish caught in scientific surveys and by fisheries to provide a management advice. Catch-at-age models typically require information on stock age, fishing effort and total catches for each fishery targeting a stock.

To apply a statistical catch-at-age models, specific data are needed for each age class, where an age class is a set of all fish born in a given year. Then, catch-at-age results provide the full suite of management advice estimating a stock's current size and its management reference points (e.g. associated with the maximum sustainable yield (MSY)). The main assumptions of such models and implemented in the JJM model are detailed in the following sections.

\subsubsection{Stock dynamics}

\begin{itemize}

\item The JJM model is not spatially-explicit, although the fisheries operate in geographically distinct areas.

\item The model needs initial conditions which should preferably be set at equilibrium conditions.

\item The population's age composition considers individuals of different ages (from 1 to more). But in all cases a stochastic Beverton-Holt relationship is included.

\item The recruitment and the spawning season should be assumed to occur in specific period of time.

%For the study of the Jack Mackerel in the South Pacific ocean, the recruitment is assumed to occur in January while the spawning season is assumed to be an instantaneous process occurring in mid-November.

\item The source of mortality is age-specific and composed of fishing mortality at age by fleet and natural mortality. Natural mortality is assumed to be constant over time and age.

\end{itemize}

\subsubsection{Fishery dynamics}

\begin{itemize}

\item The JJM model assumes that the interaction of the population with the fishery occurs through the fishing mortality.
    
\item The fishing mortality is assumed to be a composite of several processes: selectivity by fleet, catchability and effort deviations.

\item The selectivity reports the age-specific pattern of fishing mortality, and its pattern is non-parametric assuming to be fishery-specific and time-variant.

\item The catchability describes effort scales to fishing mortality and it is specific to each abundance indices.
    
\item The effort deviations describes a random effect in the fishing effort.

\item The JJM model includes temporal variation in both fishery and index selectivity patterns at the annual and regime scales, depending on the index and the stock structure hypothesis.
\end{itemize}

\subsubsection{Observation models for data}

\begin{itemize}

\item There are four data components that contribute to the log-likelihood function: the total catch data, the age-frequency data, the length-frequency data and the abundance indices.

\item Probability distributions for the age and length-frequency proportions are assumed to be approximated by multinomial distributions.

\item Sample size is specified to be gear-specific but mostly constant over years.

\item For the total catch by fishery and the abundance indices, a log-normal assumption has been assumed with constant coefficient of variation (CV).

\end{itemize}

%To be included in model input parameters
%The CV for the fisheries being 0.05 whereas the CV for the abundance indices depends on the index. Besides, the Francis T1.8 weighting method is used to assign weighted sample sizes for age-frequency data. The data weights have been updated during the JM benchmark.

\subsubsection{Parameter estimation}

\begin{itemize}

\item The most numerous parameters estimated involve estimates of annual and age-specific components of fishing mortality for each year and for each of the four fisheries identified in the model.

\item Model parameters are estimated by maximising the log-likelihoods of the data plus the log of the probability density functions of the priors and smoothing penalties specified in the model.

\item Parameter estimation is conducted in a series of phases, the first of which used arbitrary starting values for most parameters.

\end{itemize}

\subsection{Mathematical Model details}

This catch-at-age model is used as the underlying assessment model able to fit to CPUE indices as well as catch-at-age and length data. The assessment process involves developing a model of the resource dynamics and conditioning its output to the available data by maximising a log-likelihood function.

%\subsubsection{Population dynamics}

\subsubsection{a. Numbers at age}

The population dynamics are modelled by the following set of equations:
%natage at styr is calculates in FUNCTION Get_Bzero in the tpl.

\begin{equation}
N^s_{y,a=1}=e^{\mu_{R,y}^s+\epsilon_{y}^s}  \ \ \ \ \ , y_{1}\leq y \leq y_{N}
\end{equation}

where:
\begin{itemize}
    \item $s$ is a fish stock with $1\leq s \leq n_{stk}$, where $n_{stk}$ is the total number of stocks; 
    \item $a$ the group age and $y$ the year;
    
    \item the simulation period ${y \in \{y_{0}, y_1, y_2,..., y_{N}\}}$;   
  
    \item $N^s_{y,a=1}$ is the numbers of fish of group age $a=1$ and stock $s$ in year $y$;
    
    \item $\mu_{R,y}^s$ is the mean  of the logarithm of recruitment;
    %\item $\mu_R$: $mean\_log\_rec(cum\_regs(s)+yy\_sr(s,y))$;

    \item $\epsilon_{y}^s$ is the annual deviation of recruitment.
    
    %\item $\epsilon_{y}:rec\_dev(s,y)$;
\end{itemize}

The JJM uses the Pope approximation, a variant of the statistical catch-at-age. This fixes the predicted catches to the observed catches using Pope's approximation to calculate the annual exploitation rate in the midpoint of the year. In this case:

\begin{equation}
N^{s}_{y+1,a+1}=N^s_{y,a}e^{-M^s_y}-C^s_{y,a}e^{-M^s_y 0.5}, \ \ \ \ \ 1\leq a \leq m-2,
\end{equation}
    
\begin{equation}
N^s_{y+1,m}=N^s_{y,m-1}e^{-M^s_y}-C^s_{y,m-1}e^{-M^s_y 0.5}+N^s_{y,m}e^{-M^s_y}-C^s_{y,m}e^{-M^s_y 0.5}, \ \ \ a = m
\end{equation}

where:
\begin{itemize}
    \item $\ y_1\leq y \leq y_N+1$
    \item $m$ is the number of age groups considered, it is calculated from $m=o_a-r_a+1$ where $r_a$ is the age at recruitment and $o_a$ is the oldest age;
    
    \item $N^{s}_{y+1,a+1}$ is the number of fish at age group $a+1$ for the stock $s$ in the year $y+1$;

    \item $N^{s}_{y+1,m}$ is the number of fish at age group $m$ for the stock $s$ in the year $y+1$;

    \item $M^{s}_{y}$ denotes the natural mortality rate on fish of stock $s$ in the year $y$;

    \item $C^s_{y,a}$ and $C^s_{y,m}$ denotes the total catch of stock $s$ in the year $y$ at age group $a$ and $m$ respectively.
    
\end{itemize}

\hfill

In addition, the fishing mortalities and survival rate are calculated:

\begin{equation}
F^s_{y,a}=log\left(\dfrac{N^s_{y,a}}{N^s_{y+1,a+1}}\right)-M^s_y, \ \ \ \ \ 1\leq a \leq m-1
\end{equation}

\begin{equation}
F^s_{y,m}=log\left(\dfrac{N^s_{y,m-1}+N^s_{y,m}}{N^s_{y+1,m}}\right)-M^s_y
\end{equation}

where:

\begin{itemize}
    \item $F^s_{y,a}$ is the fishing mortality for the stock $s$ at the age group $a$ in the year $y$;

    \item $F^s_{y,m}$ is the fishing mortality for the stock $s$ at the maximum age group $m$ considered in the year $y$.
\end{itemize}

\hfill

Also, the fishing mortality for each fishery and the survival rate are calculated as follows:

\begin{equation}
F^k_{y,a}=F^s_{y,a} \dfrac{\sum_{a = 1} ^{m} Cat^k_{y,a}}{\sum_{a=1} ^{m} C^s_{y,a}}, \ \ \ \ \ 1\leq a \leq m.
\end{equation}

\begin{equation}
S^s_{y,a}=e^{-(F^s_{y,a}+M^s_{y})}
\end{equation}

where:
\begin{itemize}
    \item $k$ is the fishery number and $s$ is the corresponding stock due to the fishery;
    
    \item $1\leq k \leq n_{fsh}$ where $n_{fsh}$ is the total number of fisheries;
   
    \item $F^k_{y,a}$ is the fishing mortality for fishery $k$ at age group $a$ in the year $y$;

    \item $Cat^k_{y,a}$ is the catch at age group $a$ for fishery $k$ in the year $y$ (see bellow);
    
    \item $S^s_{y,a}$ is the survival rate for the stock $s$ at age group $a$ in the year $y$.
\end{itemize}

\hfill

When the Pope approximation is not used the number at age and survival rate are calculated as follows:

\begin{equation}
N^s_{y+1,a+1}=N^s_{y,a}S^s_{y,a}, \ \ \ \ \ 1\leq a \leq m-2
\end{equation}

\begin{equation}
N^s_{y+1,m}=N^s_{y,m-1}S^s_{y,m-1}+N^s_{y,m}S^s_{y,m}, \ \ \ \ a = m
\end{equation}
with $\ y_1\leq y \leq y_N+1$.\\

Defining the fishing mortality for the stock, the survival rate, and the fishing mortality for the fishery as:

\begin{equation}
F^s_{y,a} = \sum_{k_s}F^{k_s}_{y,a}, 
\end{equation}

where the sum is over all fisheries $k_s$ belonging to stock s;

\begin{equation}
S^s_{y,a}=e^{-(F^s_{y,a}+M^{s}_{y})},
\end{equation}

\begin{equation}
F^k_{y,a}=e^{fmort^k_y}Se^k_{y,a}, \ \ \ y_0\leq y \leq y_N \ \ \ and  \ \ \  1\leq a \leq m
\end{equation}

where:
\begin{itemize}

    %\item $Z^{s}_{y,a}$ is the total mortality of stock $s$(to which fishery number k corresponds) in the year $y$ at the age $a$ ;
    %\item $sel\_map$ is a selectivity map,  se refiere al número de stock al que pertenece la pesquería número $k$, notemos que $1\leq k \leq nfsh$ donde $nfsh$ es la cantidad total de pesquerías.
    
    \item $fmort^k_y$ is the annual mortality for the fishery $k$ in the year $y$, it is a parameter to be estimated;
    \item $Se^k_{y,a}$ is the fishing selectivity for the fishery $k$ in the year $y$ at the age group $a$.

\end{itemize}

\hfill

The numbers at age for the year $y_0$ at the stock number $s$ at the age group  $a$ is calculated as following:
%it is calculated in function get_bzero
\begin{equation}
N^s_{y_0,a=1}=e^{\mu^s_{R,y_0} + \epsilon^s_{y_0}}.
\end{equation}
Now for all other age groups.\\
    Let $r_0 = y_0-m+r_a$ the first year of recruitment. If $r_a=1$:

\begin{equation}
N^s_{y_0,a}=e^{\mu_{R,y_0-a+1}^s + \epsilon^s_{y_0-a+1}}
            \prod_{j=1}^{a-1}e^{-M^s_{y_0,j}}, \ 1<a<m.
\end{equation}
%M^s=_{y_0,j}=M^s_{y_0}, ya que la mortalidad natural es constante
Otherwise if $r_a>1$:

\begin{equation}
N^s_{y_0,a}=e^{\mu_{R,y_0-a+1}^s + \epsilon^s_{y_0-a+1}}                          \prod_{j=1}^{a-1}e^{-M^s_{y_0,j}}, \ 1<a\leq m-r_a+1,
\end{equation}

\begin{equation}
N^s_{y_0,a}=R_0^{s,1}\prod_{j=1}^{a-1}e^{-M^s_{y_0,j}}, \ m-r_a+1<a\leq m-1
\end{equation}

where $R_0^{s,1}$ is the recruitment for the first regime of stock $s$.

Finally, the number at age for the maximum age group (i.e. m) considered in the population is:

\begin{equation}
N^s_{y_0,m}=N^s_{y_0-1,m-1}e^{-M^s_{y_0,m-1}}+N^s_{y_0-1,m}e^{-M^s_{y_0,m}}.
\end{equation}

\hfill

\hfill

%\begin{itemize}
%   \item $log\_Rzero_r$ estimated parameter for the regime $r$;
%   \item $Rzero(r)$=$e^{log\_Rzero_{r}}$, where $1\leq r \leq n_{regs}$ and $n_{regs}$ is the total number of regimes for all stocks;

%   \item cum\_regs(s) es la cantidad regímenes acumulados hasta el stock número s-1 (cada stock tiene una determinada cantidad de regímenes).
%   \item $R^s_{0}$ es como el reclutamiento del primer régimen del stock número s
%   %\item Rzero(cum\_reg(s)+1)=R^s_{0} es como el reclutamiento del primer régimen del stock número s.
%\end{itemize}

\subsubsection{b. Spawning stock biomass}

The spawning stock biomass (SSB) is the total biomass of fish of reproductive age during the breeding season of a stock. SSB is calculated from the first year of spawning ($ssb_0$) until $y_N+1$ as follows:

%\textbf{Biomasa desovante (sp\_biom)}\\
%Obtención de la biomasa desovante desde el primer año de desove $\left(styr\_sp\right)$ hasta el primer año de observación ($y_0$).
% \begin{equation}
%     Sp\_Biom(s)_p=wt\_mature(s)_1.e^{-M^s_{styr,1}.spmo\_frac}.Rzero(cum\_regs(s)+1),
%coment: Rzero(cum\_regs(s)+1)=R^s_0
% \end{equation}

% \begin{equation}
%     SB^s_p=wt\_mature(s)_1.e^{-M^s_{y_0,1}.spmo\_frac}.R^s_0
% \end{equation}
%styr_rec=r_0

\begin{equation}
    SSB^s_y=wt\_{mat}^s_1 e^{-M^s_{y_0,1}s_f} R^s_0 +  
            \sum_{a=2}^{m-1}wt\_{mat}^s_a e^{-M^s_{y_0,a}s_f} R^s_0\prod_{l=1}^{a-1}e^{-M^s_{y_0,l}} + 
            {wt\_mat}^s_{m} e^{-M^s_{y_0,m}s_f} \dfrac{R^s_0}{1-e^{-M^s_{y_0,m}}}\prod_{l=1}^{m-1}e^{-M^s_{y_0,l}}
\end{equation}
  
where:
%español:
% \begin{itemize}
%    % \item $Sp\_Biom(s)_p$: Biomasa desovante desde el año $p=styr\_sp$ hasta $p=styr\_rec$.
%    \item $SB^s_p$ es la Biomasa desovante para el stock número s en el año p, cuando  $styr\_sp\leq p \leq r_0$. 
%    %Biomasa desovante desde el año $p=styr\_sp$ hasta $p=r_0$.
%    \item $wt\_mature^s_j$ es el peso(o proporción) de especies maduras para cada edad $j$ en cada stock $s$, se calcula como
%     \begin{equation}
%         wt\_mature^s_j=wt\_pop^s_j.maturity^s_j
%     \end{equation}
%     \item $wt\_pop^s_j$ es input, línea 140 del ctl. Peso a la edad $j$ de la población para cada stock $s$.
%     \item $maturity^s_j$ es input, línea 143 del ctl. Madurez a la edad $j$ para cada stock $s$.
% \end{itemize}
%en ingles:

\begin{itemize}
  
   \item $SSB^s_y$ is the spawning stock biomass for the stock s in the year y, when  $ssb_0\leq y \leq r_0$;
   
   \item $r_0$ is the first year of recruitment;
   
   \item $wt\_{mat}^s_a$ is the proportion of mature females (in weight) at each age $a$ in each stock $s$ that is calculated as a product of the population weight at age ($wt\_pop^s_a$) and the maturity ($maturity^s_a$) as follows:
    \begin{equation}
        wt\_{mat}^s_a=wt\_pop^s_a *maturity^s_a, \ \ \ 1\leq a \leq m 
    \end{equation}
        
    \item $M^s_{y_0,m}$ is the natural mortality for stock s at age m in the year $y_0$;
    
    \item $R^s_{0}$ is the is the recruitment to the first regime of stock s;

    % \item spmo\_frac exponent of the survival rate ($S^s_{i,j}$), is computed as 
    % $spmo\_frac=\dfrac{spawnmo-1}{12}$.
    \item $s_f$ is computed as $s_f=\dfrac{s_p-1}{12}$, where $s_p$ is the spawning month.
    %\item spawnmo is input of file .dat, line 278.
    \item according to the equation (35), $SSB^s_y$ is iqual to virgen biomass $B^{s,1}_0$ for the years $ssb_0\leq y \leq r_0$.
\end{itemize}

\hfill

Also, the SSB is calculated for the years $r_0+1 \leq y \leq y_0 - 1$ and when $1\leq i \leq y_0-r_0$. First, the $nat_{age}$ is calculated as follows:\\

\begin{equation}
{nat_{age}}_{y=r_0+i,a}^s= e^{\epsilon^s_{r_0+i+1-a}+\mu^s_{R,r_0+i+1-a}}\prod_{t=1}^{a-1}e^{-M^s_{y_0,t}}, \ \ and \ \ 2\leq a \leq i+1
\end{equation}

\begin{equation}
{nat_{age}}_{y=r_0+i,a}^s=R^s_0\prod_{t=1}^{a-1}e^{-M^s_{y_0,t}}, \ \ i+2\leq  a \leq m-1
\end{equation}

\begin{equation}
{nat_{age}}_{y=r_0+i,m}^s={nat_{age}}_{r_0+i-1,m-1}^s
+{nat_{age}}_{r_0+i-1,m}^s e^{-M^s_{m}}, \ \ a=m
\end{equation}

With these previous calculations, the SSB is obtained:

\begin{equation}
    SSB^s_y=\sum_{a=2}^{m}{nat_{age}}_{y,a}^s e^{-M^s_{y_0}s_f} wt\_{mat}^s_a, \ \ r_0 + 1 \leq y \leq y_0 - 1
\end{equation}

After having calculated the numbers at age for each year and the survival rate (both depending on the choice of Popes, if true or false), the SSB is calculated for the stock s in the year y:

\begin{equation}
SSB^s_y=\sum_{a=1}^{m}N^s_{y,a}{(S^s_{y,a})}^{s_f}{wt\_{mat}}^s_a, \ \ y_0 \leq y \leq y_N.
\end{equation}

% \begin{itemize}
%     \item $wt\_pop^s_j$: es input, línea 140 del ctl. Peso a la edad $j$ de la población para cada stock $s$.
%     \item $maturity^s_j:$ es input, línea 143 del ctl. Madurez a la edad $j$ para cada stock $s$.
% \end{itemize}
%Calculo de la biomasa desovante para el año j=endyr+1.\\

Now for the year $y=y_N+1$:

\begin{equation}
    SSB^s_{y_N+1}=e^{\mu^s_{R,y_N+1}}(S^{s}_{y_N,1})^{s_f}{wt\_{mat}}^s_1+\sum_{a=2}^{m-1}(N^{s}_{y_N,a-1}S^{s}_{y_N,a-1})(S^s_{y_N,a})^{s_f}wt\_{mat}^s_a
\end{equation}
\begin{equation*}
 +(N^{s}_{y_N,m-1}S^s_{y_N,m-1}+N^s_{y_N,m}S^s_{y_N,m})(S^s_{y_N,m})^{s_f}wt\_{mat}^s_{m}.
\end{equation*}

But if the number of projected years is $nproj\_yrs>0$ then the SSB for the next year ($SSB^s_{y_N+1}$) is also projected over the time as function of futures numbers at age ($N^s_{fut}$) and survival rate ($S^s_{fut}$): 

\begin{equation}
    SSB^s_{y_N+1}= \sum_{a=1}^m wt\_{mat}^s_a{N_{fut}}^s_{y_N+1,a}({{S_{fut}}^s_{y_N+1,a}})^{s_f}
\end{equation}

where: 

\begin{itemize}

    \item ${S_{fut}}^s_{y_N+1,a} = e^{-M^s_{y_N}}$, is the survival rate future for iscen i=5.

    \item ${N_{fut}}^s_{y_N+1,a} = N^s_{y_N,a-1}S^s_{y_N,a-1}, \ \ 2\leq a \leq m-1$
    
    \item ${N_{fut}}^s_{y_N+1,m} = N^s_{y_N,m-1}S^s_{y_N,m-1}+N^s_{y_N,m}S^s_{y_N,m}$, \ \ a = m 
    
    \item ${N_{fut}}^s_{y_N,1} = SRecruit(SSB^s_{y_N+1-r_a},cum\_regs(s)+yy\_sr(s,y_N))*e^{\epsilon^s_{y_N+1}}$, where $SRecruit$ is a function of  spawning biomass and the number of regimen (for this function see Recruitment section).
    \item $\epsilon^s_{y_N+1}$ in this case is the future annual (for the year $y_N+1$) recruitment deviation for the stock s. 
    
\end{itemize}

%SRecruit is calculated in the recruitment section (from equation 50), it is a function with spawning biomass as the first argument and a regime number as the second argument.

\hfill

\subsubsection{c. Catches}\\

When the model is using the Popes's approximation, the total catch of stock ($C^s_{y,a}$) is calculated as a function of ${C_{tmp}}^{k_s}_{y,a}$ for each stock $s$ ($1\leq s \leq n_{stk}$) at age group $a$ in the year $y$ ($y_0 \leq y \leq y_N$): 

\begin{equation}
{C_{tmp}}^{k_s}_{y,a}=N^s_{y,a}*e^{-0.5M^s_{y,a}}* Se_{y,a}^{k_s}* \dfrac{c_{tmp}^{k_s}}{v_{bio}^{k_s}}, \ \  1\leq a \leq m, \ \ where
\end{equation}

\begin{equation}
v_{bio}^{k_s}=\sum_{a=1}^mN^s_{y,a}e^{-0.5M^s_{y,a}} Se_{y,a}^{k_s} w_{y,a}^{k_s}, \ \ and 
\end{equation}
    %\item If $popes=TRUE$, then pentmp=0. Let  $k_s$ the fisheries that correspond to the stock $s$:
    
%    para $1\leq a \leq m$, where
%    \begin{equation}
%        vbio=\sum_{a=1}^mN^s_{y,a}.e^{-\frac{M^s_{y,a}}{2}}.sel\_fsh_a(k_s,y).wt\_fsh_a(k_s,y),
%    \end{equation}
%    and 

\begin{equation}
c_{tmp}^{k_s} = v_{bio}^{k_s}-posfun\left(\frac{v_{bio}^{k_s} - {C_{obs}}_{k_s,y}}{v_{bio}^{k_s}} , 0.1 , pen_{tmp}=0 \right).v_{bio}^{k_s},
\end{equation}

 $k_s$ denotes the fisheries that correspond to the stock $s$.

%        \begin{equation}
%        catch\_tmp=vbio-posfun\left(\frac{(vbio - catch\_bio(k_s)_y)}{vbio} , 0.1 , pentmp \right).vbio,
%    \end{equation}

Following this, the catch of the stock ($C$), catch-at-age ($Cat$) and the predicted catch ($C_{pred}$) are calculated as follows:

\begin{equation}
        %catage\_tot(s,i)+=Ctmp, consultar
C^s_{y,a}=\sum_{k_s}{C_{tmp}}^{k_s}_{y,a} 
%(sum on the fisheries belonging to the stock s)
\end{equation}

\begin{equation}
%catage(k,i)=Ctmp
Cat^{k_s}_{y,a}={C_{tmp}}^{k_s}_{y,a},  \  \  \ 1\leq a \leq m
\end{equation}
and in the last optimization phase the predicted catch for the fishery $k_s$ in the year $y$ is calculated as follows 
\begin{equation}
{C_{pred}}^{k_s}_y=\sum_{a=1}^{m}{C_{tmp}}^{k_s}_{y,a} w_{y,a}^{k_s}
\end{equation} 
%$\begin{equation}
%pred\_catch(k_s,y)=\sum_{a=1}^{m}Ctmp_a.wt\_fsh_a(k_s,y).
%\end{equation} 

where:        
\begin{itemize}
    %\item $C^s_{y,a}$ is the total catch of stock $s$ for year $y$ at age $a$. It is used in eq. 6.
    %\item $Cat(k,y)_a$ is the catch at age $a$ of fishery $k$ in year $y$. It is used in eq. 6.
    %\item pred\_catch(k,y) is the predicted catch for year $y$ of fishery number $k$.

    \item $Se_{y,a}^{k_s}$ is the fishing selectivity of the fishery $k$ at the age $a$ in the year $y$;
    
    \item $w_{y,a}^{k}$ is the weight at age $a$ for the fishery $k$ in the year $y$ of observation;
    %Is input, line 80 of .dat file.
    
    \item $C_{obs}$ is the observed catch.
    
    %\item catch\_bio is the observed catch biomass
    
    %    \begin{equation}
    %      catch\_bio(k)_y=catch\_bio\_in(k)_y,  
    %    \end{equation}
    %    where $1\leq k \leq nfsh$ y $y_0\leq y \leq y_N$.

    %\item $catch\_bio\_in(k)_y$ is the observed catch of fishery $k$ in year $y$. Is input, line 16 of .dat file. 
 
\end{itemize}

However, when the Pope's approximation is not used, the catch-at-age and predicted catch are estimated as follows:

\begin{equation}
Cat^{k_s}_{y,a}=\dfrac{F^{k_s}_{y,a}}{F^s_{y,a}+M^{s}_{y}}\left(1-S^s_{y,a}\right)N^s_{y,a}
\end{equation}

%\begin{equation}
%Cat(k_s,y)_a=\dfrac{F^{k_s}_{y,a}}{Z^s_{y,a}}\left(1-S^s_{y,a}\right)N^s_{y,a},
%\end{equation}

\begin{equation}
{C_{pred}}^{k_s}_y=\sum_{a=1}^{m}Cat^{k_s}_{y,a}*w_{y,a}^{k_s}.
\end{equation}

%\begin{equation}
%pred\_catch(k,y)=\sum_{a=1}^{m}Cat(k,y)_a.wt\_fsh_a(k,y),
%\end{equation}

%where $Z^s_{y,a}=F^s_{y,a}+M^{s}_{y}$ 

\hfill

\subsubsection{d. Calculation of zero biomass}

The zero biomass (also called virgin biomass) is calculated for each regime $1\leq r \leq  n_{regs}$. This estimation is needed to calculate recruitment and is calculated as follows:

% \begin{equation}
%     Bzero(cum\_regs(s)+1)=wt\_mature(s)_1.e^{-M^s_{styr,1}.spmo\_frac}.Rzero(cum\_regs(s)+1)
% \end{equation}
%cambiando Rzero(cum\_regs(s)+1) por R^s_0.
% \begin{equation}
%     Bzero(cum\_regs(s)+1)=wt\_mature^s_1.e^{-M^s_{styr,1}.spmo\_frac}.R^s_0
% \end{equation}

\begin{equation}
    B^{s,1}_0=wt\_{mat}^s_1*e^{(-M^s_{y_0,1})(s_f)}*R^{s,1}_0
  +\sum_{a=2}^{m-1}wt\_{mat}^s_a*e^{(-M^s_{y_0,a})(s_f)}*R^{s,1}_0\prod_{l=1}^{a-1}e^{-M^s_{y_0,l}} 
+ wt\_{mat}^s_{m}*e^{(-M^s_{y_0,m})(s_f)}\frac{R^{s,1}_0}{1-e^{-M^s_{y_0,m}}}\prod_{l=1}^{m-1}e^{-M^s_{y_0,l}},
\end{equation}

and for the rest of regimes
\begin{equation}
    B^{s,r}_0 = SSB^s_{reg\_shift(s,r-1)-r_a}, \ \ \ 2\leq r \leq n_{reg_s}
\end{equation}

where: 
\begin{itemize}
    \item $n_{regs}$ is the total number of regimes, that is the sum of the number of regimes of all stocks;
    \item $n_{reg_s}$ is the number of regimes of stock number s;
    \item %Bzero(cum\_regs(s)+1) es la biomasa virgen en el primer régimen del stock s.
    $B^{s,1}_0$ is the virgin biomass for the first regime belonging to the stock s;
    \item  
    $B^{s,r}_0$ is the virgin biomass for regime r belonging to stock s with $2\leq r \leq n_{reg_s}$;
    \item $R_0^{s,1}$ is the recruitment for the first regime belonging to the stock s, It is obtained from equation (42);
    \item $reg\_shift(s,r-1)$ year of regime change, is input in line 41 of .ctl file, for each stock s and regime number $r$.
    %\item $a_R$ rec\_age$ is the age at which recruitment is feasible.
\end{itemize}

\hfill

\subsubsection{e. Stock-Recruitment Parameters}

%Let $r$ be a given regime number, that is, $1\leq r \leq nregs$.\\
The parameters of the recruitment curve ($\alpha^r$, $\beta^r$ for each regimen $r$ i.e $1\leq r \leq n_{regs}$) are calculated according to the specified stock-recruitment relationship type (sr\_type). Also, they are parameterized in terms of the steepness of the stock-recruitment relationship (h), the recruitment to the first regime of stock ($R_0$), and the virgin biomass ($B_0$).\\

Using the Ricker stock-recruitment relationship (sr\_type = 1):

\begin{equation}
\alpha^r = log\left(\dfrac{-4h^{r_s}}{h^{r_s}-1}\right).
\end{equation}

Using the Beverton-Holt stock-recruitment relationship (sr\_type = 2):

\begin{equation}
\alpha^r = \dfrac{B^{r}_0}{R^{r}_0}\left(\dfrac{1 - h^{r_s}}{4h^{r_s}}\right),  
\end{equation}

\begin{equation}
\beta^r = \dfrac{5h^{r_s}-1}{4h^{r_s}R^{r}_0}.
\end{equation}

When sr\_type = 4:

\begin{equation}
\alpha^r = log\left(\dfrac{R^{r}_0}{B^{r}_0}\right)+\beta*B^{r}_0, 
\end{equation}

\begin{equation}
\beta^r = log\left(\dfrac{5h^{r_s}}{0.8*B^{r}_0}\right)
\end{equation}

where:

\begin{itemize}

\item $R^{r}_0$ is the recruitment for regimen number $r$, where $1\leq r \leq n_{regs}$, it is obtained from 
\begin{equation}
    R^r_0=e^{log\_Rzero^r},
\end{equation}
$log\_Rzero$ is a parameter to be estimated.
\item $h^{r_s}$ is the steepness of regimen number $r_s$ of all regimes belonging to stock s, the stock to which regime r belongs.  Remember that r is varying among the total number of regimes of all stocks.




\item $B^{r}_0$ is the virgin biomass for regime number $r$ where $1\leq r \leq n_{regs}$, this was calculated in section $d$.

%\item $irec=rec\_map(stk\_reg\_map(1,r),stk\_reg\_map(2,r))$, where $rec\_map$ is the recruitment matrix, it is input in the line 23 of .ctl file.

%\item $stk\_reg\_map$ is a matrix of dimensions 2xnregs, where $stk\_reg\_map(2,r)$ is the regime number $r_s$, with $1\leq r_s \leq nreg(s)$, corresponding to stock number $s=stk\_reg\_map(1,r)$.
\end{itemize}

\hfill

\subsubsection{e. Recruitment}

%(considerar escribir desde Von Bertalanfy hasta Age composition to length composition antes de numeros a la edad, así luego de reclutamiento iría selectividad).\\

The number of recruits is calculated for each year $y$, where $y_0\leq y \leq y_N$ and stock $s$ ($1\leq s \leq n_{stk}$):

\begin{equation}
    recruits^s_y =N^s_{y,a = 1}, \ \text{and}
%es calculado en la función calc_dependent_vars
\end{equation}


% \begin{equation}
%     recruits(s,endyr+1)=e^{\mu_{R,cum\_regs(s)+yy\_sr(s,endyr+1)}}.
% \end{equation}
\begin{equation}
    recruits^s_{y}=e^{\mu^s_{R,y_N+1}}, \ when \ y = y_{N+1}.
\end{equation}

Besides, the recruitment is calculated according to the specified curve type of the stock-recruitment relationship. Also to graph the stock-recruitment curve i.e $stock^r_i$ vs $SRecruit(stock^r_i, r)$, It will depend on the virgin biomass of the stock ($stock_i^r$), as follows:

\begin{equation}
stock^r_i=\dfrac{2i*B^{r}_0}{250}, \ \ 1\leq i \leq 300, \ 1\leq r \leq n_{regs},
\end{equation}

$SRecruit(stmp, r)$ is the recruitment depending of stock (stmp) and regime r, with $1\leq r \leq n_{regs}$, defined by:
\begin{itemize}

\item When $sr_{type}=1$ (Ricker form from Dorn):

    \begin{equation}
    SRecruit(stmp, r) = \dfrac{R^{r}_0* stmp}{B^{r}_0}*e^{\alpha^r \left(1-\dfrac{stmp}{B^{r}_0}\right)}
    \end{equation}

\item When $sr_{type}=2$ (Beverton-Holt form):

    \begin{equation}
    SRecruit(stmp, r) = \dfrac{stmp}{\alpha^r+\beta^r* stmp}
    \end{equation}

\item When $sr_{type}=3$ (mean recruitment):

    \begin{equation}
    SRecruit(stmp, r) = e^{\mu_{R,r}},
    \end{equation}

    where $\mu_{R,r}$ is the average recruitment in the regime $r$.

\item When $sr_{type}=4$ (old Ricker form):

    \begin{equation}
    SRecruit(stmp, r) =  stmp *e^{\alpha^r-stmp *\beta^r}
    \end{equation}

\end{itemize}

%Finally, the points are plotted $(stock^r_i, SRecruit(stock^r_i,r))$ for each regime $1\leq r \leq nregs$.

\hfill

\subsubsection{g. Von Bertalanffy growth model}

For the fish growth the JJM uses the von Bertalanffy growth model.

\begin{equation}
    \mu_{age}(r,1)=L_0(r)
\end{equation}
\begin{equation}
    \mu_{age}(r,i)=Linf(r)(1-e^{-{k\_coeff(r)}})+\mu_{age}(r,i-1)(e^{-k\_{coeff(r)}}).
\end{equation}
 \begin{itemize}
    \item $\mu_{age}(r,i)$ is the mean lenght for each age group $i$.
     \item $r$ is a integer between $1\leq r \leq ngrowth$ (maximum of the Growth map matrix values). 
     \item $Linf(r)$ is the maximum lenght.
     \item $k\_coeff(r)$ is the parameter curvature.
     \item $L_0(r)$ is the lenght initial.
     
 \end{itemize}

\hfill

\subsubsection{h. Equation weight at lenght}
\begin{equation}
     wt\_age\_vb(r,i) = lw\_a * \left(\mu_{age}(r,i)\right)^{lw\_b}
 \end{equation}
 \begin{itemize}
     \item $wt\_age\_vb(r,i)$ is the weight at lenght $\mu_{age}(r,i)$ for $1\leq i \leq m$.
     \item $lw\_a$, $lw\_b$ are growth parameters given by  $lw\_a=0.007778994e-3$ and $lw\_b=3.089248476$ in the model.
 \end{itemize}

\hfill

\subsubsection{i. Maturity equation}
 \begin{equation}
    maturity\_vb(r,i) = \dfrac{1}{1+e^{32.93-1.45.\mu_{age}(r,i)}}
\end{equation}
\begin{itemize}
    \item $maturity\_vb(r,i)$ is the proportion of mature species at lenght $\mu_{age}(r,i)$ for $1\leq i \leq m$.
\end{itemize}

\hfill

\subsubsection{j. Age composition to length composition}

It uses normal Distribution to calculate the probability 
\begin{equation}
    P(l-0.5\leq X_a\leq l+0.5 ) = P\left(\dfrac{(l-0.5)-\mu_a}{\sigma_a}\leq Z\leq\dfrac{(l+0.5)-\mu_a}{\sigma_a}\right),
\end{equation}
where $P(l-0.5\leq X_a\leq l+0.5 )$ is the probability that the number of fish at age group "$a$" varies in lenght between  $l-0.5$ and $l+0.5$.\\Be the fixed integer $r$ such that $1\leq r \leq ngrowth$.
The right expression in (54) is the normalization for $X_a$ since $X_a$ is (assumed) a random variable with normal distribution, mean $\mu_a:=\mu_{age}(r,a)$ and  standard deviation $\sigma_{a}:=sd_{age}(r).\mu_{age}(r,a)$.\\

Let $P\_age2len_r$ the matrix such that $Cl(1,nyears,1,n_L)=C(1,nyears,1,m).P\_age2lenght_r$ where $n_L$ is the number of sizes considered (input line 9 in .dat file), $Cl$ is the matrix composition for lenghts that we want to obtain and $C$ is the matrix composition for ages. The elements of $P\_age2len_r$ are calculates as:
\begin{equation}
    P\_age2len_r(a,j) = \dfrac{P(l_j-0.5\leq X_a\leq l_j+0.5 )}{\displaystyle\sum_{a=1}^mP(l_j-0.5\leq X_a\leq l_j+0.5 )}.
\end{equation}

\begin{itemize}
    %\item $P\_age2len$ is a array with dimensions  $(1,ngrowth,1,m,1,n_L)$.
    \item where $1\leq a \leq m$, $1\leq j \leq n_L$,
    \item $sd_{age}(r)$ is obtained  for each r with $1\leq r\leq ngrowth$ as $sdage(r)   = e^{log\_sdage(r)}$, where log\_sedage is a parameter to be estimated.
    \item $l_j$ is the lenght $jth$ considered from the vector $len\_bins$ (i.e $lengthbin$, input %line 10
    in the .dat file).
\end{itemize}

\subsubsection{k. Survey Predictions}

Prediction from the index number k in year y is $pred\_ind(k,y)$, with $1\leq y \leq nyrs_{ind}^k$, where $nyrs_{ind}^k$ is the number of years of observation for survey number $k$ and it is input.

%(is located on line 138 of the .dat file).\\
Let us first calculate $q\_ind(k,y)$ for each survey $1\leq k \leq n_{ind}$ and each year of observation $1\leq y \leq nyrs_{ind}^k$ by cases as follows
\begin{equation}
q\_ind(k,y)=e^{log\_q\_ind(k)}, \ for \ 1\leq y < yrs\_rw\_q(k,1)-yrs\_ind(k,1)+1;
\end{equation}

now let $i\in\mathbb{N}$ such that $2\leq i \leq 1+npars\_rw\_q^k$ and $p_i=yrs\_rw\_q(k,i-1)-yrs\_ind(k,1)+1$ then
\begin{equation}
     q\_ind(k,p_i)  = q\_ind(k,p_i-1)*e^{log\_rw\_q\_ind(k,i-1)};
\end{equation}
and for the last case
\begin{equation}
    q\_ind(k,iyr)  = q\_ind(k,p_i), \ for \ p_i+1\leq iyr \leq nyrs_{ind}^k.
\end{equation}

\begin{itemize}
    \item log\_q\_ind(k) is a parameter to be estimated for each index survey k and defined as $log\_q\_ind(1,n_{ind},phase\_q)$. It is initialized with $log\_qprior=log(qprior)$ and qprior is input.
    %  yrs_ind(k)  = yrs_ind_in(k)(1,nyrs_ind(k)), yrs_ind_in es input linea 141 del dat
    \item $npars\_rw\_q^k$ is input for each index survey k.
    \item $yrs\_ind(k,1)$ is the first year of observation for the survey number $k$.
    \item yrs\_rw\_q(k,i) is input for each index survey k and $1\leq i \leq npars\_rw\_q^k$, %line 95 of .ctl file.
    \item yrs\_ind(k) is the set of years of observation of survey number k. 
    \item log\_rw\_q\_ind(k) is a parameter to be estimated for each index survey k and defined as $log\_rw\_q\_ind(1,n_{ind},1,npars\_rw\_q,phase\_rw\_q) $.
\end{itemize}


Now we calculate the prediction for the survey number k in the year $1\leq y \leq nyrs_{ind}^k$:
\begin{equation}
    pred\_ind(k,y)=q\_ind(k,y)*
\end{equation}
% \begin{equation}
%     \left(\left(\sum_{age \ j}natage_j(istk,iyr).S(istk,iyr)_j^{ind\_month\_frac(k)}sel\_ind_j(k,iyr).wt\_ind_j(k,iyr)\right)\right)^{q\_power\_ind(k)}
% \end{equation}
\begin{equation}
    \left(\left(\sum_{j=1}^mN^{istk}_{iyr,j}.{S^{istk}_{iyr,j}}^{ind\_month\_frac(k)}sel\_ind_j(k,iyr).wt\_ind_j(k,iyr)\right)\right)^{q\_power\_ind(k)},
\end{equation}
with $iyr=yrs\_ind(k,y)$.
\begin{itemize}
\item $n_{ind}$ is the total number of index.
\item $yrs\_ind(k,y)$ is the $yth$ year belonging to the set $yrs\_ind(k)$.

    %\item $ind\_month\_frac$ es un vector de dimensiones (1,nind) y se calcula como $ind\_month\_frac(k)=\dfrac{mo\_ind(k)-1}{12}$, donde $mo\_ind(k)$, para cada pesquería número $k$, está en la línea 144 del archivo dat.
    \item $ind\_month\_frac$ is calculated for each fishery $k$ as $ind\_month\_frac(k)=\dfrac{mo_{ind}(k)-1}{12}$, where $mo_{ind}$ is input.
    %is on line 144 of the .dat file.
    \item $istk=sel\_map(1,k+n_{fsh})$ 
i.e., it is the stock number corresponding to the survey number $k$.
    %\item $iyr=yrs\_ind(k,i)$, índice número $k$ y año número $i$.
    \item $sel\_ind_j(k,iyr)$ 
is the selectivity index of survey number k in year iyr at age j.
    \item $wt\_ind_j(k,iyr)$ 
weight composition at age group j in year iyr of survey number $k$. %It is input, line 171 of the .dat file.
    \end{itemize}
    Now calculate the expected age composition from the index (i.e eac\_ind(1,$n_{ind}$,1,nyrs\_ind\_age,1,m)).\\
Let $i$ be the index of the year for which age data are available for survey $k$, that is, $1\leq i \leq nyrs\_ind\_age(k)$:
\begin{itemize}
        \item [i.] If $use\_age\_err$=TRUE then: 
    \begin{equation}
        eac\_ind_j(k,i)=\sum_{l=1}^m \left(age\_err(j,l)*\dfrac{tmp\_n_l}{\sum_{j=1}^mtmp\_n_j}\right),
    \end{equation}
        \item [ii.] If $use\_age\_err$=FALSE :
        \begin{equation}eac\_ind_j(k,i)=\dfrac{tmp\_n_j}{\sum_{j=1}^mtmp\_n_j}
    \end{equation}

where \begin{equation}
    tmp\_n_j= {S^{istk}_{iyr,j}}^{ind\_month\_frac(k)}.sel\_ind_j(k,iyr).N^{istk}_{iyr,j},
% \end{equation}.
\end{equation}
 $iyr=yrs\_ind\_age(k,i)$ and $1\leq j\leq m$.
    \end{itemize}
\begin{itemize}
    \item nyrs\_ind\_age(k) is the number of years with available data for each  index survey k. It is input. 
    \item use\_age\_err is input.
    \item age\_err(j,l) is matrix input for each group age j and each age group l.
    \item yrs\_ind\_age(k,i) is the year of index i for which index survey k age data are available. 
\end{itemize}


Now the expected size composition (i.e elc\_ind(1,$n_{ind}$,1,nyrs\_ind\_length,1,nlength)) is calculated from the index. Let $i$ be the index of the year for which size data are available for survey $k$, i.e.   $1\leq i \leq nyrs\_ind\_length(k)$:
\begin{equation}
    elc\_ind_l(k,i)=\sum_{j=1}^m\dfrac{tmp\_n_j}{\left(\displaystyle\sum_{j=1}^mtmp\_n_j\right)}*P\_age2len_{igrowth}(j,l), \ 1\leq l \leq n_L
\end{equation}
where

\begin{equation}
    tmp\_n_j= {\left(S^{istk}_{iyr,j}\right)}^{ind\_month\_frac(k)}sel\_ind(k,iyr)_j.N^{istk}_{iyr,j}, \ 1\leq j \leq m
\end{equation}
and
\begin{equation}
    igrowth=growth\_map(istk,yy\_sr(istk,iyr)).    
\end{equation}

\begin{itemize}

    \item growth\_map is the growth matrix, It is input. %located in line 43 of file .ctl.
    \item $P\_age2len_{igrowth}(j,l)$ is the element of the respective matrix at age group $j$ and size $l$.
    \item iyr=$yrs\_ind\_length(k,i)$, year of index i for which survey $k$ length data are available.
    
    %año de índice i para el cuál se tienen datos de longitud del survey $k$.
    \item $yy\_sr(istk,iyr)$ 
    \end{itemize}
    
Index predicted for the next year of the survey $k$, pred\_ind\_nextyr(k), is calculated from:
\begin{equation}
    pred\_ind\_nextyr(k)=q\_ind(k,nyrs\_ind(k)) * 
\end{equation}
\begin{equation*}
    \left( SRecruit. {\left(S^{istk}_{y_N,1}\right)}^{ind\_month\_frac(k)} sel\_ind_1(k,y_N)  wt\_ind_1(k,y_N)\right.
\end{equation*}


\begin{equation}
+\sum_{i=2}^{m-1}S^{istk}_{y_N,i-1}N^{istk}_{y_N,i-1}{\left(S^{istk}_{y_N,i}\right)}^{ind\_month\_frac(k)} sel\_ind_i(k,y_N)  wt\_ind_i(k,y_N)+
\end{equation}
\begin{equation*}
  \left. (S^{istk}_{y_N,m-1}.N^{istk}_{y_N,m-1}+N^{istk}_{y_N,m}S^{istk}_{y_N,m}){\left(S^{istk}_{y_N,m}\right)}^{ind\_month\_frac(k)} sel\_ind_m(k,y_N)  wt\_ind_m(k,y_N) \right)^{q\_power\_ind(k)},
\end{equation*}
with
%\begin{equation}
%    SRecruit=SRecruit(Sp\_Biom(istk,y_N+1-r_a),cum\_regs(istk)+yy\_sr(istk,styr\_fut)).
%\end{equation}

\begin{equation}
    SRecruit=SRecruit(SSB^{istk}_{y_N+1-r_a},cum\_regs(istk)+yy\_sr(istk,styr\_fut)).
\end{equation}


\subsubsection{l. Fishery Predictions}
Calculate the expected age composition (i.e eac\_fsh(1,$n_{fsh}$,1,$Fnyrs_{age}$,1,m)) for fisheries. Let $y$ be the index of the year for which age data are available for fishery $k$, i.e.   $1\leq y \leq Fnyrs^k_{age}$ and the age group $a$:
%catage_a(k,i):Cat_a(k,y)
\begin{itemize}
%     \item [i.] If $use\_age\_err=TRUE$:
%     \begin{equation}
%     eac\_fsh(k,i)=age\_err.\dfrac{catage(k,yrs\_fsh\_age(k,i))}{sum(catage(k,yrs\_fsh\_age(k,i)))}
% \end{equation}
\item [i.] If $use\_age\_err=TRUE$:
    \begin{equation}
    {eac{fsh}}_a(k,y)=age\_err.\dfrac{Cat_{Fyrs^{k,y}_{age},a}^k}{\displaystyle\sum_{a=1}^mCat_{Fyrs^{k,y}_{age},a}^k}
\end{equation}
% \item [ii.] If $use\_age\_err=FALSE$:
% \begin{equation}
%     eac\_fsh(k,i)=\dfrac{catage(k,yrs\_fsh\_age(k,i))}{sum(catage(k,yrs\_fsh\_age(k,i)))}.
% \end{equation}
\item [ii.] If $use\_age\_err=FALSE$:
\begin{equation}
    eacfsh_a(k,y)=\dfrac{Cat_{Fyrs^{k,y}_{age},a}^k}{\displaystyle\sum_{a=1}^mCat_{Fyrs^{k,y}_{age},a}^k},
\end{equation}
\end{itemize}
for $1\leq a \leq m$.
After calculate eac\_fsh as:
\begin{equation}
    eac\_fsh_a(k,y)=\dfrac{eacfsh_a(k,y)}{\displaystyle\sum_{a=1}^m eacfsh_a(k,y)}, \ 1\leq a \leq m.
\end{equation}
Now for lenghts. Calculate the expected length composition (i.e elc\_fsh(1,$n_{fsh}$,1,$Fnyrs_{length}$,1,$n_L$)) for fisheries from: 
% \begin{equation}
% elc\_fsh(k,i)=catage(k,yrs\_fsh\_length(k,i))*P\_age2len(igrowth^{istk}_{iyr}),
% \end{equation}
\begin{equation}
elcfsh_l(k,y)=\sum_{a=1}^m Cat_{Fyrs^{k,y}_{length},a}^k*P\_age2len_{igrowth^{istk}_{iyr}}(a,l),
\end{equation}
finally
\begin{equation}
elc\_fsh_l(k,y)=\dfrac{elcfsh_l(k,y)}{\displaystyle\sum_{l=1}^{n_L} elcfsh_l(k,y)},
\end{equation}
where $1\leq y \leq Fnyrs^k_{length}$ and \\
\begin{itemize}
    \item $igrowth^{istk}_{iyr}=growth\_map(istk,yy\_sr(istk,iyr))$, where $istk$ is the stock number corresponding to fishery number $k$, $iyr$ is the index year i for which fishery k has data available and $growth\_map$ is input.
    %on line 43 of .ctl file.
\end{itemize}

\subsubsection{m. Selectivity}
- The treatment of selectivity patterns and how they are shared among fisheries and indices need to be specified. Also the selectivity for each fleet, and depending on the model configuration, some growth functions were employed inside the model to convert model-predicted age compositions to length compositions, in order to fit the model to the length composition data.\\

Let $k$ the number of fishery and $y$ is the year between $y_0$ and $y_N$.
Depending on which values $fsh\_sel\_opt$ takes(for this fishery k) in order to calculate the logarithm of fishery selectivity $log\_sel\_fsh$:
\begin{itemize}
\item If $fsh\_sel\_opt=1:$\\

$y_0$is assumed as the first year of selectivity change, that is $yrs\_sel\_ch\_fsh(k,1)=y_0$, then the rest of the years of selectivity change are taken into account being stored in $yrs\_sel\_ch\_fsh(k,y)$, for $2\leq y \leq n\_sel\_ch\_fsh(k)$. $yrs\_sel\_ch\_fsh(k,y)$ and $n\_sel\_ch\_fsh(k)$  are given in the .ctl file.
%on line 116.
\begin{itemize}
    \item $yrs\_sel\_ch\_fsh(k)$ contains the years of selectivity change for each fishery number k.
    \item $n\_sel\_ch\_fsh(k)$is the number of selectivity changes for the fishery $k$.
    
\end{itemize}

%También sel\_change\_in\_fsh(k,styr)=1. 
% Se calcula los valores para $log\_selcoffs\_fsh\_in$( logaritmo de los coeficientes de selectividad (?) ) desde el primer cambio de selectividad hasta el cambio número $n\_sel\_ch\_fsh(k)$ para la respectiva pesquería número $k$:
% \begin{equation}
%     log\_selcoffs\_fsh\_in(k,jj)_l=\log\left(\dfrac{sel\_fsh\_tmp_l+1e-7}{\dfrac{1}{nselages\_in\_fsh(k)}\displaystyle\sum_{p=1}^{nselages\_in\_fsh(k)}(sel\_fsh\_tmp_p+1e-7)}\right),
% \end{equation}
% for $1\leq l \leq nselages\_fsh(k)$ y $1\leq jj \leq n\_sel\_ch\_fsh(k)$.
% %Ahora calculamos $log\_selcoffs\_fsh\_in(k,jj)$, que es el logaritmo de los coeficientes de selectividad para la pesquería número $k$ y el cambio de selectividad número $jj$, donde $2\leq jj \leq nsel\_ch\_fsh(k)$(se utilizaría esto si cambiara sel\_fsh\_tmp_j para 1\leq j \ļeq nselages\_in\_fsh(k) pero no cambia solo cambia para nselages\_in\_fsh +1 \leq j \leq nages) :

% %\begin{equation}
% %    log\_selcoffs\_fsh\_in(k,jj)_l = 
% %\end{equation}

% \begin{itemize}
%     \item $sel\_fsh\_tmp_j$ es el coeficiente de cambio de selelctividad para cada edad $j$, con $1\leq j \leq nages$. Es input, línea 119 del archivo .ctl.
%     \item Además para esta opción (fsh\_sel\_opt(1)), se asigna a la fase de coeficientes de selectividad para la pesquería $k$ ($phase\_selcoff\_fsh(k)$):
%     \begin{equation}
%         phase\_selcoff\_fsh(k)=phase\_sel\_fsh(k),
%     \end{equation}
%     \end{itemize}

%     donde $phase\_sel\_fsh(k)$ es la fase de minimización(del parámetro log\_selcoffs\_fsh?), input dada en la línea 111 del ctl, asímismo si este es negativo entonces se calculan los valores de inicialización para $log\_selcoffs\_fsh$ de la siguiente manera:
%     \begin{equation}
%         log\_selcoffs\_fsh(k,jj)\_l = log\_selcoffs\_fsh\_in_l
%     \end{equation}
% for $1\leq l \leq nselages\_in\_fsh(k)$ and $1\leq jj \leq n\_sel\_ch\_fsh(k)$.\\

We calculate the selectivity of the fishery $k$ in the year $y_0\leq y \leq y_N$ and each age group $a$. Let $A$ be the set of years of selectivity change for a given fishery k( i.e $A= yrs\_sel\_ch\_fsh(k)$, as stated above, it includes $y_0$) and $p_i\in A$  some element of $A$ ($p_{i+1}$ would be the next year of selectivity change):
 \begin{equation}
        log\_sel\_fsh_a(k,y)=log\_selcoffs\_fsh_a(k,jj_{p_i})-log\left(\dfrac{1}{m}.\left(\sum_{i=1}^{nselages\_fsh(k)}e^{log\_selcoffs\_fsh_i(k,jj_{p_i})}+\right.\right.
    \end{equation}
    \begin{equation*}
       \left. \left.\sum_{i=nselages\_fsh(k)+1}^{m}e^{log\_selcoffs\_fsh_{nselages\_fsh(k)}(k,jj_{p_i})}\right)\right), 
    \end{equation*}
   for $\ 1\leq a \leq nselages\_fsh(k)$.\\
   
  Now for the remaining ages:
    \begin{equation}
         log\_sel\_fsh_a(k,y)=log\_selcoffs\_fsh_{nselages\_fsh(k)}(k,jj_{p_i})-log\left(\dfrac{1}{m}.\left(\sum_{i=1}^{nselages\_fsh(k)}e^{log\_selcoffs\_fsh_i(k,jj_{p_i})}+\right.\right.
    \end{equation}
 \begin{equation*}
       \left. \left.\sum_{i=nselages\_fsh(k)+1}^{m}e^{log\_selcoffs\_fsh_{nselages\_fsh(k)}(k,jj_{p_i})}\right)\right), 
    \end{equation*}
    where $nselages\_fsh(k)\leq a \leq m$ and $p_i\leq y < p_{i+1}$.\\
    Also is calculated
    \begin{equation}
        avgsel\_fsh(k,jj_{p_i})=log\left(\dfrac{1}{nselages\_fsh(k)}\left( \sum_{i=1}^{nselages\_fsh(k)}e^{log\_selcoffs\_fsh_i(k,jj_{p_i})}\right)\right).
    \end{equation}
    
    
    \begin{itemize}
        \item $jj_{p_i}$is the change number that corresponds to the year of change $p_i\in A$.
        \item $log\_selcoffs\_fsh$ is parameter to estimate, it is initialized in function of  $log\_selcoffs\_fsh\_in$ if $phase\_selcoff\_fsh(k)<0$. %In the tpl it is declared as $log\_selcoffs\_fsh(1,n_{fsh},1,n\_sel\_ch\_fsh,1,nselages\_fsh,phase\_selcoff\_fsh)$.
        \item $nselages\_fsh(k)=nselages\_in\_fsh(k)$, where $nselages\_in\_fsh(k)$ is input for each fishery $k$.
    \end{itemize}














    
   
   % \begin{equation}
   %     log\_sel\_fsh(k,styr)_j=sel\_coffs\_tmp_j-log\left(\dfrac{1}{nages}*%%\left(\sum_{l=1}^{nselages\_fsh(k)}e^{sel\_coffs\_tmp_l}+\right.\right.
  %  \end{equation}
   % \begin{equation*}
    %   \left. \left.\sum_{l=nselages\_fsh(k)+1}^{nages}e^{sel\_coffs\_tmp_{nselages\_fsh(k)}}\right)\right), \ 1\leq j \leq nselages\_fsh(k).
    %\end{equation*}
    %\begin{equation}
    %    sel\_coffs\_tmp_j=\log\left(\dfrac{sel\_fsh\_tmp_j+1e-7}{mean(sel\_fsh\_tmp(1,nselages\_in\_fsh(k))+1e-7)}\right)
    %\end{equation}
   % \begin{itemize}
   %     \item $sel\_fsh\_tmp$ is input line 119 of ctl (?).
   % \end{itemize}
   % Now for $nselages\_fsh(k)\leq j \leq nages$:
   % \begin{equation}
   %     log\_sel\_fsh(k,styr)=log\_sel\_fsh(k,styr)_{nselgaes\_fsh(k)}.
   % \end{equation}
   % Now calculate $log\_sel\_fsh$ para el resto de años de cambio de selectividad. La selectividad es lo mismo para los años que siguen a menos que haya un cambio (año de cambio de selectividad, estos años están ubicados en la línea 116 del ctl).
    %\begin{equation}
    %    sel\_fsh\_tmp_j=sel\_fsh\_tmp(nselages\_in\_fsh(k)), \ nselages\_in\_fsh(k)+1\leq j \leq nages.
    %    \end{equation}
    
\item If $fsh\_sel\_opt=2:$ 
Let $p_i$ as before and  $p_i\leq y < p_{i+1}$
\begin{equation}
            log\_sel\_fsh_a(k,y)=-log( 1.0 + e^{(-1.sel\_slope\_fsh(k,jj_{p_i}) * ( age\_vector_a - sel50\_fsh(k,jj_{p_i})) )})
        \end{equation}
        for $1\leq a \leq nselages\_fsh(k)$;
        \begin{equation}
            log\_sel\_fsh_a(k,y)=log\_sel\_fsh_{nselages\_fsh(k))}(k,y),
        \end{equation}
        for $nselages\_fsh(k) \leq a \leq m$.
        \begin{itemize}
            \item $sel\_slope\_fsh(k,jj_{p_i}) = e^{logsel\_slope\_fsh(k,jj_{p_i})}$.
            \item logsel\_slope\_fsh and sel50\_fsh are parameters to be estimated.
            \item $age\_vector$ is calculated as follows: $age\_vector_a=2*(a+r_a-1)$, for $1\leq a \leq m$
            %and defined by $age\_vector(1,nages)$
            .
        \end{itemize}


        
\item If $fsh\_sel\_opt=3:$ Let $p_i$ as before,
 \begin{equation}
        log\_sel\_fsh_a(k,y)     = \left( -log(1.0 + e^{(\frac{-2.9444389792}{du}.( age\_vector_a - bu) )}) \right.
    \end{equation}
    \begin{equation*}
         \left.+log\left(1 - \dfrac{1}{1 + e^{\left(\frac{-2.9444389792}{dd} ( age\_vector_a - bd)\right)}} \right) \right)+0.102586589 
    \end{equation*}
      for $1\leq a \leq nselages\_fsh(k)$.\\
      Now for the remaining ages:
    \begin{equation}
        log\_sel\_fsh_a(k,y) = log\_sel\_fsh_{nselages\_fsh(k)}(k,y),
    \end{equation}
    for $nselages\_fsh(k)\leq a \leq m$.
    \begin{itemize}
        \item %$bu = sel\_p1\_fsh(k,jj_{p_i})$
        $bu = e^{logsel\_p1\_fsh(k,jj_{p_i})}$
        \item 
        $du = e^{logsel\_p2\_fsh(k,jj_{p_i})}$
        %$du = sel\_p2\_fsh(k,jj_{p_k})$
        \item
        $dd = e^{logsel\_p3\_fsh(k,jj_{p_i})}$
        %$dd = sel\_p3\_fsh(k,jj_{p_i})$
        \item $bd = bu + du + dd$.
        \item $logsel\_p1\_fsh$, $logsel\_p2\_fsh$ and $logsel\_p3\_fsh$ are parameters to be estimated.
    \end{itemize}
    
    \end{itemize}

Now for the surveys. We calculate the selectivity of index survey $k$ in the year $y$, $y_0\leq y \leq y_N$, and for each age group $a$:\\
\begin{itemize}

\item If $ind\_sel\_opt=1$:
Let $B$ the set of years of selectivity change for a given index k (i.e $B= yrs\_sel\_ch\_ind(k)$, besides $y_0\in B$) y $p_i\in B$, some element of $B$:
\begin{equation}
    sel\_tmp_{y,a} = log\_selcoffs\_ind_a(k,jj_{p_i})
\end{equation}
for $1\leq a \leq nselages\_ind(k)$.
Now for remaining ages
\begin{equation}
    sel\_tmp_{y,a}= log\_selcoffs\_ind_{nselages\_ind(k)}(k,jj_{p_i}),
\end{equation}
for $nselages\_ind(k)\leq a \leq m$. \\

Now we calculate $log\_sel\_ind$ as
     \begin{equation}
        log\_sel\_ind_a(k,y)=sel\_tmp_{y,a}-log\left(\dfrac{1}{q\_age\_max(k)-q\_age\_min(k)+1}\sum_{i=q\_age\_min(k)}^{q\_age\_max(k)}sel\_tmp_{y,i}\right)
    \end{equation}
    for $1\leq a \leq m$ and $p_i\leq y < p_{i+1}$.\\
    Also is calculated
    \begin{equation}
        avgsel\_ind(k,jj_{p_i})=log\left(\dfrac{1}{nselages\_ind(k)}\left( \sum_{i=1}^{nselages\_ind(k)}e^{log\_selcoffs\_ind_i(k,jj_{p_i})}\right)\right).
    \end{equation}
    
\begin{itemize}    
    \item $jj_{p_i}$ is the change number corresponding to the change year  $p_i\in B$.
    \item $log\_selcoffs\_ind$ is parameter to estimate.
     \item $nselages\_ind(k)=nselages\_in\_ind(k)$, where $nselages\_in\_ind(k)$ is input for each index survey $k$.
     \item $q\_age\_max$, $q\_age\_min$ are input and $q\_age\_min(k) \leftarrow  q\_age\_min(k) - r_a + 1$.
\end{itemize}

    
    \item If $ind\_sel\_opt=2:$
    Let $p_i$ as before, 
\begin{equation}
            log\_sel\_ind_a(k,y) = - log( 1.0 + e^{(-sel\_slope\_ind(k,jj_{p_i}) . ( age\_vector_a - sel50\_ind(k,jj_{p_i})) )}).
        \end{equation}
        for $1\leq a \leq m
$ where $p_i\leq y < p_{i+1}$.
        \begin{itemize}
            \item $sel\_slope\_ind(k,jj_{p_i}) = e^{logsel\_slope\_ind(k,jj_{p_i})}$.
            \item logsel\_slope\_ind and sel50\_ind are parameters to be estimated.
        \end{itemize}

    \item If $ind\_sel\_opt=3:$
     \begin{equation}
        log\_sel\_ind_a(k,y)     =  -log(1.0 + e^{(\frac{-2.9444389792}{p1} . ( age\_vector_a - i1) )}) 
\end{equation}
    \begin{equation}
          +log\left(1 - \frac{1}{(1 + e^{(\frac{-2.9444389792}{p3} . ( age\_vector_a - i2))})}  \right)+0.102586589 
    \end{equation}
for $1\leq a \leq nselages\_ind(k).$ \\

    Now for remaining ages
    \begin{equation}
         log\_sel\_ind_a(k,y) = log\_sel\_ind_{nselages\_ind(k)}(k,y),
    \end{equation}
    for $nselages\_ind(k)\leq a \leq m$ where $p_i\leq y < p_{i+1}$.
\begin{itemize}
    \item $p1 = e^{logsel\_p1\_ind(k,jj_{p_i})}$
    \item $p2 = sel\_p2\_ind(k,jj_{p_i})$
    \item $p3 = e^{logsel\_p3\_ind(k,jj_{p_i})}$
    \item $i1 = p1 + p2$
    \item $i2 = p1 + i1 + p3$
    \item logsel\_p1\_ind, sel\_p2\_ind y logsel\_p3\_ind are parameters to be estimated.
\end{itemize}
Let's look at the change in selectivity of the fisheries according to the selectivity matrix.
In the selectivity matrix, if we look at the values in the third row and see that some value does not match the respective fishery number then the selectivity of the fishery of that value is used, i.e. let the fishery k
\begin{itemize}
    \item If $sel\_map(3,k) \neq k$ then
    \begin{equation}
        log\_sel\_fsh(k)=log\_sel\_fsh(sel\_map(3,k))
    \end{equation}
    where $k$ is the fishery number and $sel\_map(3,k)$ 
    is the element of row 3 and column $k$ of the selectivity matrix.
\end{itemize}

Now let's look at the change in index selectivities:
\begin{itemize}
    \item Si $sel\_map(2,k) \neq 2$:
    \begin{equation}
        log\_sel\_ind(k-n_{fsh})=log\_sel\_fsh(sel\_map(3,k))
    \end{equation}
    \item Si $sel\_map(2,k) = 2$ y $sel\_map(3,k) \neq k-n_{fsh}$:
    \begin{equation}
        log\_sel\_ind(k-n_{fsh}) = log\_sel\_ind(sel\_map(3,k)).
    \end{equation}
\end{itemize}

   
\end{itemize}
Finally we get the fishery and index selectivity respectively from:
\begin{equation}
    sel\_fsh=e^{log\_sel\_fsh},
\end{equation}
\begin{equation}
    sel\_ind=e^{log\_sel\_ind}.
\end{equation}

- The equilibrium-based reference points are calculated within the JJM model. The model estimates values of Maximum Sustainable Yield (MSY) and the Fishing mortality expected to produce maximum sustainable yield (\(F_{MSY}\)) using a Newton-Raphson minimization routine that finds the value of fishing mortality, given the terminal year relative catches (and selectivities-at-age) by fleet,  and the terminal year weights-at-ages for each fleet, that maximizes catch. Since weights-at-age and effective selectivity change each year, these values can vary. MSY is thus defined as the maximum amount of catch that allows the remaining stock to generate sufficient recruitment to maintain the population at the same level. Besides (\(B_{MSY}\)) is taken as the long-term average of biomass fished under MSY.

%To be included in model input parameters
Between 2013 and 2021, a provisional \(B_{MSY}\) level of 5.5 millions tons was applied. 
An interim management reference point for \(B_{MSY}\) was revised to a ten-year average of the model-estimated (\(B_{MSY}\)). 
A limit reference point \(B_{LIM}\) (where B refers to spawning biomass) was defined as the spawning biomass level below which recruitment would likely be impaired. As such, there should be no fishing when the current spawning biomass is estimated to be below \(B_{LIM}\).
For the jack mackerel, \(B_{LIM}\) was computed from the lowest ratio of historical spawning biomass relative to the most recently estimated unfished spawning biomass (e.g. as the 8\% of the unfished spawning biomass).\\






\subsection{Functions}



\subsubsection{Replacement Yield}
In the last phase, the model calculate the Replacement Yield.\\
It is the volume by weight that can be removed from a fish stock without increasing or decreasing the biomass of the stock.
For calculate the Replacement Yield for each stock  number $"s"$ It uses Newton method for 4 iterations to find the root of 
\begin{equation}
    dssb   = \dfrac{ssb2 - ssb3}{df}, \ \text{with} \  df=1.e-3.
\end{equation}

\begin{algorithm}
	\caption{{\bf \textit{Replacement Yield}}}
	1.  $\  \ $Let $F_1=0.1$, $df=1.e-3$, $breakout=1$. \\
	2.  $\  \ $For $s=1,2,...,n_{stk}$, Do\\
    3.  $\  \ \quad$ For $ii=1,...,4$, Do \\
	4.  $\  \ \qquad$ If $(mceval\_phase()\&\&(F_1>5||F_1< -5)) $\\
	5.  $\  \ \qquad$$\quad$ $ii=8$\\
	6.  $\  \ \qquad$$\quad$  If ($F_1>5$): $F_1=5.0$\\
	7.  $\  \ \qquad$$\quad$   Else: $F_1=-5.0$\\
	8.  $\  \ \qquad$$\quad$   breakout = 1. \\
	9.  $\  \ \qquad$   $F_2 = F_1+df*0.5$\\
	10. $\qquad$  $F_3 = F_2 -df$\\
	11. $\quad$ $\quad$  $ssb1=-1000.\left(log\left(\dfrac{repl\_ssb(F_1,s)}{SSB^s_{y_N}}\right)\right)^2,$\\
    12. $\quad$ $\quad$  $ssb2=-1000.\left(log\left(\dfrac{repl\_ssb(F_2,s)}{SSB^s_{y_N}}\right)\right)^2,$\\
    13. $\quad$ $\quad$  $ssb3=-1000.\left(log\left(\dfrac{repl\_ssb(F_3,s)}{SSB^s_{y_N}}\right)\right)^2.$\\
    14. $\quad$$\quad$   $dssb   = \dfrac{ssb2 - ssb3}{df},$\\
    15. $\quad$$\quad$   $dssbp  = \dfrac{(ssb2 + ssb3 - 2.*ssb1)}{(.25*df*df)}$.\\
    16. $\quad$$\quad$   If $(breakout=0)$ $F_1=F_{1}-\dfrac{dssb}{dssbp}$\\
    17. $\quad$$\quad$   Else \\
    18. $\qquad$$\quad$   If ($F_1>5$) print "Frepl v. high". \\
    19. $\qquad$$\quad$   Else print "Frepl v. low". \\
    20. $\quad$ EndDo\\
    21. $\quad$ $repl\_F(s) = F1$\\
    22. $\quad$ $repl\_SSB(s) = repl\_ssb(F1,s)$.\\
    23. $\  \ $EndDo.
    
\end{algorithm}

The iteration is on

\begin{equation}
    F_{1}^s\leftarrow F_{1}^s-\dfrac{dssb}{dssbp}, \ \text{with initial $F_{1}^s=0.1$}.
\end{equation}
Other variables are
\begin{equation}
    F_2^s \leftarrow F_1^s+df*0.5,
\end{equation}
\begin{equation}
    F_3^s \leftarrow F_2^s -df.
\end{equation}

Here $dssp$ is the second derivative of $dssb$ and defined by:
\begin{equation}
    dssbp  = \dfrac{(ssb2 + ssb3 - 2.*ssb1)}{(.25*df*df)},
\end{equation}
where
\begin{equation}
    ssb1=-1000.\left(log\left(\dfrac{repl\_ssb(F_1^s,s)}{SSB^s_{y_N}}\right)\right)^2,
\end{equation}
\begin{equation}
    ssb2=-1000.\left(log\left(\dfrac{repl\_ssb(F_2^s,s)}{SSB^s_{y_N}}\right)\right)^2,
\end{equation}
\begin{equation}
    ssb3=-1000.\left(log\left(\dfrac{repl\_ssb(F_3^s,s)}{SSB^s_{y_N}}\right)\right)^2.
\end{equation}
The numerical solution $F_1^s$ is the  FMSY for each stock s.\\
Finally we get
\begin{equation}
    repl\_F(s) = F_1^s,
\end{equation}
\begin{equation}
    repl\_SSB(s) = repl\_ssb(F_1^s,s)
\end{equation}
where
\begin{itemize}
    \item $repl\_ssb(F,s)$ is a function calculated for each F and each stock s  (see the next section);
    \item $repl\_F(s)$ is the FMSY for each stock s;
    \item $repl\_SSB(s)$ is the yield for each stock s.
\end{itemize}

In addition, this section also calculates:
\begin{equation}
    sumF(s)=\sum_{k_s}\sum_{a=1}^m F^{k_s}_{y_N,a}, \  \text{with} \ 1\leq s \leq n_{stk},
\end{equation}
where $\sum k_s$ denotes the sum over the fisheries belonging to stock s, and
\begin{equation}
    Fratio(k)=\dfrac{\sum_{a=1}^mF^k_{y_N,a}}{sumF(s_k)}, \  \text{with} \ 1\leq k  \leq n_{fsh},
\end{equation}
where $s_k$ is the stock where fishery number k belongs to.

\subsubsection{Function repl\_ssb(F, s):}
This function has as input F and s, and returns:

\begin{equation}
    repl\_ssb(F,s)=\sum_{a=1}^m ntmp_a. (Stmp_a)^{s_f}.wt\_mat^s_a,
\end{equation}
where
\begin{equation}
    Ztmp_a=M^s_{y_N,a}+\sum_{k_s}F.Fratio(k_s),
\end{equation}
\begin{equation}
    Stmp_a=e^{-Ztmp_a}, \ \text{with} \ 1\leq a \leq m,
\end{equation}
$Fratio(k)=\dfrac{1}{n_{fsh}}$ for each fishery k ($1\leq k \leq n_{fsh}$)
and
\begin{equation}
    ntmp_1 = \dfrac{\displaystyle\sum_{i=r_0}^{y_N} {mod\_rec}(s,i)}{{y_N}-r_0+1},
\end{equation}
\begin{equation}
    ntmp_a=Stmp_{a-1}.N^s_{y_N+1,{a-1}}, \ 2\leq a\leq m-1,
\end{equation}
\begin{equation}
    ntmp_{m}=Stmp_{m-1}.N^s_{y_N+1,m-1}+(Stmp_{m-1}.N^s_{y_N+1,m-1}).Stmp_{m}.
\end{equation}
\begin{itemize}
    \item  $mod\_rec(s,i)$ is the recruitment as estimated by model. It is calculated, from year $r_0$ to year $y_N$, for each stock $s$ as
     \begin{equation}
        mod\_rec(s,i)=e^{\epsilon^s_i+\mu^s_{R,i}}, \ r_0\leq i \leq y_0-1,
    \end{equation}
    \begin{equation}
        mod\_rec(s,y_0)=N^s_{y_0,1},
    \end{equation}
    \begin{equation}
        mod\_rec(s,i+1)=N^s_{i+1,1}, \ y_0\leq i \leq y_N-1.
    \end{equation}
   
    % where
    % \begin{equation}
    %     natagetmp^s_{i,1}=e^{\epsilon^s_i+\mu^s_{R,i}}, \ r_0\leq i \leq y_0.
    % \end{equation}
    %mfexp(rec_dev(s,i) + mean_log_rec(cum_regs(s)+yy_sr(s,i)))=e^{\epsilon^s_i+\mu^s_{R,i}}.
\end{itemize}
In this section is also calculated
\begin{equation}
    repl\_yld(s)=\sum_{a=1}^m Ctmp_a,
\end{equation}
where
\begin{equation}
    Ctmp_a=\sum_{k_s} wt\_fsh^{k_s}_{y_N,a}\dfrac{F.Fratio(k_s)}{Ztmp_a}(1-Stmp_a).ntmp_a, \ 1\leq a \leq m.
\end{equation}

\subsubsection{Function yld(Fratio, Ftmp, s)}

This function has as inputs Fratio, Ftmp and s, and returns msy\_stuff(i) for $i$ positive integer with $1\leq i \leq 5$. \\

The msy\_stuff(5) (BmsyTot) is calculated from
\begin{equation}
    msy\_stuff(5)=\left(\sum_{a=1}^m Ntmp_a*wt\_pop^s_a\right)*msy\_stuff(3),
\end{equation}
where $Ntmp_a$ for each age group $"a"$ is obtained from 
\begin{equation}
    Ntmp_1=1,
\end{equation}
\begin{equation}
    Ntmp_{j+1}=Ntmp_j.survtmp_j, \ 1\leq j \leq m-2,
\end{equation}
\begin{equation}
    Ntmp_m=\dfrac{Ntmp_{m-1}.survtmp_{m-1}}{1-survtmp_m}
\end{equation}
with
\begin{equation}
    survtmp_a=e^{-Ztmp_a}, \ 1\leq a \leq m,
\end{equation}
and
\begin{equation}
    Ztmp_a=M^s_{y_0,a}+\sum_{k_s}Fratio(k)*Ftmp*Se^{k_s}_{y_N,a}, \ 1\leq a \leq m, 
\end{equation}
$k_s$ are the indexes of the fisheries belonging to the stock s.\\

Let 
\begin{equation}
    phi= \sum_{a=1}^m Ntmp_a*(survtmp_a)^{s_f}*wt\_mat^s_a,
\end{equation}
and 
\begin{equation}
    phizero(r)=\dfrac{B_0^r}{R_0^r}, \ 1\leq r \leq n_{regs}.
\end{equation}


The msy\_stuff(3) (Eq Recruitment) is calculated from
\begin{equation}
    msy\_stuff(3)  = Requil(phi,y_N,s),
\end{equation}
where $Requil(phi,y_N,s)$ is a function that depends on the choice of SrType, that is, let $ireg=cum\_regs(s)+yy\_sr(s,y_N)$:\\
If $SrType=1$
\begin{equation}
    Requil(phi,y_N,s)=B_0^{ireg} * \dfrac{(\alpha^{ireg} + log(phi) - log(phizero(ireg)) )}  {(\alpha^{ireg}*phi)};
\end{equation}
If $SrType=2$
\begin{equation}
Requil(phi,y_N,s)=\dfrac{(phi-\alpha^{ireg})}{(\beta^{ireg}*phi)};
\end{equation}
If $SrType=3$
\begin{equation}
    Requil(phi,y_N,s)=e^{\mu^s_{R,y_N}};
\end{equation}
If $SrType=4$
\begin{equation}
    Requil(phi,y_N,s)=\dfrac{(log(phi)+\alpha^{ireg})}{(\beta^{ireg}*phi)}.
\end{equation}

The msy\_stuff(4) (SPR) is calculated from:
\begin{equation}
    msy\_stuff(4)=\dfrac{phi}{phizero(t)}, \ t=cum\_regs(s)+yy\_sr(s,y_N)
\end{equation}
The msy\_stuff(2) (MSY) is calculated from:
\begin{equation}
    msy\_stuff(2)=\left(\sum_{k_s}\sum_{a=1}^m wt\_fsh^{k_s}_{y_N,a}Ntmp_a.Fratio(k_s).Ftmp.Se^{k_s}_{y_N,a}\left(\dfrac{1-survtmp_a}{Ztmp_a}\right)\right).msy\_stuff(3).
\end{equation}
Note that the sum $\displaystyle\sum_{k_s}$ in equation 130 is about the indexes of fisheries belonging to stock s.\\
Finally, the msy\_stuff(1) (Bmsy) is calculated from
\begin{equation}
    msy\_stuff(1)=phi*(msy\_stuff(3)).
\end{equation}
\\
\textbf{Obs.} This yld() function uses the last year of observation i.e. $y_N$ but if you want to consider another year just replace $y_N$ by the required year.

%calc_dependent_vars
\subsubsection{Get MSY}

This function calculates MSY, FMSY, and Bmsy in the last year of observation ($y_N$). 
Use Newton Raphson method with 8 iterations to find the root of
\begin{equation}
        dyld=\dfrac{yld2-yld3}{df}
    \end{equation}
    for each stock.\\
    \begin{algorithm}
	\caption{{\bf \textit{Get MSY}}}
	1.  $\  \ $Let $F_1=0.8*natmortprior(mort\_map(s,1))$, $df=1.e-05$. \\
	2.  $\  \ $For $s=1,2,...,n_{stk}$, Do\\
    3.  $\  \ \quad$  $breakout=0$\\
    3.  $\  \ \quad$ For $ii=1,...,8$, Do \\
	4.  $\  \ \qquad$ If $(mceval\_phase()\&\&(F_1>5||F_1< 0.01)) $\\
	5.  $\  \ \qquad$$\quad$ $ii=8$\\
	6.  $\  \ \qquad$$\quad$  If ($F_1>5$): $F_1=5.0$\\
	7.  $\  \ \qquad$$\quad$   Else: $F_1=0.001$\\
	8.  $\  \ \qquad$$\quad$   breakout = 1. \\
	9.  $\  \ \qquad$   $F_2 = F_1+df*0.5$\\
	10. $\qquad$  $F_3 = F_2 -df$\\
	11. $\quad$ $\quad$  $yld1 = yield(Fratio, F_1,s),$\\
    12. $\quad$ $\quad$  $yld2=yield(Fratio,F_2,s),$\\
    13. $\quad$ $\quad$  $yld3=yield(Fratio,F_3,s).$\\
    14. $\quad$$\quad$   $dyld=\dfrac{(yld2-yld3)}{df},$\\
    15. $\quad$$\quad$   $dyldp=\dfrac{(yld2+yld3-2*yld1)}{(0.25*df*df)}$.\\
    16. $\quad$$\quad$   If $(breakout=0)$ $F_1=F_{1}-\dfrac{dyld}{dyldp}$\\
    17. $\quad$$\quad$   Else \\
    18. $\qquad$$\quad$   If ($F_1>5$) print "Fmsy v. high". \\
    19. $\qquad$$\quad$   Else print "Fmsy v. low". \\
    20. $\quad$ EndDo\\
    21. $\  \ $EndDo.
    
\end{algorithm}

    The iterations are on
    \begin{equation}
        F_2^s \leftarrow F_1^s + df*0.5, \ \text{with}  \ df=1.e-05,
    \end{equation}
    \begin{equation}
        F_3^s\leftarrow F_2^s-df,
    \end{equation}
and
\begin{equation}
    F_1^s\leftarrow F_1^s-\dfrac{dyld}{dyldp}, \ \text{with initial value } \ F_1^s=0.8*natmortprior(mort\_map(s,1)),
\end{equation}

    here $dyldp$ is the derivative of $dyld$, that is
\begin{equation}
    dyldp=\dfrac{yld2+yld3 - 2.yld1}{0.25*df*df}
\end{equation}
where
\begin{equation}
    yld1=yield(Fratio,F_1^s,s),
\end{equation}
\begin{equation}
    yld2=yield(Fratio,F2^s,s),
\end{equation}
\begin{equation}
    yld3=yield(Fratio.F3^s,s),
\end{equation}
and Fratio is a vector whose values are obtained from 
\begin{equation}
    Fratio(k)=\dfrac{\sum_{j=1}^m F^k_{y_N,j}}{sumF(s_k)}, 1 \leq k \leq n_{fsh}
\end{equation}
where $s_k$ is stock number to which fishery k belongs and \begin{equation}
    sumF(s)=\sum_{k_s}\left(\sum_{j=1}^mF^{k_s}_{y_N,j}\right), 1\leq s  \leq n_{stk}.
\end{equation}






The function $yield(Fratio,F^s,s)$ is calculated in the next section.\\

After obtaining the numerical solution $F_1^s$ (FMSY) for each stock $s$, this uses the function $yld(Fratio, F1,s)$ (from previous section) in the last year ($y_N$) to get:
\begin{equation}
    Fmsy(s)=F_1^s,
\end{equation}
\begin{equation}
    Rtmp(s)=msy\_stuff(3),
\end{equation}
\begin{equation}
    MSY(s)=msy\_stuff(2),
\end{equation}
\begin{equation}
    Bmsy(s)=msy\_stuff(1),
\end{equation}
\begin{equation}
    MSYL(s)=\dfrac{msy\_stuff(1)}{B_0^t},\ with \ t=cum\_regs(s)+yy\_sr(s,endyr),
\end{equation}
%Bzero^s_{y_N}=Bzero(cum_regs(s)+yy_sr(s,endyr)).
exploitation fraction relative to total biomass:
\begin{equation}
    lnFmsy(s)   = log\left(\dfrac{MSY(s)}{msy\_stuff(5)}\right),
\end{equation}
and
\begin{equation}
    Bcur\_Bmsy(s)= \dfrac{SSB^s_{y_N}}{Bmsy(s)}.
\end{equation}
It is also calculated
\begin{equation}
    FFtmp_s=\sum_{k_s}\left(\dfrac{1}{m}\sum_{a=1}^mF^{k_s}_{y_N,a}\right),
\end{equation}
\begin{equation}
    Fcur\_Fmsy(s)= \dfrac{FFtmp_s}{Fmsy(s)},
\end{equation}
and finally
\begin{equation}
    Rmsy(s)     = Rtmp(s).
\end{equation}
\textbf{Obs.} This Get MSY function uses the last year of observation i.e. $y_N$ but if you want to consider another year just replace $y_N$ by the required year.

\subsubsection{Function yield (Fratio, Ftmp,s)} 
This function has as input Fratio, Ftmp and s.\\
Let
\begin{equation}
    Ztmp_a=M^s_{y_0}+\sum_{k_s}Fratio(k)*Ftmp*Se^{k_s}_{y_N,a}, \ 1\leq a \leq m, 
\end{equation}
where $k_s$ are the indexes of the fisheries belonging to the stock s,
\begin{equation}
    survtmp_a=e^{-Ztmp_a}, \ 1\leq a \leq m,
\end{equation}

\begin{equation}
    Ntmp_1=1,
\end{equation}
\begin{equation}
    Ntmp_{j+1}=Ntmp_j.survtmp_j, \ 1\leq j \leq m-2,
\end{equation}
\begin{equation}
    Ntmp_m=\dfrac{Ntmp_{m-1}.survtmp_{m-1}}{1-survtmp_m},
\end{equation}
\begin{equation}
    phi=\sum_{a=1}^m Ntmp_a(survtmp_a)^{s_f}.wt\_mat^s_a
\end{equation}
and
\begin{equation}
    Req=Requil(phi,y_N,s) \  \text{(as eq.127 to eq. 130)}.
\end{equation}
This function returns
\begin{equation}
    yield(Fratio, Ftmp,s)=\left(\sum_{k_s}\sum_{a=1}^m wt\_fsh^{k_s}_{y_N,a}Ntmp_a.Fratio(k_s).Ftmp.Se^{k_s}_{y_N,a}\dfrac{1-survtmp_a}{Ztmp_a}\right)*Req.
\end{equation}
\textbf{Obs.} This yield() function uses the last year of observation i.e. $y_N$ but if you want to consider another year just replace $y_N$ by the required year.\\

%Calc_Dependent_Vars
\subsubsection{N\_NoFsh}\\
%Let the array $N\_NoFsh$ with dimensions $(1,nstk,styr,endyr\_fut,1,nages)$.\\
Let $s$ a number stock,  that is $1\leq s \leq n_{stk}$. In this section is calculated the abundance without fishing $N\_NoFsh^s_{y,a}$ for each stock s, year $y$ with $y_0\leq y \leq endyr\_fut$ and each age group $"a"$. \\

For $y=y_0$ it is calculated as 
\begin{equation}
N\_NoFsh^s_{y_0,a}=N^s_{y_0,a}, \ 1\leq a \leq m,
\end{equation}
and biomass no fishing  $SSB\_NoFish^s_y$ for $styr\_sp \leq y < y_0$ as
\begin{equation}
    SSB\_NoFish^s_y=SSB^s_{y}.
\end{equation}


Now for $y_0\leq y \leq y_N$, the number of recruits from stock $s$ in year $y$ is asumed equal to the number of individuals of stock $s$ in year $y$ at age 1 i.e $recruits^s_y=N^s_{y,1}$ .\\ 

For $y$ with $y_0 < y \leq y_N$ the abundance without fishing is calculated as 
\\
\begin{equation}
    N\_NoFsh^s_{y,1}=recruits^s_y*\dfrac{SRecruit(SSB\_NoFish^s_{y-r_a},cum\_regs(s)+yy\_sr(s,y))}{SRecruit(SSB^s_{y-r_a},cum\_regs(s)+yy\_sr(s,y))}, \ a=1;
\end{equation}
\\
\begin{equation}
    N\_NoFsh^s_{y,a}=N\_NoFsh^s_{y-1,a-1}.e^{-M^s_{y-1, a-1}}, \ 2\leq a \leq m-1, 
\end{equation}
% now for the maximum age group $m$:
\\
\begin{equation}
    N\_NoFsh^s_{y,m}=N\_NoFsh^s_{y-1,m-1}.e^{-M^s_{y-1,m-1}}+N\_NoFsh^s_{y-1,m}.e^{-M^s_{y-1,m}}, \ a=m.
\end{equation}
\\
SRecruit() is a function defined in eq. (46)-(49).

Then total biomass no fishing  $totbiom\_NoFish^s_y$  for each stock s and year y with $y_0 \leq y \leq y_N$ is calculated as follow:
\begin{equation}
    totbiom\_NoFish^s_y=\sum_{a=1}^m N\_NoFsh^s_{y,a}.wt\_pop^s_a,
\end{equation}
and the total biomass $totbiom^s_y$ 
\begin{equation}
    totbiom^s_y=\sum_{a=1}^m N^s_{y,a}.wt\_pop^s_a.
\end{equation}
Also is calculated for $y_0 \leq y \leq y_N$ and $1\leq s \leq n_{stk}$
\begin{equation}
SSB\_NoFish^s_y=\sum_{j=1}^m N\_NoFsh^s_{y,a}*e^{-M^s_{y,a}*s_f}*wt\_mat^s_a,
\end{equation}
\begin{equation}
    Sp\_Biom\_NoFishRatio^s_y=\dfrac{SSB^s_y}{SSB\_NoFish^s_y},
\end{equation}
\begin{equation}
    depletion^s=\dfrac{totbiom^s_{y_N}}{totbiom^s_{y_0}},
\end{equation}
\begin{equation}
    depletion\_dyn^s=\dfrac{totbiom^s_{y_N}}{totbiom\_NoFish^s_{y_N}}.
\end{equation}
\begin{itemize}
    \item Sp\_Biom\_NoFishRatio
    \item depletion\_dyn
\end{itemize}

For $y=y_N+1$, $totbiom^s_y$ is calculated as
\begin{equation}
totbiom^s_{y_N+1}=\sum_{a=1}^m Nnext^s_a*wt\_pop^s_a
\end{equation}
where 
\begin{equation}
%calculado en Spawning stock biomass
Nnext^s_j=N^s_{y_N,j-1}.S^s_{y_N,j-1}, \ for \ 2\leq j\leq m-1,
\end{equation}
\begin{equation}
Nnext^s_m=N^s_{y_N,m-1}.S^s_{y_N,m-1}+N^s_{y_N,m}.S^s_{y_N,m},
\end{equation}
% Calcula la SSB(biomasa desovante) para el siguiente año usando el reclutamiento medio  para la edad 1 y el mismo survival (S) como en $y_N$:
% \begin{equation}
%     Nnext(s,1)=e^{mean\_log\_rec(cum\_regs(s)+yy\_sr(s,endyr+1))}
% \end{equation}
\begin{equation}
    Nnext^s_1=e^{\mu^s_{R,y_N+1}},
\end{equation}
% \begin{equation}
%     Sp\_Biom(s,endyr+1)=\sum_{age \ j}Nnext(s)_jS(s,endyr)^{spmo\_frac}.wt\_mature(s)_j
% \end{equation}
finally recruits at stock s and year $y=y_N+1$ is
\begin{equation}
recruits^s_{y_N+1}=e^{\mu^s_{R,y_N+1}}.
\end{equation}

\begin{itemize}
    \item $Nnext_a(s)$ is the following year's abundance for each stock $s$ and each age group $a$.

\end{itemize}
Now OFL for the next year:
\begin{equation}
    OFL(s) =\sum_{k_s} \left(\sum_{a=1}^mwt\_fsh^{k_s}_{y_N,a} \left(Nnext_a^s * Fatmp_a(k_s) * \dfrac{(1 - e^{-Ztmp^s_a})}{Ztmp^s_a}\right)\right), \ 1\leq s \leq n_{stk},
\end{equation}
where for $1\leq k \leq n_{fsh}$ 
\begin{equation}
    Fatmp_a(k)=Fratio(k).Fmsy(s_k).Se^k_{y_N,a}, \  1\leq a \leq m
\end{equation}
\begin{equation}
    Ztmp_a(s)=M^s_{y_0,a}+ \sum_{k_s}Fatmp_a(k_s).
\end{equation}


\subsubsection{Get Future Fs:}\\
Let stock s, the year $y$ and some scenario denoted by iscenario.\\
Depending the value of iscenario $F\_fut\_tmp_a$ is calculated first, and then future fishing mortality $F_{fut}$, future total mortality $Z_{fut}$ and future survival rate $S_{fut}$ are calculated based on it.
\begin{itemize}
    \item Case iscenario=1. \begin{equation}
        F\_fut\_tmp_a(k)=F^k_{y_N,a}, 
        \end{equation}
    \item Case iscenario=2.  \begin{equation}
        F\_fut\_tmp_a(k) = F^k_{y_N,a}*0.75,  
    \end{equation}
    \item Case iscenario=3.  \begin{equation}
        F\_fut\_tmp_a(k) = F^{k}_{y_N,a}*1.25, 
    \end{equation}
    \item Case iscenario=4.
    \begin{equation}
        F\_fut\_tmp_a(k)=Se^k_{y_N,a}*Fratio(k)*Fmsy(s),
    \end{equation}
    where $Fratio(k)=\dfrac{1}{n_{fsh}}$,
    \item Case iscenario=5.
    \begin{equation}
        F\_fut\_tmp_a(k) = 0.0,
    \end{equation}
\end{itemize}
for $1\leq a \leq m$ and  $1\leq k \leq n_{fsh}$.\\

Then we obtein
\begin{equation}
    {F_{fut}}^{k_s}_{y,a}   = F\_fut\_tmp_a({k_s}),
\end{equation}
\begin{equation}
    {Z_{fut}}^s_{y,a}=M^s_{y_N,a}+\sum_{k_s}F\_fut\_tmp_a(k_s)
\end{equation}
and the future survival rate as
\begin{equation}
    {S_{fut}}^s_{y,a}=e^{-{Z_{fut}}^s_{y,a}}.
\end{equation}


\subsubsection{Future Projections}\\

Here we calculate the future biomass $SSB\_fut^{s,iscen}_{y}$ for each stock s with $1 \leq s \leq n_{stk}$ and year y with $styr\_fut-r_a\leq y \leq endyr\_fut$, and different scenarios iscen with $1\leq iscen \leq 5$, where $styr\_fut=y_N+1$ if $nproj\_yrs>0$ otherwise $styr\_fut=y_N$, and $endyr\_fut=y_N+nproj\_yrs$.\\

For $\ styr\_fut-r_a\leq y \leq styr\_fut-1$:
\begin{equation}
    SSB\_fut^{s,iscen}_y=\sum_{a=1}^m wt\_{mat}^s_a* N^s_{y,a}*(S^s_{y,a})^{s_f}. 
\end{equation}


Now for $y=styr\_fut$ 
\begin{equation}
    SSB\_fut^{s,iscen}_{styr\_fut}= \sum_{a=1}^mwt\_{mat}^s_a*{N_{fut}}^{s,iscen}_{y,a}*({{S_{fut}}^{s,iscen}_{y,a}})^{s\_f},
\end{equation}
where 
\begin{equation}
    {N_{fut}}^{s,iscen}_{y,a}=N^s_{y_N,a-1}.S^s_{y_N,a-1}, \ 2\leq a \leq m-1,
\end{equation}
\begin{equation}
    {N_{fut}}^{s,iscen}_{y,m}=N^s_{y_N,m-1}.S^s_{y_N,m-1}+N^s_{y_N,m}.S^s_{y_N,m},
\end{equation}
and 
\begin{equation}
{N_{fut}}^{s,iscen}_{y,1}=SRecruit( SSB\_fut^{s,iscen}_{y-r_a},cum\_regs(s)+yy\_sr(s,y_N) ) * e^{rec\_dev\_future(s,y)}. 
\end{equation}


For the rest of years y with  $styr\_fut < y \leq endyr\_fut$
\begin{equation}
    SSB\_fut^{s,iscen}_y = \sum_{a=1}^m wt\_mat^s_{a}*{N_{fut}}^{s,iscen}_{y,a}*({S_{fut}}^{s,iscen}_{y,a})^{s_f}
\end{equation}
where
\begin{equation}
   {N_{fut}}^{s,iscen}_{y,a}={N_{fut}}^{s,iscen}_{y-1,a-1}.{S_{fut}}^{s,iscen}_{y-1,a-1},  \ 2\leq a \leq m-1,
\end{equation}
\begin{equation}
    {N_{fut}}^{s,iscen}_{y,m}={N_{fut}}^{s,iscen}_{y-1,m-1}.{S_{fut}}^{s,iscen}_{y-1,a-1} + {N_{fut}}^{s,iscen}_{y,m}.{S_{fut}}^{s,iscen}_{y,m},
\end{equation}
\begin{equation}
    {N_{fut}}^{s,iscen}_{y,1}=SRecruit(SSB\_fut^{s,iscen}_{y-r_a},cum\_reg(s)+yy\_sr(s,y_N)).e^{rec\_dev\_future(s,y)}
\end{equation}
and ${S_{fut}}^{s,iscen}_{y-1,a-1}$ is obtained in section Get Future Fs for respective iscen. \\















On the other hand for the first scenario i.e if $iscen=1$ $N\_NoFsh^s_{y,a}$ and $SSB\_NoFish^s_y$ are calculated for $y_N+1\leq y \leq endyr\_fut$, $1\leq a \leq m$ and each stock s, as follows

\begin{equation}
    N\_NoFsh^{s}_{y,1}={N_{fut}}^s_{y,1}*\dfrac{SRecruit(SSB\_NoFish^s_{y-r_a},cum\_regs(s)+yy\_sr(s,y_N))}{ SRecruit(SSB\_fut^s_{y-r_a},cum\_regs(s)+yy\_sr(s,y_N))},
\end{equation}
\begin{equation}
    N\_NoFsh^{s}_{y,a}=N\_NoFsh^s_{y-1,a-1}*e^{-mean(natmort(s))}, \ 2\leq a\leq m-1,
\end{equation}
\begin{equation}
    N\_NoFsh^s_{y,m}=N\_NoFsh^s_{y-1,m-1}*e^{-mean(natmort(s))}+N\_NoFsh^s_{y-1,m}*e^{-mean(natmort(s))},
\end{equation}
and
\begin{equation}
    SSB\_NoFish^s_y   = \sum_{a=1}^mN\_NoFsh^s_{y,a}*(e^{-mean(natmort(s))})^{s_f} * wt\_{mat}^s_a.
\end{equation}

Now get future catch at group ages that is with $styr\_fut \leq y \leq endyr\_fut$ only for the first four scenarios ($iscen\neq 5$):
\begin{equation}
    catage\_future^{s,iscen}_{y,a}=\sum_{k_s} {N_{fut}}^{s,iscen}_{y,a}.{F_{fut}}^{k_s, iscen}_{y,a}.\dfrac{1-{S_{fut}}^{s,iscen}_{y,a}}{{Z_{fut}}^{s,iscen}_{y,a}},
\end{equation}

\begin{equation}
    catch\_future^s_{iscen,y}=\sum_{k_s} \sum_{a=1}^m{N_{fut}}^{s,iscen}_{y,a}.{F_{fut}}^{k_s, iscen}_{y,a}.\dfrac{1-{S_{fut}}^{s,iscen}_{y,a}}{{Z_{fut}}^{s,iscen}_{y,a}}.wt\_fsh^s_{y_N,a}
\end{equation}
where $\displaystyle\sum_{k_s}$ represents the sum is over all fisheries $k_s$ belonging to stock s and ${F_{fut}}^{k_s, iscen}_{y,a}$ was obtained from section Get Future Fs for respective iscen.
\begin{itemize}
    \item mean(natmort) is the mean of vector natmort(s), $natmort_i(s) $ is a element of this for each stock s and year i with $y_0\leq i \leq y_N$ , and it is obtained in function of  Mest. 
\end{itemize}
\subsection{The objective function obj\_fun}

The parameters of the model are chosen so that this value obj\_fun is minimized. That is, it should be the negative of the log-likelihood. obj\_fun is defined as

\begin{equation}
    obj\_fun=obj\_fun_1+obj\_fun_2+obj\_fun_3+sum(Cat\_like)+sum(age\_like\_fsh)+sum(lenght\_like\_fsh)+sum(sel\_like\_fsh)+
\end{equation}
\begin{equation*}
    sum(ind\_like)+sum(age\_like\_ind)+sum(lenght\_like\_ind)+
\end{equation*}
\begin{equation*}
    sum(sel\_like\_ind)+sum(rec\_like)+sum(fpen)+sum(post\_priors\_indp)+sum(post\_priors),
\end{equation*}
where $obj\_fun_3=\sum_{r\in R^{**}}\dfrac{1}{2}\left(log\_Rzero(r)-\mu_{R,r}\right)^2$, $R^{**}=\{r\in\mathbb{N}: log\_Rzero(r) \ is \ active, \ 1\leq r \leq n_{regs}\}$. \\
Furthermore, let us note that sum(V) denotes the sum of the components of the argument vector V.


Let's analyze each function that composes the sum that gives rise to obj\_fun.



\subsubsection{Cat\_Like}
This function will be used if $fmort$ is active.
Cat\_Like depends on the optimization phase. For each fishery $ 1\leq k \leq n_{fsh}$ $catch\_like^k$ is calculated from:\\

If $current\_phase()>3$ (i.e if if the current optimization phase is greater than 3):
    \begin{equation}
        catch\_like^k = \sum_{y=y_0}^{y_N}\dfrac{1}{2}\dfrac{(log({C_{obs}}_{k,y}+.0001) - log({C_{pred}}^k_y+.0001) )^2}{catch\_bio\_lva^k_y}
    \end{equation}
    
If $current\_phase()\leq 3$:
    \begin{equation}
        catch\_like^k =  catchbiomass\_pen*\left(\sum_{y=y_0}^{y_N}(log({C_{obs}}_{k,y}  +.000001) - log({C_{pred}}^{k}_y+.000001))^2\right).
    \end{equation}
    Finally, 
    \begin{equation}
        Cat\_Like^k = catch\_like^k*catch\_pen 
    \end{equation}
    
    \begin{itemize}
        \item $catchbiomass\_pen=200$, value given in the model.
        \item $catch\_pen$: catch\_pen=0.1 if current\_phase()=1, catch\_pen=0.5 if current\_phase()=2, catch\_pen=0.8 if current\_phase()=3, catch\_pen=1 if current\_phase()=4, catch\_pen=5 if current\_phase()=1, and in other cases catch\_pen=1.
        \item catch\_bio\_lva is the catch biomass variance (for lognormal). It is calculated from 
        \begin{equation*}
            catch\_bio\_lva^k_y=log((catch\_bio\_sd^k_y)^2+1).
        \end{equation*}
        $catch\_bio\_sd^k_y$ is the catch biomass standard errors for each fishery k and year y with $y_0\leq y \leq y_N$.
        \item ${C_{obs}}_{k,y}$ is the observed catch for each fishery k and year y woth $y_0 \leq y \leq y_N$.
        \item $Cat\_Like^k$ is the catch likelihood for fishery $k$.
    \end{itemize}


\subsubsection{Rec\_Like}
This function return four values for each stock s, that is $rec\_like(s,i)$ with $1\leq i \leq 4$.
This is calculated if $rec\_dev$ is active in the minimization phase.\\
Let
\begin{equation}
    sigmar(r)=e^{log\_sigmar(r)}, \ 1\leq r \leq n_{rec},
\end{equation}

\begin{equation}
    sigmarsq^r=(sigmar^{istk}_{ireg})^2, \ \ 1\leq r \leq n_{regs},
\end{equation}
where
\begin{itemize}
    \item $n_{rec}$ is the maximum value of the rec\_map matrix;
    \item istk number of stock to which the regime number $r$ belongs, $1\leq istk \leq n_{stk}$;
    \item ireg is the order that r occupies in the
set of regimes belonging to the stock istk. Recall that $n_{regs}$ is the sum of the number of regimes of all
stocks. 
    \item $sigmar^{istk}_{ireg}=sigmar(rec\_map^{istk}_{ireg})$ i.e value of position $rec\_map^{istk}_{ireg}$ of the sigmar vector and $rec\_map^{istk}_{ireg}:=rec\_map(istk,ireg)$; 
    \item $log\_sigmar(r)$, for each r with $1\leq r\leq n_{rec}$, is a parameter to be estimated. It is initialized with $log\_sigmarprior$.
\end{itemize}

If the current optimization phase is more than 2 and in addition if it is the last phase, then
%revisar function shift
\begin{equation}
    pred\_rec_{i}^s=SRecruit(SSB^s_{i-r_a},cum\_regs(s)+r)
\end{equation}
where $1\leq s \leq n_{stk}$, $1\leq r \leq n_{reg_s}$ and $yy\_shift\_st(s,r)\leq i \leq yy\_shift\_end(s,r)$,\\
\begin{itemize}
    \item yy\_shift\_st is such that $$yy\_shift\_st(s,1)=styr\_rec$$
    and
    \begin{equation*}
         yy\_shift\_st(s,r) = reg\_shift(s,r-1), \ 2\leq r \leq n_{reg_s}
    \end{equation*}
    where $reg\_shift$ is matrix input; 
    %(line 41 of ctl file).
    \item yy\_shift\_end is such that
    \begin{equation*}
        yy\_shift\_end(s,n_{reg_s})= y_N
    \end{equation*}
    and
    \begin{equation*}
        yy\_shift\_end(s,r-1)=reg\_shift(s,r-1)-1, \ 2 \leq r \leq n_{reg_s}.
    \end{equation*}
\end{itemize}

On the other hand, if the current optimization phase is more than 2 but this is not the last phase, then
\begin{equation}
    pred\_rec^s_i = 0.1+SRecruit(SSB^s_{i-r_a},cum\_regs(s)+r),
\end{equation}
where $yy\_shift\_st(s,r)\leq i \leq yy\_shift\_end(s,r)$.\\

It is also calculated for $1\leq r \leq n_{regs}$ and istk. ireg as before
\begin{equation}
    m\_sigmarsq(r)=\dfrac{SSQRec(r)}{nrecs\_est\_shift(r)},
\end{equation}
\begin{equation}
    m\_sigmar(r)=\sqrt{m\_sigmarsq(r)}
\end{equation}
where 
\begin{equation}
    SSQRec(r)=\displaystyle\sum_{i=styr\_rec\_est(istk,ireg)}^{endyr\_rec\_est(istk,ireg)}(chi(istk,i))^2
\end{equation}
and
\begin{equation}
    chi(istk,yr\_rec\_est(r,j)) = log(mod\_rec(istk,yr\_rec\_est(r,j))) - log(pred\_rec^{istk}_{yr\_rec\_est(r,j)}),
\end{equation}
with $1\leq j \leq nrecs\_est\_shift(r)$ and $1\leq r \leq n_{regs}$

\begin{itemize}
    \item $yr\_rec\_est$ is matrix input. % line 38 in ctl file.
    \item $nrecs\_est\_shift$ is vector input. %line 35 in ctl file.
    \item $styr\_rec\_est(s,r)$ is obtained for each stock s ($1\leq s \leq n_{stk}$) and each regime r with $1\leq r \leq n_{reg_s}$ from 
    \begin{equation*}
        styr\_rec\_est(s,r) = yr\_rec\_est(cum\_regs(s)+r,1)
    \end{equation*}
    \item $endyr\_rec\_est(s,r)$ is obtained for each stock s ($1\leq s \leq n_{stk}$) and each regime r with $1\leq r \leq n_{reg_s}$ from 
    \begin{equation*}
    endyr\_rec\_est(s,r) = yr\_rec\_est(cum\_regs(s)+r,nrecs\_est\_shift(cum\_regs(s)+r)).
    \end{equation*}
\end{itemize}

Now we calculate the rec\_like.\\

In addition (since $current\_phase() > 2$), if the current phase is more than 4 or if it is the last phase then for $1\leq istk \leq n_{stk}$

\begin{equation}
    rec\_like(istk,1)= \sum_{r=1}^{n_{reg_{istk}}}\left(\dfrac{\left(SSQRec(r)+ \dfrac{m\_sigmarsq(r)}{2.}\right)}{(2*sigmarsq^r)} + nrecs\_est\_shift(r)*log\_sigmar(rec\_map^{istk}_{ireg})\right),
\end{equation}
else 
\begin{equation}
    rec\_like(istk,1)=\sum_{r=1}^{n_{reg_{istk}}}0.1*\left(\dfrac{\left(SSQRec(r)+ \dfrac{m\_sigmarsq(r)}{2.}\right)}{(2*sigmarsq^r)} + nrecs\_est\_shift(r)*log\_sigmar(rec\_map^{istk}_{ireg})\right).
\end{equation}


If the current phase is the last then for each stock s ($1\leq s \leq n_{nstk}$)

\begin{itemize}
    \item if $styr\_rec\_est(s,1)>r_0$
    \begin{equation}
        Rec\_like(s,4) =  \dfrac{1}{2}\dfrac{\displaystyle\sum_{j=r_0}^{styr\_rec\_est(s,1)-1}(\epsilon^s_j)^2}{sigmarsq^{(cum\_regs(s)+1)}} 
    \end{equation}
    \begin{equation*}
        + ((styr\_rec\_est(s,1)-1)-r_0)*log(sigmar(rec\_map^s_1)),
    \end{equation*}
    otherwise $Rec\_like(s,4)=0$.
    \item If $y_N > endyr\_rec\_est(s,n_{reg_s})$
    \begin{equation}
        R\_like(s,4) =  \dfrac{1}{2}\dfrac{\displaystyle\left(\sum_{j=endyr\_rec\_est(s,n_{reg_s})+1}^{y_N}(\epsilon^s_j )^2\right)}{sigmarsq^{(cum\_regs(s)+n_{reg_s})}} + 
    \end{equation}
    \begin{equation*}
        (y_N-(endyr\_rec\_est(s,n_{reg_s})+1))*log(sigmar(rec\_map^s_{n_{reg_s}})) + Rec\_like(s,4),
    \end{equation*}
    otherwise $R\_like(s,4)=Rec\_like(s,4)$.
\end{itemize}
In addition, for $r\in R^*$=$\{2\leq r \leq n_{reg_s}: \ styr\_rec\_est(s,r)-1) > endyr\_rec\_est(s,r-1)\}$
\begin{equation}
    rec\_like(s,4) =  \sum_{r\in R^*}\dfrac{1}{2}\dfrac{\displaystyle\sum_{j=endyr\_rec\_est(s,r-1)+1}^{styr\_rec\_est(s,r)-1}( \epsilon^s_j)^2}{sigmarsq^{(cum\_regs(s)+(r-1))}} + 
\end{equation}
\begin{equation*}
    + ((styr\_rec\_est(s,r)-1)-(endyr\_rec\_est(s,r-1)+1))*log(sigmar(rec\_map^s_{r-1})) + R\_like(s,4).
\end{equation*}
















Else, i.e if the minimization phase is less than 2 and is not the last phase, then for $1\leq s \leq n_{stk}$
\begin{equation}
    Rc\_like(s,2) = \sum_{r}\sum_{j=1}^{nrecs\_est\_shift(r)}(\epsilon^s_{yr\_rec\_est(r,j)})^2, 
\end{equation} 
where here $\sum_{r}$ is the sum over all the numbers of regimens $r$ that belong  at stock s.\\

With the last information we calculate the final value of Rc\_Like(s,2) for each stock s:
\begin{equation}
    rec\_Like(s,2) = Rc\_like(s,2)+ \sum_{j=styr\_rec\_est(s,1)}^{y_N}( \epsilon^s_j)^2.
\end{equation}
And if the current phase is such that  $rec\_dev\_future$ is active then: 
\begin{equation}
    sigmar\_fut(s)=sigmar(rec\_map^s_{nreg_s}), \ 1\leq s \leq n_{stk}
\end{equation}
and with this
\begin{equation}
    rec\_like(s,3) = \dfrac{ \displaystyle\sum_{j=styr\_fut}^{endyr\_fut}(rec\_dev\_future_j(s))}{(2*(sigmar\_fut(s))^2)} + size\_count(rec\_dev\_future(s))*log(sigmar\_fut(s)).
\end{equation}
\begin{itemize}
    \item $rec\_dev\_future_j(s)$ is a parameter to be estimated for each stock s and year y with $styr\_fut \leq y \leq endyr\_fut$.
\end{itemize}



\subsubsection{Compute priors}

Let index survey  number $k$ ($1\leq k \leq n_{ind}$),
\begin{itemize}
    \item if $log\_q\_ind(k)$ is active
    \begin{equation}
        post\_priors\_indq_1(k) = \dfrac{\left(log\left(\dfrac{q\_ind(k,1)}{qprior(k)}\right)\right)^2}{(2.cvqprior^2(k))},
    \end{equation}
    if not active then $post\_priors\_indq_1(k)$=0;
    \begin{itemize}
        \item q\_ind
        \item qprior(k) is input for each index survey k.
        \item cvqprior(k) is input for each index survey k.
        \item log\_q\_ind(k) is a parameter to be estimated.
    \end{itemize}
    \item if $log\_q\_power\_ind(k)$ is active
    \begin{equation}
        post\_priors\_indq_2(k) = \dfrac{\left(log\left(\dfrac{q\_power\_ind(k)}{q\_power\_prior(k)}\right)\right)^2}{(2*cvq\_power\_prior^2(k))},
    \end{equation}
    if not active then $post\_priors\_indq_2(k)$=0;
    \begin{itemize}
    \item q\_power\_ind(k)
    \item q\_power\_prior(k) is input for each index survey k
    \item cvq\_power\_prior(k) is input for each index survey k
    \item log\_q\_power\_ind(k) is a paramter to be estimated for each index survey k.
    \end{itemize}
    \item if $log\_rw\_q\_ind(k)$ active
    \begin{equation}
        post\_priors\_indq_3(k) = \sum_{i=1}^{npars\_rw\_q(k)}\dfrac{(log\_rw\_q\_ind(k,i))^2}{(2*sigma\_rw\_q^2(k,i))}
    \end{equation}
    if not active then $post\_priors\_indq_3(k)$=0.
    \begin{itemize}
    
    \item sigma\_rw\_q(k,i) is input for each index survey k and i with $1\leq i \leq npars\_rw\_q$,
    \item log\_rw\_q\_ind(k) is a parameter (vector) to be estimated, log\_rw\_q\_ind(k,i) is a element of this vector for each index survey k and i with $1\leq i \leq npars\_rw\_q(k)$,.
    \end{itemize}
    
    
    
    \end{itemize}

    Then 
    \begin{equation}
         post\_priors\_indq(k)=post\_priors\_indq_1(k)+post\_priors\_indq_2(k)+ post\_priors\_indq_3(k).
    \end{equation}

    
    Let $r$ a positive integer such that $1\leq r \leq nmort$, where nmort is the maximum value of the mort\_map
    \begin{itemize}
        \item If $Mest(r)$ is active
        \begin{equation}
            post\_priors_1(r,1) = \dfrac{\left(log\left(\dfrac{Mest(r)}{natmortprior(r)}\right)\right)^2}{(2*cvnatmortprior^2(r))}
\end{equation}
        else $post\_priors_1(r,1)=0$.
    \begin{itemize}
        \item Mest(r) is a paramter to be estimated for each r with $1\leq r \leq nmort$.
        \item natmortprior(r) is input for each r with $1\leq r \leq nmort$.
        
        \item cvnatmortprior(r) is input for each r with $1\leq r \leq nmort$.
    \end{itemize}

        
\item If $Mage\_offset(r)$ is active
        \begin{equation}
            post\_priors_2(r,1) = \dfrac{\displaystyle\sum_{i=1}^{npars\_Mage(r)}(Mage\_offset_i(r))^2}{2*cvnatmortprior^2(r)}
        \end{equation}
        else $post\_priors_2(r,1)=0$.
        \begin{itemize}
        \item Mage\_offset(r) is a parameter(vector) to be estimated, $Mage\_offset_i(r)$  is a element of this vector for each r with $1\leq r \leq nmort$ and i with $1\leq i \leq npars\_Mage(r)$.
        \item $npars\_Mage(r)$ is input for each r with $1\leq r \leq nmort$.
        \end{itemize}
    \end{itemize}
    Then
        \begin{equation}
            post\_priors(r,1)=post\_priors_1(r,1)+post\_priors_2(r,1).
        \end{equation}
    Let the stock number s ($1\leq s \leq n_{stk}$)
    \begin{itemize}
        \item if $M\_rw(s)$ is active
        \begin{equation}
             post\_priors(s,1) 
 +=  \sum_{i=1}^{npars\_rw\_M(s)}\dfrac{(M\_rw(s,i))^2}{2*sigma\_rw\_M^2(s,i)}.
        \end{equation}
        \begin{itemize}
            \item $M\_rw(s)$ is a parameter to be estimated for each stock s. 
            \item $sigma\_rw\_M(s,i)$ is input for each stock s and i with $1\leq i \leq npars\_rw\_M(s)$.
            \item $npars\_rw\_M(s)$ is input for each stock s.
        \end{itemize}
    \end{itemize}
    Let r such that $1\leq r \leq n_{rec}$
    \begin{itemize}
        \item if $steepness(r)$ is active
        \begin{equation}
            post\_priors(r,2) = \dfrac{\left(log\left(\dfrac{steepness(r)}{h^p(r)}\right)\right)^2}{2*(h^p_{cv})^2(r)},
        \end{equation}
        else $post\_priors(r,2)=0$.
        \begin{itemize}
            \item steepness(r) is a parameter to be estimated for each r. 
            \item $h^p(r)$ is the steepness prior, it is input for each r. 
            \item $h^p_{cv}(r)$ is the cv steepness prior, it input for each r. 
        \end{itemize}
    \end{itemize}
    Let $r$ such that $1\leq r \leq n_{rec}$
    \begin{itemize}
        \item if $log\_sigmar(r)$ is active
        \begin{equation}
            post\_priors(r,3) = \dfrac{\left(log\left(\dfrac{sigmar(r)}{sigmarprior(r)}\right)\right)^2}{2*cvsigmarprior^2(r)},
        \end{equation}
        else $post\_priors(r,3)=0$.
        \begin{itemize}
            \item sigmar(r)
            \item sigmarprior(r) is input for each r,
            \item cvsigmarprior(r) is input for each r,
            \item log\_sigmar(r) is a parameter to be estimated for each r with $1\leq r \leq n_{rec}$.
        \end{itemize}
    \end{itemize}

    Let $r$ such that $1\leq r \leq ngrowth$:
    \begin{itemize}
        \item if $log\_Linf(r)$ is active
        \begin{equation}
            post\_priors(r,4) = \dfrac{(log\_Linf(r)-log\_Linfprior(r))^2}{2*cvLinfprior^2(r)},
        \end{equation}
        else $post\_priors(r,4)=0.$
        \begin{itemize}
            \item log\_Linf(r) is a parameter to be estimated for each r with $1\leq r \leq ngrowth$,
            \item log\_Linfprior(r) is obtained from log\_Linfprior(r)=log(Linfprior(r)), where Linfprior(r) is input for each r with $1\leq r\leq ngrowth$.
            \item cvLinfprior(r) is input for each r.
        \end{itemize}
        \item if $log\_k(r)$ is active
        \begin{equation}
            post\_priors(r,5) = \dfrac{(log\_k(r)-log\_kprior(r))^2}{2*cvkprior^2(r)},
        \end{equation}
        else  $post\_priors(r,5)=0$.
        \begin{itemize}
            \item $log\_k(r)$ is a parameter to be estimated for each r.
            \item $log\_kprior(r)$ is obtained from $log\_kprior(r)=log(kprior(r))$, where kprior(r) is input for each r.
            \item cvkprior(r) is input for each r.
        \end{itemize}
        \item if $log\_Lo(r)$ is active
        \begin{equation}
            post\_priors(r,6) = \dfrac{(log\_Lo(r)-log\_Loprior(r))^2}{2*cvLoprior^2(r)},
        \end{equation}

        else $post\_priors(r,6)=0$.
        \begin{itemize}
            \item $log\_Lo(r)$ is a parameter to be estimated for each r.
            \item $log\_Loprior(r)$ is obtained from $log\_Loprior(r)=log(Loprior(r))$, where Loprior(r) is input for each r.
            \item cvLoprior(r) is input for each r.
        \end{itemize}
        \item if $log\_sdage(r)$ is active
        \begin{equation}
            post\_priors(r,7) = \dfrac{(log\_sdage(r)-log\_sdageprior(r))^2}{2*cvsdageprior^2(r)},
        \end{equation}

        else $post\_priors(r,7)=0.$
        \begin{itemize}
            \item $log\_sdaaage(r)$ is a parameter to be estimated for each r.
            \item $log\_sdageprior(r)$ is obtained from $log\_sdageprior(r)=log(sdageprior(r))$, where sdageprior(r) is input for each r.
            \item cvsdageprior(r) is input for each r.
        \end{itemize}
    \end{itemize}



\subsubsection{Fmort\_Pen}
The penalty function for fishing mortality fpen(1) is

\begin{itemize}
    \item If the current phase is less than 3, then
    \begin{equation}
        fpen(1)=\sum_{k,y,a}(F^k_{y,a}-0.2)^2
    \end{equation}
    \item Else
    \begin{equation}
        fpen(1)=0.0001.\sum_{k,y,a}(F^k_{y,a}-0.2)^2.
    \end{equation}
\end{itemize}

\subsubsection{Sel\_Like}
This section calculates four values for sel\_like\_fsh for  each fishery and four values for  sel\_like\_ind for each index survey, that is sel\_like\_fsh(k,i) ($1\leq k \leq n_{fsh}$) and  sel\_like\_ind(k,i) ($1\leq k \leq n_{ind}$) with in both cases $1\leq i \leq 4$.
Let the fishery number k

\begin{itemize}
    \item If logsel\_p1\_fsh(k) is active: 


\begin{equation}
sel\_like\_fsh_1(k,3)= \dfrac{1}{2}(logsel\_p1\_fsh(k,1))^2+\dfrac{1}{10}(logsel\_p2\_fsh(k,1))^2+(logsel\_p3\_fsh(k,1))^2
\end{equation}
\begin{equation*}
    +\sum_{i}\left(\dfrac{1}{10}( logsel\_p1\_fsh(k,i))^2+\dfrac{1}{10}(logsel\_p2\_fsh(k,i))^2+ 5.0.(logsel\_p3\_fsh(k,i))^2\right),
\end{equation*}
where the last sum is over i such that $2 \leq i \leq n\_sel\_ch\_fsh(k)$,

on the other hand
\begin{equation}
    sel\_like\_fsh_1(k,2)=\sum_{2\leq i \leq n\_sel\_ch\_fsh(k)}\dfrac{0.5*\displaystyle\left(\sum_{j=1}^m(log\_sel\_fsh_j(k,yr_i-1)-log\_sel\_fsh_j(k,yr_i))^2\right)}{(sel\_sigma\_fsh(k,i))^2},
\end{equation}
for $2 \leq i \leq n\_sel\_ch\_fsh(k)$ 
where  $yr_i=yrs\_sel\_ch\_fsh(k,i)$.\\
Else $sel\_like\_fsh_1(k,3)=0$ and $sel\_like\_fsh_1(k,2)=0$.
\begin{itemize}
    \item logsel\_p1\_fsh(k) is  a vector to be estimated for each fishery k, logsel\_p1\_fsh(k,i) is a element of this vector with i in $1\leq i \leq n\_sel\_ch\_fsh(k)$.
    \item logsel\_p2\_fsh(k) is  a vector to be estimated for each fishery k, logsel\_p2\_fsh(k,i) is a element of this vector with i in $1\leq i \leq n\_sel\_ch\_fsh(k)$. 
    \item logsel\_p3\_fsh(3) is  a vector to be estimated for each fishery k, logsel\_p3\_fsh(k,i) is a element of this vector with i in $1\leq i \leq n\_sel\_ch\_fsh(k)$.
    \item $log\_sel\_fsh_j(k,i)$ is obtained in section m, for each age group j, year i and fishery k.
    \item sel\_sigma\_fsh(k,i) is input for each fishery k and i.
    \item n\_sel\_ch\_fsh(k) is input for each fishery k.
    \item yrs\_sel\_ch\_fsh(k,i) is input for each fishery k and i.
\end{itemize}



\item If log\_selcoffs\_fsh(k) is active:
\begin{equation}
    sel\_like\_fsh(k,1) = \sum_{yr_i}curv\_pen\_fsh(k)*norm2(first\_difference( first\_difference(log\_sel\_fsh(k,yr_i)))),
\end{equation}
where $yr_i = yrs\_sel\_ch\_fsh(k,i)$ for each $1\leq i \leq n\_sel\_ch\_fsh(k)$.\\
And
\begin{equation}
    sel\_like\_fsh(k,2)  = \sum_{i\in W}0.5*\dfrac{\left(\sum_{j=1}^m(log\_sel\_fsh_j(k,yr_i-1)-log\_sel\_fsh_j(k,yr_i))^2\right)}{(sel\_sigma\_fsh(k,i))^2} + sel\_like\_fsh_1(k,2) 
\end{equation}
where $W=\{1\leq i \leq n\_sel\_ch\_fsh(k): \ i>1\}$.\\

Now for each j such that $seldecage \leq j \leq nselages\_fsh(k)$:
\begin{equation}
    difftmp_j=log\_sel\_fsh_{j-1}(k,yr_i)-log\_sel\_fsh_j(k,yr_i), 
\end{equation}
then
\begin{equation}
    sel\_like\_fsh(k,3)    = \sum_{yr_i}\sum_{j\in D}0.5*\dfrac{( difftmp_j )^2}{seldec\_pen\_fsh(k)}+sel\_like\_fsh_1(k,3),
\end{equation}
where $D=\{j \in \mathbb{N} : difftmp_j>0, \ seldecage \leq j \leq nselages\_fsh(k)\}$
and 
\begin{equation}
    obj\_fun_1  =\sum_{k\in act\_selcoffs\_fsh} \sum_{i=1}^{n\_sel\_ch\_fsh(k)}20 * (avgsel\_fsh(k,i))^2
\end{equation}
where $act\_selcoffs\_fsh=\{1\leq k \leq  n_{nfsh}: \ log\_selcoffs\_fsh(k)\  is \ active\}$.
\begin{itemize}
    \item curv\_pen\_fsh(k) is input for each fishery k such that fsh\_sel\_opt(k)=1,  and also
        if $phase\_selcoff\_fsh(k)>0$ then
        \begin{equation*}
    curv\_pen\_fsh(k) \leftarrow \dfrac{1.} {({(curv\_pen\_fsh(k))}^2*2)}.\end{equation*} 
    \item yrs\_sel\_ch\_fsh(k,i) is input for each fishery k and i with $2\leq i \leq n\_sel\_ch\_fsh(k)$ and first year always is $y_0$ i.e $yrs\_sel\_ch\_fsh(k,1)=y_0$. 
    \item n\_sel\_ch\_fsh(k) is input value plus one for each fishery k.
    \item sel\_sigma\_fsh(k,i) is input for each fishery k and i with $n\_sel\_ch\_fsh(k)$.
    \item seldecage it is a fixed value calculated from $selcage=int\left(\dfrac{m}{2}\right)$.
    \item nselages\_fsh(k) is calculated from $nselages\_fsh(k)=nselages\_in\_fsh(k)$ where nselages\_in\_fsh is input depending of fsh\_sel\_opt(k).
    \item seldec\_pen\_fsh(k) is input depending of fsh\_sel\_opt(k) for each fishery k.
    \item avgsel\_fsh(k,i) is obtained in Selectivity section and is only calculated when fsh\_sel\_opt(k)=1. 
    
\end{itemize}
\end{itemize}






Now, let index number k (i.e $1\leq k \leq n_{ind}$):



\begin{itemize}
    \item If $logsel\_slope\_ind(k)$ is active
    \begin{equation}
        sel\_like\_ind_1(k,2) = \sum _{i=2}^{n\_sel\_ch\_ind(k)} 0.5*\dfrac{\sum_{j=1}^m(log\_sel\_ind_j(k,yr_i-1)-log\_sel\_ind_j(k,yr_i))^2}{sel\_sigma\_ind^2(k,i)}
    \end{equation} otherwise $sel\_like\_ind_1(k,2)=0$, where for the rest of this section $yr_i = yrs\_sel\_ch\_ind(k,i)$ for each $1\leq i \leq n\_sel\_ch\_ind(k)$. 
    \begin{itemize}
        \item logsel\_slope\_ind(k) is a parameter to be estimated(vector for each index survey k), $logsel\_slope\_ind_i(k)$ is a element of this vector with $1\leq i \leq n\_sel\_ch\_ind(k)$.
        \item n\_sel \_ch\_ind(k) is input value plus one for each index survey k.
        \item yrs\_sel\_ch\_ind(k,i)  is input for each index survey k and i with $2 \leq i \leq n\_sel\_ch\_ind(k)$ and first year
always is $y_0$ i.e $yrs\_sel\_ch\_fsh(k, 1) = y0$.
        \item sel\_sigma\_ind(k,i) is input for each index survey k and i with $n\_sel\_ch\_ind(k)$
        \item $log\_sel\_ind_j(k,i)$  is obtained in section m, for each age group j, year i and index survey k.
37

    \end{itemize}
    
    \item If $log\_selcoffs\_ind(k)$ is active
    \begin{equation}
sel\_like\_ind(k,1) = \sum_{i=1}^{n\_sel\_ch\_ind(k)} curv\_pen\_ind(k)*norm2(first\_difference( first\_difference(log\_sel\_ind(k,yr_i)))).
    \end{equation}
    
    On the other hand
    \begin{equation}
sel\_like\_ind(k,2)    =\sum_{i\in B} 0.5*\dfrac{\left(\sum_{j=1}^m(log\_sel\_ind_j(k,yr_i-1)-log\_sel\_ind_j(k,yr_i))^2\right)}{(sel\_sigma\_ind(k,i))^2} + sel\_like\_ind_1(k,2)
    \end{equation}

    where $B=\{1\leq i \leq n\_sel\_ch\_ind(k):\  i>1\}$.\\

    
    Let for each $j$ such that $seldecage \leq j \leq nselages\_ind(k)$
    \begin{equation}
        difftmp_j= log\_sel\_ind_{j-1}(k,yr_i)-log\_sel\_ind_j(k,yr_i),
    \end{equation}
     then
    \begin{equation}
sel\_like\_ind(k,3)    =\sum_{yr_i}\sum_{j\in M} 0.5*\dfrac{(difftmp_j )^2}{seldec\_pen\_ind(k)}
    \end{equation}
    where $M=\{j\in\mathbb{N}: \ difftmp_j>0, \ seldecage \leq j \leq nselages\_ind(k)\}$
    and 
    \begin{equation}
obj\_fun_2= \sum_{k\in act\_selcoffs\_ind}\left(\sum_{1\leq i \leq n\_sel\_ch\_ind(k)}20 * (avgsel\_ind(k,i))^2\right)
    \end{equation}
    where $act\_selcoffs\_ind=\{1\leq k \leq  n_{ind}: \ log\_selcoffs\_ind(k)\  is \ active\}$.
    \begin{itemize}
        \item curv\_pen\_ind(k) is input for ind\_sel\_opt(k)=1,  and also
        if $phase\_selcoff\_ind(k)>0$ then
        \begin{equation*}
    curv\_pen\_ind(k) \leftarrow \dfrac{1.} {({(curv\_pen\_ind(k))}^2*2)}.
        \end{equation*}
        \item nselages\_ind(k) is obtained for each index survey k from $nselages\_ind(k)=nselages\_in\_ind(k)$, where $nselages\_in\_ind(k)$ is input.
        \item seldec\_pen\_ind(k) is input for each index survey k such that ind\_sel\_opt(k)=1.
        \item avgsel\_ind(k,i) is obtained in Selectivity section  and is only calculated when fsh\_sel\_opt(k)=1. 
        \item log\_selcoffs\_ind(k) is a matrix to be estimated for each index survey k. 
    \end{itemize}
\end{itemize}







\subsubsection{Srv\_Like}
Let the index number k, using the log-normal distribution we obtain the log-likelihood function 
\begin{equation} 
ind\_like(k)=\sum_{i=1}^{nyrs_{ind}^k}\dfrac{(log(obs\_ind(k,i)) - log(pred\_ind(k,i)) )^2}{(2*obs\_lse\_ind^2
    (k,i))}.
\end{equation}

\begin{itemize}
    \item $nyrs_{ind}^k$ is the number of years of index value k.
    \item $obs\_lse\_ind(k,i)$ is a matrix with standard errors and is calculated from $obs\_lse\_ind(k,i)=\sqrt{log\left(\left(\dfrac{obs\_se\_ind(k,i)}{obs\_ind(k,i)}\right)^2+1\right)}$ for each index k and i-th year  with $1\leq i \leq nyrs_{ind}^k$.
    \item obs\_se\_ind(k,i) values of indices serrs(i.e obs\_se\_ind\_in(k,i) which is input %line 150
    in dat 
 file) for each index survey k and i with $1\leq i \leq nyrs_{ind}^k$.
    \item obs\_ind(k,i) annuals values of index value (i.e obs\_ind\_in(k,i) which is input %line 147
    in dat file) for each index survey k and i with $1\leq i \leq nyrs_{ind}^k$.
\end{itemize}

\subsubsection{Age Like}
The likelihood function for fisheries and index surveys are calculated as follows.
Let the fishery number k ($1\leq k \leq n_{fsh}$)
\begin{equation}
\textbf{age\_like\_fsh}(k)=\left(\sum_{i=1}^{Fnyrs^k_{age}}-n\_sample\_fsh\_age(k,i)\left(\sum_{j=1}^{m}(oac\_fsh_j(k,i)+0.001)*log(eac\_fsh_j(k,i)+0.001)\right)\right)
\end{equation}
\begin{equation*}
    -offset\_fsh(k),
\end{equation*}
\begin{itemize}
    \item $n\_sample\_fsh\_age$ is observed age composition sample sizes from fishery
 and is obtained from $n\_sample\_fsh\_age_j(k) = n\_sample\_fsh\_age\_in_j(k)$ for each $1\leq j \leq Fnyrs^k_{age}$ if $Fnyrs^k_{age}>0$ 
 where n\_sample\_fsh\_age\_in is input  %line 29 in 
 dat file  and $Fnyrs^k_{age}$ %line 21
 .
\item offset\_fsh(k) for each fishery k is calculated as follows
\begin{equation*}
    offset\_fsh(k)=\displaystyle\sum_{i=1}^{Fnyrs^k_{age}}-n\_sample\_fsh\_age(k,i)*
\end{equation*}
\begin{equation*}
   \left(\sum_{j=1}^m\left(\dfrac{oac\_fsh_j(k,i)}{\sum_{a=1}^m oac\_fsh_a(k,i)}+0.001\right)*log\left(\dfrac{oac\_fsh_j(k,i)}{\sum_{a=1}^m oac\_fsh_a(k,i)}+0.001\right)\right)
\end{equation*}
where oac\_fsh is the observed age composition from fishery and is calculated from $oac\_fsh_j(k,i)=oac\_fsh\_in_j(k,i)$ for each fishery k, year i and age group j. $oac\_fsh\_in$ is matrix input %line 33 
in .dat file.
\item eac\_fsh is calculated in section L. Fishery Predictions.
\end{itemize}




\begin{equation}
    \textbf{length\_like \_fsh}(k)=\left(\sum_{i=1}^{Fnyrs^k_{length}}-n\_sample\_fsh\_length(k,i)\left(\sum_{j=1}^{n_L}(olc\_fsh_j(k,i)+0.001)*log(elc\_fsh_j(k,i)+0.001)\right)\right)
\end{equation}
\begin{equation*}
    -offset\_lfsh(k),
\end{equation*}
\begin{itemize}
    \item $n\_sample\_fsh\_length$ is observed length composition sample sizes from fishery
 and is obtained from $n\_sample\_fsh\_length_j(k) = n\_sample\_fsh\_length\_in_j(k)$ for each $1\leq j \leq Fnyrs^k_{length}$ if $Fnyrs^k_{length}>0$ 
 where n\_sample\_fsh\_length\_in is input  line 31 in dat file  and $Fnyrs_{length}$ line 23.
\item offset\_lfsh(k) for each fishery k is calculated as follows
\begin{equation*}
    offset\_lfsh(k)=\displaystyle\sum_{i=1}^{Fnyrs^k_{length}}-n\_sample\_fsh\_length(k,i)*
\end{equation*}
\begin{equation*}
   \left(\sum_{j=1}^{n_L}\left(\dfrac{olc\_fsh_j(k,i)}{\sum_{a=1}^{n_L} olc\_fsh_a(k,i)}+0.001\right)*log\left(\dfrac{olc\_fsh_j(k,i)}{\sum_{a=1}^{n_L} olc\_fsh_a(k,i)}+0.001\right)\right)
\end{equation*}
where olc\_fsh is the observed length composition from fishery and is calculated from $olc\_fsh_j(k,i)=olc\_fsh\_in_j(k,i)$ for each fishery k, year i and length group j. $olc\_fsh\_in$ is matrix input %line 36 
in .dat file.
\item elc\_fsh is calculated in section L. Fishery Predictions.
\end{itemize}



Now for survey index, let the index number k ($1\leq k \leq n_{ind}$)
\begin{equation}
    \textbf{length\_like\_ind}(k)=\left(\sum_{i=1}^{nyrs\_ind\_lenght(k)}-n\_sample\_ind\_lenght(k,i)\left(\sum_{j=1}^{n_L}(olc\_ind_j(k,i)+0.001)*log(elc\_ind_j(k,i)+0.001)\right)\right)
\end{equation}
\begin{equation*}
    -offset\_lind(k),
\end{equation*}

\begin{itemize}
    \item $n\_sample\_ind\_length$ is observed length composition sample sizes from index
 and is obtained from $n\_sample\_ind\_length_j(k) = n\_sample\_ind\_length\_in_j(k)$ for each $1\leq j \leq nyrs\_ind\_length(k)$ if $nyrs\_ind\_length(k)>0$ 
 where n\_sample\_ind\_length\_in is input  %line 167 
 in .dat file  and nyrs\_ind\_length %line 156
 .
\item offset\_lind(k) for each fishery k is calculated as follows
\begin{equation*}
    offset\_lind(k)=\displaystyle\sum_{i=1}^{nyrs\_ind\_length(k)}-n\_sample\_ind\_length(k,i)*
\end{equation*}
\begin{equation*}
   \left(\sum_{j=1}^{n_L}\left(\dfrac{olc\_ind_j(k,i)}{\sum_{a=1}^{n_L} olc\_ind_a(k,i)}+0.001\right)*log\left(\dfrac{olc\_ind_j(k,i)}{\sum_{a=1}^{n_L} olc\_ind_a(k,i)}+0.001\right)\right)
\end{equation*}
where olc\_ind is the observed length composition from index and is calculated from $olc\_ind_j(k,i)=olc\_ind\_in_j(k,i)$ for each index k, year i and length group j. $olc\_ind\_in$ is matrix input %line 169 
in .dat file.
\item $elc\_ind$ is calculated in section k. Survey Predictions.
\end{itemize}






\begin{equation}
    \textbf{age\_like\_ind}(k)=\left(\sum_{i=1}^{nyrs\_ind\_age(k)}-n\_sample\_ind\_age(k,i)\left(\sum_{j=1}^m(oac\_ind_j(k,i)+0.001)*log(eac\_ind_j(k,i)+0.001)\right)\right)
\end{equation}
\begin{equation*}
    -offset\_ind(k).
\end{equation*}
\begin{itemize}
    \item $n\_sample\_ind\_age$ is observed age composition sample sizes from index
 and is obtained from $n\_sample\_ind\_age_j(k) = n\_sample\_ind\_age\_in_j(k)$ for each $1\leq j \leq nyrs\_ind\_age(k)$ if $nyrs\_ind\_age(k)>0$ 
 where n\_sample\_ind\_age\_in is input  %line 161
 in dat file  and nyrs\_ind\_age %line 153
 .
\item offset\_ind(k) for each index k is calculated as follows
\begin{equation*}
    offset\_ind(k)=\displaystyle\sum_{i=1}^{nyrs\_ind\_age(k)}-n\_sample\_ind\_age(k,i)*
\end{equation*}
\begin{equation*}
   \left(\sum_{j=1}^m\left(\dfrac{oac\_ind_j(k,i)}{\sum_{a=1}^m oac\_ind_a(k,i)}+0.001\right)*log\left(\dfrac{oac\_ind_j(k,i)}{\sum_{a=1}^m oac\_ind_a(k,i)}+0.001\right)\right)
\end{equation*}
where oac\_ind is the observed age composition from index and is calculated from $oac\_ind_j(k,i)=oac\_ind\_in_j(k,i)$ for each index k, year i and age group j. $oac\_ind\_in$ is matrix input %line 163 
in .dat file.
\item eac\_ind is calculated in section k. Survey Predictions.
\end{itemize}



\subsection{Other useful functions}


\subsubsection{Function dvariable get\_spr\_rates(double spr\_percent,int istk)}

Let $sel\_tmp^k_j$ for each fishery k and group age j as follows:
If fishery k belongs to stock istk
\begin{equation}
sel\_tmp^k_j=sel\_fsh^k_{y_N,j}
\end{equation}
else $sel\_tmp^k_j=0$ for all $1\leq j \leq m$ .

Then let
% \begin{equation}
%     Fratio(k)=\sum_{j=1}^mF^k_{y_N,j},
% \end{equation}
\begin{equation}
    sumF(s)=\sum_{k_s}\left(\sum_{j=1}^mF^{k_s}_{y_N,j}\right), 1\leq s  \leq n_{stk},
\end{equation}
and
\begin{equation}
    Fratio(k)=\dfrac{\sum_{j=1}^m F^k_{y_N,j}}{sumF(s_k)}, 1 \leq k \leq n_{fsh}
\end{equation}
where $s_k$ is stock number to which fishery k belongs.


Use Newton Raphson method with 6 iterations to find the root of:
\begin{equation}
    dyld=\dfrac{(yld2-yld3)}{2*df}
\end{equation}
with second derivative:
\begin{equation}
    dyldp=\dfrac{(yld3-(2*yld1)+yld2)}{df^2},
\end{equation}
with df=1.e-3 and
iterations on
\begin{equation*}
    F1\leftarrow F1-\dfrac{dyld}{dyldp},
\end{equation*}
where the initial value is $F1=0.8*natmortprior(mort\_map(istk,1))$ and
\begin{equation*}
    F2\leftarrow F1+df,
\end{equation*}
\begin{equation*}
    F3 \leftarrow F1-df,
\end{equation*}
\begin{equation*}
    yld1=-1000*\left(log\left(\dfrac{spr\_percent}{spr\_ratio(F1, sel\_tmp,y_0,istk)}\right)\right)^2,
\end{equation*}
\begin{equation*}
    yld2   = -1000*\left(log\left(\dfrac{spr\_percent}{spr\_ratio(F2, sel\_tmp,y_0,istk)}\right)\right)^2,
\end{equation*}
\begin{equation*}
    yld3= -1000*\left(log\left(\dfrac{spr\_percent}{spr\_ratio(F3, sel\_tmp,y_0,istk)}\right)\right)^2.
\end{equation*}
This function returns $F1$ after the 6 iterations and spr\_ratio function is defined in the next section.


 \begin{algorithm}[H]
	\caption{{\bf \textit{get spr rates}}}
	1. $\  \ $Let $F_1=0.8*natmortprior(mort\_map(istk,1))$, $df=1.e-3$. \\
    2. $\  \ $ For $ii=1,...,6$, Do \\
	3. $\  \ \quad$   $F_2 = F_1+df$\\
	4. $\  \ \quad$  $F_3 = F_1 -df$\\
	5. $\  \ \quad yld1 =-1000*\left(log\left(\dfrac{spr\_percent}{spr\_ratio(F1, sel\_tmp,y_0,istk)}\right)\right)^2,$\\
    6. $\  \ \quad yld2=-1000*\left(log\left(\dfrac{spr\_percent}{spr\_ratio(F2, sel\_tmp,y_0,istk)}\right)\right)^2,$\\
    7. $\  \ \quad yld3=-1000*\left(log\left(\dfrac{spr\_percent}{spr\_ratio(F3, sel\_tmp,y_0,istk)}\right)\right)^2.$\\
    8. $\  \ \quad$   $dyld=\dfrac{(yld2-yld3)}{2*df},$\\
    9. $\  \ \quad$   $dyldp=\dfrac{yld3-(2*yld1)+yld2}{(df*df)}$.\\
    10. $\  \ \quad$    $F_1=F_{1}-\dfrac{dyld}{dyldp}$\\
    11. $\  \ $EndDo.
    
\end{algorithm}




\subsubsection{FUNCTION dvariable spr\_ratio(dvariable trial\_F,dvar\_matrix sel\_tmp,int iyr,int istk)}

Let for each age group j:
\begin{equation}
    srvtmp(j)=e^{-(\sum_{k=1}^{n_{fsh}}sel\_tmp^k_j*trial\_F*Fratio(k))-M^{istk}_{iyr,j}}.
\end{equation}
Then let $Ntmp_1=1$,
\begin{equation}
    Ntmp_j=Ntmp_{j-1}*srvtmp_{j-1}, \  2\leq j < m.
\end{equation}
Now for $j=m$:
\begin{equation}
Ntmp_{m}=Ntmp_{m-1}*\dfrac{srvtmp(m-1)}{(1.-srvtmp(m))}.
\end{equation}
\begin{equation}
    SBtmp=wt\_mat^{istk}_1*(srvtmp(1))^{s_f}+\sum_{ j=2}^{m-1}Ntmp(j)*wt\_mat^{istk}_j*(srvtmp(j))^{s_f} 
\end{equation}
\begin{equation*}
+Ntmp_{m}*wt\_mat^{istk}_j*(srvtmp(m))^{s_f}.
\end{equation*}
Finally this function returns 
\begin{equation}
    \dfrac{SBtmp}{phizero(cum\_regs(istk)+yy\_sr(istk,iyr))}.
\end{equation}

\subsubsection{FUNCTION spr\_unfished(int istk,int i)}
Let $Ntmp_1=1$ and then 

\begin{equation*}
    Ntmp_j=Ntmp_{j-1}*e^{-M^{istk}_j} \\ 2 \leq j \leq m-1.
\end{equation*}
Finally
\begin{equation}
    Ntmp_m=\dfrac{Ntmp_{m-1}e^{-M^{istk}_{m-1}}}{(1.-e^{-M^{istk}_{i,m}})},
\end{equation}
and
\begin{equation}
    SBtmp=\sum_{j=1}^{m}Ntmp_j*wt\_mat_j^{istk}*e^{-s\_f * M^{istk}_{i,j}}.
\end{equation}
% \begin{equation*}
% +Ntmp_m*wt\_mat^{istk}_m*e^{(-s\_f * M^{istk}_{i,m})}.
% \end{equation*}
This function returns $SBtmp$.

\subsubsection{FUNCTION compute\_spr\_rates}

Let the stock number s:
\begin{equation}
    sumF(s)=\sum_{k_s}\left(\sum_{j=1}^mF^{k_s}_{y_N, j}\right),
\end{equation}
where $\sum_{k_s}$ denotes the sum over the fisheries corresponding to stock s, then
\begin{equation}
    Fratio(k)=\dfrac{\sum_{j=1}^mF^k_{y_N,j}}{sumF(s_k)},
\end{equation}
where $s_k$ is the stock number to which fishery k belongs.\\

For $1\leq s \leq nstk$:
 \begin{equation}
        F35\_est(s) = get\_spr\_rates(0.35,s),
    \end{equation}
     \begin{equation}
        F50\_est(s) = get\_spr\_rates(0.50,s),
    \end{equation}
     \begin{equation}
        F40\_est(s) = get\_spr\_rates(0.40,s).
    \end{equation}

And for $1\leq k \leq n_{fsh}$:
\begin{equation}
        F50(k) = F50\_est(s_k) * (Fratio(k)),
    \end{equation}
\begin{equation}
        F40(k) = F40\_est(s_k) * (Fratio(k)),
    \end{equation}
\begin{equation}
        F35(k) = F35\_est(s_k) * (Fratio(k)).
    \end{equation}


% \textbf{FUNCTION void writerep(dvariable\& tmp,adstring\& tmpstring)}\\


\subsubsection{SolveF3( iyr, N\_tmp,  TACin, istk)}
This function returns ftmp.\\
Input:  iyr, N\_tmp,  TACin, istk.
\begin{equation}
    M\_tmp_j=M^{istk}_{iyr,j}, \ 1\leq j \leq m
\end{equation}
with initial value for ftmp
\begin{equation}
    ftmp=\dfrac{TACin}{\sum_{j=1}^mN\_tmp_j*se^1_{iyr,j}*wt\_pop^s_j},
\end{equation}

\begin{equation}
    Fratsel_j(k)=Fratio(k)*se^k_{iyr,j}, \ 1\leq k \leq n_{fsh}.
\end{equation}
For $1 \leq ii \leq 5$ :
\begin{equation}
    Ftottmp_j= \sum_{k_{istk}}ftmp*Fratsel_j(k_{istk}), \ 1\leq j \leq m,
\end{equation}
where $\displaystyle\sum_{k_{istk}}$ denotes the sum over all fisheries corresponding with stock number istk.
\begin{equation}
    Z\_tmp_j=Ftottmp_j+M\_tmp_j,
\end{equation}
\begin{equation}
    S\_tmp_j=e^{-Z\_tmp_j}.
\end{equation}
\begin{equation}
    cc=\sum_{k_{istk}}\left(\sum_{j=1}^m wt\_fsh^{k_{istk}}_{y_N,j}*\left(\dfrac{ftmp*Fratsel_j(k_{istk})}{Z\_tmp_j}\right)*(1.-S\_tmp_j)*N\_tmp_j\right),
\end{equation}
\begin{equation}
    dd=\dfrac{cc}{TACin}-1
\end{equation}
If ($dd<0.$) :   $dd \leftarrow dd . (-1)$

\begin{equation}
    ftmp \leftarrow ftmp + \dfrac{(TACin-cc)}{btmp}.
\end{equation}
\begin{equation}
    ii \leftarrow ii +1.
\end{equation}
Output: $ftmp$.



 \begin{algorithm}[H]
	\caption{{\bf \textit{SolveF3}}}
	1. $\  \ $Let $ftmp=\dfrac{TACin}{\sum_{j=1}^mN\_tmp_j*se^1_{iyr,j}*wt\_pop^s_j}$. \\
    2. $\  \ $ For $ii=1,...,5$, Do \\
	3. $\  \ \quad$   $Ftottmp_j= \sum_{k_{istk}}ftmp*Fratsel_j(k_{istk}), \ 1\leq j \leq m,$\\
	4. $\  \ \quad$  $Z\_tmp_j=Ftottmp_j+M\_tmp_j,$\\
	5. $\  \ \quad$ $S\_tmp_j=e^{-Z\_tmp_j},$\\
    6. $\  \ \quad$ $cc=\sum_{k_{istk}}\left(\sum_{j=1}^m wt\_fsh^{k_{istk}}_{y_N,j}*\left(\dfrac{ftmp*Fratsel_j(k_{istk})}{Z\_tmp_j}\right)*(1.-S\_tmp_j)*N\_tmp_j\right),$\\
    7. $\  \ \quad$ $dd=\dfrac{cc}{TACin}-1.$\\
    8. $\  \ \quad$  If  $dd<0,$\\
    9. $\  \ \qquad$   $dd \leftarrow dd * (-1)$,\\
    10.$\  \ \quad$   $ftmp \leftarrow ftmp + \dfrac{(TACin-cc)}{btmp},$\\
    11.$\  \ \quad$   $ii \leftarrow ii+1.$\\
    12.$\  \ $EndDo.
    
\end{algorithm}



%hace lo mismo que solveF3\textbf{SolveF2(iyr, N\_tmp, TACin, istk)}\\
%Entradas: iyr, N\_tmp, TACin, istk.





\subsubsection{SolveF2( iyr, Catch, istk )}
Entradas: iyr, Catch, istk.
\begin{equation}
    dd=10,
\end{equation}
\begin{equation}
    N\_tmp_j = N^{istk}_{iyr,j}, \ 1\leq j \leq m,
\end{equation}
\begin{equation}
    btmp_0=0,
\end{equation}
\begin{equation}
    M\_tmp_j=M^{istk}_{iyr,j}.
\end{equation}

Let $k$ a fishery ($1\leq k \leq n_{fsh}$)
\begin{equation}
    btmp(k)  =  \sum_{j=1}^mN\_tmp_j * se^k_{iyr,j} * wt\_fsh^k_{iyr,j},
\end{equation}
\begin{equation}
    hrate(k) = \dfrac{Catch(k)}{btmp(k)},
\end{equation}
\begin{equation}
    Frat(k)  = \dfrac{Catch(k)}{\sum_{k=1}^{n_{fsh}} Catch(k)},
\end{equation}
\begin{equation}
    Fratsel_j(k) = Frat(k)*se^k_{iyr,j}, \ 1\leq k \leq n_{fsh}, \ 1\leq j \leq m,
\end{equation}
\begin{equation}
    ftmp(k) = 1.1*(1.- posfun(1.-hrate(k),.10,fpen(4))).
\end{equation}
If $hrate(k)<.9999$, for $1\leq ii \leq 8$:
\begin{equation}
    Ftottmp(aaa)=\sum_{k_{istk}}ftmp(k_{istk})*Fratsel_{aaa}(k_{istk}), \ 1\leq aaa \leq m
\end{equation}
where the sum is over the fisheries corresponding to stock number $istk$.
\begin{equation}
    Z\_tmp_j     = Ftottmp_j  + M\_tmp_j, \ 1\leq j \leq m
\end{equation}
\begin{equation}
    S\_tmp_j     = e^{ -Z\_tmp_j },
\end{equation}
\begin{equation}
    cc = \sum_{j=1}^m wt\_fsh^k_{iyr,j} * \left(\dfrac{ftmp(k)*Fratsel_j(k)}{  Z\_tmp_j}\right)*(1.-S\_tmp_j)*N\_tmp_j.
\end{equation}
\begin{equation}
    ftmp(k) \leftarrow ftmp(k) + \dfrac{Catch(k)-cc}{btmp(k)}
\end{equation}
End For.
\begin{equation}
    Frat(k)=\dfrac{ftmp(k)}{\sum_{k=1}^{n_{fsh}}ftmp(k)},
\end{equation}
\begin{equation}
    Fratsel_j(k)\leftarrow Frat(k)*se^k_{iyr,j}, \ 1\leq j \leq m.
\end{equation}
Output: ftmp.\\

%\textbf{FUNCTION Write\_SimDatafile}\\
%\textbf{FUNCTION Write\_Datafile}\\


\subsubsection{FUNCTION double mn\_age(const dvector\& pobs)}
\begin{equation}
    mobs = \sum_{a=1}^m(pobs_a*age\_vector_a)
\end{equation}
This function returns mobs.\\

\subsubsection{FUNCTION double mn\_age(const dvar\_vector\& pobs)}

\begin{equation}
    mobs = value\left(\sum_{a=1}^m pobs_a*age\_vector_a\right).
\end{equation}
This function returns mobs.\\

\subsubsection{FUNCTION double Sd\_age(const dvector\& pobs)}
\begin{equation}
    mobs = \sum_{a=1}^m(pobs_a*age\_vector_a),
\end{equation}
\begin{equation}
    stmp = \sqrt{\left(\sum_{a=1}^m(age\_vector_a*age\_vector_a)*pobs_a\right) - mobs^2}.
\end{equation}
This function returns stmp.\\
\subsubsection{FUNCTION double mn\_length(const dvector\& pobs)}
\begin{equation}
    mobs = \sum_{a=1}^{n_L}(pobs_a*len\_bins_a),
\end{equation}
this function returns mobs.\\
\subsubsection{FUNCTION double mn\_length(const dvar\_vector\& pobs)}
\begin{equation}
    mobs = value\left(\sum_{a=1}^{n_L}(pobs_a*len\_bins_a)\right),
\end{equation}
this function returns mobs.\\

\subsubsection{FUNCTION double Sd\_length(const dvector\& pobs)}
\begin{equation}
    mobs = \sum_{a=1}^{n_L}(pobs_a*len\_bins_a),
\end{equation}
\begin{equation}
    stmp = \sqrt{\left(\sum_{a=1}^{n_L}(len\_bins_a^2)*pobs_a\right) - mobs^2},
\end{equation}
this function returns stmp.\\

\subsubsection{FUNCTION double Eff\_N\_adj(const double, const dvar\_vector\& pobs, const dvar\_vector\& phat)}
Let
\begin{itemize}
    \item $lb1 = pobs.indexmin();$
    \item $ub1 = pobs.indexmax().$
\end{itemize}

\begin{equation}
    av_j = age\_vector_j, \ lb1\leq j \leq ub1.
\end{equation}

\begin{equation}
     mobs = value\left(\sum_{j=lb1}^{ub1}pobs_j*av_j\right),
\end{equation}
\begin{equation}
    mhat = value\left(\sum_{j}phat_j*av_j\right),
\end{equation}
\begin{equation}
    rtmp = mobs-mhat,
\end{equation}
\begin{equation}
    stmp = value\left(\sqrt{\left(\sum_{j}(av_j^2)*pobs_j\right) - mobs^2}\right),
\end{equation}
this function returns $\dfrac{stmp^2}{rtmp^2}$.\\

\subsubsection{FUNCTION double Eff\_N2(const dvector\& pobs, const dvar\_vector\& phat)}
\begin{itemize}
    \item $lb1 = pobs.indexmin();$
    \item $ub1 = pobs.indexmax()$.
\end{itemize}
\begin{equation}
    av_j = age\_vector_j, \ lb1\leq j \leq ub1.
\end{equation}

\begin{equation}
     mobs = \sum_{j=lb1}^{ub1}pobs_j*av_j,
\end{equation}
\begin{equation}
    mhat = value\left(\sum_{j}phat_j*av_j\right),
\end{equation}
\begin{equation}
    rtmp = mobs-mhat,
\end{equation}
\begin{equation}
    stmp = \sqrt{\left(\sum_{j}(av_j^2)*pobs_j\right) - mobs^2},
\end{equation}
this function returns $\dfrac{stmp^2}{rtmp^2}$.\\

\subsubsection{FUNCTION double Eff\_N(pobs, phat)}
%Los parámetros de entrada son vectores de la misma dimensión, es decir, pobs y phat tienen la misma cantidad de coordenadas supongamos n.
The input parameters are vectors of the same dimension, i.e., pobs and phat have the same number of coordinates suppose n.
\begin{equation}
    rtmp_j = \dfrac{(pobs_j-phat_j)}{\sqrt{((phat_j*(1-phat_j)))}},\ 1\leq j \leq n,
\end{equation}
\begin{equation}
    vtmp = value\left(\dfrac{\sum_{j=1}^n(rtmp_j)^2}{size\_count(rtmp)}\right),
\end{equation}
this function returns $\dfrac{1}{vtmp}$.\\


\subsubsection{FUNCTION double Eff\_N2\_L(const dvector\& pobs, const dvar\_vector\& phat)}
\begin{equation}
    av = len\_bins, 
\end{equation}
\begin{equation}
    mobs =   \sum_{j=1}^{n_L}(pobs_j*av_j),
\end{equation}
\begin{equation}
    mhat = value\left(\sum_{j=1}^{n_L}phat_j*av_j\right),
\end{equation}

\begin{equation}
    rtmp = mobs-mhat,
\end{equation}
\begin{equation}
    stmp = \sqrt{\left(\sum_{j=1}^{n_L}(av^2)*pobs_j\right) - mobs^2},
\end{equation}
this function returns $\dfrac{stmp^2}{rtmp^2}$.\\

\subsubsection{FUNCTION double get\_AC(const int\& indind)}
Let 
\begin{itemize}
    \item $i1=1$
    \item $i2 = nyrs\_ind(indind)$
\end{itemize}
and
\begin{equation}
    res(i) = log(obs\_ind(indind,i)) - value(log(pred\_ind(indind,i)))
\end{equation}
for $1\leq i \leq i2$.\\

\begin{itemize}
    \item $m1 = (mean(res(i1,i2-1)))$;
    \item $m2 = (mean(res(i1+1,i2))).$
\end{itemize}

\begin{equation}
    actmp = \dfrac{\dfrac{1}{i2-i1}\displaystyle\sum_{j=i1}^{i2-1}\left((res(j+1) - m1)*(res(j+1) - m2)\right)}{\left(\sqrt{\dfrac{1}{i2-i1}\displaystyle\sum_{j=i1}^{i2-1}(res(j) - m1 )^2} \right) * \left(\sqrt{\dfrac{1}{i2-i1}\displaystyle\sum_{j=i1+1}^{i2}(res(j) - m2 )^2} \right)},
\end{equation}

where $i1\leq j \leq i2-1$.\\
This function returns actmp.\\

\subsubsection{FUNCTION double sdnr(const dvar\_vector\& pred,const dvector\& obs, double m)}
Let
\begin{itemize}
    \item n the coordinates number of pred (and obs, have to be the same for both);
    \item $pp = value(pred)+0.000001$
\end{itemize}
and let the vector $v$ such that
\begin{equation}
    v_j=\dfrac{(obs_j+0.000001-pp_j)}{\sqrt{pp_j*(1.-pp_j)*\dfrac{1}{m}}}, \ 1\leq j \leq n.
\end{equation}
Then get
\begin{equation}
    sdnr = std\_dev\left(v\right).
\end{equation}
This function returns sdnr.


\subsubsection{FUNCTION double calc\_Francis\_weights(const dmatrix oac, const dvar\_matrix eac, const ivector sam )}
\begin{itemize}
    \item $i1=oac.rowmin()$,
    \item $i2=oac.rowmax()$,
    \item $nobs = oac.rowsize()$,
    \item $ages$ is a vector defined by $ages(oac.colmin(),m)$, that is, with oac.colmin() rows and $m$ columns.
    \item $resid$ is a vector defined by $resid(i1,i2)$.
\end{itemize}
Then we get
\begin{equation}
    ages(i) = 2*(i) + 0.5,
\end{equation}
for  $oac.colmin() \leq i \leq m$.\\

On the other hand, considering $i1\leq i \leq i2$:

\begin{equation}
    Obs = \sum_{j=oac.colmin()}^{m}oac_j(i) * (ages_j+0.5),
\end{equation}
\begin{equation}
    Pre = \sum_{j=oac.colmin()}^m value(eac_j(i)) * (ages_j+ 0.5),
\end{equation}

\begin{equation}
    Var = \left(\sum_{j=oac.colmin()}^mvalue(eac_j(i)) * (ages_j+0.5)^2\right) - (Pre)^2,
\end{equation}


\begin{equation}
    resid(i) = \dfrac{(Obs - Pre)}{\sqrt{Var * \dfrac{1.0}{ sam(i) }}}.
\end{equation}

Finally
\begin{equation}
     lfwt = \dfrac{1.0}{ (std\_dev(resid))^2 * \left(\dfrac{(nobs - 1.0)}{nobs * 1.0}\right)},
\end{equation}

this function returns lfwt.

\subsection{Models for stock structure hypothesis}

The JJM model allows the exploration of two types of population structure. This allow the construction of models under the one-stock hypothesis "h1" and under the two-stock hypothesis "h2".

\subsection{Description of Model Explorations}

Model implementation could allow to analyse the effect of stock structure hypothesis, model updates and data revisions, changes in selectivity for a specific year, shift in the distribution of fishing effort, among others. 

\section{Model parameters}


\subsection{Estimable parameters}
% Para ajustar el modelo a los datos observados se estiman determinados parámetros de manera que sus predicciones se aproximen a las observaciones lo mejor posible. 
To fit the model to the observed data, certain parameters are estimated so that its predictions approximate the observations as closely as possible.

Each of the different model parameter objects (numbers, vectors, matrices)  to be estimated in the model are declared using the init\_ prefix, optional bounds and an optimization phase. For example, in
\begin{equation*}
    init\_bounded\_vector \ \ theta(1,5,0.0,1.0,2)
\end{equation*}
the first two numbers are the valid indices for the parameter vector theta, the third and fourth arguments specify the bounded interval of the elements of the vector theta, and the final argument is the order in which that model parameter theta is to be estimated (this may depend on the vector indices or be one and the same phase for all elements of the vector). 

If optimization phase is negative means that the parameter is not estimated in the model and therefore takes a constant value throughout the evaluation.



% Para esta sección tomaremos la siguiente convención, si el objeto $XXX$ es un vector entonces denotaremos por $XXX_i$ al valor de la coordenada $i$ del vector $XXX$.\\ 
For this section we will take the following convention, if the object $XXX$ is a vector then we will denote by $XXX_i$ the value of the coordinate $i$ of the vector $XXX$. \\


The parameters that can be estimated in the JJM are as follows
\subsubsection{Biological parameters}
\begin{itemize}
    %\item init\_bounded\_number\_vector Mest(1,nmort,0.02,4.8,phase\_M)
    
    \item Mest: vector of nmort coordinates, each coordinate is estimated in the phase $phase\_M_i$ and its values are bounded between 0.02 and 4.8.
    % vector de nmort coordenadas, cada coordenada se estima en la fase $phase\_M_i$ y sus valores están acotados entre 0.02 y 4.8.
    
    %\item init\_bounded\_vector\_vector Mage\_offset(1,nmort,1,npars\_Mage,-3,3,phase\_Mage)

    \item Mage\_offset: object of nmort rows where each row i has $npars\_Mage_i$ elements and is estimated in phase $phase\_Mage_i$ if this is positive, all values of the Mage\_offset object are bounded between -3 and 3.
    %objeto de nmort filas donde cada fila i tiene $npars\_Mage_i$ elementos y se estima en la fase $phase\_Mage_i$ si este es positivo, todos los valores del objeto Mage\_offset están acotados entre -3 y 3.
    
    %\item  init\_bounded\_vector\_vector M\_rw(1,nstk,1,npars\_rw\_M,-10,10,phase\_rw\_M)
    
    \item M\_rw: object of $n_{stk}$ rows where each row i has $npars\_rw\_M_i$ elements and is estimated in phase $phase\_rw\_M_i$, if this is positive. All values of the object $M\_rw$ are bounded between -10 and 10.
    % objeto de $n_{stk}$ filas donde cada fila i tiene $npars\_rw\_M_i$ elementos y se estima en la fase $phase\_rw\_M_i$, si este es positivo. Todos los valores del objeto $M\_rw$ están acotados entre -10 y 10.
\end{itemize}


\subsubsection{Growth parameters}
\begin{itemize}
    %\item init\_number\_vector log\_Linf(1,ngrowth,phase\_Linf)
    \item log\_Linf: vector of ngrowth coordinates, each object $log\_Linf_i$ is estimated in phase $phase\_Linf_i$ where $1\leq i \leq ngrowth$. 
    % vector de ngrowth coordenadas, cada objeto $log\_Linf_i$ se estima en la fase $phase\_Linf_i$ donde $1\leq i \leq ngrowth$. 
    
    %\item init\_number\_vector log\_k(1,ngrowth,phase\_k)
    \item log\_k: vector of ngrowth coordinates, each object$log\_k_i$ is estimated in phase $phase\_k_i$ where $1\leq i \leq ngrowth$.
    % vector de ngrowth coordenadas, cada objeto$log\_k_i$ se estima en la fase $phase\_k_i$ donde $1\leq i \leq ngrowth$.
    
    %\item init\_number\_vector log\_Lo(1,ngrowth,phase\_Lo)
    \item log\_Lo: vector of ngrowth coordinates, each object $log\_Lo_i$ is estimated in phase $phase\_Lo_i$ where $1 \leq i \leq ngrowth$.
    % vector de ngrowth coordenadas, cada objeto $log\_Lo_i$ se estima en la fase $phase\_Lo_i$ donde $1\leq i \leq ngrowth.$
    
    %\item init\_number\_vector log\_sdage(1,ngrowth,phase\_sdage)
    \item log\_sdage: vector of ngrowth coordinates, each object $log\_sdage_i$ is estimated in phase $phase\_dage_i$ where $1 \leq i \leq ngrowth$.
    % vector de ngrowth coordenadas, cada objeto $log\_sdage_i$ se estima en la fase $phase\_sdage_i$ donde $1\leq i \leq ngrowth$.
    
    \end{itemize}
\subsubsection{Stock Recruitment parameters}
\begin{itemize}
    %\item init\_number\_vector mean\_log\_rec(1,nregs,phase\_mean\_rec)
    \item mean\_log\_rec:
    vector of $n_{regs}$ coordinates, each object $mean\_log\_rec_i$ is estimated in phase $phase\_mean\_rec_i$, $1 \leq i \leq n_{regs}$. 
    % vector de $n_{regs}$ coordenadas, cada objeto $mean\_log\_rec_i$ se estima en la fase $phase\_mean\_rec_i$, $1\leq i \leq n_{regs}$. 
    
    %\item init\_bounded\_number\_vector steepness(1,nrec,0.21,Steepness\_UB,phase\_srec)
    \item steepness: vector of $n_{rec}$ coordinates, each object $steepness_i$ is bounded between $0.21$ and $Steepness\_UB$ (in the model $Steepness\_UB=0.9999$ is taken) and is estimated in the phase $phase\_srec_i$ with $1\leq i \leq n_{rec}$.
    % vector de $n_{rec}$ coordenadas, cada objeto  $steepness_i$ está acotado entre $0.21$ y $Steepness\_UB$ (en el modelo se toma $Steepness\_UB=0.9999$) y se estima en la fase $phase\_srec_i$ con $1\leq i \leq n_{rec}$.


    %\item init\_number\_vector log\_Rzero(1,nregs,phase\_Rzero)
    
    \item log\_Rzero: vector of $n_{regs}$ coordinates, each object $log\_Rzero_i$ is estimated in phase $phase\_Rzero_i$ where $1 \leq i \leq n_{regs}$.
    % vector de $n_{regs}$ coordenadas, cada objeto $log\_Rzero_i$ se estima en la fase $phase\_Rzero_i$ donde $1\leq i \leq n_{regs}$.
    
    %\item init\_bounded\_matrix rec\_dev(1,nstk,styr\_rec,endyr,-15,15,2)
    \item rec\_dev: matrix with values from year $styr\_rec$ to year $y_N$ for each row $i$ with $1\leq i \leq n_{stk}$, all rec\_dev values are bounded from -15 to 15 and are estimated at phase 2.

    %\item init\_number\_vector log\_sigmar(1,nrec,phase\_sigmar)
    \item log\_sigmar: vector with $n_{rec}$ rows, each object $log\_sigmar_i$  are estimated at phase $phase\_sigmar_i$.
\end{itemize}



\subsubsection{Fishing mortality parameters}
\begin{itemize}
    %\item init\_bounded\_matrix fmort(1,nfsh,styr,endyr,-15,15.,phase\_fmort)
    
    \item fmort: matrix with values from year $y_0$ to year $y_N$ for each row $i$ with $1\leq i \leq n_{fsh}$, all fmort values are bounded from -15 to 15 and are estimated at phase $phase\_fmort$.

    
    %\item init\_matrix\_vector log\_selcoffs\_fsh(1,nfsh,1,n\_sel\_ch\_fsh,1,nselages\_fsh,phase\_selcoff\_fsh)
    
    \item log\_selcoffs\_fsh: each object $log\_selcoffs\_fsh_i$ with $1\leq i \leq n_{fsh}$ is a matrix with $n\_sel\_ch\_fsh_i$ rows and $nselages\_fsh_i$ columns and is estimated in phase $phase\_selcoff\_fsh_i$.
    
    %\item init\_matrix\_vector  log\_sel\_spl\_fsh(1,nfsh,1,n\_sel\_ch\_fsh,1,4,phase\_sel\_spl\_fsh)
    \item log\_sel\_spl\_fsh: each object $log\_sel\_spl\_fsh_i$ with $1\leq i \leq n_{fsh}$ is a matrix with $n\_sel\_ch\_fsh_i$ rows and 4 columns, and is estimated in phase $phase\_sel\_spl\_fsh_i$.
    

    
    %\item init\_vector\_vector logsel\_slope\_fsh(1,nfsh,1,n\_sel\_ch\_fsh,phase\_logist\_fsh)
    \item logsel\_slope\_fsh: each object $logsel\_slope\_fsh_i$ with $1\leq i \leq n_{fsh}$ is a vector with $n\_sel\_ch\_fsh_i$ coordinates and is estimated in phase $phase\_logist\_fsh_i$.

    %\item init\_vector\_vector  sel50\_fsh(1,nfsh,1,n\_sel\_ch\_fsh,phase\_logist\_fsh)
    
    \item sel50\_fsh: each object $sel50\_fsh_i$ with $1\leq i\leq n_{fsh}$ is a vector with $n\_sel\_ch\_fsh_i$ coordinates and is estimated in phase $phase\_logist\_fsh_i$.

    
    %\item init\_vector\_vector logsel\_p1\_fsh(1,nfsh,1,n\_sel\_ch\_fsh,phase\_dlogist\_fsh)
    \item logsel\_p1\_fsh: each object $logsel\_p1\_fsh_i$ with $1\leq i \leq n_{fsh}$ is a vector with $n\_sel\_ch\_fsh_i$ coordinates and is estimated in phase $phase\_dlogist\_fsh_i$.   


    %\item init\_vector\_vector logsel\_p2\_fsh(1,nfsh,1,n\_sel\_ch\_fsh,phase\_dlogist\_fsh)
    
    \item logsel\_p2\_fsh: each object $logsel\_p2\_fsh_i$ with $1\leq i \leq n_{fsh}$ is a vector with $n\_sel\_ch\_fsh_i$ coordinates and is estimated in phase $phase\_dlogist\_fsh_i$.

    
    %\item init\_bounded\_vector\_vector logsel\_p3\_fsh(1,nfsh,1,n\_sel\_ch\_fsh,-10,10,phase\_dlogist\_fsh)
    
    \item logsel\_p3\_fsh: each object $logsel\_p3\_fsh_i$ with $1\leq i \leq n_{fsh}$ is  a  vector with $n\_sel\_ch\_fsh_i$ coordinates and bounded values between -10 and 10, and is estimated in phase $phase\_dlogist\_fsh_i$.
    
    
    %\item init\_matrix rec\_dev\_future(1,nstk,styr\_fut,endyr\_fut,phase\_proj)
    \item rec\_dev\_future: matrix with values from year $styr\_fut$ to year $endyr\_fut$ for each row $i$ with $1\leq i \leq n_{stk}$, and all values are estimated in phase $phase\_proj$.
\end{itemize}

\subsubsection{Survey Observation parameters}
\begin{itemize}
    %\item init\_number\_vector log\_q\_ind(1,nind,phase\_q) 
    \item log\_q\_ind: is a vector with $n_{ind}$ coordinates, and each object $log\_q\_ind_i$ with $1\leq i \leq n_{ind}$ is estimated in phase $phase\_q_i$. 

    %\item init\_number\_vector log\_q\_power\_ind(1,nind,phase\_q\_power)
    \item log\_q\_power\_ind: is a vector with $n_{ind}$ coordinates and is estimated in phase $phase\_q\_power_i$.

    
    %\item init\_vector\_vector log\_rw\_q\_ind(1,nind,1,npars\_rw\_q,phase\_rw\_q) 
    \item log\_rw\_q\_ind: each object $log\_rw\_q\_ind_i$ with $1\leq i \leq n_{ind}$ is a vector with $npars\_rw\_q_i$ coordinates and is estimated in phase $phase\_rw\_q_i$.

    
    %\item init\_matrix\_vector log\_selcoffs\_ind(1,nind,1,n\_sel\_ch\_ind,1,nselages\_ind,phase\_selcoff\_ind)
    
    \item log\_selcoffs\_ind: each object $log\_selcoffs\_ind_i$ with $1\leq i \leq n_{ind}$ is a matrix with $n\_sel\_ch\_ind_i$ rows and $nselages\_ind_i$ columns and is estimated in phase $phase\_selcoff\_ind_i$.
    
    
    %\item init\_vector\_vector logsel\_slope\_ind(1,nind,1,n\_sel\_ch\_ind,phase\_logist\_ind+1)
    \item logsel\_slope\_ind: each object $logsel\_slope\_ind_i$ with $1\leq i \leq n_{ind}$ is a vector with $n\_sel\_ch\_ind_i$ coordinates and is estimated in $phase\_logist\_ind_i+1$.
    
    %\item init\_bounded\_vector\_vector        sel50\_ind(1,nind,1,n\_sel\_ch\_ind,0,nages,phase\_logist\_ind)
    
    \item sel50\_ind: each object $sel50\_ind_i$ with $1\leq i \leq n_{ind}$ is a  vector with $n\_sel\_ch\_ind_i$ coordinates with values bounded between 0 and m (number of age groups) and estimated in phase $phase\_logist\_ind_i$. 
    
    %\item init\_vector\_vector logsel\_p1\_ind(1,nind,1,n\_sel\_ch\_ind,phase\_dlogist\_ind)
    \item logsel\_p1\_ind: each object $logsel\_p1\_ind_i$ with $1\leq i \leq n_{ind}$ is a vector with $n\_sel\_ch\_ind_i$ coordinates and is estimated in phase $phase\_dlogist\_ind_i$.

    
    %\item init\_vector\_vector    sel\_p2\_ind(1,nind,1,n\_sel\_ch\_ind,phase\_dlogist\_ind)
    \item sel\_p2\_ind: each object $sel\_p2\_ind_i$  with $1\leq i \leq n_{ind}$ is a vector with $n\_sel\_ch\_ind_i$ coordinates and is estimated in phase $phase\_dlogist\_ind_i$.
    
    %\item init\_vector\_vector logsel\_p3\_ind(1,nind,1,n\_sel\_ch\_ind,phase\_dlogist\_ind)
    \item logsel\_p3\_ind: each object $logsel\_p3\_ind_i$ with $1\leq  i \leq n_{ind}$ is a vector with $n\_sel\_ch\_ind_i$ coordinates and estimated in phase $phase\_dlogist\_ind_i$.
\end{itemize}


\subsection{Parameter estimation procedure}
Model parameters assigned to phase 1 are estimated first, while other parameters are fixed at their initial values.  After phase 1 converges, the optimizer starts phase 2, where parameters assigned to phases 1 and  2 are estimated, and so on until all parameters have been estimated simultaneously in the final phase.

Parameters can be initialized via a .pin file, in the template's INITIALIZATION\_SECTION or PRELIMINARY\_CALC\_SECTION. If a paramter is not initialized in any of these ways, ADMB willl asign it an initial default value, 0 or (if  the  parameter is bounded) the midpoint of the defined interval. 

Using the input .dat and .ctl files of the demo evaluation in the appendix we obtain the estimated parameters and their respective estimation phases.

Let's take into account that for those input files we have
\begin{itemize}
    \item $nmort=1$
    \item $n_{ind}=2$
    \item $n_{stk}=1$
    \item $n_{fsh}=1$
    \item $n_{rec}=1$
    \item $n_{regs}=2$
    \item $ngrwoth=1$
\end{itemize}
\textbf{First phase of optimization}\\
The following parameters are assigned to phase 1

\begin{itemize}
    \item $mean\_log\_rec[1]$
    \item $mean\_log\_rec[2]$
    \item $fmort(1)$
\end{itemize}

\textbf{Second phase of optimization}
\begin{itemize}
    \item $rec\_dev[1]$
\end{itemize}

\textbf{Third phase of optimization}
\begin{itemize}
    \item $log\_q\_ind[1]$
\end{itemize}
\textbf{Fourth phase of estimation}
\begin{itemize}
    \item $log\_Rzero[1]$
    \item $log\_Rzero[2]$
    \item $log\_selcoffs\_fsh[1]$
    \item $log\_q\_ind[2]$
\end{itemize}

\textbf{Fifth phase of optimization}
\begin{itemize}
    \item $rec\_dev\_future[1]$
\end{itemize}

The rest of the parameters are not estimated, that is, they have a negative estimation phase.

\subsection{Initialization Section}
Initialization values of estimable parameters in the JJM model.

\begin{tabular}{| c | c |}
\hline
    Parameter & Initialization value \\ \hline  \hline
    Mest & natmortprior \\ \hline
     steepness & $h^p$ \\ \hline
     log\_sigmar & log\_sigmarprior \\ \hline
     log\_Rzero &    R\_guess\\ \hline
     mean\_log\_rec 
 & R\_guess\\ \hline
 log\_Linf  &  log\_Linfprior\\ \hline
  log\_k &       log\_kprior\\ \hline
  log\_Lo &      log\_Loprior\\ \hline
  log\_sdage &  log\_sdageprior\\ \hline
   log\_q\_ind & log\_qprior\\ \hline
  log\_q\_power\_ind & log\_q\_power\_prior\\ \hline
  sel50\_fsh & sel\_inf\_in\_fshv\\ \hline
  logsel\_p1\_fsh &   logsel\_p1\_in\_fshv \\ \hline
  logsel\_p2\_fsh &   logsel\_p2\_in\_fshv\\ \hline
  logsel\_p3\_fsh &  logsel\_p3\_in\_fshv \\ \hline
  logsel\_p1\_ind &   logsel\_p1\_in\_indv \\ \hline
  sel\_p2\_ind  &       sel\_p2\_in\_indv \\ \hline
  logsel\_p3\_ind &   logsel\_p3\_in\_indv\\ \hline
  logsel\_slope\_ind & logsel\_slp\_in\_indv \\ \hline
  sel50\_ind & sel\_inf\_in\_indv \\ \hline
\end{tabular}


\textbf{Calculation of initialization values}\\
Some values are previously calculated within the model.
% \begin{equation}
%     natmortprior, \ input
% \end{equation}
% \begin{equation}
%     steepnessprior, \ input
% \end{equation}
\begin{equation}
log\_sigmarprior = log(sigmarprior)
\end{equation}

\begin{equation} R\_guess
\end{equation}
\begin{equation}
log\_Linfprior = log(Linfprior)
\end{equation}
\begin{equation}
    log\_kprior = log(kprior)
\end{equation}

\begin{equation}
    log\_Loprior = log(Loprior)
\end{equation}
\begin{equation}
    log\_sdageprior = log(sdageprior)
\end{equation}
\begin{equation}
    log\_qprior = log(qprior)
\end{equation}

\begin{equation}
    log\_q\_power\_prior = log(q\_power\_prior)
\end{equation}

If for some fishery $k$, $fsh\_sel\_opt(k)=2$ then
\begin{equation}
    sel\_inf\_in\_fshv(k)=sel\_inf\_in\_fsh(k,1) 
\end{equation}
where $sel\_inf\_in\_fsh(k,1) $ will be input in such case.\\
If $fsh\_sel\_opt(k)=3$, then 
\begin{equation}
    sel\_inf\_in\_fshv(k)=0.
\end{equation}


If $fsh\_sel\_opt(k)=3$ for some fishery $k$
\begin{itemize}
    \item \begin{equation}
    logsel\_p1\_in\_fshv_k = log(sel\_p1\_in\_fsh(k,1)) 
\end{equation}
where $sel\_p1\_in\_fsh(k,1)$ is input for that case.

\item \begin{equation}
 logsel\_p2\_in\_fshv_k =    log(sel\_p2\_in\_fsh(k,1))   
\end{equation}
where $sel\_p2\_in\_fsh(k,1)$ is input for that case.
\end{itemize}



If $ind\_sel\_opt(k)=3$ for some index k
\begin{itemize}
\item \begin{equation}
    logsel\_p1\_in\_indv(k) = log (sel\_p1\_in\_ind(k,1))
\end{equation} 
where $sel\_p1\_in\_ind(k,1)$ is input for that case.

\item \begin{equation}
sel\_p2\_in\_indv_k = sel\_p2\_in\_ind(k,1)
\end{equation} 
where $sel\_p2\_in\_ind(k,1)$ is input for that case.

\item \begin{equation}
    logsel\_p3\_in\_indv_k = log(sel\_p3\_in\_ind(k,1))
\end{equation}
where $sel\_p3\_in\_ind(k,1)$ is input for that case.

\end{itemize}


If $ind\_sel\_opt(k)=2$ for some index survey $k$
\begin{itemize}
    \item \begin{equation}
    logsel\_slp\_in\_indv_k = log(sel\_slp\_in\_ind(k,1))
\end{equation}
where $sel\_slp\_in\_indv(k,1)$ is input for that case.

\item \begin{equation}
sel\_inf\_in\_indv_k = sel\_inf\_in\_ind(k,1) 
\end{equation}
where $sel\_inf\_in\_ind(k,1)$ is input for that case.
\end{itemize}


\section{File organization}
% List of files to run the model, and how those files are organized?
\subsection{Input Files}
\begin{itemize}
    \item Control file (.ctl): file containing set-up for the parameters (see section 6). Located in the folder called "config".    
    \item Datafile (.dat):  file containing the data for fisheries and index surveys (see section 5). Located in the folder called "input".
\end{itemize}

\subsection{Output Files}
These files are located in the folder called "results". These are the following: MODEL\_NAME\_1\_R.rep, MODEL\_NAME.cor, MODEL\_NAME.par, MODEL\_NAME.pdf, MODEL\_NAME.rep, MODEL\_NAME.std and MODEL\_NAME.yld.  \\ 

The following is the content of each output file and note that in this section some parameters are called by their names from the template, to find them with their names from the manual consult the Parameter index section or the tables in Appendix A, some parameters have the same name in the template and in this manual.
%\begin{itemize}
    %\item 
    
    \subsubsection{MODEL\_NAME\_1\_R.rep} This is generated from the function Write\_R() in the tpl and contains 
    \begin{itemize}
        \item $repl\_F$
        \item $repl\_yld$
        \item $repl\_SSB$
        \item $FW\_$: Francis wts for fisheries ($Francis\_wts(k)$, $1\leq k \leq n_{fsh}$) and index survey ($Francis\_wts(k+n_{fsh})$, $1\leq k \leq n_{ind}$).
    
        \item $M$ \item $q\_$: For each index k and i-th year with available data ($1\leq 
 i \leq nyrs\_ind(k)$) this prints
 \begin{center}
 \begin{tabular}{r l}
    year & q\_k\\ yrs\_ind(k,i)  & ${q\_ind(k,i)}^{q\_power\_ind(k)}$
     \end{tabular}
\end{center}
    \item SurvNextYr, Yr: Is printed $pred\_ind\_nextyr(k)$ for each survey k, then the years from $y_0$ to $y_N$ are printed.
    \item $P\_age2len\_$: Described matrix in section j for each $growth\_map(s,r)$ where $1\leq s \leq n_{stk}$ and $1\leq r \leq n_{reg_s}$
    
    \item len\_bins
    \item TotF: 
 Ftot(s) is printed for each stock s.

 \end{itemize}
 \textbf{If in the model do\_hess=0} (in the model for default do\_hess=0):
 \begin{itemize}
    \item df1
    \item $Total\_Biom\_Nofishing$: For each year i with 
    $y_0\leq i \leq y_N$ is printed
    \begin{center}\begin{tabular}{c c c c c c}
        "Total\_Biom\_Nofishing " & i & totbiom\_NoFish(s,i) & totbiom\_NoFish.sd(s,i) & lb & lu\\
         
    \end{tabular}
    \end{center}
    where 
    lb=$value\left( 
    \dfrac{totbiom\_NoFish(s,i)}{exp{\left(2.*\sqrt{log\left(1+\dfrac{(totbiom\_NoFish.sd(s,i))^2}{(totbiom\_NoFish(s,i))^2} \right) } \right)}}    \right)$ and \\
    lu=$value\left( 
    {totbiom\_NoFish(s,i)}*{exp{\left(2.*\sqrt{log\left(1+\dfrac{(totbiom\_NoFish.sd(s,i))^2}{(totbiom\_NoFish(s,i))^2} \right) } \right)}}    \right)$

    \begin{center}\begin{tabular}{c c c c c c}
        "SSB0\_Dynamic " & i & Sp\_Biom\_NoFishRatio(s,i) & Sp\_Biom\_NoFishRatio.sd(s,i) & lb & lu\\
         
    \end{tabular}
    \end{center}
    where 
    lb=$value\left( 
    \dfrac{Sp\_Biom\_NoFishRatio(s,i)}{exp{\left(2.*\sqrt{log\left(1+\dfrac{(Sp\_Biom\_NoFishRatio.sd(s,i))^2}{(Sp\_Biom\_NoFishRatio(s,i))^2} \right) } \right)}}    \right)$ and \\
    lu=$value\left( 
    {Sp\_Biom\_NoFishRatio(s,i)}*{exp{\left(2.*\sqrt{log\left(1+\dfrac{(Sp\_Biom\_NoFishRatio.sd(s,i))^2}{(Sp\_Biom\_NoFishRatio(s,i))^2} \right) } \right)}}    \right)$ 
    
    
    \begin{center}\begin{tabular}{c c c c c c}
        "SSB\_Nofishing "  & i & Sp\_Biom\_NoFish(s,i) & Sp\_Biom\_NoFish.sd(s,i) & lb & lu\\
         
    \end{tabular}
    \end{center}
    where 
    lb=$value\left( 
    \dfrac{Sp\_Biom\_NoFish(s,i)}{exp{\left(2.*\sqrt{log\left(1+\dfrac{(Sp\_Biom\_NoFish.sd(s,i))^2}{(Sp\_Biom\_NoFish(s,i))^2} \right) } \right)}}    \right)$ and \\
    lu=$value\left( 
    {Sp\_Biom\_NoFish(s,i)}*{exp{\left(2.*\sqrt{log\left(1+\dfrac{(Sp\_Biom\_NoFish.sd(s,i))^2}{(Sp\_Biom\_NoFish(s,i))^2} \right) } \right)}}    \right)$

    
    \begin{center}\begin{tabular}{c c c c c c}
        "Total\_Biom    "  & i & totbiom(s,i) & totbiom.sd(s,i) & lb & lu\\
         
    \end{tabular}
    \end{center}
    where 
    lb=$value\left( 
    \dfrac{totbiom(s,i)}{exp{\left(2.*\sqrt{log\left(1+\dfrac{(totbiom.sd(s,i))^2}{(totbiom(s,i))^2} \right) } \right)}}    \right)$ and \\
    lu=$value\left( 
    {totbiom(s,i)}*{exp{\left(2.*\sqrt{log\left(1+\dfrac{(totbiom.sd(s,i))^2}{(totbiom(s,i))^2} \right) } \right)}}    \right)$ 
    \begin{center}\begin{tabular}{c c c c c c}
        "SSB "   & i & Sp\_Biom(s,i) & Sp\_Biom..sd(s,i) & lb & lu\\
         
    \end{tabular}
    \end{center}
    where 
    lb=$value\left( 
    \dfrac{Sp\_Biom(s,i)}{exp{\left(2.*\sqrt{log\left(1+\dfrac{(Sp\_Biom.sd(s,i))^2}{(Sp\_Biom(s,i))^2} \right) } \right)}}    \right)$ and \\
    lu=$value\left( 
    {Sp\_Biom(s,i)}*{exp{\left(2.*\sqrt{log\left(1+\dfrac{(Sp\_Biom.sd(s,i))^2}{(Sp\_Biom(s,i))^2} \right) } \right)}}    \right)$

    \begin{center}\begin{tabular}{c c c c c c}
        "Recruits "    & i & recruits(s,i) & recruits.sd(s,i) & lb & lu\\
         
    \end{tabular}
    \end{center}
    where 
    lb=$value\left( 
    \dfrac{recruits(s,i)}{exp{\left(2.*\sqrt{log\left(1+\dfrac{(recruits.sd(s,i))^2}{(recruits(s,i))^2} \right) } \right)}}    \right)$ and \\
    lu=$value\left( 
    {recruits(s,i)}*{exp{\left(2.*\sqrt{log\left(1+\dfrac{(recruits.sd(s,i))^2}{(recruits(s,i))^2} \right) } \right)}}    \right)$    
\item   $TotBiom\_NoFish$: Is printed for each stock s and year i with $y_0 \leq i \leq y_N$
\begin{center}
\begin{tabular}{c c c c c}
  i   &  $totbiom\_NoFish(s,i)$ & $totbiom\_NoFish.sd(s,i)$ & lb & lu \\

\end{tabular}
\end{center}

\item $SSB\_NoFishR$: Is printed for each stock s and year i with $y_0 +1\leq i \leq y_N$.
\begin{center}
\begin{tabular}{c c c c c}
  i   &  $Sp\_Biom\_NoFishRatio(s,i)$ & $Sp\_Biom\_NoFishRatio.sd(s,i)$ & lb & lu \\
      
\end{tabular}
\end{center}
\item  $TotBiom$: Is printed for each stock s and year i with $y_0 \leq i \leq y_N$.
\begin{center}
\begin{tabular}{c c c c c}
  i   &  $totbiom(s,i)$ & $totbiom.sd(s,i)$ & lb & lu \\
      
\end{tabular}
\end{center}
\textbf{In addition if $nproj\_yrs>0$:}
\item df2: for each stock s and year i with $styr\_fut\leq  i \leq endyr\_fut$:
\begin{center}
    \begin{tabular}{c c c c c c}
"SSB\_fut\_1 "    & $i$ &  $SSB\_fut\_1(s,i$ & $SSB\_fut\_1.sd(s,i)$ & lb & lu\\ \end{tabular}
\end{center}
where lb=$value\left(\dfrac{SSB\_fut\_1(s,i)}{exp\left(2.*\sqrt{log(1+{(SSB\_fut\_1.sd(s,i))}^2/{(SSB\_fut\_1(s,i))}^2)}\right)}\right)$ and \\

lu=$value\left({SSB\_fut\_1(s,i)}*{exp\left(2.*\sqrt{log(1+{(SSB\_fut\_1.sd(s,i))}^2/{(SSB\_fut\_1(s,i))}^2)}\right)}\right)$ 

\begin{center}
    \begin{tabular}{c c c c c c}
"SSB\_fut\_2 "    & $i$ &  $SSB\_fut\_2(s,i$ & $SSB\_fut\_2.sd(s,i)$ & lb & lu\\ \end{tabular}
\end{center}
where lb=$value\left(\dfrac{SSB\_fut\_2(s,i)}{exp\left(2.*\sqrt{log(1+{(SSB\_fut\_2.sd(s,i))}^2/{(SSB\_fut\_2(s,i))}^2)}\right)}\right)$ and \\

lu=$value\left({SSB\_fut\_2(s,i)}*{exp\left(2.*\sqrt{log(1+{(SSB\_fut\_2.sd(s,i))}^2/{(SSB\_fut\_2(s,i))}^2)}\right)}\right)$,

\begin{center}
    \begin{tabular}{c c c c c c}
"SSB\_fut\_3 "    & $i$ &  $SSB\_fut\_3(s,i$ & $SSB\_fut\_3.sd(s,i)$ & lb & lu\\ \end{tabular}
\end{center}
where lb=$value\left(\dfrac{SSB\_fut\_3(s,i)}{exp\left(2.*\sqrt{log(1+{(SSB\_fut\_3.sd(s,i))}^2/{(SSB\_fut\_3(s,i))}^2)}\right)}\right)$ and \\

lu=$value\left({SSB\_fut\_3(s,i)}*{exp\left(2.*\sqrt{log(1+{(SSB\_fut\_3.sd(s,i))}^2/{(SSB\_fut\_3(s,i))}^2)}\right)}\right)$,

\begin{center}
    \begin{tabular}{c c c c c c}
"SSB\_fut\_4 "    & $i$ &  $SSB\_fut\_4(s,i$ & $SSB\_fut\_4.sd(s,i)$ & lb & lu\\ \end{tabular}
\end{center}
where lb=$value\left(\dfrac{SSB\_fut\_4(s,i)}{exp\left(2.*\sqrt{log(1+{(SSB\_fut\_4.sd(s,i))}^2/{(SSB\_fut\_4(s,i))}^2)}\right)}\right)$ and \\

lu=$value\left({SSB\_fut\_4(s,i)}*{exp\left(2.*\sqrt{log(1+{(SSB\_fut\_4.sd(s,i))}^2/{(SSB\_fut\_4(s,i))}^2)}\right)}\right)$,


\begin{center}
    \begin{tabular}{c c c c c c}
"SSB\_fut\_5 "    & $i$ &  $SSB\_fut\_5(s,i)$ & $SSB\_fut\_5.sd(s,i)$ & lb & lu\\ \end{tabular}
\end{center}
where lb=$value\left(\dfrac{SSB\_fut\_5(s,i)}{exp\left(2.*\sqrt{log(1+{(SSB\_fut\_5.sd(s,i))}^2/{(SSB\_fut\_5(s,i))}^2)}\right)}\right)$ and \\

ub=$value\left({SSB\_fut\_5(s,i)}*{exp\left(2.*\sqrt{log(1+{(SSB\_fut\_5.sd(s,i))}^2/{(SSB\_fut\_5(s,i))}^2)}\right)}\right)$. 

\item $SSB\_fut\_1$: Let stock number s. For each year i with $styr\_fut \leq i \leq endyr\_fut$ is printed

\begin{center}
    \begin{tabular}{c c c c c}
       i  & $SSB\_fut\_1(s,i)$ & $SSB\_fut\_1.sd(s,i)$ 
         & lb & ub \\
    \end{tabular}
\end{center}


\item $SSB\_fut\_2$: Let stock number s. For each year i with $styr\_fut \leq i \leq endyr\_fut$ is printed

\begin{center}
    \begin{tabular}{c c c c c}
       i  & $SSB\_fut\_2(s,i)$ & $SSB\_fut\_2.sd(s,i)$ 
         & lb & ub \\
    \end{tabular}
\end{center}


\item $SSB\_fut\_3$: Let stock number s. For each year i with $styr\_fut \leq i \leq endyr\_fut$ is printed

\begin{center}
    \begin{tabular}{c c c c c}
       i  & $SSB\_fut\_3(s,i)$ & $SSB\_fut\_3.sd(s,i)$ 
         & lb & ub \\
    \end{tabular}
\end{center}



\item $SSB\_fut\_4$: Let stock number s. For each year i with $styr\_fut \leq i \leq endyr\_fut$ is printed

\begin{center}
    \begin{tabular}{c c c c c}
       i  & $SSB\_fut\_4(s,i)$ & $SSB\_fut\_4.sd(s,i)$ 
         & lb & ub \\
    \end{tabular}
\end{center}




\item $SSB\_fut\_5$: Let stock number s. For each year i with $styr\_fut \leq i \leq endyr\_fut$ is printed

\begin{center}
    \begin{tabular}{c c c c c}
       i  & $SSB\_fut\_5(s,i)$ & $SSB\_fut\_5.sd(s,i)$ 
         & lb & ub \\
    \end{tabular}
\end{center}
\item $Catch\_fut\_$: Is printed for each k with $1\leq k \leq 5$ and year i with $styr\_fut \leq i \leq endyr\_fut$ the future catch
\begin{equation}
    catch\_future(s,k,i)
\end{equation}
(for k=5 the future catch is equal to zero).

\textbf{End of  projection output.}

\item $SSB$: For each year i with $styr\_sp \leq i \leq y_N+1$ is printed 
\begin{center}
    \begin{tabular}{c c c c c }
        i & $Sp\_Biom(s,i)$  &  $Sp\_Biom.sd(s,i)$ & lb & ub\\
          
    \end{tabular}
\end{center}
where lb, ub is defined as before for $Sp\_Biom$.

\item $R$: For each year i with $y_0\leq i \leq y_N$

\begin{center}
    \begin{tabular}{c c c c c}
      i   & recruits(s,i) &  recruits.sd(s,i) & lb & ub\\

    \end{tabular}
\end{center}
where lb, ub is defined as before for $recruits$.\\

\textbf{End of do\_hess=0.}\\

\textbf{If do\_hess $\neq$ 0:} No additional values are calculated for lb and ub. \textbf{End of do\_hess $\neq$ 0.}\\

\item N: Is printed the numbers at age for each year i with $y_0\leq i \leq y_N$

\begin{center}
    \begin{tabular}{c c}
        i & $N^s_{i}$ \\
    \end{tabular}
\end{center}

\item $F\_age\_:$ For each stock s and each fishery k corresponding to stock s is printed
\begin{center}
    \begin{tabular}{c c}
        i & $F^{k_s}_i$ \\
    \end{tabular}
\end{center}
where $y_0\leq i \leq y_N$.
   
\item $Fshry\_names$:The names of the fisheries are printed.

\item $Index\_names$: The names of index surveys are printed.

\item $Obs\_Survey\_$: For index k and their respective years i with available data (i.e $i\in yrs\_ind(k)$) is printed 
\begin{center}
\begin{tabular}{c c c c c c}
  i &  $obs\_ind(k,ii)$ & $pred\_ind(k,ii)$ & $obs\_se\_ind(k,ii)$ & PearsResid & lnPearsResid  \\
\end{tabular}
\end{center}
where $yrs\_ind(k,ii)=i$, PearsResid= $value\left(\dfrac{(obs\_ind(k,ii)-pred\_ind(k,ii))}{obs\_se\_ind(k,ii)} \right)$, and 
$lnPearsResid =  value\left(\dfrac{(log(obs\_ind(k,ii))-log(pred\_ind(k,ii)))}{obs\_lse\_ind(k,ii) }\right)$.
\item $Index\_Q\_$: For each index survey k is printed 
\begin{equation}
    q\_ind(k).
\end{equation}

\textbf{For each fishery k corresponding to each stock s}:\\
\textbf{If $nyrs\_fsh\_age(k)>0$}
\item $pobs\_fsh\_$:
For each i with $1\leq i \leq nyrs\_fsh\_age(k)$ is printed

\begin{center}
    \begin{tabular}{c c}
        $yrs\_fsh\_age(k,i)$ &  $oac\_fsh(k,i)$\\
        \end{tabular}
\end{center}

\item $phat\_fsh\_$: For each i with $1\leq i \leq nyrs\_fsh\_age(k)$ is printed

\begin{center}
    \begin{tabular}{c c}
        $yrs\_fsh\_age(k,i)$ &  $eac\_fsh(k,i)$\\
        \end{tabular}
\end{center}

\item $sdnr\_age\_fsh\_$: For each i with $1\leq i \leq nyrs\_fsh\_age(k)$ is printed

\begin{center}
    \begin{tabular}{c c}
        $yrs\_fsh\_age(k,i)$ &  $sdnr( eac\_fsh(k,i),oac\_fsh(k,i),n\_sample\_fsh\_age(k,i))$\\
          
    \end{tabular}
\end{center}
\textbf{If $nyrs\_fsh\_length(k)>0$:}
\item $pobs\_len\_fsh\_$: For each i with $1\leq i \leq nyrs\_fsh\_length(k)$ is printed
\begin{center}
    \begin{tabular}{c c}
       $yrs\_fsh\_length(k,i)$  &  $olc\_fsh(k,i)$\\
\end{tabular}
\end{center}

\item $phat\_len\_fsh\_$: For each i with $1\leq i \leq nyrs\_fsh\_length(k)$ is printed
\begin{center}
    \begin{tabular}{c c}
       $yrs\_fsh\_length(k,i)$  &  $elc\_fsh(k,i)$\\
\end{tabular}
\end{center}

\item $sdnr\_length\_fsh\_$: For each i with $1\leq i \leq nyrs\_fsh\_length(k)$ is printed
\begin{center}
    \begin{tabular}{c c}
       $yrs\_fsh\_length(k,i)$  &  $sdnr( elc\_fsh(k,i),olc\_fsh(k,i),n\_sample\_fsh\_length(k,i))$.\\
\end{tabular}
\end{center}

\textbf{Now for each index k corresponding to stock s:}\\
\textbf{If $nyrs\_ind\_age(k)>0$}

\item $pobs\_ind\_$: For each i with $1\leq i \leq nyrs\_ind\_age(k)$:
\begin{center}
    \begin{tabular}{c c}
        $yrs\_ind\_age(k,i)$ & $oac\_ind(k,i)$ \\ 
    \end{tabular}
\end{center}

\item $phat\_ind\_$: For each i with $1\leq i \leq nyrs\_ind\_age(k)$:
\begin{center}
    \begin{tabular}{c c}
        $yrs\_ind\_age(k,i)$ & $eac\_ind(k,i)$ \\ 
    \end{tabular}
\end{center}

\item $sdnr\_age\_ind\_$: For each i with $1\leq i \leq nyrs\_ind\_age(k)$:
\begin{center}
    \begin{tabular}{c c}
        $yrs\_ind\_age(k,i)$ & $sdnr( eac\_ind(k,i),oac\_ind(k,i),n\_sample\_ind\_age(k,i)) $. \\ 
    \end{tabular}
\end{center}
\textbf{If $nyrs\_ind\_length(k)>0$:}

\item $pobs\_len\_ind\_$: For each i with $1\leq i \leq nyrs\_ind\_length(k)$
\begin{center}
    \begin{tabular}{c c}
       $yrs\_ind\_length(k,i)$  &  $olc\_ind(k,i)$\\
         
    \end{tabular}
\end{center}

\item $phat\_len\_ind\_$: For each i with $1\leq i \leq nyrs\_ind\_length(k)$
\begin{center}
    \begin{tabular}{c c}
       $yrs\_ind\_length(k,i)$  &  $elc\_ind(k,i)$\\
         
    \end{tabular}
\end{center}



\item $sdnr\_length\_ind\_$: For each i with $1\leq i \leq nyrs\_ind\_length(k)$
\begin{center}
    \begin{tabular}{c c}
       $yrs\_ind\_length(k,i)$  &  $sdnr( elc\_ind(k,i),olc\_ind(k,i),n\_sample\_ind\_length(k,i))$\\
         
    \end{tabular}
\end{center}
\textbf{For each fishery k corresponding to stock s}\\

\item  $Obs\_catch\_$: Is printed 
\begin{equation}
    catch\_bio(k)
\end{equation}
\item $Pred\_catch\_$: Is printed

\begin{equation}
    pred\_catch(k)
\end{equation}

\item $F\_fsh\_$: For each year i with $y_0 \leq  i \leq y_N$
\begin{center}
    \begin{tabular}{c c c }
      i   &  $mean(F^k_i)$ & $mean(F^k_i)*max(Se^k_i
      )$\\
\end{tabular}
\end{center}

\item $sel\_fsh\_$: For each year i with $y_0 \leq  i \leq y_N$
\begin{center}
    \begin{tabular}{c c c }
    k   &  i & $Se^k_i$.\\
\end{tabular}
\end{center}

\textbf{For each index k corresponding to stock s is printed the  index selectivity}\\

\item $sel\_ind\_$: For each year i with $y_0 \leq i \leq y_N$

\begin{center}
    \begin{tabular}{c c c}
        k & i & $sel\_ind(k,i)$ \\
          
    \end{tabular}
\end{center}

\item $Stock\_Rec$: For each year i with $styr\_rec \leq i \leq y_N$, if $log\_Rzero(cum\_regs(s)+yy\_sr(s,i))$ is active then is printed
\begin{center}
    \begin{tabular}{c c c c}
        i &  $Sp\_Biom(s,i-rec\_age)$ & $SRecruit(Sp\_Biom(s,i-rec\_age),cum\_regs(s)+yy\_sr(s,i))$ & $mod\_rec(s,i)$\\
         
    \end{tabular}
    
\end{center}
else is printed
\begin{center}
    \begin{tabular}{c c c c}
     i    & $Sp\_Biom(s,i-rec\_age)$ & $999$ & $mod\_rec(s,i)$. \\

    \end{tabular}
\end{center}
\item $SR\_Curve\_years\_$: For regimen r corresponding to stock s is printed
\begin{equation}
    yr\_rec\_est(cum\_regs(s)+r).
\end{equation}

\item $stock\_Rec\_Curve\_$: For each regimen r corresponding to stock s is printed
\begin{center}
    \begin{tabular}{c c}
        0 & 0. \end{tabular}
\end{center}
If $log\_Rzero(cum\_regs(s)+r)$ is active then is printed
\begin{center}
    \begin{tabular}{c c}
        $stock$ &  $SRecruit(stock, cum\_regs(s)+r)$ \end{tabular}
\end{center}
else is printed

\begin{center}
    \begin{tabular}{c c}
        $stock$ &  99 \\

    \end{tabular}
\end{center}
where in both cases $stock=\dfrac{2*i}{250}*Bzero(cum\_regs(s)+r)$ where $1\leq i \leq 300$.
\item $Like\_Comp:$ Is printed obj\_comps.
\item $Like\_Comp\_names$: The components names of likelihood are printed: $catch\_like$, $age\_like\_fsh$,  $length\_like\_fsh$, $sel\_like\_fsh$, $ind\_like $, $age\_like\_ind$, $length\_like\_ind$, $sel\_like\_ind$, $rec\_like$, $fpen$, $post\_priors\_indq$, $post\_priors$, $residual$, $total$.

\item $Sel\_Fshry\_$: For each fishery corresponding to stock s is printed
\begin{equation}
    sel\_like\_fsh(k)
\end{equation}

\item $Survey\_Index\_$: For each index k corresponding to stock s is printed
\begin{equation}
    ind\_Like(k)
\end{equation}

\item $Age\_Survey\_$: For each index k corresponding to stock s is printed
\begin{equation}
    age\_like\_ind(k).
\end{equation}

\item $Sel\_Survey\_$: For each index survey k corresponding to stock s is printed
\begin{center}
    \begin{tabular}{c c c }
        sel\_like\_ind(k,1) & sel\_like\_ind(k,2) & sel\_like\_ind(k,3) . \\
         \end{tabular}
\end{center}

\item $Rec\_Pen$: For each stock s and regime r with $1\leq r \leq n_{reg_s}$ is printed
\begin{equation}
    sigmar(rec\_map(s,r))
\end{equation}
and in the same line $rec\_like(s)$.
     
\item $m\_sigmar$: Is printed
\begin{equation}
m\_sigmar(cum\_regs(s)+1,cum\_regs(s)+n_{reg_s}).
\end{equation}

\item $sigmar$: For each stock s and regime r with $1\leq r \leq n_{reg_s}$ is printed
\begin{equation}
    sigmar(rec\_map(s,r)).
\end{equation}

 \item $rec\_dev$: For each year i with $styr\_rec \leq i \leq y_N$ is printed
 \begin{center}
     \begin{tabular}{c c}
         i & rec\_dev(s,i). \\
          
     \end{tabular}
 \end{center}

\item $F\_Pen$: Is printed 
\begin{center}
\begin{tabular}{c c}
    fpen(1) & fpen(2). \\
     
\end{tabular}
\end{center}

\item $Q\_Survey\_$: For each index survey k corresponding to stock s is printed 
\begin{center}
    \begin{tabular}{c c c c}
        $post\_priors\_indq(k)$ & $q\_ind(k,1)$ & $qprior(k)$ & $cvqprior(k)$ \\
    \end{tabular}
\end{center}


\item $Q\_power\_Survey\_$: For each index survey k corresponding to stock s is printed 
\begin{center}
    \begin{tabular}{c c c c}
        $post\_priors\_indq(k)$ & $q\_power\_ind(k)$ & $q\_power\_prior(k)$ & $cvq\_power\_prior(k)$. \\
    \end{tabular}
\end{center}

\item $Mest$: For each regime r such that $1\leq r\leq n_{reg_s}$ is printed
\end{itemize}

\begin{center}
\begin{tabular}{c c c c}
       $post\_priors(mort\_map(s,r),1)$  & $Mest(mort\_map(s,r))$  & $natmortprior(mort\_map(s,r))$ & $cvnatmortprior(mort\_map(s,r))$.\\
\end{tabular}
\end{center}
\begin{itemize}
\item $Steep$: For each regime r with $1\leq r \leq n_{reg_s}$ is printed \\
\begin{tabular}{c c c c }
    $post\_priors(rec\_map(s,r),2)$ & $steepness(rec\_map(s,r))$ & $steepnessprior(rec\_map(s,r))$ & $cvsteepnessprior(rec\_map(s,r))$. \\
     
\end{tabular}

\item $Sigmar$:  For each regime r with $1\leq r \leq n_{reg_s}$ is printed \\
\begin{tabular}{c c c c }
    $post\_priors(rec\_map(s,r),3)$ & $sigmar(rec\_map(s,r))$ & $sigmarprior(rec\_map(s,r))$ & $cvsigmarprior(rec\_map(s,r))$. \\
     
\end{tabular}

\item $Num\_parameters\_Est$: Number of parameters.

\item $Steep\_Prior$: For each regime r with $1\leq r \leq n_{reg_s}$ is printed \\
\begin{tabular}{c c c}
    $steepnessprior(rec\_map(s,r))$ & $cvsteepnessprior(rec\_map(s,r))$ & $phase\_srec(rec\_map(s,r))$.\\
     
\end{tabular}

\item $sigmarPrior$: For each regime r with $1\leq r \leq n_{reg_s}$ is printed \\
\begin{tabular}{c c c}
   $sigmarprior(rec\_map(s,r))$  &  $cvsigmarprior(rec\_map(s,r))$& $phase\_sigmar(rec\_map(s,r))$.\\
     
\end{tabular}

\item $Rec\_estimated\_in\_styr\_endyr$: Is printed 
\begin{center}
    \begin{tabular}{c c}
       $styr\_rec$  & $y_N$.  \\
         \end{tabular}
\end{center}


\item $SR\_Curve\_fit\_\_in\_styr\_endyr\_$:  For each regime r with $1\leq r \leq n_{reg_s}$ is printed \\
\begin{tabular}{c c}
   $styr\_rec\_est(s,r)$  & $endyr\_rec\_est(s,r)$ \\
     
\end{tabular}

\item $Model\_styr\_endyr$: Is printed 
\begin{center}
    \begin{tabular}{c c}
        $y_0$ & $y_N$.  \\
    \end{tabular}
\end{center}

\item $M\_prior$:  For each regime r with $1\leq r \leq n_{reg_s}$ is printed 
\begin{center}
    \begin{tabular}{c c c}
       $natmortprior(mort\_map(s,r))$  & $cvnatmortprior(mort\_map(s,r))$ & $phase\_M(mort\_map(s,r))$. \\
    \end{tabular}
\end{center}


\item $qprior$: For each index survey k is printed
\begin{center}
    \begin{tabular}{c c c}
        $qprior(k)$ &  $cvqprior(k)$ & $phase\_q(k)$. \\
    \end{tabular}
\end{center}

\item $q\_power\_prior$: For each index survey k is printed 
\begin{center}
    \begin{tabular}{c c c}
        $q\_power\_prior(k)$ & $cvq\_power\_prior(k)$ & $phase\_q\_power(k)$.  \\
        
    \end{tabular}
\end{center}

\item $cv\_catchbiomass$: Is printed
\begin{equation*}
    cv\_catchbiomass.
\end{equation*}

\item $Projection\_years$: Is printed
\begin{equation*}
    nproj\_yrs.
\end{equation*}

\item $Fsh\_sel\_opt\_fish$: For each fishery k corresponding to stock s is printed
\begin{center}
    \begin{tabular}{c c c}
       k  &  $fsh\_sel\_opt(k)$ & $sel\_change\_in\_fsh(k)$.\\ 
    \end{tabular}
\end{center}

\item $Survey\_Sel\_Opt\_Survey$: For each survey k corresponding to stock s is printed
\begin{center}
    \begin{tabular}{c c}
        k &  $(ind\_sel\_opt(k))$\\
    \end{tabular}
\end{center}

\item $Phase\_survey\_Sel\_Coffs$: For each index survey k corresponding to stock s is printed
\begin{equation*}
    phase\_selcoff\_ind(k).
\end{equation*}

\item $Fshry\_Selages $: For each fishery k corresponding to stock s is printed
\begin{equation*}
    nselages\_in\_fsh(k).
\end{equation*}

\item $Survy\_Selages$: For each index survey k corresponding to stock s is printed
\begin{equation}
    nselages\_in\_ind(k).
\end{equation}

\item $Phase\_for\_age\_spec\_fishery$: For each fishery k is printed
\begin{equation}
    phase\_selcoff\_fsh(k).
\end{equation}

\item $Phase\_for\_logistic\_fishery$:
For each fishery k is printed
\begin{equation}
    phase\_logist\_fsh(k).
\end{equation}

\item $Phase\_for\_dble\_logistic\_fishery$: For each fishery k is printed
\begin{equation*}
    phase\_dlogist\_fsh(k).
\end{equation*}

\item $Phase\_for\_age\_spec\_survey$: For each fishery k corresponding to stock s is printed
\begin{equation*}
    phase\_selcoff\_ind(k).
\end{equation*}

\item $Phase\_for\_logistic\_survey$: For each index survey k is printed
\begin{equation*}
    phase\_logist\_ind(k).
\end{equation*}

\item $Phase\_for\_dble\_logistic\_indy$: For each index survey k corresponding to stock s is printed
\begin{equation*}
    phase\_dlogist\_ind(k).
\end{equation*}

\item $EffN\_Fsh\_$: If $nyrs\_fsh\_age(k)>0$ for some fishery k corresponding to stock s is printed

\begin{tabular}{c c c c }
    $yrs\_fsh\_age(k,i)$ & $Eff\_N(oac\_fsh(k,i),eac\_fsh(k,i))$  & $Eff\_N2(oac\_fsh(k,i),eac\_fsh(k,i))$ & $mn\_age(oac\_fsh(k,i))$ ...  \\
\end{tabular}
 \\
\begin{tabular}{c c c }
    ... $mn\_age(eac\_fsh(k,i))$ & $sda\_tmp$ & $mn\_age(oac\_fsh(k,i)) - \dfrac{sda\_tmp *2.}{ \sqrt{(n\_sample\_fsh\_age(k,i))}}$... 
\end{tabular}
\begin{center}
    ...$mn\_age(oac\_fsh(k,i)) + \dfrac{sda\_tmp *2.}{ \sqrt{(n\_sample\_fsh\_age(k,i))}}$.  \\
     
\end{center}
where $sda\_tmp=Sd\_age(oac\_fsh(k,i))$ and $1\leq i \leq nyrs\_fsh\_age(k)$.


\item $EffN\_Length\_Fsh\_$: If $nyrs\_fsh\_length(k)>0$ for some fishery k corresponding to stock s is printed
\begin{tabular}{c c c c }
    $yrs\_fsh\_length(k,i)$ & $Eff\_N(olc\_fsh(k,i),elc\_fsh(k,i))$  & $Eff\_N2\_L(olc\_fsh(k,i),elc\_fsh(k,i))$ & $mn\_length(olc\_fsh(k,i))$ ...  \\
\end{tabular}
 \\
\begin{tabular}{c c c }
    ... $mn\_length(elc\_fsh(k,i))$ & $sda\_tmp$ & $mn\_length(olc\_fsh(k,i)) - \dfrac{sda\_tmp *2.}{ \sqrt{(n\_sample\_fsh\_length(k,i))}}$... 
\end{tabular}
\begin{center}
    ...$mn\_length(olc\_fsh(k,i)) + \dfrac{sda\_tmp *2.}{ \sqrt{(n\_sample\_fsh\_length(k,i))}}$.  \\
     
\end{center}
where $sda\_tmp=Sd\_length(olc\_fsh(k,i))$ and $1\leq i \leq nyrs\_fsh\_length(k)$.

\item $C\_fsh\_$: For each fishery k corresponding to stock s and year i with $y_0 \leq i \leq y_N$ is printed
\begin{center}
    \begin{tabular}{c c}
       i  &  catage(k,i). \\
    \end{tabular}
\end{center}

\item $wt\_a\_pop$: For each stock s $wt\_pop(s)$ is printed. 

\item $mature\_a$: For each stock s $maturity(s)$ is printed.

\item $wt\_fsh\_$: For each fishery k and year i with $y_0 \leq i \leq y_N$ is printed

\begin{center}
    \begin{tabular}{c c}
        i  & $wt\_fsh(k,i)$. \\
    \end{tabular}
\end{center}
\item $wt\_ind\_$: For each fishery k and year i with $y_0 \leq i \leq y_N$ is printed
\begin{center}
    \begin{tabular}{c c}
       i  &  $wt\_ind(k,i)$.\\
    \end{tabular}
\end{center}

\item $EffN\_Survey\_$: If $nyrs\_ind\_age(k)>0$ for some index survey k corresponding to stock s is printed
\begin{tabular}{c c c c}
    $yrs\_ind\_age(k,i)$ & $Eff\_N(oac\_ind(k,i),eac\_ind(k,i))$  & $Eff\_N2(oac\_ind(k,i),eac\_ind(k,i))$ & $mn\_age(oac\_ind(k,i))$ ...  \\
\end{tabular}
 \\
\begin{tabular}{c c c }
    ... $mn\_age(eac\_ind(k,i))$ & $sda\_tmp$ & $mn\_age(oac\_ind(k,i)) - \dfrac{sda\_tmp *2.}{ \sqrt{(n\_sample\_ind\_age(k,i))}}$... 
\end{tabular}
\begin{center}
    ...$mn\_age(oac\_ind(k,i)) + \dfrac{sda\_tmp *2.}{ \sqrt{(n\_sample\_ind\_age(k,i))}}$.  \\
     
\end{center}
where $sda\_tmp=Sd\_age(oac\_ind(k,i))$ and $1\leq i \leq nyrs\_ind\_age(k)$.

\item $EffN\_Length\_Survey\_$:  If $nyrs\_ind\_length(k)>0$ for some index survey k corresponding to stock s is printed
\begin{tabular}{c c c c}
    $yrs\_ind\_length(k,i)$ & $Eff\_N(olc\_ind(k,i),elc\_ind(k,i))$  & $Eff\_N2\_L(olc\_ind(k,i),elc\_ind(k,i))$ & $mn\_length(olc\_ind(k,i))$ ...  \\
\end{tabular}
 \\
\begin{tabular}{c c c }
    ... $mn\_length(elc\_ind(k,i))$ & $sda\_tmp$ & $mn\_length(olc\_ind(k,i)) - \dfrac{sda\_tmp *2.}{ \sqrt{(n\_sample\_ind\_length(k,i))}}$... 
\end{tabular}
\begin{center}
    ...$mn\_length(olc\_ind(k,i)) + \dfrac{sda\_tmp *2.}{ \sqrt{(n\_sample\_ind\_length(k,i))}}$.  \\
     
\end{center}
where $sda\_tmp=Sd\_age(olc\_ind(k,i))$ and $1\leq i \leq nyrs\_ind\_length(k)$.

\item $msy\_mt$: Let the year i with $y_0 \leq i \leq y_N$ and

\begin{equation*}
    Fratio(k)= \dfrac{\sum_{a=1}^mF^k_{i,a}}{\sum_{k_s} \left(\sum_{a=1}^mF^{k_s}_{i,a}\right)}, \ 1\leq k \leq n_{fsh}
\end{equation*}
where s is the stock to which the k fishery belongs. And

\begin{equation}
    sumF(s)= \dfrac{\sum_{k_s} \left(\sum_{a=1}^mF^{k_s}_{i,a}\right)}{m}.
\end{equation}
For each stock s is printed
\begin{center}
\begin{tabular}{c c c c c c c  }
    i & $spr\_mt\_ft$ & $(1.-spr\_mt\_ft)$ & $Fcur\_Fmsy(s)$ & $Fmsy(s)$ & $sumF(s)$ & $spr\_ratio(Fmsy(s),sel\_tmp,i,s)$... \\
\end{tabular}
\end{center}
\begin{center}
    \begin{tabular}{c c c c c c}
       ...$MSY(s)$  &  $MSYL(s)$ & $Bmsy(s) $ & $Bzero(cum\_regs(s)+yy\_sr(s,i))$ & $Sp\_Biom(s,i)$ & $Bcur\_Bmsy(s)$. \\
    \end{tabular}
\end{center}
where $sel\_tmp$ is a matrix such that $sel\_tmp(j,k)=Se^k_{i,j}$ with $1\leq j \leq m$, and $spr\_mt\_ft=spr\_ratio(sumF(s), sel\_tmp,i, s)$.

\item $age2len\_$: for each $growth\_map(s,r)$ with $1\leq s \leq n_{stk}$, $1\leq r \leq n_{reg_s}$ and $1\leq j \leq m$ is printed
\begin{equation*}
P\_age2len(growth\_map(s,r),j).
\end{equation*}

\item $msy\_m0$: Let the year i with $y_0 \leq i \leq y_N$ and

\begin{equation*}
    Fratio(k)= \dfrac{\sum_{a=1}^mF^k_{i,a}}{\sum_{k_s} \left(\sum_{a=1}^mF^{k_s}_{i,a}\right)}, \ 1\leq k \leq n_{fsh}
\end{equation*}
where s is the stock to which the k fishery belongs. And

\begin{equation}
    sumF(s)= \dfrac{\sum_{k_s} \left(\sum_{a=1}^mF^{k_s}_{i,a}\right)}{m}.
\end{equation}

And considering the natural mortality constant over the years $M(s,i)=M(s,y_0)$, $y_0\leq i \leq y_N$. For each stock s is printed
\begin{center}
    \begin{tabular}{c c c c c c} 
        i & $spr\_mt\_ft$  & $spr\_mt\_f0$ & $\dfrac{(1.-spr\_mt\_f0)}{(1-spr\_mt\_ft)}$ & $Fcur\_Fmsy(s)$ & $Fmsy(s)$...\\
    \end{tabular}
\end{center}
\begin{center}
    \begin{tabular}{c c c c c c }
        ...$sumF(s) $ & $spr\_ratio(Fmsy(s),sel\_tmp,i,s)$ & $MSY(s)$ & $Bmsy(s)$ & $MSYL(s)$ & $Bcur\_Bmsy(s)$.\\
    \end{tabular}
\end{center}

\item $F40\_est$: For each stock s $F40\_est(s)$ is printed.

\item $F35\_est$: For each stock s $F35\_est(s)$ is printed.

\textbf{For each fishery k:}

\item  $rec\_like\_SRR\_stock\_$: Is printed 
\begin{equation}
    rec\_like(k,1).
\end{equation}
\item $rec\_like\_pen\_stock\_$: Is printed
\begin{equation}
    rec\_like(k,2).
\end{equation}
\item $rec\_like\_fut\_stock\_$: Is printed
\begin{equation*}
    rec\_like(k,3).
\end{equation*}


\end{itemize}
    %\item
    \subsubsection{MODEL\_NAME.cor} File containing the correlation matrix and standard deviations for the estimated model parameters.   In the first line is the logarithm of the determinant of the hessian. The index and the name of the parameter is followed by its value and standard deviation. The correlation matrix is included after the standard deviation.
    %\item 
    \subsubsection{MODEL\_NAME.par} File containing the parameter estimates, the final objective function value, and the gradient(which should be close to zero).
    
    %\item 
    \subsubsection{MODEL\_NAME.pdf} File containing the images. These are: Weight at age in the fishery, Weight at age in the survey, Weight at age by cohort in the fleet, Weight at age by cohort in the survey, Weight in the stock, Maturity in the stock, Length composition in fleet FarNorth, Length composition in fleets FarNorth, Total catch, Catch residuals by fleet, Residuals catch at length by fleet, Length fits FarNorth, Predicted and observed catches by fleet, Predicted and observed indices, Standardized survey residuals, SD per input series, Selectivity of the Fishery by Pentad, Selectivity of the survey by Pentad, F at age, F proportion at age, N at age, Proportion at age, Fishery mean length, SSB vs years,  Fishing mortality vs years, Recruitment vs years, Landings vs years, Total biomass vs years, Fishing mortality vs years, Recruitment vs years, Unfished biomass vs years, Uncertainty of key parameters, Mature Immature fish, Stock Recruitment, Comparing fished with unfished biomass, SSB prediction, Catch prediction, Yield and spawing stock biomass per recruit, Kobe plot. 









    
    %\item 
    \subsubsection{MODEL\_NAME.rep} File containing all variables specified in the REPORT\_SECTION. These are 
    \begin{itemize}
        \item P1: Is printed \begin{equation*}
            sel\_p1\_fsh.
        \end{equation*}
        \item P2: Is printed  \begin{equation*}
            sel\_p2\_fsh.
        \end{equation*}
        \item P3: Is printed \begin{equation*}
            sel\_p3\_fsh.
        \end{equation*}
    \item Model name.
    \item Estimated annual F's:  The annual total $Fmort^s_{i}$ for each stock s and year i with $y_0 \leq i \leq y_N$ is printed, that is,
    \begin{equation*}
        Fmort^s_i= \sum_{k_s} \dfrac{\sum_{a=1}^mF^{k}_{i,a}}{m}.
    \end{equation*}

   \item Total mortality (Z): The total mortality Z is printed.
    \item Estimated numbers of fish: Is printed the numbers at age for each stock and year, that is
    \begin{center}
    \begin{tabular}{c c c}
        Year: & i & $N^s_{i}$\\
    \end{tabular}
        \end{center}
where $N^s_i$ is a age vector.
    \item Estimated F mortality: For each fishery k is printed
    \begin{center}
        \begin{tabular}{c c c}
           Fishery  &  k & : \\
            
        \end{tabular}
    \end{center}
    \begin{center}
        \begin{tabular}{c c c }
          Year:   & i  & $F^k_i$ \\
        
        \end{tabular}
        for each year i with $y_0\leq i \leq y_N$ where $F^k_i$ is a vector age.
    \end{center}
    \item survey q : $q\_ind$ is printed.
    \item Observed survey values: For each index survey k belonging to stock s is printed
    \begin{center}
        \begin{tabular}{c c c}
        $Yr\_Obs\_Pred\_Survey $     & k & :  \\
        \end{tabular}
    \end{center}

    and if iyr is a year with available data for index k is printed
    \begin{center}
        \begin{tabular}{c c c}
            iyr & obs\_ind(k,ii) & pred\_tmp \\
        \end{tabular}
    \end{center}
    where ii is such that yrs\_ind(k,ii)= iyr, else is printed
    \begin{center}
        \begin{tabular}{c c c }
           iyr  & -1  & pred\_tmp\\
        \end{tabular}
    \end{center}
    where in both cases 
    \begin{equation*}
        pred\_tmp= q\_ind(k,ii) * \left(\sum_{a=1}^m\left(N^s_{iyr,a}.{(S^{s}_{iyr,a})}^{ind\_month\_frac(k)}. sel\_ind^k_{iyr,a}.  wt\_ind^k_{iyr,a}\right)\right)^{q\_power\_ind(k)}.
    \end{equation*}
    \item Survey\_Q: q\_ind is printed.
    \item Observed Prop: For each fishery k is printed
    \begin{center}
        \begin{tabular}{c c c}
         ObsFishery    &  k & :\\
        \end{tabular}
    \end{center}
    then for each index year i, that is $1\leq i \leq nyrs\_fsh\_age(k)$ is printed
    \begin{center}
        \begin{tabular}{c c}
            yrs\_fsh\_age(k,i) &  oac\_fsh(k,i) \\.
            
        \end{tabular}
    \end{center}
    \item Pobs\_length\_fishery\_: For each fishery k is printed 
    \begin{center}
        \begin{tabular}{c c}
          $yrs\_fsh\_length(k,i)$   &  $olc\_fsh(k,i)$\\
            \end{tabular}        
    \end{center}
    where $1\leq i \leq nyrs\_fsh\_length(k)$.
    
    \item Predicted prop: For each fishery k is printed
    \begin{center}
        \begin{tabular}{c c}
            PredFishery  &  k \\
            
        \end{tabular}
    \end{center}
    then for each index year i, that is $1\leq i \leq nyrs\_fsh\_age(k)$ is printed
    \begin{center}
        \begin{tabular}{c c}
          $yrs\_fsh\_age(k,i)$   &  eac\_fsh(k,i)\\.
        \end{tabular}
    \end{center}
    
    \item Pred\_length\_fishery\_: For each fishery k is printed and index year i with $1\leq i \leq nyrs\_fsh\_length(k)$
    \begin{center}
        \begin{tabular}{c c}
           $yrs\_fsh\_length(k,i)$  & elc\_fsh(k,i).\\ 
        \end{tabular}
    \end{center}

    \item Observed prop Survey: For each index survey k ($1\leq k \leq n_{ind}$) is printed
    \begin{center}
        \begin{tabular}{c c c}
           ObsSurvey  &  k & :\\
        \end{tabular}
    \end{center}
    then for each index year i with $1\leq i \leq nyrs\_ind\_age(k)$ is printed
    \begin{center}
        \begin{tabular}{c c}
            $yrs\_ind\_age(k,i)$ & $oac\_ind(k,i)$. \\
        \end{tabular}
    \end{center}

    \item Pobs\_length\_survey:  For each index survey k ($1\leq k \leq n_{ind}$) is printed
    \begin{center}
        \begin{tabular}{c c}
           $yrs\_ind\_length(k,i)$  & $olc\_ind(k,i)$ \\
        \end{tabular}
    \end{center}
    where i is the index year with $1\leq i \leq nyrs\_ind\_length(k)$.

    \item $Predicted prop Survey$: For each index survey k ($1\leq k \leq n_{ind}$) is printed
    \begin{center}
        \begin{tabular}{c c}
           $yrs\_ind\_age(k,i)$  & eac\_ind(k,i) \\
        \end{tabular}
    \end{center}
where i is the index year with $1\leq i \leq nyrs\_ind\_age(k)$.

    \item Pred\_length\_survey: For each index survey k is printed 
    \begin{center}
        \begin{tabular}{c c}
           $yrs\_ind\_length(k,i)$  &  $elc\_ind(k,i)$\\
        \end{tabular}
    \end{center}
    with $1\leq i \leq nyrs\_ind\_length(k)$.

    \item Observed catch biomass: $catch\_bio$ is printed.
    \item predicted catch biomass: $pred\_catch$ is printed.
    \item Estimated annual fishing mortality: For each fishery k is printed
    \begin{center}
        \begin{tabular}{c c c c}
          Average\_F\_Fshry\_   &  k & Full\_selection\_F\_Fshry\_ & k \\
        \end{tabular}
    \end{center}
    and then is printed the index year i 
    followed again by each fishery k without line break
    \begin{center}
        \begin{tabular}{c c}
              $mean(F(k,i))$ & $mean(F(k,i))*max(sel\_fsh(k,i))$. \\
        \end{tabular}
    \end{center}
    \item Selectivity: For each fishery k ($1\leq k \leq n_{fsh}$) and year $y_0 \leq i \leq y_N$
    \begin{center}
        \begin{tabular}{c c c c}
            Fishery  &  k & i & $sel\_fsh(k,i)$\\
        \end{tabular}
    \end{center}
    similarly for index surveys is printed
     \begin{center}
         \begin{tabular}{c c c c}
           Survey   & k & i & $sel\_ind(k,i)$. \\
         \end{tabular}
     \end{center}
    \item Stock Recruitment stuff: For each stock s ($1\leq s\leq n_{stk}$) and year $styr\_rec\leq i \leq y_N$, if $log\_Rzero(cum\_regs(s)+yy\_sr(s,i))$ is active then is printed 
    \begin{center}
        \begin{tabular}{c c c c }
          i   & $Sp\_Biom(s,i-rec\_age)$  & $SRecruit(Sp\_Biom(s,i-rec\_age),cum\_regs(s)+yy\_sr(s,i))$ & $mod\_rec(s,i)$,\\
        \end{tabular}
    \end{center}
    else 
    is printed
    \begin{center}
        \begin{tabular}{c c c c}
            i &  $Sp\_Biom(s,i-rec\_age)$ & 999 & $mod\_rec(s,i)$.\\
        \end{tabular}
    \end{center}
    \item Curve to plot, stock Recruitment:  For each regimen r ($1\leq r \leq n_{regs}$) is printed
\begin{center}
    \begin{tabular}{c c}
        0 & 0. \end{tabular}
\end{center}
Then if $log\_Rzero(r)$ is active then is printed
\begin{center}
    \begin{tabular}{c c}
        $stock$ &  $SRecruit(stock, r)$ \end{tabular}
\end{center}
else is printed

\begin{center}
    \begin{tabular}{c c}
        $stock$ &  99 \\

    \end{tabular}
\end{center}
where in both cases $stock=\dfrac{2*i}{250}*Bzero(r)$ with $1\leq i \leq 300$.
    \item Likelihood Components, catch\_like age\_like\_fsh length\_like\_fsh sel\_like\_fsh ind\_like age\_like\_ind length\_like\_ind sel\_like\_ind rec\_like fpen post\_priors\_indq post\_priors residual total: obj\_comps is printed.
    
    \item  catch\_like: Is printed obj\_comps(1).
    \item age\_like\_fsh: Is printed obj\_comps(2).
    \item length\_like\_fsh: Is printed obj\_comps(3).
    \item sel\_like\_fsh: Is printed obj\_comps(4).
    \item ind\_like: Is printed obj\_comps(5).
    \item age\_like\_ind: Is printed obj\_comps(6).
    \item length\_like\_ind: Is printed obj\_comps(7).
    \item sel\_like\_ind: Is printed obj\_comps(8).
    \item rec\_like: Is printed obj\_comps(9).
    \item fpen: Is printed obj\_comps(10).
    \item post\_priors\_indq: Is printed obj\_comps(11).
    \item post\_priors: Is printed obj\_comps(12).
    \item residual: Is printed $obj\_comps(13)= obj\_fun - \displaystyle\sum_{i=1}^{12}obj\_comps(i)$.
    \item total: Is printed obj\_fun.
    \item Fit to Catch Biomass: Is printed for each fishery k 
    \begin{center}
        \begin{tabular}{c c c}
            $Catch\_like\_Fshry\_\#$ &  k & catch\_like(k).\\
        \end{tabular}
    \end{center}
    \item Age likelihoods for fisheries : For each fishery k is printed
    \begin{center}
        \begin{tabular}{c c c}
            $Age\_like\_Fshry\_\#$ & k & age\_like\_fsh(k). \\
            
        \end{tabular}
    \end{center}
    \item Selectivity penalties for fisheries : Is printed 
    \begin{center}
        \begin{tabular}{c c c}
           Fishery Curvature\_Age  & Change\_Time & Dome\_Shaped\\
        \end{tabular}
    \end{center}
    then for each fishery k is printed
    \begin{center}
        \begin{tabular}{c c c c c}
          $Sel\_Fshry\_\#$   &  k & sel\_like\_fsh(k,1) & sel\_like\_fsh(k,2) & sel\_like\_fsh(k,3). \\
        \end{tabular}
    \end{center}
    \item survey Likelihood(s): For stock s. For each index survey k ($1\leq k \leq n_{ind}$) is printed
    \begin{center}
        \begin{tabular}{c c c}
            Survey\_Index\_\# & k & ind\_like(k).\\
        \end{tabular}
    \end{center}
    \item Age likelihoods for surveys : For each index survey k is printed
    \begin{center}
        \begin{tabular}{c c c}
          Age\_Survey\_\#   & k & age\_like\_ind(k). \\
        \end{tabular}
    \end{center}
    \item Selectivity penalties for surveys : Is printed
    \begin{center}
        \begin{tabular}{c c c c}
          Survey   &  Curvature\_Age & Change\_Time  & Dome\_Shaped\\
        \end{tabular}
    \end{center}
    then for each index survey is printed
    \begin{center}
        \begin{tabular}{c c c c c}
           Sel\_Survey\_\#  &  k & sel\_like\_ind(k,1) & sel\_like\_ind(k,2) & sel\_like\_ind(k,3).\\
        \end{tabular}
    \end{center}
    \item Recruitment penalties:  rec\_like is printed.
    \item  (sigmar): sigmar is printed.
    \item S-R\_Curve: Column 1 of the rec\_like matrix is printed.
    \item Regularity:  Column 2 of the rec\_like matrix is printed.
    \item Future\_Recruits: Column 3 of the rec\_like matrix is printed.
    \item F penalties: Then is printed
    \begin{center}
        \begin{tabular}{c c}
          Avg\_F    &  fpen(1)\\
          Effort\_Variability  &  fpen(2)
        \end{tabular}
    \end{center}
    \item Contribution of Priors: Is printed
    \begin{center}
        \begin{tabular}{c c c c c}
           Source  &   Posterior &  Param\_Val & Prior\_Val &  CV\_Prior.\\
             & 
        \end{tabular}
    \end{center}
    and under each one for each index k ($1\leq k \leq n_{ind}$) is printed
    \begin{center}
        \begin{tabular}{c c c c c}
         Q\_Survey\_\#k & post\_priors\_indq(k) & q\_ind(k) &  qprior(k) & cvqprior(k) \\
         Q\_power\_Survey\_\#k    &  post\_priors\_indq(k) & q\_power\_ind(k) & q\_power\_prior(k) & cvq\_power\_prior(k).
        \end{tabular}
    \end{center}
    \item Natural\_Mortality:  Is printed without a line break
    \begin{center}
        \begin{tabular}{c c c c} 
           column(post\_priors,1)(1,nmort)  & M & natmortprior & cvnatmortprior.\\
        \end{tabular}
    \end{center}
    \item Steepness: Is printed wihout a line break
    \begin{center}
        \begin{tabular}{c c c c}
            column(post\_priors,2)(1,nrec) &  steepness & steepnessprior &  cvsteepnessprior.\\
        \end{tabular}
    \end{center}
    \item SigmaR:  Is printed without a line break
    \begin{center}
        \begin{tabular}{c c c c}
           column(post\_priors,3)(1,nrec)  &  sigmar &  sigmarprior & cvsigmarprior.\\
        \end{tabular}
    \end{center}
    \item Num\_parameters\_Estimated: The total number of estimated parameters is printed followed by the .ctl, .dat file, model and S-R curve(used in the evaluation) name.
    \item Steepnessprior,\_CV,\_phase: Is printed without line break 
    \begin{center}
        \begin{tabular}{c c c}
         steepnessprior    &  cvsteepnessprior & phase\_srec.\\
        \end{tabular}
    \end{center}

    \item sigmarprior,\_CV,\_phase: Is printed without line break 
    \begin{center}
        \begin{tabular}{c c c}
          sigmarprior   &  cvsigmarprior & phase\_sigmar.\\
        \end{tabular}
    \end{center}
    \item Rec\_estimated\_in\_styr\_endyr: Is printed
    \begin{center}
        \begin{tabular}{c c}
           styr\_rec  &  $y_N$\\.
        \end{tabular}
    \end{center}
    For each regime r i.e $1\leq r \leq n_{regs}$ is printed 
    \begin{center}
        \begin{tabular}{c c c c c}
           SR\_Curve\_fit\_\_in\_styr\_endyr\_  & r & : & styr\_rec\_est(istk,ireg) & endyr\_rec\_est(istk,ireg) \\
        \end{tabular}
    \end{center}
where istk is the stock to which regimen number r belongs and ireg is the order that r occupies in the set of regimes belonging to the stock istk. Recall that $n_{regs}$ is the sum of the number of regimes of all stocks. 
    \item Model\_styr\_endyr: The initial year $y_0$ and the final year $y_N$ are printed.
    \item M\_prior,\_CV,\_phase: Is printed
    \begin{center}
        \begin{tabular}{c c c}
          natmortprior   &  cvnatmortprior & phase\_M.\\
        \end{tabular}
    \end{center}
    \item qprior,\_CV,\_phase:  Is printed
    \begin{center}
        \begin{tabular}{c c c}
          qprior   &  cvqprior & phase\_q\\
        \end{tabular}
    \end{center}
    \item  q\_power\_prior,\_CV,\_phase: Is printed
    \begin{center}
        \begin{tabular}{c c c}
            q\_power\_prior &  cvq\_power\_prior & phase\_q\_power.\\
        \end{tabular}
    \end{center}
    \item cv\_catchbiomass: cv\_catchbiomass is printed.
    \item Projection\_years: nproj\_yrs is printed.\\

    \textbf{For each fishery k:}
    \item Fsh\_sel\_opt\_fish: Is printed 
    \begin{center}
        \begin{tabular}{c c c}
           k  &  fsh\_sel\_opt(k) & sel\_change\_in\_fsh(k)\\.
        \end{tabular}
    \end{center}
    \textbf{For each index survey k:}
    \item Survey\_Sel\_Opt\_Survey: Is printed
    \begin{center}
        \begin{tabular}{c c}
           k  &  (ind\_sel\_opt(k)) \\
        \end{tabular}
    \end{center}
    \item Phase\_survey\_Sel\_Coffs: phase\_selcoff\_ind is printed.
    \item Fshry\_Selages:  nselages\_in\_fsh is printed.
    \item Survy\_Selages: nselages\_in\_ind is printed.
    \item Phase\_for\_age-spec\_fishery: phase\_selcoff\_fsh is printed.
    \item Phase\_for\_logistic\_fishery: phase\_logist\_fsh is printed.
    \item Phase\_for\_dble\_logistic\_fishery: phase\_dlogist\_fsh is printed.
    \item Phase\_for\_age-spec\_survey: phase\_selcoff\_ind is printed.
    \item Phase\_for\_logistic\_survey: phase\_logist\_ind is printed.
    \item Phase\_for\_dble\_logistic\_indy:  phase\_dlogist\_ind is printed.\\

    \textbf{For each fishery k:}
    \item Number\_of\_select\_changes\_fishery: Is printed
    \begin{center}
        \begin{tabular}{c c}
            k & n\_sel\_ch\_fsh(k). \\
        \end{tabular}
    \end{center}
    \item Yrs\_fsh\_sel\_change: yrs\_sel\_ch\_fsh(k) is printed.
    \item sel\_change\_in: sel\_change\_in\_fsh(k) is printed.\\

    \textbf{For each index survey k:}
    \item Number\_of\_select\_changes\_survey: Is printed
    \begin{center}
        \begin{tabular}{c c}
           k  & n\_sel\_ch\_ind(k) \\
        \end{tabular}
    \end{center}
    \item Yrs\_ind\_sel\_change: yrs\_sel\_ch\_ind(k) is printed.
    \item sel\_change\_in:  sel\_change\_in\_ind(k) is printed.

     
    \end{itemize}    






    
    \subsubsection{MODEL\_NAME.std} File containing the name of each estimated parameter, its estimated value, and its standard deviation.
    \subsubsection{MODEL\_NAME.yld} File containing the output of the function Profile\_F in the tpl. These are: 
    \begin{itemize}
        \item Profile of stock, yield, and recruitment over F: the name of the model and the .dat file are printed.\\
        Then is printed
        \begin{center}
            \begin{tabular}{c c c c c}
                F & Stock & Yld & Recruit & SPR\\
            \end{tabular}
        \end{center}
        Then for each stock s and each regime r belonging to stock s ($1\leq r \leq n_{reg_s}$) is printed 
        \begin{center}
            \begin{tabular}{c c c c c}
              0.0   &  $B_0(cum\_regs(s)+r)$ & 0.0 & $R_0(cum\_regs(s)+r)$ & 1.00\\
            \end{tabular}
        \end{center}
        followed by 
        \begin{center}
            \begin{tabular}{c c}
               $F1_i$  & $ttt_i$ \\
            \end{tabular}
        \end{center}
    where $F1_i=\dfrac{2*i}{500}$ for each integer i with $1\leq i \leq 500$ and $ttt_i=yld(Fratio, F1_i, s)$ is a vector with 5 coordinates and 
    \begin{equation*}
        Fratio(k)=\dfrac{\sum_{a=1}^m F^k_{y_N,a}}{sumF(s)}, \ 1\leq k \leq n_{fsh}
    \end{equation*}
        where s is the stock where the fishery k belongs and $sumF(s)=\sum_{k_s}\left(\sum_{a=1}^mF^{k}_{y_N,a}\right)$.
        
    \end{itemize}





\section{Data files}
% List of information as part of the data input files
The data file inputs are read in the following order (lines in dat file beginning with \# are not read, they are only comments.):
\begin{itemize}
    \item styr
    \item endyr
    \item rec\_age
    \item oldest\_age
    \item nlength
    \item len\_bins(1,nlength)
    \item nfsh
    \item fshnameread
    \item catch\_bio\_in(1,nfsh,styr,endyr)
    \item catch\_bio\_sd\_in(1,nfsh,styr,endyr)
    \item nyrs\_fsh\_age(1,nfsh)
    \item nyrs\_fsh\_length(1,nfsh)
    \item yrs\_fsh\_age\_in(1,nfsh,1,nyrs\_fsh\_age)
    \item yrs\_fsh\_length\_in(1,nfsh,1,nyrs\_fsh\_length)
    \item n\_sample\_fsh\_age\_in(1,nfsh,1,nyrs\_fsh\_age)
    \item n\_sample\_fsh\_length\_in(1,nfsh,1,nyrs\_fsh\_length)
    \item oac\_fsh\_in(1,nfsh,1,nyrs\_fsh\_age,1,nages)
    \item olc\_fsh\_in(1,nfsh,1,nyrs\_fsh\_length,1,nlength)
    \item wt\_fsh(1,nfsh,styr,endyr,1,nages)
    \item nind 
    \item indnameread
    \item nyrs\_ind(1,nind)
    \item yrs\_ind\_in(1,nind,1,nyrs\_ind)
    \item mo\_ind(1,nind)
    \item obs\_ind\_in(1,nind,1,nyrs\_ind)
    \item obs\_se\_ind\_in(1,nind,1,nyrs\_ind)
    \item nyrs\_ind\_age(1,nind)
    \item nyrs\_ind\_length(1,nind)
    \item yrs\_ind\_age\_in(1,nind,1,nyrs\_ind\_age)
    \item yrs\_ind\_length\_in(1,nind,1,nyrs\_ind\_length)
    \item n\_sample\_ind\_age\_in(1,nind,1,nyrs\_ind\_age)
    \item n\_sample\_ind\_length\_in(1,nind,1,nyrs\_ind\_length)
    \item oac\_ind\_in(1,nind,1,nyrs\_ind\_age,1,nages)
    \item olc\_ind\_in(1,nind,1,nyrs\_ind\_length,1,nlength)
    \item wt\_ind(1,nind,styr,endyr,1,nages) 
    \item spawnmo
    \item age\_err(1,nages,1,nages)

 

\end{itemize}

%%%%tabla muy importante, no borrar

% \begin{tabular}{| p{0.9cm} | p{2.0cm} | p{1.8cm} | c | c |}
% \hline
% Line in the .dat file & Name in .dat file  & Name in the User Guide & Tpl name & Definition\\ \hline\hline
%  3 &  years & $y_0$  & styr & Year of start of observation\\ \hline
% 4 &  years & $y_N$  & endyr & End year of observation\\ \hline
% 6 & ages  & $r_a$  & $rec\_age$ & Recruitment age\\ \hline
% 7 & ages  &  $o_a$ & $oldest\_age$ & Oldest age class\\ \hline
% 9 & nbins & $n_L$  & $nlenght$ & Number of sizes  considered\\ \hline
% 10 & lengthbin & $len\_bins_L$  & $len\_bins$ & Vector sizes \\  \hline
% 12 & Fnum & $n_{fsh}$  & $nfsh$ & Total number of fisheries\\ \hline
% 14 & Fnames &  Fsh\_names & $fshnameread$ & Fisheries names\\ \hline
% 16 & Fcaton &  ${C_{obs}}_{k,y}$ & $catch\_bio\_in$ & Observed catch biomass\\ \hline
% 19 & Fcatonerr &   & $catch\_bio\_sd\_in$ & Catch biomass standard errors \\ \hline
% 21 & FnumyearsA & $Fnyrs^k_{age}$   & $nyrs\_fsh\_age$ & Number of years with age data available\\ \hline
% 23 & FnumyearsL & $Fnyrs^k_{length}$  & $nyrs\_fsh\_length$ & Number of years with length data available\\ \hline
% 25 & Fageyears & $Fyrs^{k,y}_{age}$  & $yrs\_fsh\_age\_in$ & Years with age data available\\ \hline
% 27 & Flenghtyears &   $Fyrs^{k,y}_{length}$& $yrs\_fsh\_lenght\_in$ & Years with lenght data available \\ \hline
% 29 & Fagesample &  $Nsam\_fsh^{k,y}_{age
% }$ & $n\_sample\_fsh\_age\_in$ & \\ \hline
% 31 & Flenghtsample & $Nsam\_fsh^{k,y}_{length}$  & $n\_sample\_fsh\_lenght\_in$ & \\ \hline
% 33 & Fagecomp & $F\_oac^{k}_{y,a}$  & $oac\_fsh\_in$ & Age composition matrix \\ \hline
% 36 & Flenghtcomp & $F\_olc^{k}_{y,L}$  & $olc\_fsh\_in$ & Lenght composition matrix\\ \hline
% 80 & Fwtatage &  $wt\_fsh^{k}_{y,a}$ & $wt\_fsh$ & Matrix weight at age for each year(styr-endyr)\\ \hline
% 134 & Inum &  $n_{ind}$ & $nind$ & Total number of indices\\ \hline
% 136 & Inames & Ind\_names  & $indnameread$ & Index names\\ \hline
% 138 & Inumyears & $nyrs^k_{ind}$  & $nyrs\_ind$ & Vector with numbers of years for each fishery.\\ \hline
% 141 & Iyears &  $Iyrs^{k,y}$ & $yrs\_ind\_in$ & Matrix with years for each index.\\ \hline
% 144 & Imonths & $mo_{ind}$  & $mo\_ind$ & Month occur \\ \hline
% 147 & Index &  ${I_{obs}}_{k,y}$ & $obs\_ind\_in$ & Values of index value (annual)\\ \hline
% 150 & Indexerr &  ${I_{obs\_se}}_{k,y}$ & $obs\_se\_ind\_in$ & Values of indices serrs.\\ \hline
% 153 & Inumageyears &  $Inyrs^k_{age}$ & $nyrs\_ind\_age$ & Number of years with age data available for index.\\
% \hline
% 156 & Inumlenghtyears &  $Inyrs^k_{length}$ & $nyrs\_ind\_lenght$ &  Number of years with lenght data available for index\\ \hline
% 159 & Iyearsage & $Iyrs_{age}^{k,y}$  & $yrs\_ind\_age\_in$ & Matrix of years with age data available\\ \hline
% 161 & Iagesample & $Isam\_Ind^{k,y}_{age}$  & $n\_sample\_ind\_age\_in$ & \\ \hline
% 163 & Ipropage &  $I\_oac^k_{y,a}$ & $oac\_ind\_in$ & Observed age comp from index. \\ \hline
% 165 & Iyearslength &  $Iyrs_{length}^{k,y}$ & $yrs\_ind\_length\_in$ & Matrix of years with length data available\\ \hline
% 167 & Ilenghtsample &   $Isam\_Ind^{k,y}_{length}$ & $n\_sample\_ind\_lenght\_in$ & \\ \hline
% 169 & Iproplenght & $I\_olc^k_{y,L}$  & $olc\_ind\_in$ & Observed lenght comp from index.\\ \hline
% 171 & Iwtatage & $wt\_ind^k_{y,a}$  & $wt\_ind$ & Matrix weight at age for each year and index value. \\ \hline
% 278 & Pspwn &  $s_p$ & $spawnmo$ & Spawning month.\\ \hline
% 280 & Pageerr & $age\_err^a_a$  & $age\_err$ & Error in matrix age.\\ \hline
% \end{tabular} 

\subsection{Fishery data}

- Catch data: This model uses the catch data for each of the fleet as part of the model representation.

- Length and age data: the age data is also an important input for the JJM model. But in the case any fleet is using length distribution data, this information in converted into age distributions by using age-length keys. The age-length keys is fleet dependent.

- CPUE (catch per unit effort) data series are used in the model, each fleet with a specific methodology for CPUE estimation. Besides, since 2022 the CPUE series include a factor that compensates for efficiency (also termed "effort creep") increases of fishing operations.

\subsection{Fishery independent data}

The model also allow the use of relative abundance indices such as for example acoustic biomass and numbers, spawning stock biomass, estimates of abundance and numbers-at-age, egg surveys results, among others. This information comes from hydro-acoustics, stock assessment and egg and larvae surveys. This information is also fleet-dependent.

\subsection{Biological parameters}

- The JJM model requires the maturity-at-age for the Jack mackerel. This parameter can be estimated by applying an ageing criteria to the otoliths and histological maturity data.

- On the other hand, for fleets that are using length data and age-length keys to convert length to age data, to fit the length composition data a growth curve is used to convert age composition predicted by the model to predicted lengths, with the conversion occurring withing the model.

- The model needs the growth parameters and in this case the JJM model uses the von Bertalanffy growth model. For the model under development is important to consistently use the same length metric for parameters and data, i.e. total length or fork length for model parameters and data.

- The mean weight-at-age will be calculated by year by taking the mean length-at-age in the catch and a length-weight relationship derived for the year. Mean weight-at-age is required for all fishing fleets and biomass indices in order to relate biomass quantities to the underlying model estimates of jack mackerel abundance (in numbers). In some cases, missing weight-at-age data could be replaced with data from the previous year. However, it is recommended that those missing data be replaced with appropriate mean values by fleet instead. 

- The natural mortality is also required for the JJM model. For this, the (\href{https://connect.fisheries.noaa.gov/natural-mortality-tool/}{Natural Mortality Tool}) could be used. 

\subsection{Data sets}
% Name, years, ages, nbins, lengthbin, Fnum, Fnames, Fcaton, Fcatonerr, FnumyearsA, FnumyearsL, Fageyears, Flengthyears, Fagesample, Flengthsample, Fagecomp, Flengthcomp, Fwtatage, Inum, Inames, Inumyears, Iyears, Imonths, Index, Indexerr, Inumageyears, Inumlengthyears, Iyearsage, Iagesample, Ipropage, Iyearslength, Ilengthsample, Iproplength, Iwtatage, Pspwn, Pageerr.

A full description of data sets used to the assessment of Jack mackerel is in the Annex X. Summaries of all data available for the assessment are provided in Table X and Figure Y.

\section{Configuration files}
% List of information as part of the configuration files (ctl files)
The Configuration file inputs are read in the following order (lines  in control file beginning with \# are not read, they are only comments.):
\begin{itemize}
    \item datafile\_name
    \item model\_name
    \item nstk
    \item stknameread
    \item sel\_map(1,3,1,nfsh\_and\_ind)
    \item nreg(1,nstk)
    \item SrType 
    \item use\_age\_err
    \item retro 
    \item rec\_map(1,nstk,1,nreg)
    \item steepnessprior(1,nrec)
    \item cvsteepnessprior(1,nrec)
    \item phase\_srec(1,nrec)
    \item sigmarprior(1,nrec)
    \item cvsigmarprior(1,nrec)
    \item phase\_sigmar(1,nrec)
    \item phase\_Rzero(1,nregs)
    \item nrecs\_est\_shift(1,nregs)
    \item yr\_rec\_est(1,nregs,1,nrecs\_est\_shift)
    \item reg\_shift(1,nstk,1,nreg-1)
    \item growth\_map(1,nstk,1,nreg)
    \item Linfprior(1,ngrowth)
    \item cvLinfprior(1,ngrowth)
    \item phase\_Linf(1,ngrowth)
    \item kprior(1,ngrowth)
    \item  cvkprior(1,ngrowth)
    \item phase\_k(1,ngrowth)
    \item Loprior(1,ngrowth)
    \item cvLoprior(1,ngrowth)
    \item phase\_Lo(1,ngrowth)
    \item sdageprior(1,ngrowth)
    \item cvsdageprior(1,ngrowth)
    \item phase\_sdage(1,ngrowth)
    \item mort\_map(1,nstk,1,nreg)
    \item natmortprior(1,nmort)
    \item cvnatmortprior(1,nmort)
    \item phase\_M(1,nmort)
    \item npars\_Mage(1,nmort)
    \item ages\_M\_changes(1,nmort,1,npars\_Mage)
    \item Mage\_in(1,nmort,1,npars\_Mage)
    \item phase\_Mage(1,nmort)
    \item phase\_rw\_M(1,nstk)
    \item npars\_rw\_M(1,nstk)
    \item yrs\_rw\_M(1,nstk,1,npars\_rw\_M)
    \item sigma\_rw\_M(1,nstk,1,npars\_rw\_M)
    \item qprior(1,nind)
    \item cvqprior(1,nind)  
    \item phase\_q(1,nind)
    \item q\_power\_prior(1,nind)
    \item cvq\_power\_prior(1,nind) 
    \item phase\_q\_power(1,nind)
    \item phase\_rw\_q(1,nind)
    \item npars\_rw\_q(1,nind)
    \item yrs\_rw\_q(1,nind,1,npars\_rw\_q)
    \item sigma\_rw\_q(1,nind,1,npars\_rw\_q)
    \item q\_age\_min(1,nind)
    \item q\_age\_max(1,nind) 
    \item use\_vb\_wt\_age 
    \item nproj\_yrs\\
    
    \textbf{The following are the inputs depending on the type of fishery selectivity to be used:}\\
    
    \textbf{Let the fishery k, for Selectivity coefficients (i.e when fsh\_sel\_opt(k)=1):}\\
    
    \item fsh\_sel\_opt(k)
    \item nselages\_in\_fsh(k)
    \item phase\_sel\_fsh(k)
    \item curv\_pen\_fsh(k)
    \item seldec\_pen\_fsh(k) 
    \item n\_sel\_ch\_fsh(k)
    \item yrs\_sel\_ch\_fsh(k,i)
    \item sel\_sigma\_fsh(k,i)
    \item sel\_fsh\_tmp(j)\\
    
    \textbf{For single logistic (i.e when fsh\_sel\_opt(k)=2):}\\
    
    \item fsh\_sel\_opt(k)
    \item phase\_sel\_fsh(k)
    \item n\_sel\_ch\_fsh(k)
    \item yrs\_sel\_ch\_fsh(k,i)
    \item sel\_sigma\_fsh(k,i)
    \item sel\_slp\_in\_fsh(k,1)
    \item sel\_inf\_in\_fsh(k,1)\\
    
    \textbf{For Double logistic (i.e when fsh\_sel\_opt(k)=3):}\\
    
    \item fsh\_sel\_opt(k)
    \item nselages\_in\_fsh(k)
    \item phase\_sel\_fsh(k)
    \item n\_sel\_ch\_fsh(k)
    \item yrs\_sel\_ch\_fsh(k,i)
    \item sel\_sigma\_fsh(k,i)
    \item sel\_p1\_in\_fsh(k,1)
    \item sel\_p2\_in\_fsh(k,1)
    \item sel\_p3\_in\_fsh(k,1)\\
    
    \textbf{For Splines (i.e when fsh\_sel\_opt(k)=4):}\\
    
    \item fsh\_sel\_opt(k)\\
    No more input.\\
    
    \textbf{Now for index surveys:}\\
    
    \textbf{Let the index survey  k, for Selectivity coefficients indices (i.e when ind\_sel\_opt(k)=1):}\\
    
    \item ind\_sel\_opt(k)
    \item nselages\_in\_ind(k)
    \item phase\_sel\_ind(k)
    \item curv\_pen\_ind(k)
    \item seldec\_pen\_ind(k)
    \item n\_sel\_ch\_ind(k)
    \item yrs\_sel\_ch\_ind(k,i)
    \item sel\_sigma\_ind(k,i)
    \item sel\_ind\_tmp(j)\\
    
    \textbf{For Single logistic 
 (i.e when ind\_sel\_opt(k)=2):}\\
    \item ind\_sel\_opt(k)
    \item phase\_sel\_ind(k)
    \item n\_sel\_ch\_ind(k)
    \item yrs\_sel\_ch\_ind(k,i)
    \item sel\_sigma\_ind(k,i)
    \item sel\_slp\_in\_ind(k,1)
    \item sel\_inf\_in\_ind(k,1)\\
    
    \textbf{For Double logistic 
 (i.e when ind\_sel\_opt(k)=3):}\\
    \item ind\_sel\_opt(k)
    \item nselages\_in\_ind(k)
    \item phase\_sel\_ind(k)
    \item n\_sel\_ch\_ind(k)
    \item yrs\_sel\_ch\_ind(k,i)
    \item sel\_sigma\_ind(k,i)
    \item sel\_p1\_in\_ind(k,1)
    \item sel\_p2\_in\_ind(k,1)
    \item sel\_p3\_in\_ind(k,1)\\
    
     \textbf{For Splines (i.e when ind\_sel\_opt(k)=4):}\\
    \item ind\_sel\_opt(k)\\
    
    No more input.\\

    \textbf{Closing selectivity inputs.}
    \item wt\_pop(1,nstk,1,nages)
    \item maturity(1,nstk,1,nages)
    \item test.
    
 


    
\end{itemize}

%%%%tabla muy importante, no borrar

% \begin{tabular}{|  p{0.9cm} | p{1.9cm}  | p{1.9cm} | c | c |}
% \hline
% Line in the .ctl file & Name in .ctl file  & Name in the User Guide & Tpl name & Definition\\ \hline  \hline
%  5 &  Number of stocks & $n_{stk}$  & nstk & Total number of stocks\\ \hline
% 6 &  Names of stocks & $Stk\_names$ & $stknameread$   & Stocks name\\ \hline
% 8 &  Selectivity sharing vector & sel\_map  & $sel\_map$ & Selectivity matrix\\ \hline
% 15 &  Number of regimes &  ${n_{reg}}_s$ & $nreg$ & Vector with regimes for each stock.\\ \hline
% 17 &  Sr\_type & $sr_{type}$  & $SrType$ & Model type curve S-R\\ \hline
% 19 &  AgeError & $use\_age\_err$  & $use\_age\_err$ & For conditional in eac\_ind.\\ \hline
% 21 &  Retro &   & $retro$ &\\ \hline
% 23 & Recruitment sharing matrix &  $rec\_map$ & $rec\_map$ & recruitment matrix.\\ \hline
% 26 &  Steepness & $h^p$  & $steepnessprior$ & Steepness prior\\ \hline
% 27 &  Steepness & $h^p_{cv}$  & $cvsteepnessprior$ & Coefficient of variation(CV) steepness.\\ \hline
% 28 &  Steepness &   & $phase\_srec$ & Steepness estimation phase.\\ \hline
% 30 &  SigmaR &   & $sigmarprior$ & Prior Recruitment variance.
% \\ \hline
% 31 &  SigmaR &   & $cvsigmarprior$ & CV Recruitment variance.\\ \hline
% 32 &  SigmaR &   & $phase\_sigmar$ & Recruitment variance estimation phase \\ \hline
% 33 &  phase\_Rzero &   & $phase\_Rzero$ & log\_Rzero estimation phase.\\ \hline
% 35 &  Nyrs\_sr &   $Nyrs\_sr^r$& $nrecs\_est\_shift$ & \\ \hline
% 38 &  yrs\_sr & $yrs\_sr^{r,y}$  & $yr\_rec\_est$ &\\ \hline
% 41 &  reg\_shifts &  $reg\_shift^s_{r}$  & $reg\_shift$ & \\ \hline
% 43 &  Growth parameters sharing matrix &  $growth\_map^s_{r}$ & $growth\_map$ & Growth parameters sharing matrix.\\ \hline
% 46 &  Linf &   & $Linfprior$ & Prior  Asymptotic length ($L_{\infty}$)\\ \hline
% 47 &  Linf &   & $cvLinfprior$ & CV $L_{\infty}$\\ \hline
% 48 &  Linf &   & $phase\_Linf$ & $L_{\infty}$ estimation phase.\\ \hline
% 50 &  K &   & $kprior$ & Prior curvature parameter.\\ \hline
% 51 & K &   & $cvkprior$ & CV Curvature parameter.\\ \hline
% 52 &  K &   & $phase\_k$ & Curvature parameter estimation phase.\\ \hline
% 54 &  Lo\_Len &   & $Loprior$ & Prior First length($L_0$).\\ \hline
% 55 &  Lo\_Len  &   & $cvLoprior$ & CV $L_0$.\\ \hline
% 56 &  Lo\_Len  &   & $phase\_Lo$ & $log\_L_0$ phase estimation.\\ \hline
% 58 &  Sigma\_len  &   &  
%  $sdageprior$ & Coefficient of variation of length-at-age ($sd_{age}$).\\ \hline
% 59 &  Sigma\_len  &   & $cvsdageprior$ & CV $sd_{age}$\\ \hline
% 60 &  Sigma\_len  &   & $phase\_sdage$  & $sd_{age}$ phase estimation.\\ \hline
% 61 &  Mortality sharing matrix  & $mort\_map^s_r$   & $mort\_map$  & Mortality sharing matrix.\\ \hline


% \end{tabular} 

% \begin{tabular}{| p{0.9cm} | p{4.0cm}  | p{1.9cm} | c | c |}
% \hline
% Line in the .ctl file & Name in .ctl file  & Name in the User Guide & Tpl name & Definition\\ \hline
% 64 &  Natural\_Mortality  &   & $natmortprior$ & Mest prior.
% \\ \hline
% 65 &  Natural\_Mortality  &   & $cvnatmortprior$ & CV Mest prior.\\ \hline
% 66 &  Natural\_Mortality  &   & $phase\_M$  & Mest phase estimation.\\ \hline
% 67 &  NEW npars\_mage  &   & $npars\_Mage$ & \\ \hline
% 69 &  NEW ages\_M\_changes  &   & $ages\_M\_changes$ &\\ \hline
% 71 &  NEW Mage\_in  &   & $Mage\_in$  &\\ \hline
% 73 &  phase\_Mage  &   &  $phase\_Mage$ &\\ \hline
% 75 &  Phase\_Random\_walk\_M	  &   & $phase\_rw\_M$ &\\ \hline
% 77 &  Nyrs\_Random\_walk\_M  &   & $npars\_rw\_M$ &\\ \hline
% 79 &  Random\_walk\_M\_yrs	  &   & $yrs\_rw\_M$ &\\ \hline
% 81 &  Random\_walk\_M\_sigmas  &   & $sigma\_rw\_M$  &\\ \hline

% 84 & catchability &   &  $qprior$& For initialization of log\_q\_ind.\\ \hline
% 85 & catchability &   &  $cvqprior$& CV qprior.\\ \hline
% 86 & catchability &   &  $phase\_q$& log\_q\_ind phase estimation.\\ \hline
% 88 & q\_power &   & $q\_power\_prior$ & For initialization of log\_q\_power\_ind.\\ \hline
% 89 & q\_power &   & $cvq\_power\_prior$ & CV q\_power\_prior.\\ \hline
% 90 & q\_power &   & $phase\_q\_power$  & log\_q\_power\_ind estimation phase.\\ \hline
% 91 & Random\_walk\_q\_phases &   & $phase\_rw\_q$ &\\ \hline
% 93 & Nyrs\_Random\_walk\_q & $npars\_rw\_q^k$   & $npars\_rw\_q$ &\\ \hline
% 95 & Random\_walk\_q\_yrs & $yrs\_rw\_q^k_y$  & $yrs\_rw\_q$ &\\ \hline
% 97 & Random\_walk\_q\_sigmas &   & $sigma\_rw\_q$ &\\ \hline
% 99 & q\_agemin &  $q_{age,min}^k$ & $q\_age\_min$ &\\ \hline
% 102 & q\_agemax &   $q_{age,max}^k$ & $q\_age\_max$  &\\ \hline
% 103 & use vb wt age &   & $use\_vb\_wt\_age$  &\\ \hline
% 105 & n\_proj\_yrs &  $nyrs_{proj}$ & $nproj\_yrs$ & Number of years of projection.\\ \hline
% 109 & Fishery \#  &  $F_{Se,opt}^k$ & $fsh\_sel\_opt$  & Option for calculating selectivity for fsh.\\ \hline
% 110 & Fishery \# & $Fn_{Se,ages}^k$  & $nselages\_in\_fsh$  &\\ \hline
% 111 & Fishery \# & $Fp_{Se}^k$  & $phase\_sel\_fsh$  &\\ \hline
% 112 & Fishery \# &  $Fcurv_{pen}^k$ & $curv\_pen\_fsh$ &\\ \hline
% 113 & Fishery \# &  $Fdec_{Se,pen}^k$ & $seldec\_pen\_fsh$ &\\ \hline

% \end{tabular} 


% \begin{tabular}{| p{0.9cm} | p{4.0cm}  | p{1.9cm} | c | c |}
% \hline
% Line in the .ctl file & Name in .ctl file  & Name in the User Guide & Tpl name & Definition\\ \hline
% 115 & Years of selectivity &  $Fn_{Se,ch}^k$ & $n\_sel\_ch\_fsh$ & Vector number of selectivity changes for the fsh.\\ \hline
% 116 & Years of selectivity &  $Fyrs_{Se,ch}^{k,y}$ & $yrs\_sel\_ch\_fsh$ & years of selectivity changes for the fsh.\\ \hline
% 117 & Years of selectivity &  $Se_{\sigma}^{k,y}$ & $sel\_sigma\_fsh$ &\\ \hline
% 119 & Initial values for coeff. & $F_{Se}^a$  & $sel\_fsh\_tmp$ &\\ \hline
% 123 & Index \# & $I_{Se,opt}^k$  & ind\_sel\_opt\ & Option for calculating selectivity for index.\\ \hline
% 124 & Index \# & $In_{Se,ages}^k$  & nselages\_in\_ind &\\ \hline
% 125 & Index \# &  $Ip_{Se}^k$ & phase\_sel\_ind &\\ \hline
% 126 & Index \# & $Icurv_{pen}^k$  & curv\_pen\_ind &\\ \hline
% 127 & Index \# & $Idec_{Se,pen}^k$  & seldec\_pen\_ind &\\ \hline
% 128 & Index \# &   &  &\\ \hline
% 129 & Index \# & $I_{Se}^a$  & sel\_ind\_tmp &\\ \hline
% 140 & Population weight at age 1000& $wt\_pop^s_a$  & $wt\_pop$ & Population weight at age.\\ \hline
% 143 & Maturity at Age & $maturity^s_a$  & $maturity$  & Matrix maturity at Age.\\ \hline
% 146 & Test &   & $test$ &\\ \hline
% \end{tabular}


%- Input Data File, model name, Number of stocks, Names of stocks, Selectivity sharing vector, (number\_fisheries + number\_surveys), Number of regimes (by stock), Sr\_type, AgeError, Retro, Recruitment sharing matrix (number\_stocks, number\_regimes), Steepness, SigmaR, phase\_Rzero, Nyrs\_sr, yrs\_sr, reg\_shifts blank if nreg==1, Growth parameters sharing matrix (number\_stocks, number\_regimes), Linf, K, Lo\_Len, Sigma\_len, Mortality sharing matrix number\_stocks, number\_regimes), Natural\_Mortality, npars\_mage, ages\_M\_changes, Mage\_in, phase\_Mage, Phase\_Random\_walk\_M, Nyrs\_Random\_walk\_M, Random\_walk\_M\_yrs blank if nyrs==0, Random\_walk\_M\_sigmas blank if nyrs==0, catchability, q\_power, Random\_walk\_q\_phases, Nyrs\_Random\_walk\_q, Random\_walk\_q\_yrs blank if nyrs==0, Random\_walk\_q\_sigmas blank if nyrs==0, q\_agemin, q\_agemax, use vb wt age, n\_proj\_yrs, Select type for fshry 1, n\_sel\_ages, phase sel, curvature penalty, Dome-shape penalty, Years of selectivity change Fishery 3 Peru, n\_sel\_ch\_fsh, yrs\_sel\_ch\_fsh, sel\_sigma\_fsh, Initial values for coefficitients at each change (one for every change plus 1), Initial values for parameters, Index number 5 Acoustic\_Peru, SelOption, n\_sel\_ages, phase sel, curvature penalty, Dome-shape penalty, n\_sel\_ch\_ind, yrs\_sel\_ch\_ind, sel\_sigma\_ind, Initial values for parameters, Population Weight at Age 1000, Maturity at Age, Test.



\section{Getting started} 
% R, admb
% Installing jjmR: from CRAN, github
% Any other consideration
\subsection{Linux}
\textbf{Prerequisites}
\begin{itemize}
    \item Update the package lists on your system
    \begin{lstlisting}[language=Python]
    sudo apt-get update
    \end{lstlisting}
    \item Install the C++ compiler (g++) with the command 
    \begin{lstlisting}[language=Python]
    sudo apt-get install g++
    \end{lstlisting}
    
    Check if it was installed correctly with the following command:
    \begin{lstlisting}
         g++ --version

    \end{lstlisting}
    \item Install make with the following command
    \begin{lstlisting}
        sudo apt-get install make
    \end{lstlisting}
    Verify that it was installed correctly with the following command
    \begin{lstlisting}
        make --version
    \end{lstlisting}
    \item Install flex with the following command:
    \begin{lstlisting}
        sudo apt-get install flex
    \end{lstlisting}
    Check if it was installed correctly with the following command:
    \begin{lstlisting}
       flex --version
    \end{lstlisting}
\end{itemize}
\textbf{Building Source}
\begin{itemize}
    \item[1.] Download.  Download ADMB source distribution \url{https://github.com/admb-project/admb/releases/download/admb-12.3/admb-12.3-linux.zip}
    \item Run the following command in the terminal
    \begin{lstlisting}
        unzip admb-12.3-src.zip
    \end{lstlisting}
    \item[2.] Build. Then go to the admb-12.3 directory with the following command
    \begin{lstlisting}
        cd admb-12.3
    \end{lstlisting}
    \item To build ADMB for debugging, use the command below.
    \begin{lstlisting}
        make
    \end{lstlisting}
    \item \begin{lstlisting}
        make DEBUG=yes
    \end{lstlisting}
    \item[3.] Test. Run
    \begin{lstlisting}
        make --directory=examples all
    \end{lstlisting}
    \item[4.] Build and run the simple example
    \begin{lstlisting}
        cd examples/admb/simple
        admb simple.tpl
        ./simple
    \end{lstlisting}
\end{itemize}






\section{Starting the JJM model}
% How run the model?
\subsection{Prerequisites}

For run the model we need install R, Rstudio and jjmR package.

\begin{itemize}
    \item Install R
    \item Install Rstudio
        \item Instal jjmR package. For this run in the Rstudio console the next command lines
    \begin{lstlisting}
install.packages("devtools")
devtools::install_github("SPRFMO/jjmR")
    \end{lstlisting}
\end{itemize}
\subsection{Run JJM model using a demo}
Create a new working directory and save  
\begin{itemize}
    \item runModel.R script (see 8.3)
    \item a folder called "config" containing the ctl file
    \item a folder called "results", This will contain output files
    \item a folder called "input" containing the dat file
    \item a folder called "src" containing the executable created from the JJM model .tpl file,
\end{itemize}
then run the script runModel.R (suggested line by line). The output files will be saved in the "results" folder.
\subsection{R script for run the model}
The next is the script called runModel.R for run the model 
\begin{lstlisting}[language=R]

library(jjmR)

modelName = "MODEL_NAME"
 tmpDir = file.path(tempdir(), modelName, "")
 
 #file.path():Construye la ruta a un archivo.
 #tempdir(): directorio temporal
 
 if (!dir.exists(tmpDir)) #revisa si el directorio existe
   dir.create(tmpDir)     #crea el directorio en caso no exista
   
#multipliers vector
xFs_tmp = c(1, 0.75, 1.25, 0.5, 0) 

#escribe la matriz anterior en el file Fscen.dat
write.table(matrix(xFs_tmp,nrow = 1), file="Fscen.dat", row.names=F, col.names=F) 
xavgFs_tmp = c(1) 
write.table(matrix(xavgFs_tmp,nrow = 1), file="avgFlast.dat", row.names=F, col.names=F)

#copia el contenido de Fscen.dat a tmpDir
file.copy(from="Fscen.dat", to=tmpDir, overwrite=TRUE) 
file.copy(from="avgFlast.dat", to=tmpDir, overwrite=TRUE)

#corre el modelo
runJJM(modelName, path="config", input="input", exec="EXECUTABLE_DIRECTORY", 
                                                        output = "results/")
runit(modelName, est=FALSE, portrait=F, pdf=TRUE)
\end{lstlisting}

\subsection{Editing template file in Linux}
If you modify the template file you will need to generate a new executable file, to do this we go to the template directory and run the following command line in the terminal
\begin{lstlisting}
    admb NAME_TEMPLATE.tpl 
    \end{lstlisting}
and then we will have the new executable with the changes made in the template, after this we follow the usual steps above for a new evaluation.




\section{Model outputs}

To analyse the stock status the JJM model provides a big set of model outputs such as: the biomass of the population, the spawning stock biomass (SSB) and the recruitment over the time. Also, the management reference points such as: \(B_{MSY}\) and \(F_{MSY}\) over the time (years).

% To be check!: 
% The fishery mean weights-at-age?, estimates of numbers-at-age?, fits to the composition data, fits of age composition data from the surveys, fit of the indices, relative abundance, estimates of fishery mean age compositions, survey mean age compositions.

% Time series stock status: spawning biomass, fishing mortality, recruitment, total biomass, for each hypothesis.
The outputs of the model are obtained so that the log-likelihood is maximized along with the penalty functions, some of these outputs are estimates of the number of fish by age, annual fishing mortality for each age, total mortality, estimates of length compositions and age compositions, estimated catch, selectivity of both the fishery and the indices. As well as time series of stock status: spawning biomass, future fishing mortality, stock-recruitment curve, total biomass, for each hypothesis, future spawning biomass, among others. 
All model outputs can be found in detail in section 4.2. 

% Management advice and assessment issues is not included.

%\section{Bibliography}


\section{Miscellaneous}
% Any other important points to be explained
\section{Parameter index}
% List of parameter names
\begin{itemize}
    \item ngrowth is the maximum value of the matrix growth\_map.
   \item $n_L$ is the number of sizes considered, it is input in .dat file. In the template it is declared as nlength.
   \item $\mu_{age}(r,a)$ is the mean length estimated for the model for each age group a. In the template it is declared as $mu\_age(r,i)$.
   \item $sd_{age}(r)$ is obtained  for each r with $1\leq r\leq ngrowth$ as $sdage(r)   = e^{log\_sdage(r)}$, where log\_sedage is a parameter to be estimated. In the template it is declared as sdage(r).
   %\item $\mu_a$ 
   %\item $\sigma_{a}$
   \item m is the number of age groups considered. In the template it is called  nages.   %\item $P\_age2len_r$
   \item $len\_bins$ is a vector input where its elements are denoted by $l_j$.
    \item $wt\_mat^s_a$: is a element of the matrix wt\_mat. In the template it is declared as $wt\_mature(1,nstk,1,nages)$.
    \item $n_{stk}$ is the number of stocks considered in the model. In the template it is declared as nstk.
    \item $M^s_{y,a}$ is the natural mortality for each stock s, year y and age group a.
    \item $n_{fsh}$ is the number of fisheries considered in the model. In the template it is called nfsh.
    \item $N^s_{y,{a}}$ is the number at age group a, year y for the stock s. In the template it is called  natage.
    \item $r_0$ is the first year of recruitment. In the template it is called  styr\_rec.
    \item $y_N$ is the last year of observation. In the template it is called endyr.
    \item $\epsilon^s_y$ is the notation for $rec\_dev(s,y)$ in the template. It is the annual deviation of recruitment. 
    \item $\mu^s_{R,i}$ is the notation for $mean\_log\_rec(cum\_regs(s)+yy\_sr(s,i))$. It is the mean  of the logarithm of recruitment.
    \item $wt\_fsh^{k}_{y,a}$ is input in dat file  for each fishery k, year y and age group a.
    \item $SSB^s_{y}$ is the annual spawning biomass for each year y and stock s. In the template it is called sp\_biom.
    %section selectivity
    \item $F^{k}_{y,a}$ is the fishing moratlity for each fishery k, year y and age group a.
    \item $y_0$ is the first year of observation. In the template is called styr.
    \item $log\_sel\_fsh$ is the logarithm of fishery selectivity(for each fishery, year and age  group) estimated by the model. 
    \item $log\_sel\_ind$ is the logarithm of index survey selectivity(for each index survey, year and age  group) estimated by the model. 
    %numbers at age
    \item $F^s_{y,a}$ total fishing mortality for each stock, year and age group.
    \item $Se^k_{y,a}$ is the selectivity for each fishery k, year y and age group a estimated by the model in section Selectivity. In the template it is called $sel\_fsh_a(k,y)$.
    
    %\item $mod\_rec(s,i)$ igual 
    \item $C^s_{y,a}$ is the total catch (calculated for each year y  and age group a) i.e for each stock. In the template it ts called $catage\_tot$.

    \item $Cat^k_{y,a}$ is the catch for each fishery k (calculated for each year y and age group a). In the template it is called $catage$.
    \item sf in the template is called  $spmo\_frac$.
    \item ${wt\_{mat}}^s_a$ in the template is called 
    $wt\_mature$.
    \item $B^{s,r}_0$ is the notation for $Bzero(cum\_regs(s)+r)$ in the template  for $2\leq r \leq n_{reg_s}$. cum\_regs(s) is the total number of regimes up to stock s-1.
    %\item $reg_shift$ igual
    \item $r_a$ is the recruitment age. In the template is called $rec\_age$.
    %\item $phizero(r)$ igual
    \item $\alpha^r$ is a parameter of the sr curve for each regime r ($1\leq r \leq n_{regs}$).  
 In the template it is called $alpha(r)$.
    \item $\beta^r$  is a parameter of the sr curve for each regime r ($1\leq r \leq n_{regs}$).  
 In the template it is called 
 beta(r). 
    \item $ sr\_type$ is the type of sr (Stock-Recruitment) curve to be considered. In the template it is called $SrType$.
    \item $h^{r_s}$, in the template is called steepness(irec) con $irec=rec\_map(stk\_reg\_map(1,r),stk\_reg\_map(2,r))$
    \item $R^{r}_0$ is the recruitment for regimen number r where $1\leq r \leq n_{regs}$. In the template is called Rzero(r).
    \item $B^{r}_0$ is the virgin biomass for regime number r where $1\leq r \leq n_{regs}$. In the template is called Bzero(r).
    %get survey predictions
    \item $pred\_ind(k,y)$ index predicted for each index survey k and index year y with $1\leq y \leq nyrs\_ind(k)$.
    \item $nyrs_{ind}^k$ is the number of years with available data  for survey k. In the template is called $nyrs\_ind(k)$.
    %\item $q\_ind(k,y)$, en el tpl igual
    \item $n_{ind}$ is the number of index surveys considered in the model. In the template is called $nind$.
    %\item $log\_q\_ind(k)$ igual
    \item $yrs\_ind(k,y)$ is the set of years with available data for each survey k and y is the index of those years.
    %\item $yrs\_rw\_q(k,i)$, igual
    \item $npars\_rw\_q^k$ in the template is called $npars\_rw\_q(k)$.
    %\item $log\_rw\_q\_ind(k,i)$,igual
    %\item $ind\_month\_frac(k)$, igual
    \item $sel\_ind_j(k,y)$ is the index survey  selectivity estimated by the model for each survey k, year y and age group j. 
    %\item $wt\_ind_j(k,iyr)$, igual
    %\item $q\_power\_ind(k)$, igual
    
    \item $mo_{ind}(k)$ is input for each index survey k and in the template is called $mo\_ind(k)$.
    \item $nyrs\_ind\_age(k)$ is input, is the number of years with available age data for index survey k.
    %\item $use\_age\_err$, igual
    %\item $eac\_ind_j(k,i)$, igual
    %\item $age\_err(j,l)$, igual
    \item $yrs\_ind\_age(k,i)$ is the set of years with   age data available for each index survey k, and i is the index of the year.
    
    
    
    
    %\item $elc\_ind_l(k,i)$, igual
    \item $nyrs\_ind\_length(k)$ is input, is the number of years with length data available for index survey k.
    \item $yrs\_ind\_length(k,i)$ is the set of years with lenght data available for index survey k, and i is the index of the year.
    %\item $q\_power\_ind(k)$, igual
    \item $yy\_sr(istk,iyr)$ has the same name in the template.
    \item $cum\_regs(s)$ is the number of regimes up to stock s-1. This has the same name in the template.
    %fishery predictions
    \item $Fnyrs_{age}$ is input and  is a vector with elements $Fnyrs^k_{age}$. $Fnyrs^k_{age}$ is the number with age data available for fishery k. In the template it is called $nyrs\_fsh\_age$.
    %\item eac\_fsh, igual
    %\item elc\_fsh(, igual
    \item $Fnyrs_{length}$ is input and  is a vector with elements $Fnyrs^k_{length}$. $Fnyrs^k_{length}$ is the number with lenght data available for for index survey k. In the template it is called $nyrs\_fsh\_length$.
    
    %n_nofsh
    
    \item $N\_NoFsh^s_{y,a}$, 
 in the template is called  $N\_NoFsh(s,y,a)$.
    \item endyr\_fut is the final projection year.
    \item $SSB\_NoFish^s_y$ is the biomass in the absence of fishing 
 for each stock s and year y. In the template is called $Sp\_Biom\_NoFish(s,y)$.
    
    \item $recruits^s_y$ in the template it is called recruits(s,y)
    %\item $totbiom\_NoFish^s_y$, en el tpl $totbiom\_NoFish(s,i)$
    \item $wt\_pop^s_a$,is input for each stock s and age a. In the template it is called  $wt\_pop(s,a)$.
    \item $totbiom^s_y$ is the total biomass for each stock s and year y. In the template it is called $totbiom(s,i)$.
    %\item  $wt\_mat^s_a$, en tl tpl $wt\_mature(s)$
    \item $Sp\_Biom\_NoFishRatio^s_y$ in the template it is called $Sp\_Biom\_NoFishRatio(s,i)$.
    \item $depletion^s$ is the notation for depletion(s).
    \item $depletion\_dyn^s$ is the notation for $depletion\_dyn(s) $.
    %\item $\mu^s_{R,y_N+1}$, en el tpl $mean\_log\_rec(cum\_regs(s)+yy\_sr(s,endyr+1))$
    %\item $wt\_fsh^{k_s}_{y,a}$, en el tpl $wt\_fsh(k,y,a)$
    \item $phase\_proj$ is equal to 5 if the number of years of proyection $nproj\_yrs$ is positive, otherwise it is equal to -5.
    %catches
    \item $w_{y,a}^{k}$ is the notation for $wt\_fsh(k,y,a)$ in the template.
    \item $k_s$  is to denote the fishery belonging to the stock s. In the template it is obtained from $sel\_map(1,k) == s$.
    
    \item ${C_{pred}}^{k}_y$ is the predicted catch. In the template it is called $pred\_catch(k,y)$.
    \item ${C_{obs}}_{k,y}$ is the observed catch. In th template it is called. $catch\_bio(k,y)$ 
    %the objective fucntion obj_fun
    %cat_like
    \item $catch\_bio\_lva^k_y$ is the notation for  $catch\_bio\_lva(k,y)$ in the template.
    \item $catch\_bio\_sd^k_y$ is the notation for $catch\_bio\_sd(k,y)$ in the template.
    \item $n_{rec}$ is the maximum valueof rec\_map matrix. In the template it is called nrec.
    \item $sigmarsq^r$ it is the notation for 
 $sigmarsq(r)$ in the template.
    %\item $log\_sigmar(r)$, igual
    
    \item $n_{reg_s}$ is the number of regimenes for the stock s (it is different from $n_{regs}$). In the template it is called $nreg(s)$.
    %\item $yy\_shift\_st(s,r)$, igual
    %\item $yy\_shift\_end(s,r)$, igaul
    

    %\item $reg\_shift$, igual
    %\item $pred\_rec_{i}^s$, en el tpl pred\_rec(s,i)
    \item $n_{regs}$ is the total number of regimes of all stock numbers. In the template it is called 
    nregs.
    %\item $m\_sigmarsq(r)$, igual
    %\item $m\_sigmar(r)$, igual
    \item $styr\_fut$ is the initial projection year.
    
    %compute priors
    
    %\item $q_ind(k,1)$, igual
    %\item $qprior(k)$, igual
    %\item $cvqprior(k)$, es igual
    %\item q\_poer\_ind(k), igual
    %\item q\_power\_prior(k), igual
    %\item cvq\_power\_prior(k), igual
    %\item sigma\_rw\_q(k,i), igual
    %\item log\_rw\_q\_ind(k), igual 
    \item nmort is the maximum value of mort\_map matrix. 
    %\item Mest(r), igual
    %\item natmortprior(r), igual
    %\item cvnatmortprior(r), igual
    %\item $Mage\_offset_i(r)$, igaul
    %\item $npars\_Mage(r)$, igual
    %\item $M\_rw(s)$, igual
    %\item $sigma\_rw\_M(s,i)$, igual
    %\item $npars\_rw\_M(s)$, igual
    %\item steepness(r), igual, ya está linea arriba
    \item $h^p(r)$ is the notation for steepnessprior(r) in the template. It is input.
    \item $h^p_{cv}(r)$ is the notation for cvsteepnessprior(r) in the template. It is input.

    %\item sigmar(r), igual
    %\item sigmarprior(r), igaul
    %\item cvsigmarprior(r), igual
    %\item log\_sigmar(r), igual
    %\item log\_Linf(r), igual
    %\item log\_Linfprior(r), igual
    %\item cvLinfprior(r), igual
    %\item $log\_k(r)$, igual
    %\item $log\_kprior(r)$, igual
    %\item cvkprior(r), igual
    %\item $log\_Lo(r)$, igual
    %\item $log\_Loprior(r)$, igual
    %\item cvLoprior(r), igual
    %sel_like
        %\item $log\_sdage(r)$, igual
    %\item $log\_sdageprior(r)$, igual
    %\item cvsdageprior(r), igual
    %\item logsel\_p1\_fsh(k), igual
    %\item logsel\_p2\_fsh(k), igual
    %\item logsel\_p3\_fsh(3), igual
    \item $log\_sel\_fsh_j(k,i)$ is the logarithm of fishery selectivity estimated by the model. 
    %\item sel\_sigma\_fsh(k,i), igual
    \item n\_sel\_ch\_fsh(k) is the number of selectivity change.
    \item yrs\_sel\_ch\_fsh(k,i) set of years of selectivity change and i is the index of the year.
    %\item curv\_pen\_fsh(k), igual 
    
    
    %\item nselages\_fsh(k), igual
    %\item seldec\_pen\_fsh(k), igual
    %\item avgsel\_fsh(k,i), igual
     %\item logsel\_slope\_ind(k), igual
    \item n\_sel \_ch\_ind(k) is the   number of selectivity changes for index survey k.
    \item yrs\_sel\_ch\_ind(k,i) is the set of years of selectivity change of the index survey k, and i is the index of the year.
    %\item sel\_sigma\_ind(k,i), igual
    \item log\_sel\_ind is the logarithm of index survey selectivity estimated by the model.
    %\item curv\_pen\_ind(k), igual
    %\item nselages\_ind(k), igual
    %\item seldec\_pen\_ind(k), igual
    %\item avgsel\_ind(k,i), igual
    %\item log\_selcoffs\_ind(k), igual
    %srv like
    \item obs\_ind(k,i) is the observed index value for each survey k and i with $1\leq i \leq nyrs\_ind(k)$.
    %\item $obs\_lse\_ind$, igual
    %\item obs\_se\_ind(k,i), igual
    %age like
   
    %\item $n\_sample\_fsh\_age_j(k)$, igual
    \item $oac\_fsh_j(k,i)$ is the observed age composition for fishery k, year i and age group j.
    \item $eac\_fsh_j(k,i)$ is the expected age composition for each fishery k, year i and age group j. It is estimated by the model.
    %\item $offset\_fsh(k)$, igual
    
    %\item $n\_sample\_fsh\_length(k,i)$, igual
    \item $olc\_fsh_j(k,i)$ is the observed length composition for fishery k, year i and age group j.
    \item $elc\_fsh_j(k,i)$ is the expected length composition for each fishery k, year i and age group j. It is estimated by the model.
    
    %\item $n\_sample\_ind\_lenght(k,i)$, igual
    \item $elc\_ind_j(k,i)$ is the expected size composition for each index survey k, yer i and age j. It is estimated by the model.
    
    %\item $n\_sample\_ind\_age(k,i)$, igual
    \item $oac\_ind_j(k,i)$ is the observed age composition for index survey k, year i and age j.
    \item $eac\_ind_j(k,i)$ is the expected age composition for each index survey k, year i and age j. It is estimated by the model.
    %get future fs
    \item ${F_{fut}}^{k}_{y,a}$  is the future  fishing mortality  for each fishery k, year y and age a. It is notation for $F\_future(k,i)$ in the template.
    \item ${Z_{fut}}^s_{y,a}$ is the future total mortality for each stock s, year y and age a. It is notation for $Z\_future_a(s,i)$ in the template.
    \item ${S_{fut}}^s_{y,a}$ is the future survival rate. In the tamplate is called $S\_future(s,i)$.
    \item $catage\_future^{s,iscen}_{y,a}$ is the future catch for each stock s, year y and each age a. It is called in the template as 
 $catage\_future(s,i)$.
    \item $catch\_future^s_{iscen,y}$ is the future catch for each stock s, year y and scenario iscen. It is called in the template as $catch\_future(s,iscen,i)$.
    %get msy
    %\item $mort\_map(s,1)$ igual
    %\item natmortprior, igual
    
    


\end{itemize}


\section{Appendix A: Case study description}
\label{section:AppendixA}
Follow the steps in section 8 (i.e. 8.1, 8.2, and 8.3) but considering as dat file the following \url{https://drive.google.com/file/d/1e_VbI1R6tRa2nYsm1cvbY6x3K4aWQ8Yq/view?usp=sharing} and as control file the following \url{https://drive.google.com/file/d/1Wl6TRf3ItbtTjy0wS23GT8qXlT_jk_bV/view?usp=sharing}.\\

We summarize the inputs to the data file in the following table. Note that there are 5 columns, the first is the line number it occupies in the file, the second column is the names of the parameters they take in the file, the third column is the name of the parameters they take in the manual, the fourth column is the name of the parameters in the template and the fifth column is the meaning of the parameters. Some parameters take the same name in the template and in the manual (this is denoted by -). These tables are intended to identify the input parameters in the manual equations and in the template.

\begin{tabular}{| p{0.9cm} | p{2.0cm} | p{1.8cm} | c | c |}
\hline
Line in the .dat file & Name in .dat file  & Name in the User Guide & Tpl name & Definition\\ \hline\hline
 3 &  years & $y_0$  & styr & Year of start of observation\\ \hline
4 &  years & $y_N$  & endyr & End year of observation\\ \hline
6 & ages  & $r_a$  & $rec\_age$ & Recruitment age\\ \hline
7 & ages  &  $o_a$ & $oldest\_age$ & Oldest age class\\ \hline
9 & nbins & $n_L$  & $nlenght$ & Number of sizes  considered\\ \hline
10 & lengthbin & $len\_bins_L$  & $len\_bins$ & Vector sizes \\  \hline
12 & Fnum & $n_{fsh}$  & $nfsh$ & Total number of fisheries\\ \hline
14 & Fnames &  Fsh\_names & $fshnameread$ & Fisheries names\\ \hline
16 & Fcaton &  ${C_{obs}}_{k,y}$ & $catch\_bio\_in$ & Observed catch biomass\\ \hline
19 & Fcatonerr &  - & $catch\_bio\_sd\_in$ & Catch biomass standard errors \\ \hline
21 & FnumyearsA & $Fnyrs^k_{age}$   & $nyrs\_fsh\_age$ & Number of years with age data available\\ \hline
23 & FnumyearsL & $Fnyrs^k_{length}$  & $nyrs\_fsh\_length$ & Number of years with length data available\\ \hline
25 & Fageyears & $Fyrs^{k,y}_{age}$  & $yrs\_fsh\_age\_in$ & Years with age data available\\ \hline
27 & Flenghtyears &   $Fyrs^{k,y}_{length}$& $yrs\_fsh\_lenght\_in$ & Years with lenght data available \\ \hline
29 & Fagesample &  - & $n\_sample\_fsh\_age\_in$ & \\ \hline
31 & Flenghtsample & -  & $n\_sample\_fsh\_lenght\_in$ & \\ \hline
33 & Fagecomp & -  & $oac\_fsh\_in$ & Age composition matrix \\ \hline
36 & Flenghtcomp & -  & $olc\_fsh\_in$ & Lenght composition matrix\\ \hline
80 & Fwtatage &  $wt\_fsh^{k}_{y,a}$ & $wt\_fsh$ & Matrix weight at age for each year(styr-endyr)\\ \hline
134 & Inum &  $n_{ind}$ & $nind$ & Total number of indices\\ \hline
136 & Inames & Ind\_names  & $indnameread$ & Index names\\ \hline
138 & Inumyears & $nyrs^k_{ind}$  & $nyrs\_ind$ & Vector with numbers of years for each fishery.\\ \hline
141 & Iyears &  - & $yrs\_ind\_in$ & Matrix with years for each index.\\ \hline
144 & Imonths & $mo_{ind}$  & $mo\_ind$ & Month occur \\ \hline
147 & Index &  - & $obs\_ind\_in$ & Values of index value (annual)\\ \hline
150 & Indexerr &  - & $obs\_se\_ind\_in$ & Values of indices serrs.\\ \hline
153 & Inumageyears &  - & $nyrs\_ind\_age$ & Number of years with age data available for index.\\
\hline
156 & Inumlenghtyears &  - & $nyrs\_ind\_lenght$ &  Number of years with lenght data available for index\\ \hline
159 & Iyearsage & $-$  & $yrs\_ind\_age\_in$ & Matrix of years with age data available\\ \hline
161 & Iagesample & -  & $n\_sample\_ind\_age\_in$ & \\ \hline
163 & Ipropage &  - & $oac\_ind\_in$ & Observed age comp from index. \\ \hline
165 & Iyearslength &  - & $yrs\_ind\_length\_in$ & Matrix of years with length data available\\ \hline
167 & Ilenghtsample &   - & $n\_sample\_ind\_lenght\_in$ & \\ \hline
169 & Iproplenght & -  & $olc\_ind\_in$ & Observed lenght comp from index.\\ \hline
171 & Iwtatage & $wt\_ind^k_{y,a}$  & $wt\_ind$ & Matrix weight at age for each year and index value. \\ \hline
278 & Pspwn &  $s_p$ & $spawnmo$ & Spawning month.\\ \hline
280 & Pageerr & $age\_err^a_a$  & $age\_err$ & Error in matrix age.\\ \hline
\end{tabular} 
\newpage
We also summarize the inputs to the control (or configuration) file in the following table:\\

\begin{tabular}{|  p{0.9cm} | p{1.9cm}  | p{1.9cm} | c | c |}
\hline
Line in the .ctl file & Name in .ctl file  & Name in the User Guide & Tpl name & Definition\\ \hline  \hline
 5 &  Number of stocks & $n_{stk}$  & nstk & Total number of stocks\\ \hline
6 &  Names of stocks & $Stk\_names$ & $stknameread$   & Stocks name\\ \hline
8 &  Selectivity sharing vector & sel\_map  & $sel\_map$ & Selectivity matrix\\ \hline
15 &  Number of regimes &  ${n_{reg}}_s$ & $nreg$ & Vector with regimes for each stock.\\ \hline
17 &  Sr\_type & $sr_{type}$  & $SrType$ & Model type curve S-R\\ \hline
19 &  AgeError & $use\_age\_err$  & $use\_age\_err$ & For conditional in eac\_ind.\\ \hline
21 &  Retro &   & $retro$ &\\ \hline
23 & Recruitment sharing matrix &  $rec\_map$ & $rec\_map$ & recruitment matrix.\\ \hline
26 &  Steepness & $h^p$  & $steepnessprior$ & Steepness prior\\ \hline
27 &  Steepness & $h^p_{cv}$  & $cvsteepnessprior$ & Coefficient of variation(CV) steepness.\\ \hline
28 &  Steepness & -  & $phase\_srec$ & Steepness estimation phase.\\ \hline
30 &  SigmaR &  - & $sigmarprior$ & Prior Recruitment variance.
\\ \hline
31 &  SigmaR &  - & $cvsigmarprior$ & CV Recruitment variance.\\ \hline
32 &  SigmaR & -  & $phase\_sigmar$ & Recruitment variance estimation phase \\ \hline
33 &  phase\_Rzero & -  & $phase\_Rzero$ & log\_Rzero estimation phase.\\ \hline
35 &  Nyrs\_sr &   $Nyrs\_sr^r$& $nrecs\_est\_shift$ & \\ \hline
38 &  yrs\_sr & $yrs\_sr^{r,y}$  & $yr\_rec\_est$ &\\ \hline
41 &  reg\_shifts &  $reg\_shift^s_{r}$  & $reg\_shift$ & \\ \hline
43 &  Growth parameters sharing matrix &  $growth\_map^s_{r}$ & $growth\_map$ & Growth parameters sharing matrix.\\ \hline
46 &  Linf &  - & $Linfprior$ & Prior  Asymptotic length ($L_{\infty}$)\\ \hline
47 &  Linf &  - & $cvLinfprior$ & CV $L_{\infty}$\\ \hline
48 &  Linf & -  & $phase\_Linf$ & $L_{\infty}$ estimation phase.\\ \hline
50 &  K &  - & $kprior$ & Prior curvature parameter.\\ \hline
51 & K & -  & $cvkprior$ & CV Curvature parameter.\\ \hline
52 &  K & -  & $phase\_k$ & Curvature parameter estimation phase.\\ \hline
54 &  Lo\_Len &  - & $Loprior$ & Prior First length($L_0$).\\ \hline
55 &  Lo\_Len  &  - & $cvLoprior$ & CV $L_0$.\\ \hline
56 &  Lo\_Len  & -  & $phase\_Lo$ & $log\_L_0$ phase estimation.\\ \hline
58 &  Sigma\_len  & -  &  
 $sdageprior$ & Coefficient of variation of length-at-age ($sd_{age}$).\\ \hline
59 &  Sigma\_len  & -  & $cvsdageprior$ & CV $sd_{age}$\\ \hline
60 &  Sigma\_len  &  - & $phase\_sdage$  & $sd_{age}$ phase estimation.\\ \hline
61 &  Mortality sharing matrix  & $mort\_map^s_r$   & $mort\_map$  & Mortality sharing matrix.\\ \hline


\end{tabular} 

\begin{tabular}{| p{0.9cm} | p{4.0cm}  | p{1.9cm} | c | c |}
\hline
Line in the .ctl file & Name in .ctl file  & Name in the User Guide & Tpl name & Definition\\ \hline
64 &  Natural\_Mortality  &  - & $natmortprior$ & Mest prior.
\\ \hline
65 &  Natural\_Mortality  &  - & $cvnatmortprior$ & CV Mest prior.\\ \hline
66 &  Natural\_Mortality  &  - & $phase\_M$  & Mest phase estimation.\\ \hline
67 &  NEW npars\_mage  & -  & $npars\_Mage$ & \\ \hline
69 &  NEW ages\_M\_changes  &  - & $ages\_M\_changes$ &\\ \hline
71 &  NEW Mage\_in  & -  & $Mage\_in$  &\\ \hline
73 &  phase\_Mage  & -  &  $phase\_Mage$ &\\ \hline
75 &  Phase\_Random\_walk\_M	  &  - & $phase\_rw\_M$ &\\ \hline
77 &  Nyrs\_Random\_walk\_M  &  - & $npars\_rw\_M$ &\\ \hline
79 &  Random\_walk\_M\_yrs	  & -  & $yrs\_rw\_M$ &\\ \hline
81 &  Random\_walk\_M\_sigmas  & -  & $sigma\_rw\_M$  &\\ \hline

84 & catchability & -  &  $qprior$& For initialization of log\_q\_ind.\\ \hline
85 & catchability &  - &  $cvqprior$& CV qprior.\\ \hline
86 & catchability & -  &  $phase\_q$& log\_q\_ind phase estimation.\\ \hline
88 & q\_power & -  & $q\_power\_prior$ & For initialization of log\_q\_power\_ind.\\ \hline
89 & q\_power &  - & $cvq\_power\_prior$ & CV q\_power\_prior.\\ \hline
90 & q\_power &  - & $phase\_q\_power$  & log\_q\_power\_ind estimation phase.\\ \hline
91 & Random\_walk\_q\_phases & -  & $phase\_rw\_q$ &\\ \hline
93 & Nyrs\_Random\_walk\_q & $npars\_rw\_q^k$   & $npars\_rw\_q$ &\\ \hline
95 & Random\_walk\_q\_yrs & $yrs\_rw\_q^k_y$  & $yrs\_rw\_q$ &\\ \hline
97 & Random\_walk\_q\_sigmas &  - & $sigma\_rw\_q$ &\\ \hline
99 & q\_agemin &  $q_{age,min}^k$ & $q\_age\_min$ &\\ \hline
102 & q\_agemax &   $q_{age,max}^k$ & $q\_age\_max$  &\\ \hline
103 & use vb wt age & -  & $use\_vb\_wt\_age$  &\\ \hline
105 & n\_proj\_yrs &  $nyrs_{proj}$ & $nproj\_yrs$ & Number of years of projection.\\ \hline
109 & Fishery \#  &  - & $fsh\_sel\_opt$  & Option for calculating selectivity for fsh.\\ \hline
110 & Fishery \# & -  & $nselages\_in\_fsh$  &\\ \hline
111 & Fishery \# & -  & $phase\_sel\_fsh$  &\\ \hline
112 & Fishery \# &  - & $curv\_pen\_fsh$ &\\ \hline
113 & Fishery \# &  - & $seldec\_pen\_fsh$ &\\ \hline

\end{tabular} 


\begin{tabular}{| p{0.9cm} | p{4.0cm}  | p{1.9cm} | c | c |}
\hline
Line in the .ctl file & Name in .ctl file  & Name in the User Guide & Tpl name & Definition\\ \hline
115 & Years of selectivity &  $Fn_{Se,ch}^k$ & $n\_sel\_ch\_fsh$ & Vector number of selectivity changes for the fsh.\\ \hline
116 & Years of selectivity &  $Fyrs_{Se,ch}^{k,y}$ & $yrs\_sel\_ch\_fsh$ & Years of selectivity changes for the fsh.\\ \hline
117 & Years of selectivity &  $Se_{\sigma}^{k,y}$ & $sel\_sigma\_fsh$ &\\ \hline
119 & Initial values for coeff. & $F_{Se}^a$  & $sel\_fsh\_tmp$ &\\ \hline
123 & Index \# & $I_{Se,opt}^k$  & ind\_sel\_opt\ & Option for calculating selectivity for index.\\ \hline
124 & Index \# & $In_{Se,ages}^k$  & nselages\_in\_ind &\\ \hline
125 & Index \# &  $Ip_{Se}^k$ & phase\_sel\_ind &\\ \hline
126 & Index \# & $Icurv_{pen}^k$  & curv\_pen\_ind &\\ \hline
127 & Index \# & $Idec_{Se,pen}^k$  & seldec\_pen\_ind &\\ \hline
128 & Index \# & -  &  &\\ \hline
129 & Index \# & $I_{Se}^a$  & sel\_ind\_tmp &\\ \hline
140 & Population weight at age 1000& $wt\_pop^s_a$  & $wt\_pop$ & Population weight at age.\\ \hline
143 & Maturity at Age & $maturity^s_a$  & $maturity$  & Matrix maturity at Age.\\ \hline
146 & Test & -  & $test$ & To check if it has been read correctly. \\ \hline
\end{tabular}




\section{Appendix B: Assessment results of case study}
\label{section:AppendixB}
Evaluation output files:
\begin{itemize}
    \item \textbf{mod2022\_avg1\_8ages\_2\_1\_R.rep}\\
    \url{https://drive.google.com/file/d/1HEOScCmbE20kTqUJABFf4M0d7HIXH_wP/view?usp=sharing}
    \item \textbf{mod2022\_avg1\_8ages\_2.cor}\\
    \url{https://drive.google.com/file/d/1MnisHoZyYJe1Mgz0PWj--u3HokQoTbxM/view?usp=sharing}.
    \item \textbf{mod2022\_avg1\_8ages\_2.par}\\
    \url{https://drive.google.com/file/d/1WXe2mYAI1k1qPiHu1NGh8bRtDrmdcMKT/view?usp=sharing}.
    \item \textbf{mod2022\_avg1\_8ages\_2.pdf}\\
    \url{https://drive.google.com/file/d/1R086eYTN6ivHArBPz0TErVkrSZjxFpTr/view?usp=sharing}.
    
    \item \textbf{mod2022\_avg1\_8ages\_2.rep}\\
    \url{https://drive.google.com/file/d/1LylpwiJI9_iNIH51xdBED5c20jSAqegx/view?usp=sharing}.
    \item  \textbf{mod2022\_avg1\_8ages\_2.std}\\
    \url{https://drive.google.com/file/d/15RDIcGak0HvSzWVXuCysOznxhzP0ceTb/view?usp=sharing}.
    \item \textbf{mod2022\_avg1\_8ages\_2.yld}\\
    \url{https://drive.google.com/file/d/1XACVGw5bxknwpgFWndLI7d-q0MbHcanb/view?usp=sharing}.
    
\end{itemize}

\bibliographystyle{apalike} 
\printbibliography

\end{document}